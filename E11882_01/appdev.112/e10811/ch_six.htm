<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta charset="utf-8">
<title>Executing Stored Procedures and Functions</title>
<meta name="generator" content="Oracle DARB XHTML Converter (Mode = document) - Version 5.1" />
<meta name="dcterms.created" content="2009-08-03T6:35:32Z" />
<meta name="robots" content="all" />
<meta name="dcterms.title" content="Database 2 Day + PHP Developer's Guide" />
<meta name="dcterms.identifier" content="E10811-01" />
<meta name="dcterms.isVersionOf" content="TDPPH" />
<meta name="dcterms.rights" content="Copyright&nbsp;&copy;&nbsp;2009,&nbsp;Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved." />
<link rel="Start" href="../../index.htm" title="Home" type="text/html" />
<link rel="Copyright" href="../../dcommon/html/cpyr.htm" title="Copyright" type="text/html" />

<script type="application/javascript"  src="../../dcommon/js/headfoot.js"></script>
<script type="application/javascript"  src="../../nav/js/doccd.js"></script>
<link rel="Contents" href="toc.htm" title="Contents" type="text/html" />
<link rel="Index" href="index.htm" title="Index" type="text/html" />
<link rel="Prev" href="ch_five.htm" title="Previous" type="text/html" />
<link rel="Next" href="ch_seven.htm" title="Next" type="text/html" />
<link rel="alternate" href="../e10811.pdf" title="PDF version" type="application/pdf" />
<link rel="schema.dcterms" href="http://purl.org/dc/terms/" />
<link rel="stylesheet" href="../../dcommon/css/fusiondoc.css">
<link rel="stylesheet" type="text/css"  href="../../dcommon/css/header.css">
<link rel="stylesheet" type="text/css"  href="../../dcommon/css/footer.css">
<link rel="stylesheet" type="text/css"  href="../../dcommon/css/fonts.css">
<link rel="stylesheet" href="../../dcommon/css/foundation.css">
<link rel="stylesheet" href="../../dcommon/css/codemirror.css">
<link rel="stylesheet" type="text/css" title="Default" href="../../nav/css/html5.css">
<link rel="stylesheet" href="../../dcommon/css/respond-480-tablet.css">
<link rel="stylesheet" href="../../dcommon/css/respond-768-laptop.css">
<link rel="stylesheet" href="../../dcommon/css/respond-1140-deskop.css">
<script type="application/javascript" src="../../dcommon/js/modernizr.js"></script>
<script type="application/javascript" src="../../dcommon/js/codemirror.js"></script>
<script type="application/javascript" src="../../dcommon/js/jquery.js"></script>
<script type="application/javascript" src="../../dcommon/js/foundation.min.js"></script>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-552992c80ef99c8d" async="async"></script>
<script type="application/javascript" src="../../dcommon/js/jqfns.js"></script>
<script type="application/javascript" src="../../dcommon/js/ohc-inline-videos.js"></script>
<!-- Add fancyBox -->
<link rel="stylesheet" href="../../dcommon/fancybox/jquery.fancybox.css?v=2.1.5" type="text/css" media="screen" />
<script type="text/javascript" src="../../dcommon/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>
<!-- Optionally add helpers - button, thumbnail and/or media -->
<link rel="stylesheet"  href="../../dcommon/fancybox/helpers/jquery.fancybox-buttons.css?v=1.0.5"  type="text/css" media="screen" />
<script type="text/javascript" src="../../dcommon/fancybox/helpers/jquery.fancybox-buttons.js?v=1.0.5"></script>
<script type="text/javascript" src="../../dcommon/fancybox/helpers/jquery.fancybox-media.js?v=1.0.6"></script>
<link rel="stylesheet"  href="../../dcommon/fancybox/helpers/jquery.fancybox-thumbs.css?v=1.0.7"  type="text/css" media="screen" />
<script type="text/javascript" src="../../dcommon/fancybox/helpers/jquery.fancybox-thumbs.js?v=1.0.7"></script>
</head>
<body>
<a href="#BEGIN" class="accessibility-top skipto" tabindex="0">Go to main content</a><header><!--
<div class="zz-skip-header"><a id="top" href="#BEGIN">Go to main content</a>--></header>
<div class="row" id="CONTENT">
<div class="IND large-9 medium-8 columns">
<a id="BEGIN" name="BEGIN"></a>
<span id="PAGE" style="display:none;">9/12</span> <!-- End Header --><a id="CHDCECJG"></a>
<h1 class="chapter"><span class="secnum">6</span> Executing Stored Procedures and Functions</h1>
<p>This chapter shows you how to run stored procedures and functions using PHP and Oracle Database. It has the following topics:</p>
<ul>
<li>
<p><a href="#CHDDFEFF">Using PL/SQL to Capture Business Logic</a></p>
</li>
<li>
<p><a href="#CHDDHDHB">Using PL/SQL Ref Cursors to Return Result Sets</a></p>
</li>
</ul>
<p>The Anyco application is extended with a PL/SQL function to calculate remuneration for each employee, and is further extended with a PL/SQL procedure to return a REF CURSOR of employee records.</p>
<a id="CHDDFEFF"></a>
<div class="sect1">
<h2 class="sect1">Using PL/SQL to Capture Business Logic</h2>
<p>Oracle PL/SQL <a id="sthref561"></a><a id="sthref562"></a>procedures and functions enable you to store business logic in the database for any client program to use. They also reduce the amount of data that must be transferred between the database and PHP and can help improve performance.</p>
<p>In this section, you will create a PL/SQL stored function to calculate and display the total remuneration for each employee.</p>
<p>To display the total remuneration of each employee, perform the following steps:</p>
<p>The PHP application <a id="sthref563"></a><a id="sthref564"></a>connects to the database as the HR user. You may need to unlock the <code>HR</code> account as a user with DBA privileges. To unlock the <code>HR</code> user:</p>
<ol>
<li>
<p>Open SQL Developer and open a connection to your Oracle database.</p>
</li>
<li>
<p>Login to your Oracle database as <span class="bold">system</span>.</p>
</li>
<li>
<p>Open SQL Worksheet or SQL*Plus and run the following <code>grant</code> statement to assign the <code>create procedure</code> privilege to the <code>HR</code> user:</p>
<pre>
grant create procedure to hr;
</pre>
<img width="739" height="569" src="img/chap6_hrgrantproc.gif" alt="Description of chap6_hrgrantproc.gif follows" title="Description of chap6_hrgrantproc.gif follows" /><br />
<a id="sthref565" href="img_text/chap6_hrgrantproc.htm">Description of the illustration chap6_hrgrantproc.gif</a><br />
<br /></li>
<li>
<p>Login to your HR sample schema as <code>hr</code>.</p>
</li>
<li>
<p>Open SQL Worksheet or SQL*Plus and enter the following text to create a <code><a id="sthref566"></a><a id="sthref567"></a>calc_remuneration()</code> function:</p>
<pre>
<span class="bold">create or replace function calc_remuneration(</span>
<span class="bold">  salary IN number, commission_pct IN number) return number is</span>
<span class="bold">begin</span>
<span class="bold">  return ((salary*12) + (salary * 12 * nvl(commission_pct,0)));</span>
<span class="bold">end;</span>
</pre>
<img width="738" height="568" src="img/chap6_hrcalcrem.gif" alt="Description of chap6_hrcalcrem.gif follows" title="Description of chap6_hrcalcrem.gif follows" /><br />
<a id="sthref568" href="img_text/chap6_hrcalcrem.htm">Description of the illustration chap6_hrcalcrem.gif</a><br />
<br /></li>
<li>
<p>Create the <code>chap6</code> directory, copy the application files from <code>chap5</code>, and change to the newly created directory:</p>
<p>On Windows:</p>
<pre>
mkdir c:\program files\Apache Group\Apache2\htdocs\chap6
cd c:\program files\Apache Group\Apache2\htdocs\chap6
copy ..\chap5\* .
</pre>
<p>On Linux:</p>
<pre>
mkdir $HOME/public_html/chap6
cd $HOME/public_html/chap6
cp ../chap5/* .
</pre></li>
<li>
<p>Edit the <code><a id="sthref569"></a><a id="sthref570"></a>anyco.php</code> file. Modify the query in the <a id="sthref571"></a><a id="sthref572"></a><code>construct_employees()</code> function to call the PL/SQL function for each row returned:</p>
<pre>
$query =
 "SELECT employee_id,
         substr(first_name,1,1) || '. '|| last_name as employee_name,
         hire_date,
         to_char(salary, '9999G999D99') as salary,
         nvl(commission_pct,0) as commission_pct<span class="bold">,</span>
<span class="bold">         to_char(calc_remuneration(salary, commission_pct),'9999G999D99')</span>
<span class="bold">           as remuneration</span>
  FROM employees
  WHERE department_id = :did
  ORDER BY employee_id ASC";
</pre></li>
<li>
<p>Edit the <code><a id="sthref573"></a><a id="sthref574"></a>anyco_ui.inc</code> file. In the <code><a id="sthref575"></a><a id="sthref576"></a>ui_print_employees()</code> function, add a <code>Remuneration</code> column to the table, and modify the <code>foreach</code> loop to display the remuneration field for each employee:</p>
<pre>
echo &lt;&lt;&lt;END
   &lt;form method="post" action="$posturl"&gt;
   &lt;table&gt;
   &lt;tr&gt;
     &lt;th&gt;&amp;nbsp;&lt;/th&gt;
     &lt;th&gt;Employee&lt;br&gt;ID&lt;/th&gt;
     &lt;th&gt;Employee&lt;br&gt;Name&lt;/th&gt;
     &lt;th&gt;Hiredate&lt;/th&gt;
     &lt;th&gt;Salary&lt;/th&gt;
     &lt;th&gt;Commission&lt;br&gt;(%)&lt;/th&gt;
<span class="bold">     &lt;th&gt;Remuneration&lt;/th&gt;</span>
   &lt;/tr&gt;
END;

    // Write one row per employee
    foreach ($employeerecords as $emp) {
      echo '&lt;tr&gt;';
      echo '&lt;td&gt;&lt;input type="radio" name="emprec"
                 value="'.htmlentities($emp['EMPLOYEE_ID']).'"&gt;&lt;/td&gt;';
      echo '&lt;td align="right"&gt;'.htmlentities($emp['EMPLOYEE_ID']).'&lt;/td&gt;';
      echo '&lt;td&gt;'.htmlentities($emp['EMPLOYEE_NAME']).'&lt;/td&gt;';
      echo '&lt;td&gt;'.htmlentities($emp['HIRE_DATE']).'&lt;/td&gt;';
      echo '&lt;td align="right"&gt;'.htmlentities($emp['SALARY']).'&lt;/td&gt;';
      echo '&lt;td align="right"&gt;'.htmlentities($emp['COMMISSION_PCT']).'&lt;/td&gt;';
<span class="bold">      echo '&lt;td align="right"&gt;'.htmlentities($emp['REMUNERATION']).'&lt;/td&gt;';</span>
      echo '&lt;/tr&gt;';
    }
</pre></li>
<li>
<p>Save the changes to your application files. In a browser, enter the following URL to <a id="sthref577"></a><a id="sthref578"></a>test the application:</p>
<p>On Windows:</p>
<pre>
http://localhost/chap6/anyco.php
</pre>
<p>On Linux:</p>
<pre>
http://localhost/~&lt;username&gt;/chap6/anyco.php
</pre></li>
<li>
<p>In the Departments page, click <span class="bold">Show Employees</span>.</p>
<img width="608" height="241" src="img/chap6_stored_proc_test_001.gif" alt="Description of chap6_stored_proc_test_001.gif follows" title="Description of chap6_stored_proc_test_001.gif follows" /><br />
<a id="sthref579" href="img_text/chap6_stored_proc_test_001.htm">Description of the illustration chap6_stored_proc_test_001.gif</a><br />
<br />
<p>In the Employees page for the department, the employee remuneration is displayed in the last column:</p>
<img width="629" height="242" src="img/chap6_stored_proc_test_002.gif" alt="Description of chap6_stored_proc_test_002.gif follows" title="Description of chap6_stored_proc_test_002.gif follows" /><br />
<a id="sthref580" href="img_text/chap6_stored_proc_test_002.htm">Description of the illustration chap6_stored_proc_test_002.gif</a><br />
<br /></li>
</ol>
</div>
<!-- class="sect1" -->
<a id="CHDDHDHB"></a>
<div class="sect1">
<h2 class="sect1">Using PL/SQL Ref Cursors to Return Result Sets</h2>
<p>Query data can be returned as REF CURSORS from PL/SQL blocks and displayed in PHP. This can be useful where the data set requires complex functionality or where you want multiple application programs to use the same query.</p>
<p>A REF CURSOR in PL/SQL is a type definition that is assigned to a cursor variable. It is common to declare a PL/SQL type inside a package specification for reuse in other PL/SQL constructs, such as a package body.</p>
<p>In this section, you will use a REF CURSOR to retrieve the employees for a specific department.</p>
<p>To create a PL/SQL package specification and body, with a REF CURSOR to retrieve employees for a specific department, perform the following steps:</p>
<ol>
<li>
<p>Open SQL Developer and login to your HR sample schema as <code>hr</code>.</p>
</li>
<li>
<p>Open SQL Worksheet or SQL*Plus and enter the following text to create the <code>cv_types</code> PL/SQL package:</p>
<pre>
<span class="bold">CREATE OR REPLACE PACKAGE cv_types AS</span>
<span class="bold">  TYPE empinfotyp IS REF CURSOR;</span>
<span class="bold">  PROCEDURE get_employees(deptid in number,</span>
<span class="bold">                          employees in out empinfotyp);</span>
<span class="bold">END cv_types;</span>
</pre>
<p>Click <span class="bold">Run</span>:</p>
<img width="739" height="569" src="img/chap6_hrcreatepack.gif" alt="Description of chap6_hrcreatepack.gif follows" title="Description of chap6_hrcreatepack.gif follows" /><br />
<a id="sthref581" href="img_text/chap6_hrcreatepack.htm">Description of the illustration chap6_hrcreatepack.gif</a><br />
<br /></li>
<li>
<p>In SQL Worksheet enter the following text to create the <code>cv_types</code> PL/SQL package body:</p>
<pre>
<span class="bold">CREATE OR REPLACE PACKAGE BODY cv_types AS</span>
<span class="bold">  PROCEDURE get_employees(deptid in number,</span>
<span class="bold">                          employees in out empinfotyp)</span>
<span class="bold">  IS</span>
<span class="bold">  BEGIN</span>
<span class="bold">    OPEN employees FOR</span>
<span class="bold">      SELECT employee_id,</span>
<span class="bold">        substr(first_name,1,1) || '. '|| last_name as employee_name,</span>
<span class="bold">        hire_date,</span>
<span class="bold">        to_char(salary, '999G999D99') as salary,</span>
<span class="bold">        NVL(commission_pct,0) as commission_pct,</span>
<span class="bold">        to_char(calc_remuneration(salary, commission_pct),</span>
<span class="bold">                '9999G999D99') as remuneration</span>
<span class="bold">      FROM employees</span>
<span class="bold">      WHERE department_id = deptid</span>
<span class="bold">      ORDER BY employee_id ASC;</span>
<span class="bold">  END get_employees;</span>
<span class="bold">END cv_types;</span>
</pre>
<p>Click <span class="bold">Run</span>:</p>
<img width="739" height="569" src="img/chap6_hrcreatebody.gif" alt="Description of chap6_hrcreatebody.gif follows" title="Description of chap6_hrcreatebody.gif follows" /><br />
<a id="sthref582" href="img_text/chap6_hrcreatebody.htm">Description of the illustration chap6_hrcreatebody.gif</a><br />
<br /></li>
<li>
<p>Edit the <code><a id="sthref583"></a><a id="sthref584"></a>anyco_db.inc</code> file. Create a new PHP function that calls the PL/SQL packaged procedure:</p>
<pre>
<span class="bold">// Use ref cursor to fetch employee records</span>
<span class="bold">// All records are retrieved - there is no paging in this example </span>
<span class="bold">function db_get_employees_rc($conn, $deptid, &amp;$e)</span>
{
<span class="bold">  // Execute the call to the stored procedure</span>
<span class="bold">  $stmt = "BEGIN cv_types.get_employees($deptid, :rc); END;";</span>
<span class="bold">  $stid = @oci_parse($conn, $stmt);</span>
<span class="bold">  if (!$stid) {</span>
<span class="bold">    $e = db_error($conn, __FILE__, __LINE__);</span>
<span class="bold">    return false;</span>
<span class="bold">  }</span>
<span class="bold">  $refcur = oci_new_cursor($conn);</span>
<span class="bold">  if (!$stid) {</span>
<span class="bold">    $e = db_error($conn, __FILE__, __LINE__);</span>
<span class="bold">    return false;</span>
<span class="bold">  }</span>
<span class="bold">  $r = @oci_bind_by_name($stid, ':RC', $refcur, -1, OCI_B_CURSOR);</span>
<span class="bold">  if (!$r) {</span>
<span class="bold">    $e = db_error($stid, __FILE__, __LINE__);</span>
<span class="bold">    return false;</span>
<span class="bold">  }</span>
<span class="bold">  $r = @oci_execute($stid);</span>
<span class="bold">  if (!$r) {</span>
<span class="bold">    $e = db_error($stid, __FILE__, __LINE__);</span>
<span class="bold">    return false;</span>
<span class="bold">  }</span>
<span class="bold">  // Now treat the ref cursor as a statement resource</span>
<span class="bold">  $r = @oci_execute($refcur, OCI_DEFAULT);</span>
<span class="bold">  if (!$r) {</span>
<span class="bold">    $e = db_error($refcur, __FILE__, __LINE__);</span>
<span class="bold">    return false;</span>
<span class="bold">  }</span>
<span class="bold">  $r = @oci_fetch_all($refcur, $employeerecords, null, null,</span>
<span class="bold">                          OCI_FETCHSTATEMENT_BY_ROW);</span>
<span class="bold">  if (!$r) {</span>
<span class="bold">    $e = db_error($refcur, __FILE__, __LINE__);</span>
<span class="bold">    return false;</span>
<span class="bold">  }</span>
<span class="bold">  return ($employeerecords);</span>
<span class="bold">}</span>
</pre>
<p>The <a id="sthref585"></a><a id="sthref586"></a><code>db_get_employees_rc()</code> function executes the following anonymous (unnamed) PL/SQL block:</p>
<pre>
BEGIN cv_types.get_employees($deptid, :rc); END;
</pre>
<p>The PL/SQL statement inside the BEGIN END block calls the stored PL/SQL package procedure <code><a id="sthref587"></a><a id="sthref588"></a>cv_types.et_employees()</code>. This returns an <code><a id="sthref589"></a><a id="sthref590"></a>OCI_B_CURSOR</code> REF CURSOR bind variable in the PHP variable <code><a id="sthref591"></a><a id="sthref592"></a>$refcur</code>.</p>
<p>The <code>$refcur</code> variable is treated like a statement handle returned by <code>oci_parse()</code>. It is used for execute and fetch operations just as if the SQL query had been done in PHP.</p>
</li>
<li>
<p>Edit the <code>anyco.php</code> file. In the <code>construct_employees()</code> function, remove the query text and the bind arguments. The function becomes:</p>
<pre>
function construct_employees()
{
  $deptid = $_SESSION['deptid'];
  $conn = db_connect($err);
  if (!$conn) {
    handle_error('Connection Error', $err);
  }
  else {
<span class="bold">    $emp = db_get_employees_rc($conn, $deptid, $err);</span>

    if (!$emp) {
      handle_error('Cannot fetch Employees', $err);
    }
    else {
      $deptname = get_dept_name($conn, $deptid);

      ui_print_header('Employees: '.$deptname);
      ui_print_employees($emp, $_SERVER['SCRIPT_NAME']);
      ui_print_footer(date('Y-m-d H:i:s'));
    }
  }
}
</pre></li>
<li>
<p>Save the changes to your application files. In a browser, enter the following URL to <a id="sthref593"></a><a id="sthref594"></a>test the application:</p>
<p>On Windows:</p>
<pre>
http://localhost/chap6/anyco.php
</pre>
<p>On Linux:</p>
<pre>
http://localhost/~&lt;username&gt;/chap6/anyco.php
</pre></li>
<li>
<p>In the Departments page, click <span class="bold">Next</span> to navigate to the Marketing department page.</p>
<img width="620" height="241" src="img/chap6_refcursor_005.gif" alt="Description of chap6_refcursor_005.gif follows" title="Description of chap6_refcursor_005.gif follows" /><br />
<a id="sthref595" href="img_text/chap6_refcursor_005.htm">Description of the illustration chap6_refcursor_005.gif</a><br />
<br /></li>
<li>
<p>In the Marketing department page, click <span class="bold">Show Employees</span>.</p>
<img width="579" height="242" src="img/chap6_refcursor_006.gif" alt="Description of chap6_refcursor_006.gif follows" title="Description of chap6_refcursor_006.gif follows" /><br />
<a id="sthref596" href="img_text/chap6_refcursor_006.htm">Description of the illustration chap6_refcursor_006.gif</a><br />
<br />
<p>In the Employees page for the Marketing department, the employee pages displays as previously:</p>
<img width="652" height="281" src="img/chap6_refcursor_007.gif" alt="Description of chap6_refcursor_007.gif follows" title="Description of chap6_refcursor_007.gif follows" /><br />
<a id="sthref597" href="img_text/chap6_refcursor_007.htm">Description of the illustration chap6_refcursor_007.gif</a><br />
<br /></li>
</ol>
</div>
<!-- class="sect1" --></div>
<!-- class="ind" -->
<!-- Start Footer -->
</div>
<!-- add extra wrapper close div-->
<footer><!--
<hr />
<table class="cellalignment943">
<tr>
<td class="cellalignment950">
<table class="cellalignment948">
<tr>
<td class="cellalignment947"><a href="ch_five.htm"><img width="24" height="24" src="../../dcommon/gifs/leftnav.gif" alt="Go to previous page" /><br />
<span class="icon">Previous</span></a></td>
<td class="cellalignment947"><a href="ch_seven.htm"><img width="24" height="24" src="../../dcommon/gifs/rightnav.gif" alt="Go to next page" /><br />
<span class="icon">Next</span></a></td>
</tr>
</table>
</td>
<td class="cellalignment-copyrightlogo"><img width="144" height="18" src="../../dcommon/gifs/oracle.gif" alt="Oracle" /><br />
Copyright&nbsp;&copy;&nbsp;2009,&nbsp;Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved.<br />
<a href="../../dcommon/html/cpyr.htm">Legal Notices</a></td>
<td class="cellalignment952">
<table class="cellalignment946">
<tr>
<td class="cellalignment947"><a href="../../index.htm"><img width="24" height="24" src="../../dcommon/gifs/doclib.gif" alt="Go to Documentation Home" /><br />
<span class="icon">Home</span></a></td>
<td class="cellalignment947"><a href="../../nav/portal_booklist.htm"><img width="24" height="24" src="../../dcommon/gifs/booklist.gif" alt="Go to Book List" /><br />
<span class="icon">Book List</span></a></td>
<td class="cellalignment947"><a href="toc.htm"><img width="24" height="24" src="../../dcommon/gifs/toc.gif" alt="Go to Table of Contents" /><br />
<span class="icon">Contents</span></a></td>
<td class="cellalignment947"><a href="index.htm"><img width="24" height="24" src="../../dcommon/gifs/index.gif" alt="Go to Index" /><br />
<span class="icon">Index</span></a></td>
<td class="cellalignment947"><a href="../../nav/mindx.htm"><img width="24" height="24" src="../../dcommon/gifs/masterix.gif" alt="Go to Master Index" /><br />
<span class="icon">Master Index</span></a></td>
<td class="cellalignment947"><a href="../../dcommon/html/feedback.htm"><img width="24" height="24" src="../../dcommon/gifs/feedbck2.gif" alt="Go to Feedback page" /><br />
<span class="icon">Contact Us</span></a></td>
</tr>
</table>
</td>
</tr>
</table>
--></footer>
<noscript>
<p>Scripting on this page enhances content navigation, but does not change the content in any way.</p>
</noscript>
</body>
</html>
