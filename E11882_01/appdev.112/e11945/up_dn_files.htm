<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta charset="utf-8">
<title>How to Upload and Download Files in an Application</title>
<meta name="generator" content="Oracle DARB XHTML Converter (Mode = document) - Version 5.1.2 Build 015" />
<meta name="dcterms.created" content="2012-02-02T14:33:21Z" />
<meta name="robots" content="all" />
<meta name="dcterms.title" content="Application Express Advanced Tutorials" />
<meta name="dcterms.identifier" content="E11945-02" />
<meta name="dcterms.isVersionOf" content="HTMAD" />
<meta name="dcterms.rights" content="Copyright&nbsp;&copy;&nbsp;2003, 2012,&nbsp;Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved." />
<link rel="Start" href="../../index.htm" title="Home" type="text/html" />
<link rel="Copyright" href="../../dcommon/html/cpyr.htm" title="Copyright" type="text/html" />

<script type="application/javascript"  src="../../dcommon/js/headfoot.js"></script>
<script type="application/javascript"  src="../../nav/js/doccd.js"></script>
<link rel="Contents" href="toc.htm" title="Contents" type="text/html" />
<link rel="Prev" href="bar_chart.htm" title="Previous" type="text/html" />
<link rel="Next" href="javascript.htm" title="Next" type="text/html" />
<link rel="alternate" href="../e11945.pdf" title="PDF version" type="application/pdf" />
<link rel="schema.dcterms" href="http://purl.org/dc/terms/" />
<link rel="stylesheet" href="../../dcommon/css/fusiondoc.css">
<link rel="stylesheet" type="text/css"  href="../../dcommon/css/header.css">
<link rel="stylesheet" type="text/css"  href="../../dcommon/css/footer.css">
<link rel="stylesheet" type="text/css"  href="../../dcommon/css/fonts.css">
<link rel="stylesheet" href="../../dcommon/css/foundation.css">
<link rel="stylesheet" href="../../dcommon/css/codemirror.css">
<link rel="stylesheet" type="text/css" title="Default" href="../../nav/css/html5.css">
<link rel="stylesheet" href="../../dcommon/css/respond-480-tablet.css">
<link rel="stylesheet" href="../../dcommon/css/respond-768-laptop.css">
<link rel="stylesheet" href="../../dcommon/css/respond-1140-deskop.css">
<script type="application/javascript" src="../../dcommon/js/modernizr.js"></script>
<script type="application/javascript" src="../../dcommon/js/codemirror.js"></script>
<script type="application/javascript" src="../../dcommon/js/jquery.js"></script>
<script type="application/javascript" src="../../dcommon/js/foundation.min.js"></script>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-552992c80ef99c8d" async="async"></script>
<script type="application/javascript" src="../../dcommon/js/jqfns.js"></script>
<script type="application/javascript" src="../../dcommon/js/ohc-inline-videos.js"></script>
<!-- Add fancyBox -->
<link rel="stylesheet" href="../../dcommon/fancybox/jquery.fancybox.css?v=2.1.5" type="text/css" media="screen" />
<script type="text/javascript" src="../../dcommon/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>
<!-- Optionally add helpers - button, thumbnail and/or media -->
<link rel="stylesheet"  href="../../dcommon/fancybox/helpers/jquery.fancybox-buttons.css?v=1.0.5"  type="text/css" media="screen" />
<script type="text/javascript" src="../../dcommon/fancybox/helpers/jquery.fancybox-buttons.js?v=1.0.5"></script>
<script type="text/javascript" src="../../dcommon/fancybox/helpers/jquery.fancybox-media.js?v=1.0.6"></script>
<link rel="stylesheet"  href="../../dcommon/fancybox/helpers/jquery.fancybox-thumbs.css?v=1.0.7"  type="text/css" media="screen" />
<script type="text/javascript" src="../../dcommon/fancybox/helpers/jquery.fancybox-thumbs.js?v=1.0.7"></script>
</head>
<body>
<a href="#BEGIN" class="accessibility-top skipto" tabindex="0">Go to main content</a><header><!--
<div class="zz-skip-header"><a id="top" href="#BEGIN">Go to main content</a>--></header>
<div class="row" id="CONTENT">
<div class="IND large-9 medium-8 columns">
<a id="BEGIN" name="BEGIN"></a>
<span id="PAGE" style="display:none;">12/19</span> <!-- End Header --><a id="CJAHDJDA"></a>
<h1 class="chapter"><span class="secnum">9</span> <a id="HTMAD008"></a>How to Upload and Download Files in an Application</h1>
<p>Oracle Application Express applications support the ability to upload and download files stored in the database. This tutorial illustrates how to create a form and report with links for file upload and download, how to create and populate a table to store additional attributes about the documents, and finally how to create the mechanism to download the document in your custom table.</p>
<p>This section contains the following topics:</p>
<ul>
<li>
<p><a href="#BABEFEIE">Creating an Application</a></p>
</li>
<li>
<p><a href="#CIHCFCHF">Creating an Upload Form</a></p>
</li>
<li>
<p><a href="#CIHBFCDH">Creating a Report with Download Links</a></p>
</li>
<li>
<p><a href="#CIHBEAAD">Storing Additional Attributes About the Document</a></p>
</li>
<li>
<p><a href="#CIHHEHCJ">Storing the Document in a Custom Table</a></p>
</li>
<li>
<p><a href="#CIHDDJGF">Downloading Documents from the Custom Table</a></p>
</li>
<li>
<p><a href="#CHDCFCIG">Security Issues to Consider</a></p>
</li>
</ul>
<p>For additional examples on this topic, please visit the following Oracle by Examples (OBEs):</p>
<ul>
<li>
<p>Defining and Viewing BLOB Data in Oracle Application Express 3.1</p>
<p><code><a href="http://www.oracle.com/technology/obe/apex/apex31nf/apex31blob.htm">http://www.oracle.com/technology/obe/apex/apex31nf/apex31blob.htm</a></code></p>
</li>
</ul>
<a id="BABEFEIE"></a>
<div class="sect1"><!-- infolevel="all" infotype="General" -->
<h2 class="sect1">Creating an Application</h2>
<p>First, create a new application using the Create Application Wizard with the assumption you will include an upload form on page 1.</p>
<p>To create an application using the Create Application Wizard:</p>
<ol>
<li>
<p>On the Workspace home page, click the <span class="bold">Application Builder</span> icon.</p>
<p>The Application Builder home page appears.</p>
</li>
<li>
<p>Click <span class="bold">Create</span>.</p>
</li>
<li>
<p>Select <span class="bold">Create Application</span> and then click <span class="bold">Next</span>.</p>
</li>
<li>
<p>For Name, specify the following:</p>
<ol>
<li>
<p>For Name, enter <code>Download App</code>.</p>
</li>
<li>
<p>Accept the remaining defaults and click <span class="bold">Next</span>.</p>
</li>
</ol>
</li>
<li>
<p>Add a blank page:</p>
<ol>
<li>
<p>Under Select Page Type, select <span class="bold">Blank</span> and click Add Page.</p>
<p>The new page appears in the Create Application list at the top of the page.</p>
</li>
<li>
<p>Click <span class="bold">Next</span>.</p>
</li>
</ol>
</li>
<li>
<p>For Tabs, accept the default, <span class="bold">One Level of Tabs,</span> and click <span class="bold">Next</span>.</p>
</li>
<li>
<p>For Copy Shared Components from Another Application, accept the default, <span class="bold">No</span>, and click <span class="bold">Next</span>.</p>
</li>
<li>
<p>For Attributes, accept the defaults for Authentication Scheme, Language, and User Language Preference Derived From and click <span class="bold">Next</span>.</p>
</li>
<li>
<p>For User Interface, select <span class="bold">Theme 2</span> and then click <span class="bold">Next</span>.</p>
</li>
<li>
<p>Review your selections and click <span class="bold">Create</span>.</p>
<p>The Application home page appears.</p>
</li>
</ol>
</div>
<!-- class="sect1" -->
<a id="CIHCFCHF"></a>
<div class="sect1">
<h2 class="sect1">Creating an Upload Form</h2>
<p>Once you create an application, the next step is to create a form to upload documents. In the following exercise, you create a form in an HTML region that contains a file upload item and a button. The button submits the page and returns the user to the same page.</p>
<p>Topics in this section include:</p>
<ul>
<li>
<p><a href="#CJAFGBDI">Create an HTML Region</a></p>
</li>
<li>
<p><a href="#CJADIIIH">Create an Upload Item</a></p>
</li>
<li>
<p><a href="#CJAFCIEH">Create a Button</a></p>
</li>
</ul>
<a id="CJAFGBDI"></a>
<div class="sect2"><!-- infolevel="all" infotype="General" -->
<h3 class="sect2">Create an HTML Region</h3>
<p>First, you need to create a container to hold the form. In Application Builder, this container is called a region.</p>
<p>To create an HTML region:</p>
<ol>
<li>
<p>Click the <span class="bold">Page 1</span> icon.</p>
<p>The Page Definition appears.</p>
</li>
<li>
<p>Under Regions, click the <span class="bold">Create</span> icon as shown in <a href="#BABHCIEH">Figure 9-1</a>.</p>
<div class="figure">
<p class="titleinfigure"><a id="BABHCIEH"></a>Figure 9-1 Create Icon</p>
<img width="62" height="67" src="img/pg_def_create_ico.gif" alt="Description of Figure 9-1 follows" title="Description of Figure 9-1 follows" /><br />
<a id="sthref111" href="img_text/pg_def_create_ico.htm">Description of "Figure 9-1 Create Icon "</a><br />
<br /></div>
<!-- class="figure" --></li>
<li>
<p>For Region:</p>
<ol>
<li>
<p>Identify the type of region to add to this page - Accept the default, <span class="bold">HTML</span>, and click <span class="bold">Next</span>.</p>
</li>
<li>
<p>Select the type of HTML region container you wish to create - Accept the default, <span class="bold">HTML</span>, and click <span class="bold">Next</span>.</p>
</li>
</ol>
</li>
<li>
<p>For Display Attributes:</p>
<ol>
<li>
<p>Title - Enter <code>Submit File</code>.</p>
</li>
<li>
<p>Accept the remaining defaults and click <span class="bold">Next</span>.</p>
</li>
</ol>
</li>
<li>
<p>Accept the remaining defaults and click <span class="bold">Create Region</span>.</p>
<p>The Page Definition appears.</p>
</li>
</ol>
</div>
<!-- class="sect2" -->
<a id="CJADIIIH"></a>
<div class="sect2"><!-- infolevel="all" infotype="General" -->
<h3 class="sect2">Create an Upload Item</h3>
<p>Next, you need to create a text field or item. In Application Builder, an item is part of an HTML form. An item can be a text field, text area, password, select list, check box, and so on. In this exercise, you will create a File Browse item. When you create a File Browse item, files you upload are stored in a table named <code>wwv_flow_file_objects$</code>.</p>
<p>To create a file upload item:</p>
<ol>
<li>
<p>Under Items on the Page Definition for page 1, click the <span class="bold">Create</span> icon.</p>
</li>
<li>
<p>For Item Type, select <span class="bold">File Browse</span> and then click <span class="bold">Next</span>.</p>
</li>
<li>
<p>For Display Position and Name:</p>
<ol>
<li>
<p>Item Name - Enter <code>P1_FILE_NAME</code>.</p>
</li>
<li>
<p>For Sequence, accept the default.</p>
</li>
<li>
<p>For Region, select <span class="bold">Submit File</span>.</p>
</li>
<li>
<p>Click <span class="bold">Next</span>.</p>
</li>
</ol>
</li>
<li>
<p>Accept the remaining defaults and click <span class="bold">Next</span>.</p>
</li>
<li>
<p>Click <span class="bold">Create Item</span>.</p>
<p>The Page Definition appears.</p>
</li>
</ol>
</div>
<!-- class="sect2" -->
<a id="CJAFCIEH"></a>
<div class="sect2"><!-- infolevel="all" infotype="General" -->
<h3 class="sect2">Create a Button</h3>
<p>Next, you need to create a button to submit the file.</p>
<p>To create a button:</p>
<ol>
<li>
<p>Under Buttons, click the <span class="bold">Create</span> icon.</p>
</li>
<li>
<p>For Button Region, select <span class="bold">Submit File (1) 1</span> and click <span class="bold">Next</span>.</p>
</li>
<li>
<p>For Button Position, select <span class="bold">Create a button in a region position</span> and then click <span class="bold">Next</span>.</p>
</li>
<li>
<p>On Button Attributes:</p>
<ol>
<li>
<p>Button Name - Enter <code>Submit</code>.</p>
</li>
<li>
<p>Accept the remaining defaults.</p>
</li>
<li>
<p>Click <span class="bold">Next</span>.</p>
</li>
</ol>
</li>
<li>
<p>For Button Template, accept the default and click <span class="bold">Next</span>.</p>
</li>
<li>
<p>For Display Properties, accept the defaults and click <span class="bold">Next</span>.</p>
</li>
<li>
<p>For Branching:</p>
<ol>
<li>
<p>Branch to Page - Select <span class="bold">Page 1</span>.</p>
<p>This selection causes the page to call itself on submit rather than navigate to another page.</p>
</li>
<li>
<p>Click <span class="bold">Create Button</span>.</p>
</li>
</ol>
</li>
<li>
<p>Run the page by clicking the <span class="bold">Run Page</span> icon as shown in <a href="#BABEAJED">Figure 9-2</a>.</p>
<div class="figure">
<p class="titleinfigure"><a id="BABEAJED"></a>Figure 9-2 Run Page Icon</p>
<img width="14" height="20" src="img/run_ico_green.gif" alt="Description of Figure 9-2 follows" title="Description of Figure 9-2 follows" /><br />
<a id="sthref112" href="img_text/run_ico_green.htm">Description of "Figure 9-2 Run Page Icon"</a><br />
<br /></div>
<!-- class="figure" --></li>
<li>
<p>If prompted to enter a user name and password, enter your workspace user name and password and click <span class="bold">Login</span>. See <a href="about.htm#BABFCHBC">"About Application Authentication"</a>.</p>
</li>
</ol>
<p>When you run the page, it should look similar to <a href="#CHDEHCJC">Figure 9-3</a>.</p>
<div class="figure">
<p class="titleinfigure"><a id="CHDEHCJC"></a>Figure 9-3 Submit File Form</p>
<img width="331" height="94" src="img/dn_app_1.gif" alt="Description of Figure 9-3 follows" title="Description of Figure 9-3 follows" /><br />
<a id="sthref113" href="img_text/dn_app_1.htm">Description of "Figure 9-3 Submit File Form"</a><br />
<br /></div>
<!-- class="figure" --></div>
<!-- class="sect2" --></div>
<!-- class="sect1" -->
<a id="CIHBFCDH"></a>
<div class="sect1">
<h2 class="sect1">Creating a Report with Download Links</h2>
<p>Once you create the form to upload documents, the next step is to create a report on the document table that contains links to the uploaded documents. When you use a File Browse item, the files you upload are stored in a table called <code>wwv_flow_file_objects$</code>. Every workspace has access to this table through a view called <code>APEX_APPLICATION_FILES</code>.</p>
<p>Topics in this section include:</p>
<ul>
<li>
<p><a href="#CJADGCJD">Create a Report on APEX_APPLICATION_FILES</a></p>
</li>
<li>
<p><a href="#CJAJCABC">Add Link to Download Documents</a></p>
</li>
</ul>
<a id="CJADGCJD"></a>
<div class="sect2"><!-- infolevel="all" infotype="General" -->
<h3 class="sect2">Create a Report on APEX_APPLICATION_FILES</h3>
<p>To create a report on <code>APEX_APPLICATION_FILES</code>:</p>
<ol>
<li>
<p>Click <span class="bold">Edit Page 1</span> on the Developer toolbar at the bottom of the page.</p>
<p>The Page Definition appears.</p>
</li>
<li>
<p>Under Regions, click the <span class="bold">Create</span> icon.</p>
</li>
<li>
<p>For Region, select <span class="bold">Report</span> and then click <span class="bold">Next</span>.</p>
</li>
<li>
<p>For Report Implementation, select <span class="bold">SQL Report</span> and then click <span class="bold">Next</span>.</p>
</li>
<li>
<p>For Display Attributes:</p>
<ol>
<li>
<p>Title - Enter <code>Uploaded Files</code>.</p>
</li>
<li>
<p>Accept the remaining defaults and click <span class="bold">Next</span>.</p>
</li>
</ol>
</li>
<li>
<p>For Source, enter the following SQL query:</p>
<pre>
SELECT id,name FROM APEX_APPLICATION_FILES
</pre></li>
<li>
<p>Click <span class="bold">Create Region</span>.</p>
</li>
<li>
<p>Run the page.</p>
</li>
</ol>
<p>Your report should resemble <a href="#CHDHIICE">Figure 9-4</a>. Note that your display may differ slightly depending on what files you have uploaded.</p>
<div class="figure">
<p class="titleinfigure"><a id="CHDHIICE"></a>Figure 9-4 Uploaded Files Report</p>
<img width="459" height="380" src="img/dn_app_1b.gif" alt="Description of Figure 9-4 follows" title="Description of Figure 9-4 follows" /><br />
<a id="sthref114" href="img_text/dn_app_1b.htm">Description of "Figure 9-4 Uploaded Files Report"</a><br />
<br /></div>
<!-- class="figure" --></div>
<!-- class="sect2" -->
<a id="CJAJCABC"></a>
<div class="sect2"><!-- infolevel="all" infotype="General" -->
<h3 class="sect2">Add Link to Download Documents</h3>
<p>Next, you need to provide a link to download each document.</p>
<p>To provide a link to download the documents in the report:</p>
<ol>
<li>
<p>Click <span class="bold">Edit Page 1</span> on the Developer toolbar.</p>
</li>
<li>
<p>Under Regions, click <span class="bold">Report</span> next to Uploaded Files as shown in <a href="#BABICJGG">Figure 9-5</a>.</p>
<div class="figure">
<p class="titleinfigure"><a id="BABICJGG"></a>Figure 9-5 Report Link</p>
<img width="413" height="143" src="img/dn_app_rpt_link.gif" alt="Description of Figure 9-5 follows" title="Description of Figure 9-5 follows" /><br />
<a id="sthref115" href="img_text/dn_app_rpt_link.htm">Description of "Figure 9-5 Report Link"</a><br />
<br /></div>
<!-- class="figure" -->
<p>The Report Attributes page appears. You can add a link to the ID column by editing Column Attributes.</p>
</li>
<li>
<p>Under Column Attributes, click the <span class="bold">Edit</span> icon in the ID row.</p>
</li>
<li>
<p>Scroll down to Column Link.</p>
</li>
<li>
<p>Under Column Link:</p>
<ol>
<li>
<p>Link Text - Select <code>#ID#</code>.</p>
</li>
<li>
<p>Target - Select URL.</p>
</li>
<li>
<p>In the URL field, enter the following:</p>
<pre>
p?n=#ID#
</pre>
<p><code>#ID#</code> parses the value contained in the column where <code>ID</code> is the column alias.</p>
</li>
</ol>
</li>
<li>
<p>At the top of the page, click <span class="bold">Apply Changes</span>.</p>
</li>
<li>
<p>Run the page.</p>
<p>When you run the page, it should look similar to <a href="#CHDHFDGD">Figure 9-6</a>.</p>
<div class="figure">
<p class="titleinfigure"><a id="CHDHFDGD"></a>Figure 9-6 Uploaded Files Report with Download Links</p>
<img width="530" height="397" src="img/dn_app_2.gif" alt="Description of Figure 9-6 follows" title="Description of Figure 9-6 follows" /><br />
<a id="sthref116" href="img_text/dn_app_2.htm">Description of "Figure 9-6 Uploaded Files Report with Download Links"</a><br />
<br /></div>
<!-- class="figure" --></li>
<li>
<p>To test the links, click an ID.</p>
<p>A File Download dialog box appears.</p>
</li>
<li>
<p>Click <span class="bold">Edit Page 1</span> on the Developer toolbar to return to the Page Definition.</p>
</li>
</ol>
</div>
<!-- class="sect2" --></div>
<!-- class="sect1" -->
<a id="CIHBEAAD"></a>
<div class="sect1">
<h2 class="sect1">Storing Additional Attributes About the Document</h2>
<p>Next, you create another table to store additional information about the documents that are uploaded. In this exercise, you:</p>
<ul>
<li>
<p>Add an item to the upload form to capture the information</p>
</li>
<li>
<p>Add a process to insert this information along with the name of the file</p>
</li>
<li>
<p>Alter the SQL Report of uploaded files to join to the table containing the additional information</p>
</li>
</ul>
<p>Topics in this section include:</p>
<ul>
<li>
<p><a href="#CJAJJEGE">Create a Table to Store Document Attributes</a></p>
</li>
<li>
<p><a href="#CJABEDEH">Create an Item to Capture the Document Subject</a></p>
</li>
<li>
<p><a href="#CJAFHBBC">Create a Process to Insert Information</a></p>
</li>
<li>
<p><a href="#CJAGBBIF">Show Additional Attributes in the Report Region</a></p>
</li>
</ul>
<a id="CJAJJEGE"></a>
<div class="sect2"><!-- infolevel="all" infotype="General" -->
<h3 class="sect2">Create a Table to Store Document Attributes</h3>
<p>First, you create a table in SQL Commands.</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
"Using SQL Commands" in <span class="italic"><a class="olink HTMDB19000" href="http://www.oracle.com/pls/topic/lookup?ctx=db112&amp;id=HTMDB19000">Oracle Database Application Express User's Guide</a></span></div>
<p>To create the table to store additional information about uploaded files:</p>
<ol>
<li>
<p>Go to SQL Commands:</p>
<ol>
<li>
<p>Click the <span class="bold">Home</span> breadcrumb link at the top of the page as shown in <a href="#BABFABAD">Figure 9-7</a>.</p>
<div class="figure">
<p class="titleinfigure"><a id="BABFABAD"></a>Figure 9-7 Breadcrumb Menu</p>
<img width="327" height="27" src="img/dn_app_bread.gif" alt="Description of Figure 9-7 follows" title="Description of Figure 9-7 follows" /><br />
<a id="sthref117" href="img_text/dn_app_bread.htm">Description of "Figure 9-7 Breadcrumb Menu"</a><br />
<br /></div>
<!-- class="figure" -->
<p>The Workspace home page appears.</p>
</li>
<li>
<p>On the Workspace home page, click <span class="bold">SQL Workshop</span> and then <span class="bold">SQL Commands</span>.</p>
<p>The SQL Commands page appears.</p>
</li>
</ol>
</li>
<li>
<p>In the top section, enter:</p>
<pre>
CREATE TABLE oehr_file_subject 
   (name     VARCHAR2(4000) primary key, 
    subject  VARCHAR2(4000));
</pre></li>
<li>
<p>Click <span class="bold">Run</span>.</p>
<p>The message <code>Table created</code> appears in the Results section.</p>
</li>
<li>
<p>Click the <span class="bold">Home</span> breadcrumb link.</p>
<p>The Workspace home page appears.</p>
</li>
</ol>
</div>
<!-- class="sect2" -->
<a id="CJABEDEH"></a>
<div class="sect2"><!-- infolevel="all" infotype="General" -->
<h3 class="sect2">Create an Item to Capture the Document Subject</h3>
<p>To create an item to capture the subject of the document:</p>
<ol>
<li>
<p>Go to the Page Definition for page 1:</p>
<ol>
<li>
<p>On the Workspace home page, click the <span class="bold">Application Builder</span> icon.</p>
</li>
<li>
<p>On the Application Builder home page, click <span class="bold">Download App</span>.</p>
</li>
<li>
<p>On the Application home page, click the <span class="bold">Page 1</span> icon.</p>
</li>
</ol>
<p>The Page Definition for Page 1 appears.</p>
</li>
<li>
<p>Under Items, click the <span class="bold">Create</span> icon.</p>
</li>
<li>
<p>For Item Type, select <span class="bold">Text</span> and click <span class="bold">Next</span>.</p>
</li>
<li>
<p>For Text Control Display Type, select <span class="bold">Text Field</span> and click <span class="bold">Next</span>.</p>
</li>
<li>
<p>For Display Position and Name:</p>
<ol>
<li>
<p>For Item Name - Enter <code>P1_SUBJECT</code>.</p>
</li>
<li>
<p>Sequence - Accept the default.</p>
</li>
<li>
<p>Region - Select <span class="bold">Uploaded Files</span>.</p>
</li>
<li>
<p>Click <span class="bold">Next</span>.</p>
</li>
</ol>
</li>
<li>
<p>For Item Attributes:</p>
<ol>
<li>
<p>Label field - Enter <code>Subject</code>.</p>
</li>
<li>
<p>Accept the remaining defaults.</p>
</li>
<li>
<p>Click <span class="bold">Next</span>.</p>
</li>
</ol>
</li>
<li>
<p>Click <span class="bold">Create Item</span>.</p>
</li>
</ol>
</div>
<!-- class="sect2" -->
<a id="CJAFHBBC"></a>
<div class="sect2"><!-- infolevel="all" infotype="General" -->
<h3 class="sect2">Create a Process to Insert Information</h3>
<p>Next, you need to create a process to insert the subject information into the new table.</p>
<p>To create a process:</p>
<ol>
<li>
<p>Under Page Processing, Processes, click the <span class="bold">Create</span> icon.</p>
</li>
<li>
<p>For Process Type, select <span class="bold">PL/SQL</span> and then click <span class="bold">Next</span>.</p>
</li>
<li>
<p>For Process Attributes:</p>
<ol>
<li>
<p>Name - Enter <code>Insert file description</code>.</p>
</li>
<li>
<p>Sequence- Accept the default.</p>
</li>
<li>
<p>From Point - Select <span class="bold">On Submit - After Computations and Validations</span>.</p>
</li>
<li>
<p>Click <span class="bold">Next</span>.</p>
</li>
</ol>
</li>
<li>
<p>In Enter PL/SQL Page Process, enter the following:</p>
<pre>
INSERT INTO oehr_file_subject(name, subject) VALUES(:P1_FILE_NAME,:P1_SUBJECT);
</pre></li>
<li>
<p>Click <span class="bold">Next</span>.</p>
</li>
<li>
<p>For Messages:</p>
<ol>
<li>
<p>Success Message - Enter:</p>
<pre>
Subject inserted
</pre></li>
<li>
<p>Failure Message - Enter:</p>
<pre>
Error inserting subject
</pre></li>
<li>
<p>Click <span class="bold">Next</span>.</p>
</li>
</ol>
</li>
<li>
<p>For Process Conditions:</p>
<ol>
<li>
<p>When Button Pressed - Select <span class="bold">SUBMIT</span>.</p>
</li>
<li>
<p>Accept the remaining defaults and click <span class="bold">Create Process</span>.</p>
</li>
</ol>
</li>
</ol>
</div>
<!-- class="sect2" -->
<a id="CJAGBBIF"></a>
<div class="sect2"><!-- infolevel="all" infotype="General" -->
<h3 class="sect2">Show Additional Attributes in the Report Region</h3>
<p>Finally, you need to alter the SQL Report region to join it to the additional attributes table. To accomplish this, you edit the Region Source attribute on the Region Definition page.</p>
<p>To edit the Region Source:</p>
<ol>
<li>
<p>Under Regions, click <span class="bold">Uploaded Files</span>.</p>
<p>The Region Definition appears.</p>
</li>
<li>
<p>Scroll down to Source.</p>
</li>
<li>
<p>Replace the Region Source with the following:</p>
<pre>
SELECT w.id,w.name,s.subject  
FROM APEX_APPLICATION_FILES w,oehr_file_subject s
WHERE w.name = s.name
</pre></li>
<li>
<p>Click <span class="bold">Apply Changes</span>.</p>
</li>
<li>
<p>Run the page.</p>
</li>
<li>
<p>Click <span class="bold">Browse</span>, locate a file to upload, and click <span class="bold">Submit</span>.</p>
<p>As shown in <a href="#CHDIEIFD">Figure 9-8</a>, the Uploaded Files report now contains a Subject column.</p>
<div class="figure">
<p class="titleinfigure"><a id="CHDIEIFD"></a>Figure 9-8 Uploaded Files Report with Subject Column</p>
<img width="532" height="283" src="img/dn_sub_col.gif" alt="Description of Figure 9-8 follows" title="Description of Figure 9-8 follows" /><br />
<a id="sthref118" href="img_text/dn_sub_col.htm">Description of "Figure 9-8 Uploaded Files Report with Subject Column"</a><br />
<br /></div>
<!-- class="figure" --></li>
<li>
<p>Click <span class="bold">Edit Page 1</span> on the Developer toolbar to return to the Page Definition.</p>
</li>
</ol>
</div>
<!-- class="sect2" --></div>
<!-- class="sect1" -->
<a id="CIHHEHCJ"></a>
<div class="sect1">
<h2 class="sect1">Storing the Document in a Custom Table</h2>
<p>In certain cases, you may want to store uploaded documents in a table owned by your schema. For example, if you want to create an Oracle Text index on uploaded documents, you need to store the documents in a custom table.</p>
<p>To store documents in your custom table:</p>
<ul>
<li>
<p>Add a column of type <code>BLOB</code> to hold the document</p>
</li>
<li>
<p>Alter the process to insert documents into the custom table</p>
</li>
</ul>
<p>To add a BLOB column to the <code>oehr_file_subject</code> table:</p>
<ol>
<li>
<p>Go to SQL Commands:</p>
<ol>
<li>
<p>Click the <span class="bold">Home</span> breadcrumb link at the top of the page.</p>
<p>The Workspace home page appears.</p>
</li>
<li>
<p>On the Workspace home page, click <span class="bold">SQL Workshop</span> and then <span class="bold">SQL Commands</span>.</p>
<p>The SQL Commands page appears.</p>
</li>
</ol>
</li>
<li>
<p>In the top section, enter the following SQL statement:</p>
<pre>
ALTER TABLE oehr_file_subject ADD(id number,blob_content BLOB,mime_type varchar2(4000) );
</pre></li>
<li>
<p>Click <span class="bold">Run</span>.</p>
<p>The message <code>Table Altered</code> appears.</p>
</li>
<li>
<p>Click the <span class="bold">Home</span> breadcrumb link at the top of the page.</p>
</li>
</ol>
<p>To alter the process to insert documents into the <code>oehr_file_subject</code> table:</p>
<ol>
<li>
<p>On the Workspace home page, click <span class="bold">Application Builde</span>r.</p>
</li>
<li>
<p>Click <span class="bold">Download App</span>.</p>
</li>
<li>
<p>Click <span class="bold">Page 1</span>.</p>
</li>
<li>
<p>Under Processes, click the <span class="bold">Insert file description</span> link.</p>
</li>
<li>
<p>Scroll down to Source.</p>
</li>
<li>
<p>Under Source, replace the process with the following:</p>
<pre>
  IF ( :P1_FILE_NAME is not null ) THEN 
     INSERT INTO oehr_file_subject(id,NAME, SUBJECT, BLOB_CONTENT, MIME_TYPE) 
      SELECT ID,:P1_FILE_NAME,:P1_SUBJECT,blob_content,mime_type
            FROM APEX_APPLICATION_FILES
            WHERE name = :P1_FILE_NAME;
   DELETE from APEX_APPLICATION_FILES WHERE name = :P1_FILE_NAME;
  END IF;
</pre></li>
<li>
<p>Click <span class="bold">Apply Changes</span>.</p>
</li>
</ol>
</div>
<!-- class="sect1" -->
<a id="CIHDDJGF"></a>
<div class="sect1">
<h2 class="sect1">Downloading Documents from the Custom Table</h2>
<p>Now that documents are being stored in a custom table, you need to provide a way to download them. You do this by creating a procedure and granting execute on that procedure to the pseudo user <code>APEX_PUBLIC_USER</code>.</p>
<p>To accomplish this you need to change:</p>
<ul>
<li>
<p>The SQL report region to no longer join to the <code>APEX_APPLICATION_FILES</code> view</p>
</li>
<li>
<p>The URL supplied for the ID column in the SQL report to execute the new procedure instead of executing the previous procedure</p>
</li>
</ul>
<p>Topics in this section include:</p>
<ul>
<li>
<p><a href="#CHDCGIEF">Create a Procedure to Download Documents</a></p>
</li>
<li>
<p><a href="#CHDDHBEF">Edit the Uploaded Files Region</a></p>
</li>
<li>
<p><a href="#CHDECDAJ">Change the Download Link to Use the New Procedure</a></p>
</li>
</ul>
<a id="CHDCGIEF"></a>
<div class="sect2"><!-- infolevel="all" infotype="General" -->
<h3 class="sect2">Create a Procedure to Download Documents</h3>
<p>To create a procedure to download documents from the <code>oehr_file_subject</code> table and grant execute to public:</p>
<ol>
<li>
<p>Go to SQL Commands:</p>
<ol>
<li>
<p>Click the <span class="bold">Home</span> breadcrumb link at the top of the page.</p>
<p>The Workspace home page appears.</p>
</li>
<li>
<p>On the Workspace home page, click <span class="bold">SQL Workshop</span> and then <span class="bold">SQL Commands</span>.</p>
<p>The SQL Commands page appears.</p>
</li>
</ol>
</li>
<li>
<p>Enter the following SQL statement:</p>
<pre>
CREATE OR REPLACE PROCEDURE download_my_file(p_file in number) AS
        v_mime  VARCHAR2(48);
        v_length  NUMBER;
        v_file_name VARCHAR2(2000);
        Lob_loc  BLOB;
BEGIN
        SELECT MIME_TYPE, BLOB_CONTENT, name,DBMS_LOB.GETLENGTH(blob_content)
                INTO v_mime,lob_loc,v_file_name,v_length
                FROM oehr_file_subject
                WHERE id = p_file;
              --
              -- set up HTTP header
              --
                    -- use an NVL around the mime type and 
                    -- if it is a null set it to application/octect
                    -- application/octect may launch a download window from windows
                    owa_util.mime_header( nvl(v_mime,'application/octet'), FALSE );
 
                -- set the size so the browser knows how much to download
                htp.p('Content-length: ' || v_length);
                -- the filename will be used by the browser if the users does a save as
                htp.p('Content-Disposition:  attachment; filename="'||replace(replace(substr(v_file_name,instr(v_file_name,'/')+1),chr(10),null),chr(13),null)|| '"');
                -- close the headers            
                owa_util.http_header_close;
                -- download the BLOB
                wpg_docload.download_file( Lob_loc );
end download_my_file;
/
</pre></li>
<li>
<p>Click <span class="bold">Run</span>.</p>
<p>The message <code>Procedure Created</code> appears.</p>
<p>Next, you want to run another SQL statement.</p>
</li>
<li>
<p>Click the <span class="bold">SQL Workshop</span> breadcrumb link and then click <span class="bold">SQL Commands</span>.</p>
<p>The SQL Commands page appears.</p>
</li>
<li>
<p>In the top section, replace the existing SQL statement with the following:</p>
<pre>
GRANT EXECUTE ON download_my_file TO PUBLIC/
</pre></li>
<li>
<p>Click <span class="bold">Run</span>.</p>
<p>The message <code>Statement processed</code> appears.</p>
</li>
<li>
<p>Click the <span class="bold">Home</span> breadcrumb link at the top of the page to return to the Workspace home page.</p>
</li>
</ol>
</div>
<!-- class="sect2" -->
<a id="CHDDHBEF"></a>
<div class="sect2"><!-- infolevel="all" infotype="General" -->
<h3 class="sect2">Edit the Uploaded Files Region</h3>
<p>To change the SQL report region to no longer join with the <code>APEX_APPLICATION_FILES</code> view:</p>
<ol>
<li>
<p>Go to the Page Definition of page 1:</p>
<ol>
<li>
<p>On the Workspace home page, click <span class="bold">Application Builder</span>.</p>
</li>
<li>
<p>On the Application Builder home page, click <span class="bold">Download App</span>.</p>
</li>
<li>
<p>On the Application home page, click <span class="bold">Page 1</span>.</p>
</li>
</ol>
</li>
<li>
<p>Under Regions, click <span class="bold">Uploaded Files</span>.</p>
</li>
<li>
<p>Scroll down to Source.</p>
</li>
<li>
<p>Replace the Region Source with the following:</p>
<pre>
SELECT s.id,s.name,s.subject FROM oehr_file_subject s
</pre></li>
<li>
<p>Click <span class="bold">Apply Changes</span>.</p>
<p>The Page Definition appears.</p>
</li>
</ol>
</div>
<!-- class="sect2" -->
<a id="CHDECDAJ"></a>
<div class="sect2"><!-- infolevel="all" infotype="General" -->
<h3 class="sect2">Change the Download Link to Use the New Procedure</h3>
<p>Next you need to change the download link to call the PL/SQL download_my_file procedure.</p>
<div class="infobox-note">
<p class="notep1">Note:</p>
If you are using Application Express in Database 11g, instead of calling the PL/SQL procedure as described in this section, please follow the steps outlined in the following section <a href="#CJACBEHG">Create Download Page for Embedded PL/SQL Gateway</a>.</div>
<p>To change the download link to use the new download procedure:</p>
<ol>
<li>
<p>Under Regions, click <span class="bold">Report</span> next to Uploaded Files.</p>
</li>
<li>
<p>In the ID row, click the <span class="bold">Edit</span> icon.</p>
</li>
<li>
<p>Scroll down to the Column Link section.</p>
</li>
<li>
<p>In the URL field, replace the existing URL with the following:</p>
<pre>
#OWNER#.download_my_file?p_file=#ID#
</pre>
<p>In this URL:</p>
<ul>
<li>
<p><code>#OWNER#</code> is the parsing schema of the current application.</p>
</li>
<li>
<p><code>download_my_file</code> is the new procedure you just created.</p>
</li>
<li>
<p>You are passing in the value of the column ID to the parameter <code>p_file</code>.</p>
</li>
</ul>
</li>
<li>
<p>Click <span class="bold">Apply Changes</span>.</p>
<p>The Page Definition appears.</p>
</li>
</ol>
</div>
<!-- class="sect2" -->
<a id="CJACBEHG"></a>
<div class="sect2"><!-- infolevel="all" infotype="General" -->
<h3 class="sect2">Create Download Page for Embedded PL/SQL Gateway</h3>
<p>The Oracle XML DB HTTP Server with the embedded PL/SQL Gateway is typically used for Application Express in Oracle Database 11g. Calling a PL/SQL procedure directly from a URL that is not known in a list of allowed procedures, as shown in <a href="#CHDECDAJ">Change the Download Link to Use the New Procedure</a>, results in an error message.</p>
<p>To avoid this situation, there are a couple of available options. The first option is to modify the PL/SQL function <code>WWV_FLOW_EPG_INCLUDE_MOD_LOCAL</code> to include the PL/SQL <code>download_my_file</code> procedure and then recompile. The second, described below, is to create a page in the application that has a before header branch to the PL/SQL <code>download_my_file</code> procedure. You then create a hidden item on that page for the document ID of the document to be downloaded.</p>
<p>To accomplish the second option you need to:</p>
<ul>
<li>
<p>Create a page with a before header branch to the PL/SQL procedure download_my_file</p>
</li>
<li>
<p>Change the download link to use the new page to display the file</p>
</li>
</ul>
<p>To create a page with a before header branch to the PL/SQL procedure download_my_file:</p>
<ol>
<li>
<p>On the Application Home page, click <span class="bold">Create Page</span>.</p>
</li>
<li>
<p>Select <span class="bold">Blank Page</span> and click <span class="bold">Next</span>.</p>
</li>
<li>
<p>For Page Number, enter 2 and click <span class="bold">Next</span>.</p>
</li>
<li>
<p>For Name, enter Download File and click <span class="bold">Next</span>.</p>
</li>
<li>
<p>For Tabs, select <span class="bold">No</span> and click <span class="bold">Next</span>.</p>
</li>
<li>
<p>Click <span class="bold">Finish</span>.</p>
<p>The Success page appears.</p>
</li>
<li>
<p>Click <span class="bold">Edit Page</span> icon.</p>
<p>The Page Definition for page 2 appears.</p>
</li>
<li>
<p>Under Regions, click the <span class="bold">Create</span> icon.</p>
</li>
<li>
<p>For Region:</p>
<ol>
<li>
<p>Identify the type of region to add to this page - Accept the default, <span class="bold">HTML</span>, and click <span class="bold">Next</span>.</p>
</li>
<li>
<p>Select the type of HTML region container you wish to create - Accept the default, <span class="bold">HTML</span>, and click <span class="bold">Next</span>.</p>
</li>
</ol>
</li>
<li>
<p>For Display Attributes, specify the following:</p>
<ol>
<li>
<p>For Title - Enter <code>Display Document</code>.</p>
</li>
<li>
<p>Accept the remaining default values.</p>
</li>
<li>
<p>Click <span class="bold">Next</span>.</p>
</li>
</ol>
</li>
<li>
<p>Click <span class="bold">Create Region</span>.</p>
<p>The Page Definition for page 2 appears. A confirmation message displays at the top of the page: Region created.</p>
</li>
<li>
<p>Under Items on the Page Definition for page 2, click <span class="bold">Create</span> icon.</p>
</li>
<li>
<p>For Item Type, select <span class="bold">Hidden</span> and then click <span class="bold">Next</span>.</p>
</li>
<li>
<p>For Hidden Item Type, select <span class="bold">Hidden and Protected</span> and then click <span class="bold">Next</span>.</p>
</li>
<li>
<p>For Item Name, enter <span class="bold">P2_DOC_ID</span> and then click <span class="bold">Next</span>.</p>
</li>
<li>
<p>For Source, accept all defaults and then click <span class="bold">Create Item</span>.</p>
<p>The Page Definition for Page 2 appears.</p>
</li>
<li>
<p>Under Branches, click the <span class="bold">Create</span> icon.</p>
</li>
<li>
<p>For the Branch Point list, select <span class="bold">On Load: Before Header</span>.</p>
</li>
<li>
<p>For the Branch Type, select <span class="bold">Branch to PL/SQL Procedure</span> and then click <span class="bold">Next</span>.</p>
</li>
<li>
<p>For the Identify PL/SQL procedure to call text box, enter <code>download_my_file(:P2_DOC_ID)</code>.</p>
</li>
<li>
<p>For Branch Conditions, accept defaults and click <span class="bold">Create Branch</span>.</p>
<p>The Page Definition for page 2 appears.</p>
</li>
</ol>
<p>Change the download link to display to the Download Display page:</p>
<ol>
<li>
<p>Click the Page 1 icon.</p>
<p>The Page Definition for page 1 appears.</p>
</li>
<li>
<p>Under Regions, click <span class="bold">Report</span> next to Uploaded Files.</p>
<p>The Report Attributes page appears.</p>
</li>
<li>
<p>Under Column Attributes, click the <span class="bold">Edit</span> icon in the ID row.</p>
</li>
<li>
<p>Scroll down to Column Link</p>
</li>
<li>
<p>Under Column Link:</p>
<ol>
<li>
<p>Target - select <span class="bold">Page in this Application</span></p>
</li>
<li>
<p>Page - enter <span class="bold">2</span></p>
</li>
<li>
<p>Item 1 Name - <code>P2_DOC_ID</code></p>
</li>
<li>
<p>Item 1 Value - <code>#ID#</code></p>
</li>
</ol>
</li>
<li>
<p>Click <span class="bold">Apply Changes</span>.</p>
</li>
<li>
<p>Run the application.</p>
</li>
</ol>
</div>
<!-- class="sect2" --></div>
<!-- class="sect1" -->
<a id="CHDCFCIG"></a>
<div class="sect1"><!-- infolevel="all" infotype="General" -->
<h2 class="sect1">Security Issues to Consider</h2>
<p>The application you built in this tutorial provides download links that invoke the procedure <code>download_my_file</code>. Note that this approach has security implications that you need to be aware of.</p>
<p>To invoke your procedure, a user can click the links you provide, or a user can enter similar URLs in the Web browser's Address (or Location) field. Be aware that a curious or malicious user could experiment with your <code>download_my_file</code> procedure, passing in any file ID as the <code>p_file</code> argument. A hacker could determine what file IDs exist in your table by legitimate or illicit means. Worse yet, in a mechanized attack, a hacker could submit successive IDs until an ID matches a file in your table at which time your procedure would download the file to the hacker.</p>
<p>The measures you take to protect your data from unauthorized access depend upon:</p>
<ul>
<li>
<p>Your assessment of the degree of harm that would result if a hacker were able to download a file.</p>
</li>
<li>
<p>The likelihood of such an attack balanced against the cost and difficulty of providing controls.</p>
</li>
</ul>
<p>One technique you can use to protect an application is to call one of the Oracle Application Express security APIs from within the procedure in order to ensure that the user has already been authenticated. For example, you could include a block of code into the procedure so that it runs first. Consider the following example:</p>
<pre>
-- Assuming your application's numeric ID is 100, set g_flow_id to
--     that value, otherwise change the value as required. 
--
APEX_APPLICATION.G_FLOW_ID := 100;

IF NOT wwv_flow_custom_auth_std.is_session_valid then
    -- 
    -- 
    -- display this message or a custom message. 
    -- 
htp.p('Unauthorized access - file will not be retrieved.'); 
    -- 
    -- You can do whatever else you need to here to log the
    --     unauthorized access attempt, get the requestor's
    --     IP address, send email, etc. 
    -- 
    RETURN;
END IF;
</pre></div>
<!-- class="sect1" --></div>
<!-- class="ind" -->
<!-- Start Footer -->
</div>
<!-- add extra wrapper close div-->
<footer><!--
<hr />
<table class="cellalignment883">
<tr>
<td class="cellalignment890">
<table class="cellalignment893">
<tr>
<td class="cellalignment887"><a href="bar_chart.htm"><img width="24" height="24" src="../../dcommon/gifs/leftnav.gif" alt="Go to previous page" /><br />
<span class="icon">Previous</span></a></td>
<td class="cellalignment887"><a href="javascript.htm"><img width="24" height="24" src="../../dcommon/gifs/rightnav.gif" alt="Go to next page" /><br />
<span class="icon">Next</span></a></td>
</tr>
</table>
</td>
<td class="cellalignment-copyrightlogo"><img width="144" height="18" src="../../dcommon/gifs/oracle.gif" alt="Oracle" /><br />
Copyright&nbsp;&copy;&nbsp;2003, 2012,&nbsp;Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved.<br />
<a href="../../dcommon/html/cpyr.htm">Legal Notices</a></td>
<td class="cellalignment892">
<table class="cellalignment886">
<tr>
<td class="cellalignment887"><a href="../../index.htm"><img width="24" height="24" src="../../dcommon/gifs/doclib.gif" alt="Go to Documentation Home" /><br />
<span class="icon">Home</span></a></td>
<td class="cellalignment887"><a href="../../nav/portal_booklist.htm"><img width="24" height="24" src="../../dcommon/gifs/booklist.gif" alt="Go to Book List" /><br />
<span class="icon">Book List</span></a></td>
<td class="cellalignment887"><a href="toc.htm"><img width="24" height="24" src="../../dcommon/gifs/toc.gif" alt="Go to Table of Contents" /><br />
<span class="icon">Contents</span></a></td>
<td class="cellalignment887"><a href="../../nav/mindx.htm"><img width="24" height="24" src="../../dcommon/gifs/masterix.gif" alt="Go to Master Index" /><br />
<span class="icon">Master Index</span></a></td>
<td class="cellalignment887"><a href="../../dcommon/html/feedback.htm"><img width="24" height="24" src="../../dcommon/gifs/feedbck2.gif" alt="Go to Feedback page" /><br />
<span class="icon">Contact Us</span></a></td>
</tr>
</table>
</td>
</tr>
</table>
--></footer>
<noscript>
<p>Scripting on this page enhances content navigation, but does not change the content in any way.</p>
</noscript>
</body>
</html>
