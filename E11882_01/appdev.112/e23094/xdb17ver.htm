<!DOCTYPE html>
<html lang="en" >
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta charset="utf-8">
<title>Managing Resource Versions</title>
<meta name="generator" content="Oracle DARB XHTML Converter (Mode = document) - Version 5.1.2 Build 748" />
<meta name="description" content="This manual describes Oracle XML&nbsp;DB. It includes guidelines and examples for storing, generating, accessing, searching, validating, transforming, evolving, and indexing XML data in Oracle Database." />
<meta name="dcterms.created" content="2014-02-20T9:56:16Z" />
<meta name="robots" content="all" />
<meta name="dcterms.title" content="XML DB Developer's Guide" />
<meta name="dcterms.identifier" content="E23094-04" />
<meta name="dcterms.isVersionOf" content="ADXDB" />
<meta name="dcterms.rights" content="Copyright&nbsp;&copy;&nbsp;2002, 2014,&nbsp;Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved." />
<link rel="Start" href="../../index.htm" title="Home" type="text/html" />
<link rel="Copyright" href="../../dcommon/html/cpyr.htm" title="Copyright" type="text/html" />

<script type="application/javascript"  src="../../dcommon/js/headfoot.js"></script>
<script type="application/javascript"  src="../../nav/js/doccd.js"></script>
<link rel="Contents" href="toc.htm" title="Contents" type="text/html" />
<link rel="Index" href="index.htm" title="Index" type="text/html" />
<link rel="Prev" href="xdb_xlink.htm" title="Previous" type="text/html" />
<link rel="Next" href="xdb18res.htm" title="Next" type="text/html" />
<link rel="alternate" href="../e23094.pdf" title="PDF version" type="application/pdf" />
<link rel="schema.dcterms" href="http://purl.org/dc/terms/" />
<link rel="stylesheet" href="../../dcommon/css/fusiondoc.css">
<link rel="stylesheet" type="text/css"  href="../../dcommon/css/header.css">
<link rel="stylesheet" type="text/css"  href="../../dcommon/css/footer.css">
<link rel="stylesheet" type="text/css"  href="../../dcommon/css/fonts.css">
<link rel="stylesheet" href="../../dcommon/css/foundation.css">
<link rel="stylesheet" href="../../dcommon/css/codemirror.css">
<link rel="stylesheet" type="text/css" title="Default" href="../../nav/css/html5.css">
<link rel="stylesheet" href="../../dcommon/css/respond-480-tablet.css">
<link rel="stylesheet" href="../../dcommon/css/respond-768-laptop.css">
<link rel="stylesheet" href="../../dcommon/css/respond-1140-deskop.css">
<script type="application/javascript" src="../../dcommon/js/modernizr.js"></script>
<script type="application/javascript" src="../../dcommon/js/codemirror.js"></script>
<script type="application/javascript" src="../../dcommon/js/jquery.js"></script>
<script type="application/javascript" src="../../dcommon/js/foundation.min.js"></script>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-552992c80ef99c8d" async="async"></script>
<script type="application/javascript" src="../../dcommon/js/jqfns.js"></script>
<script type="application/javascript" src="../../dcommon/js/ohc-inline-videos.js"></script>
<!-- Add fancyBox -->
<link rel="stylesheet" href="../../dcommon/fancybox/jquery.fancybox.css?v=2.1.5" type="text/css" media="screen" />
<script type="text/javascript" src="../../dcommon/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>
<!-- Optionally add helpers - button, thumbnail and/or media -->
<link rel="stylesheet"  href="../../dcommon/fancybox/helpers/jquery.fancybox-buttons.css?v=1.0.5"  type="text/css" media="screen" />
<script type="text/javascript" src="../../dcommon/fancybox/helpers/jquery.fancybox-buttons.js?v=1.0.5"></script>
<script type="text/javascript" src="../../dcommon/fancybox/helpers/jquery.fancybox-media.js?v=1.0.6"></script>
<link rel="stylesheet"  href="../../dcommon/fancybox/helpers/jquery.fancybox-thumbs.css?v=1.0.7"  type="text/css" media="screen" />
<script type="text/javascript" src="../../dcommon/fancybox/helpers/jquery.fancybox-thumbs.js?v=1.0.7"></script>
</head>
<body>
<a href="#BEGIN" class="accessibility-top skipto" tabindex="0">Go to main content</a><header><!--
<div class="zz-skip-header"><a id="top" href="#BEGIN">Go to main content</a>--></header>
<div class="row" id="CONTENT">
<div class="IND large-9 medium-8 columns" dir="ltr">
<a id="BEGIN" name="BEGIN"></a>
<span id="PAGE" style="display:none;">36/54</span> <!-- End Header -->
<script  >
<!-- // <![CDATA[
window.name='xdb17ver'
// ]]> -->
</script> <script  >
// <![CDATA[
function footdisplay(footnum,footnote) {
    var msg = window.open('', 'NewWindow' + footnum,
        'directories=no,height=120,location=no,menubar=no,resizable=yes,' +
        'scrollbars=yes,status=no,toolbar=no,width=598');
    msg.document.open('text/html');
    msg.document.write('<!DOCTYPE html ');
    msg.document.write('PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" ');

    msg.document.write('"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">');
    msg.document.write('<html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><title>');
    msg.document.write('Footnote ' + footnum);
    msg.document.write('<\/title><meta http-equiv="Content-Type" ');
    msg.document.write('content="text/html; charset=utf-8" />');
    msg.document.write('');
    msg.document.write('<style> <![CDATA[ ');
    msg.document.write('h1 {text-align: center; font-size: 14pt;}');
    msg.document.write('fieldset {border: none;}');
    msg.document.write('form {text-align: center;}');
    msg.document.write(' ]]\u003e <\/style>');
    msg.document.write('<\/head><body><h1>Footnote ' + footnum + '<\/h1><p>');
    msg.document.write(footnote);
    msg.document.write('<\/p><form action="" method="post"><fieldset>');
    msg.document.write('<input type="button" value="OK" ');
    msg.document.write('onclick="window.close();" />');
    msg.document.write('<\/fieldset><\/form><\/body><\/html>');
    msg.document.close();
    msg.focus();
}
// ]]>
</script> <noscript>
<p>The script content on this page is for navigation purposes only and does not alter the content in any way.</p>
</noscript>
<div id="ADXDB2100" class="chapter"><a id="g1046246"></a> <a id="i1037410"></a>
<h1 class="chapter"><span class="secnum">24</span> Managing <a id="sthref1465"></a><a id="sthref1466"></a>Re<a id="sthref1467"></a><a id="sthref1468"></a>source Versions</h1>
<p>This chapter describes how to create and manage versions of Oracle XML&nbsp;DB resources.</p>
<p>This chapter contains these topics:</p>
<ul>
<li>
<p><a href="#i1040964">Overview of Oracle XML&nbsp;DB Versioning</a></p>
</li>
<li>
<p><a href="#i1038901">Versioning and Resource IDs</a></p>
</li>
<li>
<p><a href="#CCHGADCE">Versioning and ACLs</a></p>
</li>
<li>
<p><a href="#CCHDEEBE">Resource Versioning Examples</a></p>
</li>
</ul>
<a id="i1040964"></a>
<div id="ADXDB5362" class="sect1">
<h2 class="sect1">Overview of Oracle XML&nbsp;DB Versioning</h2>
<p>Versioning lets you create and manage different versions of a resource in Oracle XML&nbsp;DB Repository. A record, or history, is kept of all changes to an Oracle XML&nbsp;DB resource that is under version control. When you update a version-controlled resource, Oracle XML&nbsp;DB stores the pre-update contents as a separate resource version &ndash; a snapshot for the historical record.</p>
<p>Versioning features include the following:</p>
<ul>
<li>
<p>Version control for a resource.</p>
<p>You can turn version control on or off for an Oracle XML&nbsp;DB Repository resource.</p>
</li>
<li>
<p>Updating a version-controlled resource.</p>
<p>When Oracle XML&nbsp;DB updates a version-controlled resource, it creates a new version of the resource. This new version is not deleted from the database when you delete the version-controlled resource.</p>
</li>
<li>
<p>Accessing a version-controlled resource.</p>
<p>You can access a version-controlled resource the same way you access any other resource.</p>
</li>
<li>
<p>Accessing a resource version.</p>
<p>To access a particular version of a resource, you use the resource ID of that version. The resource ID can be obtained from the resource version history or from the version-controlled resource itself. See <a href="#i1038901">"Versioning and Resource IDs"</a>.</p>
</li>
</ul>
<p><a href="#g1043974">Table 24-1</a> lists some terms used in this chapter.</p>
<div id="ADXDB5365" class="tblhruleformalwide">
<p class="titleintable"><a id="sthref1469"></a><a id="g1043974"></a>Table 24-1 Oracle XML&nbsp;DB Versioning Terms</p>
<table class="cellalignment1032" title="Oracle XML DB Versioning Terms " summary="This table describes Oracle XML DB versioning terms." >
<thead>
<tr class="cellalignment1020">
<th class="cellalignment1027" id="r1c1-t2">Term</th>
<th class="cellalignment1027" id="r1c2-t2">Description</th>
</tr>
</thead>
<tbody>
<tr class="cellalignment1020">
<td class="cellalignment1028" id="r2c1-t2" headers="r1c1-t2">
<p><a id="sthref1470"></a><span class="glossaryterm">Versionable resource</span></p>
</td>
<td class="cellalignment1028" headers="r2c1-t2 r1c2-t2">
<p>A resource that can be put under version control. All Oracle XML&nbsp;DB resources except folders and ACLs are versionable.</p>
</td>
</tr>
<tr class="cellalignment1020">
<td class="cellalignment1028" id="r3c1-t2" headers="r1c1-t2">
<p><a id="sthref1471"></a><span class="glossaryterm">Version-controlled resource</span></p>
</td>
<td class="cellalignment1028" headers="r3c1-t2 r1c2-t2">
<p>A resource that is under version control.</p>
</td>
</tr>
<tr class="cellalignment1020">
<td class="cellalignment1028" id="r4c1-t2" headers="r1c1-t2">
<p><a id="sthref1472"></a><a id="sthref1473"></a><span class="glossaryterm">Version resource</span></p>
</td>
<td class="cellalignment1028" headers="r4c1-t2 r1c2-t2">
<p>A particular version of a version-controlled resource. A version resource is itself a resource. It is system-generated, and it has no associated path name. It is read-only (it cannot be updated or deleted).</p>
</td>
</tr>
<tr class="cellalignment1020">
<td class="cellalignment1028" id="r5c1-t2" headers="r1c1-t2">
<p><code>checkOut</code>, <code>checkIn</code>, <code>unCheckOut</code></p>
</td>
<td class="cellalignment1028" headers="r5c1-t2 r1c2-t2">
<p>Operations for managing version-controlled resources. You must use <code>checkOut</code> before you can modify a version-controlled resource. Use <code>checkIn</code> to make your changes permanent. Use <code>unCheckOut</code> to cancel your changes. (Use <code>COMMIT</code> after each of these operations.)</p>
</td>
</tr>
</tbody>
</table>
<br /></div>
<!-- class="tblhruleformalwide" -->
<div class="infobox-note">
<p class="notep1">Note:</p>
Oracle XML&nbsp;DB supports version control only for Oracle XML&nbsp;DB resources. It does <span class="italic">not</span> support version control for user-defined tables or data in Oracle Database.
<p>Oracle does <span class="italic">not</span> guarantee preservation of the resource ID of a version across check-in and check-out. Everything except the resource ID of the latest version is preserved.</p>
<p>Oracle XML&nbsp;DB supports versioning of XML resources that are not XML schema-based. It also supports versioning of XML schema-based resources and resources that contain XML schema-based metadata, but only if the underlying tables have <span class="italic">no</span> associated triggers or constraints.</p>
<p>If hierarchy is enabled for a table, then the table has a trigger. This includes tables that are created as part of XML schema registration, for which the default behavior is to enable hierarchy.</p>
<p>Be aware also that if you query one of the tables underlying a resource, the query can return data from multiple versions of the resource. This is because the data for the different resource versions is stored in the same underlying table, using different rows.</p>
</div>
</div>
<!-- class="sect1" -->
<a id="i1038901"></a>
<div id="ADXDB5366" class="sect1">
<h2 class="sect1">Versioning and Resource IDs</h2>
<p>A resource object ID, or <a id="sthref1474"></a><span class="glossaryterm">resource ID</span>, is a unique, constant, system-generated identifier for an Oracle XML&nbsp;DB resource. Each resource has a resource ID. This includes <span class="italic">version resources</span>, which are system-generated resources that do not have any path names. A resource ID is sometimes called a <a id="sthref1475"></a><span class="glossaryterm">RESID</span>.</p>
<p>You use PL/SQL package <code>DBMS_XDB_VERSION</code> to put a resource under version-control and manage different versions of it. Some of the <code>DBMS_XDB_VERSION</code> routines accept the path name of a version-controlled resource as argument and return the resource ID of the relevant version resource.</p>
<p>For example, you use function <code>DBMS_XDB_VERSION.makeVersioned</code> to put a resource under version control, that is, to turn it into a version-controlled resource. It accepts as argument a repository path to the resource.</p>
<p>You need not use the same path name for a given version-controlled resource when you perform various versioning operations on it, but the path names you use must all refer to the same resource.</p>
<p>Whenever a path name is passed as an argument representing a version-controlled resource, it is the latest (that is, the current) version of the resource that is used. A <span class="italic">path name always stands for the latest version.</span> The only way you can refer to a version other than the current version is to use its resource ID.</p>
<p>The resource ID of a given version is constant. Remember that a version is itself a resource, and the resource ID of a resource never changes.</p>
<p>Each time you check in a version-controlled resource, Oracle XML&nbsp;DB creates a new version resource. A <span class="glossaryterm">version resource</span> is a snapshot of a resource (its content and metadata) together with a resource ID. The collection of version resources for a given version-controlled resource constitutes a historical sequence of previous versions, the <a id="sthref1476"></a><span class="glossaryterm">version series</span> or history of the resource.</p>
<p>When you check in a version-controlled resource that has resource ID <span class="bolditalic">R</span>, Oracle XML&nbsp;DB creates a new resource ID, <span class="bolditalic">P</span>, which refers to a snapshot of the resource (both content and metadata), as it was before it was last checked out. The snapshot was made before check-out, but the associated version resource (and its resource ID <span class="bolditalic">P</span>) are created at check-in time. Together, the new resource ID <span class="bolditalic">P</span> and the snapshot it refers to thus represent the <span class="italic">previous</span>, not the current, version of the resource. Resource ID <span class="bolditalic">R</span> continues to refer to the current version.</p>
<p>Put another way, when you check in a version-controlled resource, a version resource is created that represents the previous state of the version-controlled resource. Like any new resource, this new version resource is allocated a new resource ID (<span class="bolditalic">P</span>).</p>
<p>You can think about making a version resource (check-in) the way you think about making a backup copy of a file: Just as you give a new name to the backup file, so the previous-version snapshot of a resource is given a new resource ID. The current resource retains the original resource ID, just as your working file keeps its original name.</p>
<p>What this means is that when you check in a resource, in order to "create a new version", what's really new is the version resource (resource ID <span class="bolditalic">P</span> and the snapshot it references) that represents the <span class="italic">old</span> (previous) version. The newest, or latest, version of the resource (<span class="bolditalic">R</span>) is really just the current version. Remember: new version resource = old (previous) version of the resource content and metadata.</p>
<p>Resource ID <span class="bolditalic">R</span> refers to the <span class="italic">current</span> version of the version-controlled resource throughout its lifetime, from the moment it was put under version control until it is deleted. You can always access the latest version of a resource using its original resource ID.</p>
<p>When you need to refer to a previous version of a resource, you must use its resource ID to reference it. You cannot use a path name. You can use function <code>DBMS_XDB_VERSION.getPredsByRESID</code> to obtain the resource ID of the previous version of a given resource.</p>
<div class="infobox-note">
<p class="notep1">Note:</p>
If you <span class="italic">delete</span> a resource, then any subsequent reference to it, whether by resource ID or path name, raises an error (typically <code>ORA-31001: Invalid resource handle or path name</code>). You <span class="italic">cannot</span> access any version of a version-controlled resource that has been deleted.</div>
</div>
<!-- class="sect1" -->
<a id="CCHGADCE"></a>
<div id="ADXDB5916" class="sect1"><!-- infolevel="all" infotype="General" -->
<h2 class="sect1">Versioning and ACLs</h2>
<p>A version resource is immutable. It is a snapshot of resource content and metadata, plus a resource ID, and both snapshot and ID are static. Likewise, the ACL of a version resource cannot be changed.</p>
<p>You can modify the ACL of a version-controlled resource that you have checked out. When you check it in, the modified ACL continues to be associated with the current (latest) version of the resource, and the previous version, that is, the newly created version resource, is associated with the ACL before it was modified. That is, the previous version is associated with the previous ACL, and the current version is associated with the updated ACL.</p>
<p>What is important to keep in mind is this:</p>
<ul>
<li>
<p>Different versions of a resource can have different ACLs associated with them.</p>
</li>
<li>
<p>You can modify the ACL associated with the current version after you check out the resource.</p>
</li>
<li>
<p>Check-in associates the ACL as it was before check-out with the newly created version resource, that is, with the previous version of the resource.</p>
</li>
<li>
<p>The ACL associated with a given version remains the same.</p>
</li>
</ul>
</div>
<!-- class="sect1" -->
<a id="CCHDEEBE"></a>
<div id="ADXDB5917" class="sect1"><!-- infolevel="all" infotype="General" -->
<h2 class="sect1">Resource Versioning Examples</h2>
<p>This section presents examples that do the following:</p>
<ul>
<li>
<p>Put a resource under version control, that is, create a version-controlled resource &ndash; <a href="#CCHGICDB">Example 24-2</a></p>
</li>
<li>
<p>Retrieve the content of the resource by referring to the resource ID &ndash; <a href="#CCHCEAIJ">Example 24-3</a></p>
</li>
<li>
<p>Check out the version-controlled resource (for all users) &ndash; <a href="#CCHJEAIE">Example 24-4</a></p>
</li>
<li>
<p>Update the resource content &ndash; <a href="#CCHDFBJF">Example 24-5</a></p>
</li>
<li>
<p>Check in the resource &ndash; <a href="#CCHEHBAF">Example 24-6</a></p>
</li>
<li>
<p>Retrieve the content and metadata of both the new and old versions of the resource &ndash; <a href="#CCHHDEIE">Example 24-7</a>, <a href="#CCHEGHEA">Example 24-8</a>, <a href="#CCHJDGEC">Example 24-9</a></p>
</li>
<li>
<p>Cancel a resource check-out &ndash; <a href="#CCHJFGED">Example 24-10</a></p>
</li>
</ul>
<p><a href="#CCHCEAIJ">Example 24-3</a> creates an Oracle XML&nbsp;DB Repository resource at repository path <code>/public/t1.txt</code>. The resource has as content the text <code>Mary had a little lamb</code>. The example uses SQL*Plus command <code>VARIABLE</code> to declare bind variables <code>targetPath</code>, <code>current_RESID</code>, and <code>previous_RESID</code>, which are used in other examples in this section.</p>
<div id="ADXDB5918" class="example">
<p class="titleinexample"><a id="sthref1477"></a>Example 24-1 Creating a Repository Resource</p>
<pre>
VARIABLE <span class="bold">targetPath</span>      VARCHAR2(700)
VARIABLE <span class="bold">current_RESID</span>   VARCHAR2(32)
VARIABLE <span class="bold">previous_RESID</span>  VARCHAR2(32)

DECLARE
  res BOOLEAN;
BEGIN
  :targetPath  := '<span class="bold">/public/t1.txt</span>';
  IF (DBMS_XDB.existsResource(:targetPath))
     THEN DBMS_XDB.deleteResource(:targetPath);
  END IF;
  res := DBMS_XDB.<span class="bold">createResource</span>(:targetPath, '<span class="bold">Mary had a little lamb</span>');
END;
/
</pre></div>
<!-- class="example" -->
<p>The new resource is <span class="italic">not</span> version-controlled. <a href="#CCHGICDB">Example 24-2</a> uses PL/SQL function <code>makeVersioned</code> to put it under version control. This function returns the resource ID of the first version resource for the version-controlled resource. The function does not auto-commit. You must explicitly use <code>COMMIT</code>.</p>
<div id="ADXDB5919" class="example">
<p class="titleinexample"><a id="CCHGICDB"></a>Example 24-2 Creating a Version-Controlled Resource</p>
<pre>
DECLARE
  resid DBMS_XDB_VERSION.RESID_TYPE;
BEGIN
  resid := DBMS_XDB_VERSION.<span class="bold">makeVersioned</span>(:targetPath);
  :<span class="bold">current_RESID</span> := resid;
  <span class="bold">COMMIT</span>;
END;
/
</pre></div>
<!-- class="example" -->
<p><a href="#CCHGICDB">Example 24-2</a> also copies the resource ID of the new version resource to bind variable <code>current_RESID</code>. <a href="#CCHCEAIJ">Example 24-3</a> shows how to use type constructor <code>XDBUritype</code> together with PL/SQL function <code>createOIDPath</code> to retrieve the resource content by referencing the resource ID.</p>
<div id="ADXDB5920" class="example">
<p class="titleinexample"><a id="CCHCEAIJ"></a>Example 24-3 Retrieving Resource Content by Referencing the Resource ID</p>
<pre>
SELECT XDBURIType(DBMS_XDB.<span class="bold">createOIDPath</span>(<span class="bold">:current_RESID</span>)).getClob() FROM DUAL;

XDBURITYPE(DBMS_XDB.CREATEOIDPATH(:CURRENT_RESID)).GETCLOB()
------------------------------------------------------------
Mary had a little lamb
 
1 row selected.
</pre></div>
<!-- class="example" -->
<p><a href="#CCHJEAIE">Example 24-4</a> checks out the version-controlled resource (and commits), so that it can be modified. Note that any user can modify a resource that has been checked out.</p>
<div id="ADXDB5921" class="example">
<p class="titleinexample"><a id="CCHJEAIE"></a>Example 24-4 Checking Out a Version-Controlled Resource</p>
<pre>
BEGIN
  DBMS_XDB_VERSION.<span class="bold">checkOut</span>(:targetPath);
  <span class="bold">COMMIT</span>;
END;
/
</pre></div>
<!-- class="example" -->
<p><a href="#CCHDFBJF">Example 24-5</a> updates the content of the checked-out resource. Before the (LOB) content can be updated, you must lock the resource. The example uses a dummy update of the resource display name (a scalar attribute) to do this.</p>
<div id="ADXDB5922" class="example">
<p class="titleinexample"><a id="CCHDFBJF"></a>Example 24-5 Updating Resource Content</p>
<pre>
DECLARE
  content        BLOB;
  newContentBlob BLOB;
  newContentClob CLOB;
  source_offset  INTEGER := 1;
  target_offset  INTEGER := 1;
  warning        INTEGER;
  lang_context   INTEGER := 0;
BEGIN
  <span class="bold">-- Lock the resource using a dummy update.</span>
  UPDATE RESOURCE_VIEW
    SET RES =
      updateXML(RES, '/Resource/<span class="bold">DisplayName</span>/text()',
                XMLCast(XMLQuery(
                          'declare namespace ns =
                           "http://xmlns.oracle.com/xdb/XDBResource.xsd"; (: :)
                           $r/ns:Resource/ns:<span class="bold">DisplayName</span>/text()'
                          PASSING RES AS "r" RETURNING CONTENT)
                        AS VARCHAR2(128)))
    WHERE equals_path(res, :targetPath) = 1;
  <span class="bold">-- Get the LOB locator.</span>
  SELECT XMLCast(XMLQuery('declare namespace ns =
                           "http://xmlns.oracle.com/xdb/XDBResource.xsd"; (: :)
                           $r/ns:Resource/<span class="bold">ns:XMLLob</span>'
                          PASSING RES AS "r" RETURNING CONTENT)
                 AS BLOB)
    INTO <span class="bold">content</span> FROM RESOURCE_VIEW
    WHERE equals_path(RES, :targetPath) = 1;
  <span class="bold">-- Update the LOB.</span>
  newContentClob := '<span class="bold">Hickory dickory dock, the mouse ran up the clock</span>';
  DBMS_LOB.createTemporary(newContentBlob, false, DBMS_LOB.CALL);
  DBMS_LOB.convertToBlob(<span class="bold">newContentBlob</span>, newContentClob,
                         DBMS_LOB.getLength(newContentClob),
                         source_offset, target_offset,
                         nls_charset_id('AL32UTF8'), lang_context, warning);
  DBMS_LOB.open(content, DBMS_LOB.lob_readwrite);
  DBMS_LOB.<span class="bold">trim</span>(content, <span class="bold">0</span>);
  DBMS_LOB.append(<span class="bold">content</span>, <span class="bold">newContentBlob</span>);
  DBMS_LOB.close(content);
  DBMS_LOB.freeTemporary(newContentBlob);
  DBMS_LOB.freeTemporary(newContentClob);
  <span class="bold">COMMIT</span>;
END;
/
</pre></div>
<!-- class="example" -->
<p><a href="#CCHDFBJF">Example 24-5</a> retrieves the LOB content using the <a id="sthref1478"></a>LOB locator, which is element <code>/ns:Resource/ns:XMLLob</code>. It empties the existing content and adds new content using PL/SQL procedures <code>trim</code> and <code>append</code> in package <code>DBMS_LOB</code>. It commits the content change.</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<a class="olink ADLOB1400" href="../../appdev.112/e18294/adlob_lob_ops.htm#ADLOB1400"><span class="italic">Oracle Database SecureFiles and Large Objects Developer's Guide</span></a> for information about updating a LOB</div>
<p>At this point, the content has been modified, but this change has not been recorded in the version series. <a href="#CCHEHBAF">Example 24-6</a> checks in the resource and commits the check-in.</p>
<div id="ADXDB5923" class="example">
<p class="titleinexample"><a id="CCHEHBAF"></a>Example 24-6 Checking In a Version-Controlled Resource</p>
<pre>
DECLARE
  resid DBMS_XDB_VERSION.RESID_TYPE;
BEGIN
  <span class="bold">resid</span> := DBMS_XDB_VERSION.<span class="bold">checkIn</span>(:targetPath);
  :<span class="bold">previous_RESID</span> := DBMS_XDB_VERSION.<span class="bold">getPredsByRESID</span>(<span class="bold">resid</span>)(1);
  <span class="bold">COMMIT</span>;
END;
/
</pre></div>
<!-- class="example" -->
<p>PL/SQL function <code>checkIn</code> returns the resource ID of the current version, which is the same as <code>current_RESID</code>. <a href="#CCHEHBAF">Example 24-6</a> passes this value to PL/SQL function <code>getPredsByRESID</code>. This function returns the list of resource IDs for the (immediate) predecessors of its argument resource.<a id="sthref1479" href="#sthref1479" onclick='footdisplay(1,"In Oracle XML&nbsp;DB, a version resource always has a \u003cspan class=\"italic\"\u003esingle\u003c/span\u003e predecessor, that is, a single version that immediately precedes it. The WebDAV standard provides for the possibility of multiple predecessors.")'><sup class="tablefootnote">Foot&nbsp;1&nbsp;</sup></a> <a href="#CCHEHBAF">Example 24-6</a> assigns the first (and only) element of this list to bind variable <code>previous_RESID</code>.</p>
<p>At this point, the value of <code>current_RESID</code> is the resource ID of the current version, and the value of <code>previous_RESID</code> is the resource ID of the previous version.</p>
<p>You can retrieve the content or metadata of a resource using any of the following methods:</p>
<ul>
<li>
<p><code>XDBURIType</code> together with PL/SQL function <code>DBMS_XDB.createOIDPath</code> &ndash; Retrieve content. See <a href="#CCHCEAIJ">Example 24-3</a> and <a href="#CCHHDEIE">Example 24-7</a>.</p>
</li>
<li>
<p>PL/SQL function <code>DBMS_XDB_VERSION.getContentsCLOBByRESID</code> &ndash; Retrieve content. See <a href="#CCHEGHEA">Example 24-8</a>.</p>
</li>
<li>
<p>PL/SQL function <code>DBMS_XDB_VERSION.getResourceByRESID</code> &ndash; Retrieve metadata. See <a href="#CCHJDGEC">Example 24-9</a>.</p>
</li>
</ul>
<p>You can use <code>XDBURIType</code> with <code>createOIDPath</code> to access resource content using protocols. For example, you could have Oracle XML&nbsp;DB serve up various versions of a graphic image file resource for a Web page, setting the <code>HREF</code> for the HTML <code>IMAGE</code> tag to a value returned by <code>createOIDPath</code>.</p>
<p><a href="#CCHHDEIE">Example 24-7</a> through <a href="#CCHJDGEC">Example 24-9</a> use these different methods to retrieve the two versions of the resource addressed by bind variables <code>current_RESID</code> and <code>previous_RESID</code> after check-in.</p>
<div id="ADXDB5924" class="example">
<p class="titleinexample"><a id="CCHHDEIE"></a>Example 24-7 Retrieving Resource Version Content using XDBURITYPE and CREATEOIDPATH</p>
<pre>
SELECT XDBURIType(DBMS_XDB.createOIDPath(<span class="bold">:current_RESID</span>)).getClob() FROM DUAL;
 
XDBURITYPE(DBMS_XDB.CREATEOIDPATH(:CURRENT_RESID)).GETCLOB()
------------------------------------------------------------
Mary had a little lamb
 
1 row selected.
 
SELECT XDBURIType(DBMS_XDB.createOIDPath(<span class="bold">:previous_RESID</span>)).getClob() FROM DUAL;
 
XDBURITYPE(DBMS_XDB.CREATEOIDPATH(:PREVIOUS_RESID)).GETCLOB()
-------------------------------------------------------------
Hickory dickory dock, the mouse ran up the clock
 
1 row selected.
</pre></div>
<!-- class="example" -->
<div id="ADXDB5925" class="example">
<p class="titleinexample"><a id="CCHEGHEA"></a>Example 24-8 Retrieving Resource Version Content using GETCONTENTSCLOBBYRESID</p>
<pre>
SELECT DBMS_XDB_VERSION.getContentsCLOBByRESID(<span class="bold">:current_RESID</span>) FROM DUAL;

DBMS_XDB_VERSION.GETCONTENTSCLOBBYRESID(:CURRENT_RESID)
-------------------------------------------------------
Mary had a little lamb
 
1 row selected.
 
SELECT DBMS_XDB_VERSION.getContentsCLOBByRESID(<span class="bold">:previous_RESID</span>) FROM DUAL;
 
DBMS_XDB_VERSION.GETCONTENTSCLOBBYRESID(:PREVIOUS_RESID)
--------------------------------------------------------
Hickory dickory dock, the mouse ran up the clock
 
1 row selected.
</pre></div>
<!-- class="example" -->
<div id="ADXDB5926" class="example">
<p class="titleinexample"><a id="CCHJDGEC"></a>Example 24-9 Retrieving Resource Version Metadata using GETRESOURCEBYRESID</p>
<pre>
SELECT XMLSerialize(DOCUMENT DBMS_XDB_VERSION.getResourceByRESID(<span class="bold">:current_RESID</span>)
                    AS CLOB INDENT SIZE = 2)
  FROM DUAL;
&lt;Resource xmlns="http://xmlns.oracle.com/xdb/XDBResource.xsd" Hidden="false"
          Invalid="false" <span class="bold">VersionID="2"</span> ActivityID="0" Container="false"
          CustomRslv="false" VersionHistory="false" StickyRef="true"&gt;
  &lt;CreationDate&gt;2009-05-06T12:33:34.012133&lt;/CreationDate&gt;
  &lt;ModificationDate&gt;2009-05-06T12:33:34.<span class="bold">280199</span>&lt;/ModificationDate&gt;
  &lt;DisplayName&gt;t1.txt&lt;/DisplayName&gt;
  &lt;Language&gt;en-US&lt;/Language&gt;
  &lt;CharacterSet&gt;UTF-8&lt;/CharacterSet&gt;
  &lt;ContentType&gt;text/plain&lt;/ContentType&gt;
  &lt;RefCount&gt;<span class="bold">1</span>&lt;/RefCount&gt;
  &lt;ACL&gt;
    &lt;acl description="Public:All privileges to PUBLIC"
         xmlns="http://xmlns.oracle.com/xdb/acl.xsd" 
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://xmlns.oracle.com/xdb/acl.xsd 
                             http://xmlns.oracle.com/xdb/acl.xsd"
         shared="true"&gt;
      &lt;ace&gt;
        &lt;grant&gt;true&lt;/grant&gt;
        &lt;principal&gt;PUBLIC&lt;/principal&gt;
        &lt;privilege&gt;
          &lt;all/&gt;
        &lt;/privilege&gt;
      &lt;/ace&gt;
    &lt;/acl&gt;
  &lt;/ACL&gt;
  &lt;Owner&gt;HR&lt;/Owner&gt;
  &lt;Creator&gt;HR&lt;/Creator&gt;
  &lt;LastModifier&gt;HR&lt;/LastModifier&gt;
  &lt;SchemaElement&gt;http://xmlns.oracle.com/xdb/XDBSchema.xsd#text&lt;/SchemaElement&gt;
  &lt;Contents&gt;
    &lt;text&gt;<span class="bold">Mary had a little lamb</span>&lt;/text&gt;
  &lt;/Contents&gt;
  &lt;VCRUID&gt;69454F2EF12E3375E040578C8A1764B5&lt;/VCRUID&gt;
  <span class="bold">&lt;Parents&gt;69454F2EF12F3375E040578C8A1764B5&lt;/Parents&gt;</span>
&lt;/Resource&gt;
 
1 row selected.
 
SELECT XMLSerialize(DOCUMENT DBMS_XDB_VERSION.getResourceByRESID(<span class="bold">:previous_RESID</span>)
                    AS CLOB INDENT SIZE = 2)
  FROM DUAL;
&lt;Resource xmlns="http://xmlns.oracle.com/xdb/XDBResource.xsd" Hidden="false"
          Invalid="false" <span class="bold">VersionID="1"</span> Container="false" CustomRslv="false" 
          VersionHistory="false" StickyRef="true"&gt;
  &lt;CreationDate&gt;2009-05-06T12:33:34.012133&lt;/CreationDate&gt;
  &lt;ModificationDate&gt;2009-05-06T12:33:34.<span class="bold">012133</span>&lt;/ModificationDate&gt;
  &lt;DisplayName&gt;t1.txt&lt;/DisplayName&gt;
  &lt;Language&gt;en-US&lt;/Language&gt;
  &lt;CharacterSet&gt;UTF-8&lt;/CharacterSet&gt;
  &lt;ContentType&gt;text/plain&lt;/ContentType&gt;
  &lt;RefCount&gt;<span class="bold">0</span>&lt;/RefCount&gt;
  &lt;ACL&gt;
    &lt;acl description="Public:All privileges to PUBLIC"
         xmlns="http://xmlns.oracle.com/xdb/acl.xsd" 
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://xmlns.oracle.com/xdb/acl.xsd
                             http://xmlns.oracle.com/xdb/acl.xsd"
         shared="true"&gt;
      &lt;ace&gt;
        &lt;grant&gt;true&lt;/grant&gt;
        &lt;principal&gt;PUBLIC&lt;/principal&gt;
        &lt;privilege&gt;
          &lt;all/&gt;
        &lt;/privilege&gt;
      &lt;/ace&gt;
    &lt;/acl&gt;
  &lt;/ACL&gt;
  &lt;Owner&gt;HR&lt;/Owner&gt;
  &lt;Creator&gt;HR&lt;/Creator&gt;
  &lt;LastModifier&gt;HR&lt;/LastModifier&gt;
  &lt;SchemaElement&gt;http://xmlns.oracle.com/xdb/XDBSchema.xsd#text&lt;/SchemaElement&gt;
  &lt;Contents&gt;
    &lt;text&gt;<span class="bold">Hickory dickory dock, the mouse ran up the clock</span>&lt;/text&gt;
  &lt;/Contents&gt;
  &lt;VCRUID&gt;69454F2EF12E3375E040578C8A1764B5&lt;/VCRUID&gt;
&lt;/Resource&gt;
 
1 row selected.
</pre></div>
<!-- class="example" -->
<p>You can cancel a check-out using PL/SQL function <code>DBMS_XDB_VERSION.unCheckOut</code>. <a href="#CCHJFGED">Example 24-10</a> illustrates this.</p>
<div id="ADXDB5927" class="example">
<p class="titleinexample"><a id="CCHJFGED"></a>Example 24-10 Canceling a Check-Out using UNCHECKOUT</p>
<pre>
DECLARE
  resid DBMS_XDB_VERSION.RESID_TYPE;
BEGIN
  resid := DBMS_XDB_VERSION.<span class="bold">unCheckOut</span>(:targetPath);
END;
/
</pre></div>
<!-- class="example" -->
<p><a href="#g1044007">Table 24-2</a> summarizes the subprograms in PL/SQL package <code>DBMS_XDB_VERSION</code> that are mentioned in this chapter.</p>
<div id="ADXDB5386" class="tblhruleformalwide">
<p class="titleintable"><a id="sthref1480"></a><a id="g1044007"></a>Table 24-2 PL/SQL Functions and Procedures in Package DBMS_XDB_VERSION</p>
<table class="cellalignment1032" title="PL/SQL Functions and Procedures in Package DBMS_XDB_VERSION" summary="This table describes DBMS_XDB_VERSION functions and procedures, including syntax. It has two columns." dir="ltr">
<thead>
<tr class="cellalignment1020">
<th class="cellalignment1027" id="r1c1-t6">Function or Procedure</th>
<th class="cellalignment1027" id="r1c2-t6">Description</th>
</tr>
</thead>
<tbody>
<tr class="cellalignment1020">
<td class="cellalignment1028" id="r2c1-t6" headers="r1c1-t6">
<p><code>makeVersioned(pathname VARCHAR2) RETURN DBMS_XDB_VERSION.RESID_TYPE;</code></p>
</td>
<td class="cellalignment1028" headers="r2c1-t6 r1c2-t6">
<p>Turn a resource with the given path name into a version controlled resource.</p>
<p>If two or more path names refer to the same resource, then the resource is copied, and argument path name is bound with the copy. The new resource is put under version control. All other path names continue to refer to the original resource.</p>
<p>The argument is the path name of the resource to be put under version control.</p>
<p>Returns the resource ID of the first version resource of the version-controlled resource.</p>
<p>This is not an auto-commit SQL operation. An error is raised of you call <code>makeVersioned</code> for a folder, version resource, or ACL, or if the target resource does not exist. Note: No error or warning is raised if you call <code>makeVersioned</code> for a version-controlled resource.</p>
</td>
</tr>
<tr class="cellalignment1020">
<td class="cellalignment1028" id="r3c1-t6" headers="r1c1-t6">
<p><code>checkOut(pathname VARCHAR2);</code></p>
</td>
<td class="cellalignment1028" headers="r3c1-t6 r1c2-t6">
<p>Check out a version-controlled resource. You cannot update or delete a version-controlled resource until you check it out. Check-out is for all users: any user can modify a resource that has been checked out.</p>
<p>The argument is the path name of the version-controlled resource to be checked out. This is not an auto-commit SQL operation. If two users check out the same version-controlled resource at the same time, then one user must roll back. As a precaution, commit after checking out and before updating a resource. An error is raised if the target resource is not under version control, does not exist, or is already checked out.</p>
</td>
</tr>
<tr class="cellalignment1020">
<td class="cellalignment1028" id="r4c1-t6" headers="r1c1-t6">
<p><code>checkIn (pathname VARCHAR2) RETURN DBMS_XDB_VERSION.RESID_TYPE;</code></p>
</td>
<td class="cellalignment1028" headers="r4c1-t6 r1c2-t6">
<p>Check in a version-controlled resource that has been checked out.</p>
<p><code>pathname</code> - Path name of the checked-out resource.</p>
<p>Returns the resource id of the newly created version.</p>
<p>This is not an auto-commit SQL operation. You need not use the same path name that was used for check-out. However, the check-in path name and the check-out path name must reference the same resource, or else results are unpredictable.</p>
<p>If the resource has been renamed, then the new name must be used when checking it in. An error is raised if the path name refers to no resource.</p>
</td>
</tr>
<tr class="cellalignment1020">
<td class="cellalignment1028" id="r5c1-t6" headers="r1c1-t6">
<p><code>unCheckOut(pathname VARCHAR2) RETURN DBMS_XDB.RESID_TYPE;</code></p>
</td>
<td class="cellalignment1028" headers="r5c1-t6 r1c2-t6">
<p>Check in a checked-out resource.</p>
<p>The argument is the path name of the checked-out resource.</p>
<p>Returns the resource id of the version before the resource was checked out. This is not an auto-commit SQL operation. You need not use the same path name that was used for check-out. However, the <code>unCheckOut</code> path name and the check-out path name must reference the same resource, or else results are unpredictable.</p>
<p>If the resource has been renamed, then the new name must be used for <code>unCheckOut</code>. An error is raised if the path name refers to no resource.</p>
</td>
</tr>
<tr class="cellalignment1020">
<td class="cellalignment1028" id="r6c1-t6" headers="r1c1-t6">
<p><code>getPredecessors(pathname VARCHAR2) RETURN RESID_LIST_TYPE;</code></p>
<p><code>getPredsByRESID(resid DBMS_XDB.RESID_TYPE) RETURN RESID_LIST_TYPE;</code></p>
</td>
<td class="cellalignment1028" headers="r6c1-t6 r1c2-t6">
<p>Given a path name that references a version resource or a version-controlled resource, return the predecessors of the resource.</p>
<p>Retrieving predecessors by resource ID, using function getPredsByRESID is more efficient than by path name, using function <code>getPredecessors</code>.</p>
<p>The list of predecessors returned has only one element (the parent): Oracle XML&nbsp;DB does not support version branching.</p>
</td>
</tr>
<tr class="cellalignment1020">
<td class="cellalignment1028" id="r7c1-t6" headers="r1c1-t6">
<p><code>getSuccessors(pathname VARCHAR2) RETURN RESID_LIST_TYPE;</code></p>
<p><code>getSuccsByRESID(resid DBMS_XDB.RESID_TYPE) RETURN RESID_LIST_TYPE;</code></p>
</td>
<td class="cellalignment1028" headers="r7c1-t6 r1c2-t6">
<p>Given a version resource or a version-controlled resource, return the successors of the resource.</p>
<p>Retrieving successors by resource ID, using function getSuccsByRESID is more efficient than by path name, using function <code>getSuccessors</code>.</p>
<p>The list of successors returned has only one element (the parent): Oracle XML&nbsp;DB does not support version branching.</p>
</td>
</tr>
<tr class="cellalignment1020">
<td class="cellalignment1028" id="r8c1-t6" headers="r1c1-t6">
<p><code>getResourceByRESID(resid DBMS_XDB.RESID_TYPE) RETURN XMLType;</code></p>
</td>
<td class="cellalignment1028" headers="r8c1-t6 r1c2-t6">
<p>Given a resource ID, return the resource as an <code>XMLType</code> instance.</p>
</td>
</tr>
</tbody>
</table>
<br /></div>
<!-- class="tblhruleformalwide" --></div>
<!-- class="sect1" --></div>
<!-- class="chapter" -->
<hr />
<br />
<p style="text-decoration:underline">Footnote Legend</p>
Footnote&nbsp;1:&nbsp;In Oracle XML&nbsp;DB, a version resource always has a <span class="italic">single</span> predecessor, that is, a single version that immediately precedes it. The WebDAV standard provides for the possibility of multiple predecessors.<br /></div>
<!-- class="ind" -->
<!-- Start Footer -->
</div>
<!-- add extra wrapper close div-->
<footer><!--
<hr />
<table class="cellalignment1019">
<tr>
<td class="cellalignment1028">
<table class="cellalignment1024">
<tr>
<td class="cellalignment1023"><a href="xdb_xlink.htm"><img width="24" height="24" src="../../dcommon/gifs/leftnav.gif" alt="Go to previous page" /><br />
<span class="icon">Previous</span></a></td>
<td class="cellalignment1023"><a href="xdb18res.htm"><img width="24" height="24" src="../../dcommon/gifs/rightnav.gif" alt="Go to next page" /><br />
<span class="icon">Next</span></a></td>
</tr>
</table>
</td>
<td class="cellalignment-copyrightlogo"><img width="144" height="18" src="../../dcommon/gifs/oracle.gif" alt="Oracle" /><br />
Copyright&nbsp;&copy;&nbsp;2002, 2014,&nbsp;Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved.<br />
<a href="../../dcommon/html/cpyr.htm">Legal Notices</a></td>
<td class="cellalignment1030">
<table class="cellalignment1022">
<tr>
<td class="cellalignment1023"><a href="../../index.htm"><img width="24" height="24" src="../../dcommon/gifs/doclib.gif" alt="Go to Documentation Home" /><br />
<span class="icon">Home</span></a></td>
<td class="cellalignment1023"><a href="../../nav/portal_booklist.htm"><img width="24" height="24" src="../../dcommon/gifs/booklist.gif" alt="Go to Book List" /><br />
<span class="icon">Book List</span></a></td>
<td class="cellalignment1023"><a href="toc.htm"><img width="24" height="24" src="../../dcommon/gifs/toc.gif" alt="Go to Table of Contents" /><br />
<span class="icon">Contents</span></a></td>
<td class="cellalignment1023"><a href="index.htm"><img width="24" height="24" src="../../dcommon/gifs/index.gif" alt="Go to Index" /><br />
<span class="icon">Index</span></a></td>
<td class="cellalignment1023"><a href="../../nav/mindx.htm"><img width="24" height="24" src="../../dcommon/gifs/masterix.gif" alt="Go to Master Index" /><br />
<span class="icon">Master Index</span></a></td>
<td class="cellalignment1023"><a href="../../dcommon/html/feedback.htm"><img width="24" height="24" src="../../dcommon/gifs/feedbck2.gif" alt="Go to Feedback page" /><br />
<span class="icon">Contact Us</span></a></td>
</tr>
</table>
</td>
</tr>
</table>
--></footer>
</body>
</html>
