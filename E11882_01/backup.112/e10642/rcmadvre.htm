<!DOCTYPE html>
<html lang="en" >
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta charset="utf-8">
<title>Performing RMAN Recovery: Advanced Scenarios</title>
<meta name="generator" content="Oracle DARB XHTML Converter (Mode = document) - Merged Version 1054" />
<meta name="description" content="A guide to backup and recovery of Oracle databases, including RMAN backup and recovery, RMAN data transfer, Oracle Flashback Technology, and user-managed backup and recovery" />
<meta name="dcterms.created" content="2015-05-13T14:1:11Z" />
<meta name="robots" content="all" />
<meta name="dcterms.title" content="Database Backup and Recovery User's Guide" />
<meta name="dcterms.identifier" content="E10642-08" />
<meta name="dcterms.isVersionOf" content="BRADV" />
<meta name="dcterms.rights" content="Copyright&nbsp;&copy;&nbsp;2003, 2015,&nbsp;Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved." />
<link rel="Start" href="../../index.htm" title="Home" type="text/html" />
<link rel="Copyright" href="../../dcommon/html/cpyr.htm" title="Copyright" type="text/html" />

<script type="application/javascript"  src="../../dcommon/js/headfoot.js"></script>
<script type="application/javascript"  src="../../nav/js/doccd.js"></script>
<link rel="Contents" href="toc.htm" title="Contents" type="text/html" />
<link rel="Index" href="index.htm" title="Index" type="text/html" />
<link rel="Glossary" href="glossary.htm" title="Glossary" type="text/html" />
<link rel="Prev" href="rcmblock.htm" title="Previous" type="text/html" />
<link rel="Next" href="rcmtspit.htm" title="Next" type="text/html" />
<link rel="alternate" href="../e10642.pdf" title="PDF version" type="application/pdf" />
<link rel="schema.dcterms" href="http://purl.org/dc/terms/" />
<link rel="stylesheet" href="../../dcommon/css/fusiondoc.css">
<link rel="stylesheet" type="text/css"  href="../../dcommon/css/header.css">
<link rel="stylesheet" type="text/css"  href="../../dcommon/css/footer.css">
<link rel="stylesheet" type="text/css"  href="../../dcommon/css/fonts.css">
<link rel="stylesheet" href="../../dcommon/css/foundation.css">
<link rel="stylesheet" href="../../dcommon/css/codemirror.css">
<link rel="stylesheet" type="text/css" title="Default" href="../../nav/css/html5.css">
<link rel="stylesheet" href="../../dcommon/css/respond-480-tablet.css">
<link rel="stylesheet" href="../../dcommon/css/respond-768-laptop.css">
<link rel="stylesheet" href="../../dcommon/css/respond-1140-deskop.css">
<script type="application/javascript" src="../../dcommon/js/modernizr.js"></script>
<script type="application/javascript" src="../../dcommon/js/codemirror.js"></script>
<script type="application/javascript" src="../../dcommon/js/jquery.js"></script>
<script type="application/javascript" src="../../dcommon/js/foundation.min.js"></script>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-552992c80ef99c8d" async="async"></script>
<script type="application/javascript" src="../../dcommon/js/jqfns.js"></script>
<script type="application/javascript" src="../../dcommon/js/ohc-inline-videos.js"></script>
<!-- Add fancyBox -->
<link rel="stylesheet" href="../../dcommon/fancybox/jquery.fancybox.css?v=2.1.5" type="text/css" media="screen" />
<script type="text/javascript" src="../../dcommon/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>
<!-- Optionally add helpers - button, thumbnail and/or media -->
<link rel="stylesheet"  href="../../dcommon/fancybox/helpers/jquery.fancybox-buttons.css?v=1.0.5"  type="text/css" media="screen" />
<script type="text/javascript" src="../../dcommon/fancybox/helpers/jquery.fancybox-buttons.js?v=1.0.5"></script>
<script type="text/javascript" src="../../dcommon/fancybox/helpers/jquery.fancybox-media.js?v=1.0.6"></script>
<link rel="stylesheet"  href="../../dcommon/fancybox/helpers/jquery.fancybox-thumbs.css?v=1.0.7"  type="text/css" media="screen" />
<script type="text/javascript" src="../../dcommon/fancybox/helpers/jquery.fancybox-thumbs.js?v=1.0.7"></script>
</head>
<body>
<a href="#BEGIN" class="accessibility-top skipto" tabindex="0">Go to main content</a><header><!--
<div class="zz-skip-header"><a id="top" href="#BEGIN">Go to main content</a>--></header>
<div class="row" id="CONTENT">
<div class="IND large-9 medium-8 columns" dir="ltr">
<a id="BEGIN" name="BEGIN"></a>
<span id="PAGE" style="display:none;">32/47</span> <!-- End Header -->
<div id="BRADV008" class="chapter"><a id="CACJFJHI"></a> <a id="i1008870"></a>
<h1 class="chapter"><span class="secnum">20</span> Performing RMAN Recovery: Advanced Scenarios</h1>
<p>The preceding chapters in <a href="part_dia.htm#CHDEEBED">Part V, "Diagnosing and Responding to Failures"</a> cover the most basic recovery scenarios and are intended to be as generic as possible. The scenarios in this chapter are less common or are more complicated than the basic scenarios.</p>
<p>This chapter contains the following topics:</p>
<ul>
<li>
<p><a href="#CACGEAEE">Recovering a NOARCHIVELOG Database with Incremental Backups</a></p>
</li>
<li>
<p><a href="#CHDBEDCH">Restoring the Server Parameter File</a></p>
</li>
<li>
<p><a href="#i1006245">Performing Recovery with a Backup Control File</a></p>
</li>
<li>
<p><a href="#i1006453">Performing Disaster Recovery</a></p>
</li>
<li>
<p><a href="#i1007814">Restoring a Database on a New Host</a></p>
</li>
</ul>
<a id="CACGEAEE"></a>
<div id="BRADV89841" class="sect1"><!-- infolevel="all" infotype="General" -->
<h2 class="sect1">Recovering a NOARCHIVELOG Database with Incremental Backups</h2>
<p>Restoring a database running in <code dir="ltr">NOARCHIVELOG</code> mode is similar to restoring a database in <code dir="ltr">ARCHIVELOG</code> mode. The main differences are:</p>
<ul>
<li>
<p>Only consistent backups can be used in restoring a database in <code dir="ltr">NOARCHIVELOG</code> mode.</p>
</li>
<li>
<p>Media recovery is not possible because no archived redo logs exist.</p>
</li>
</ul>
<p><a id="sthref1635"></a>You <a id="sthref1636"></a>can perform limited recovery of changes to a database running in <code dir="ltr">NOARCHIVELOG</code> mode by applying incremental backups. The incremental backups must be consistent, like all backups of a database run in <code dir="ltr">NOARCHIVELOG</code> mode, so you cannot make backups of the database when it is open.</p>
<p>When you are recovering a <code dir="ltr">NOARCHIVELOG</code> database, specify the <code dir="ltr">NOREDO</code> option on the <code dir="ltr">RECOVER</code> command to indicate that RMAN should not attempt to apply archived redo logs. Otherwise, RMAN returns an error.</p>
<p class="subhead2"><a id="BRADV362"></a>To recover a NOARCHIVELOG database with incremental backups:</p>
<ol>
<li>
<p>After connecting to the target database and the recovery catalog, place the database in a mounted state:</p>
<pre dir="ltr">
STARTUP FORCE MOUNT
</pre></li>
<li>
<p>Restore and recover the database.</p>
<p>For example, you can perform incomplete recovery with the following commands:</p>
<pre dir="ltr">
RESTORE DATABASE 
  FROM TAG "consistent_whole_backup";
RECOVER DATABASE NOREDO;
</pre></li>
<li>
<p>Open the database with the <code dir="ltr">RESETLOGS</code> option.</p>
<p>For example, enter the following command:</p>
<pre dir="ltr">
ALTER DATABASE OPEN RESETLOGS;
</pre></li>
</ol>
</div>
<!-- class="sect1" -->
<a id="CHDBEDCH"></a>
<div id="BRADV85339" class="sect1">
<h2 class="sect1">Restoring the Server Parameter File</h2>
<p><a id="sthref1637"></a><a id="sthref1638"></a>If you lose the server parameter file, then RMAN can restore it to its default location or to a location of your choice. Unlike the loss of the control file, the loss of the server parameter file does not cause the instance to immediately stop. The instance may continue operating, although you must shut it down and restart it after restoring the server parameter file. <a id="sthref1639"></a><a id="sthref1640"></a></p>
<p>Note the following considerations when restoring the server parameter file:</p>
<ul>
<li>
<p>If the instance is already started with the server parameter file, then you cannot overwrite the existing server parameter file.</p>
</li>
<li>
<p>When the instance is started with a client-side initialization parameter file, RMAN restores the server parameter file to the default location if the <code dir="ltr">TO</code> clause is not used in the restore command. The default location is platform-specific, for example, <code dir="ltr">?</code><code dir="ltr">/dbs/spfile.ora</code> on Linux.</p>
</li>
<li>
<p>A recovery catalog simplifies the recovery procedure because you can avoid recording and remembering the DBID. This procedure assumes that you are <span class="italic">not</span> using a recovery catalog.</p>
</li>
</ul>
<p class="subhead2"><a id="BRADV363"></a>To restore the server parameter file from autobackup:</p>
<ol>
<li>
<p>Start RMAN and do one of the following:</p>
<ul>
<li>
<p>If the database instance is started at the time of the loss of the server parameter file, then connect to the target database.</p>
</li>
<li>
<p>If the database instance is not started when the server parameter file is lost, and if you are not using a recovery catalog, then run the <code dir="ltr">SET DBID</code> command to set the DBID of the target database. See <a href="rcmcomre.htm#i1038112">"Determining the DBID of the Database"</a> for details on determining the DBID.</p>
</li>
</ul>
</li>
<li>
<p>Shut down the database instance and restart it without mounting the database.</p>
<p>When the server parameter file is not available, RMAN starts the instance with a dummy parameter file. For example, enter the following command:</p>
<pre dir="ltr">
STARTUP FORCE NOMOUNT;
</pre></li>
<li>
<p>Execute a <code dir="ltr">RUN</code> command to restore the server parameter file.</p>
<p>Depending on the situation, you may need to execute multiple commands in the <code dir="ltr">RUN</code> command. Note the following considerations:</p>
<ul>
<li>
<p>If restoring from tape, then use <code dir="ltr">ALLOCATE CHANNEL</code> to allocate an SBT channel manually. If restoring from disk, then RMAN uses the default disk channel.</p>
</li>
<li>
<p>If the autobackups were not produced with the default format (<code dir="ltr">%F</code>), then use the <code dir="ltr">SET CONTROLFILE AUTOBACKUP FOR DEVICE TYPE</code> command to specify the format in effect when the autobackup was performed.</p>
</li>
<li>
<p>If the most recent autobackup was not created today, then use <code dir="ltr">SET UNTIL</code> to specify the date from which to start the search.</p>
</li>
<li>
<p>If RMAN is not connected to a recovery catalog, then use <code dir="ltr">SET DBID</code> to set the DBID for the target database.</p>
</li>
<li>
<p>To restore the server parameter file to a nondefault location, specify the <code dir="ltr">TO</code> clause or <code dir="ltr">TO PFILE</code> clause on the <code dir="ltr">RESTORE SPFILE</code> command.</p>
</li>
<li>
<p>If you know that RMAN never produces more than <span class="italic">n</span> autobackups each day, then you can set the <code dir="ltr">RESTORE SPFILE FROM AUTOBACKUP ... MAXSEQ</code> parameter to <span class="italic">n</span> to reduce the search time. <code dir="ltr">MAXSEQ</code> is set to 255 by default, and <code dir="ltr">RESTORE</code> counts backward from <code dir="ltr">MAXSEQ</code> to find the last backup of the day. To terminate the restore operation if you do not find the autobackup in the current day (or specified day), set <code dir="ltr">MAXDAYS 1</code> on the <code dir="ltr">RESTORE</code> command.</p>
</li>
</ul>
<p>The following example illustrates a <code dir="ltr">RUN</code> command that restores a server parameter file from an autobackup on tape:</p>
<pre dir="ltr">
RUN 
{
  ALLOCATE CHANNEL c1 DEVICE TYPE sbt PARMS ...;
  SET UNTIL TIME 'SYSDATE-7';
  SET CONTROLFILE AUTOBACKUP FORMAT 
    FOR DEVICE TYPE sbt TO '/disk1/control_files/autobackup_%F';
  SET DBID 123456789;
  RESTORE SPFILE
    TO '/tmp/spfileTEMP.ora'
    FROM AUTOBACKUP MAXDAYS 10;
}
</pre></li>
<li>
<p>Restart the database instance with the restored file.</p>
<p>If you are restarting RMAN with a server parameter file in a nondefault location, then create an initialization parameter file with the line <code dir="ltr">SPFILE=</code><code dir="ltr"><span class="codeinlineitalic">new_location</span></code>, where <code dir="ltr"><span class="codeinlineitalic">new_location</span></code> is the path name of the restored server parameter file. Then, restart the instance with the client-side initialization parameter file.</p>
<p>For example, create a file <code dir="ltr">/tmp/init.ora</code> which contains the single line:</p>
<pre dir="ltr">
SPFILE=/tmp/spfileTEMP.ora
</pre>
<p>You can use the following RMAN command to restart the instance with the restored server parameter file:</p>
<pre dir="ltr">
STARTUP FORCE PFILE=/tmp/init.ora;
</pre></li>
</ol>
<a id="CHDEIIEB"></a>
<div id="BRADV89829" class="sect2">
<h3 class="sect2">Restoring the Server Parameter File from a Control File Autobackup</h3>
<p>If you have configured control file autobackups, then the server parameter file is backed up with the control file whenever an autobackup is taken.</p>
<p>To restore the server parameter file from the control file autobackup, you must first set the DBID for your database and then use the <code dir="ltr">RESTORE SPFILE FROM AUTOBACKUP</code> command. If the autobackup is in a nondefault format, then first use the <code dir="ltr">SET CONTROLFILE AUTOBACKUP FORMAT</code> command to specify the format.</p>
<p><a href="#CHDCEIII">Example 20-1</a> sets the DBID and restores the server parameter file from a control file autobackup in a nondefault location.</p>
<div id="BRADV364" class="example">
<p class="titleinexample"><a id="CHDCEIII"></a>Example 20-1 Restoring the Server Parameter File from a Control File Autobackup</p>
<pre dir="ltr">
SET DBID 320066378;
RUN 
{
  SET CONTROLFILE AUTOBACKUP FORMAT 
    FOR DEVICE TYPE DISK TO '<span class="italic">autobackup_format</span>';
  RESTORE SPFILE FROM AUTOBACKUP;
}
</pre></div>
<!-- class="example" -->
<p>RMAN uses the autobackup format and DBID to hunt for control file autobackups. If a control file autobackup is found, then RMAN restores the server parameter file from that backup to its default location.</p>
<p>To learn how to determine the correct value for <code dir="ltr"><span class="codeinlineitalic">autobackup_format</span></code>, see the description of <code dir="ltr">CONFIGURE CONTROLFILE AUTOBACKUP FORMAT</code> in the entry for the <code dir="ltr">CONFIGURE</code> command in <a class="olink RCMRF113" href="../../backup.112/e10643/rcmsynta010.htm#RCMRF113"><span class="italic">Oracle Database Backup and Recovery Reference</span></a>.</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<a href="rcmcomre.htm#i1038112">"Determining the DBID of the Database"</a> for details on how to determine the DBID</div>
</div>
<!-- class="sect2" -->
<div id="BRADV89830" class="sect2"><a id="sthref1641"></a>
<h3 class="sect2">Creating an Initialization Parameter File with RMAN</h3>
<p>You can also restore the server parameter file as a client-side initialization parameter file with the <code dir="ltr">TO</code> <code dir="ltr">PFILE</code> <code dir="ltr"><span class="codeinlineitalic">'filename'</span></code> clause. The file name that you specify should be on a file system accessible from the host where the RMAN client is running. This file need not be accessible directly from the host running the instance.</p>
<p>The following RMAN command creates an initialization parameter file named <code dir="ltr">/tmp/initTEMP.ora</code> on the system running the RMAN client:</p>
<pre dir="ltr">
RESTORE SPFILE TO PFILE '/tmp/initTEMP.ora';
</pre>
<p>To restart the instance with the initialization parameter file, use the following command, again running RMAN on the same client host:</p>
<pre dir="ltr">
STARTUP FORCE PFILE='/tmp/initTEMP.ora';
</pre></div>
<!-- class="sect2" --></div>
<!-- class="sect1" -->
<a id="i1006245"></a>
<div id="BRADV154" class="sect1">
<h2 class="sect1">Performing Recovery with a Backup Control File</h2>
<p>This section explains what to do when all current control files are lost and you must restore a backup control file.</p>
<div id="BRADV89834" class="sect2"><!-- infolevel="all" infotype="General" --><a id="sthref1642"></a>
<h3 class="sect2">About Recovery with a Backup Control File</h3>
<p>If all copies of the current control file are lost or damaged, then you must restore and mount a backup control file. You must then run the <code dir="ltr">RECOVER</code> command, even if no data files have been restored, and open the database with the <code dir="ltr">RESETLOGS</code> option. <a id="sthref1643"></a><a id="sthref1644"></a>If some copies of the current control file are usable, however, then you can follow the procedure in <a href="osadvsce.htm#CHDFDCGD">"Responding to the Loss of a Subset of the Current Control Files"</a> and avoid the recovery and <code dir="ltr">RESETLOGS</code> operation.</p>
<p>During recovery, RMAN automatically searches for online and archived logs that are not recorded in the RMAN repository and catalogs any that it finds. RMAN attempts to find a valid archived redo log in any current archiving destination with the current log format. The current format is specified in the initialization parameter file used to start the instance (or all instances in an Oracle RAC configuration). Similarly, RMAN attempts to find the online redo logs by using the file names listed in the control file.</p>
<p>If you changed the archiving destination or format during recovery, or if you added new online log members after the backup of the control file, then RMAN may not be able to automatically catalog a needed online or archived log. Whenever RMAN cannot find online redo logs and you did not specify an <code dir="ltr">UNTIL</code> time, RMAN reports errors similar to the following:</p>
<pre dir="ltr">
RMAN-00571: ===========================================================
RMAN-00569: =============== ERROR MESSAGE STACK FOLLOWS ===============
RMAN-00571: ===========================================================
RMAN-03002: failure of recover command at 08/29/2007 14:23:09
RMAN-06054: media recovery requesting unknown log: thread 1 scn 86945
</pre>
<p>In this case, you must use the <code dir="ltr">CATALOG</code> command to manually add the required redo logs to the repository so that recovery can proceed.</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
The discussion of <code dir="ltr">RESTORE CONTROLFILE</code> in <a class="olink RCMRF149" href="../../backup.112/e10643/rcmsynta2008.htm#RCMRF149"><span class="italic">Oracle Database Backup and Recovery Reference</span></a> for more details about restrictions on using <code dir="ltr">RESTORE CONTROLFILE</code> in different scenarios (such as when using a recovery catalog, or restoring from a specific backup)</div>
<div id="BRADV89835" class="sect3"><!-- infolevel="all" infotype="General" --><a id="sthref1645"></a>
<h4 class="sect3">Control File Locations</h4>
<p>When you are restoring the control file, the default destination is all of the locations defined in the <code dir="ltr">CONTROL_FILES</code> initialization parameter. If you do not set the <code dir="ltr">CONTROL_FILES</code> initialization parameter, then the database uses the same rules to determine the destination for the restored control file that it uses when creating a control file if the <code dir="ltr">CONTROL_FILES</code> parameter is not set. These rules are described in <a class="olink SQLRF01203" href="../../server.112/e41084/statements_5003.htm#SQLRF01203"><span class="italic">Oracle Database SQL Language Reference</span></a> in the description of the <code dir="ltr">CREATE CONTROLFILE</code> statement.</p>
<p><a id="sthref1646"></a><a id="sthref1647"></a>One way to restore the control file to one or more new locations is to change the <code dir="ltr">CONTROL_FILES</code><a id="sthref1648"></a><a id="sthref1649"></a> initialization parameter, and then use the <code dir="ltr">RESTORE CONTROLFILE</code> command with no arguments to restore the control file to the default locations. For example, if you are restoring your control file after a disk failure made some but not all <code dir="ltr">CONTROL_FILES</code> locations unusable, you can change <code dir="ltr">CONTROL_FILES</code> to replace references to the failed disk with path names pointing to another disk, and then run <code dir="ltr">RESTORE CONTROLFILE</code> with no arguments.</p>
<p>You can also restore the control file to any location that you choose other than the <code dir="ltr">CONTROL_FILES</code> locations, by using the form <code dir="ltr">RESTORE CONTROLFILE TO</code> <span class="italic">'filename'</span>:</p>
<pre dir="ltr">
RESTORE CONTROLFILE TO '/tmp/my_controlfile';
</pre>
<p>You can perform this operation with the database in <code dir="ltr">NOMOUNT</code>, <code dir="ltr">MOUNT</code>, or <code dir="ltr">OPEN</code> states, because you are not overwriting any of the control files currently in use. Any existing file named <code dir="ltr">'</code><code dir="ltr"><span class="codeinlineitalic">filename</span></code><code dir="ltr">'</code> is overwritten. After restoring the control file to a new location, you can then update the <code dir="ltr">CONTROL_FILES</code> initialization parameter to include the new location.</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<a class="olink RCMRF149" href="../../backup.112/e10643/rcmsynta2008.htm#RCMRF149"><span class="italic">Oracle Database Backup and Recovery Reference</span></a> for <code dir="ltr">RESTORE CONTROLFILE</code> syntax</div>
</div>
<!-- class="sect3" -->
<div id="BRADV89836" class="sect3"><!-- infolevel="all" infotype="General" --><a id="sthref1650"></a>
<h4 class="sect3">Recovery With and Without a Recovery Catalog</h4>
<p>When RMAN is connected to a recovery catalog, the recovery procedure with a backup control file is identical to recovery with a current control file. The RMAN metadata missing from the backup control file is available from the recovery catalog. The only exception is if the database name is not unique in the catalog, in which case you must use <code dir="ltr">SET DBID</code> command before restoring the control file.</p>
<p>If you are not using a recovery catalog, then you must restore your control file from an autobackup. To restore the control file from autobackup, the database must be in a <code dir="ltr">NOMOUNT</code> state. As shown in <a href="#CHDBHDJD">Example 20-2</a>, you must first set the DBID for your database, and then use the <code dir="ltr">RESTORE CONTROLFILE FROM AUTOBACKUP</code> command.</p>
<div id="BRADV365" class="example">
<p class="titleinexample"><a id="CHDBHDJD"></a>Example 20-2 Setting the DBID and Restoring the Control File from Autobackup</p>
<pre dir="ltr">
SET DBID 320066378;
RUN
{
  SET CONTROLFILE AUTOBACKUP FORMAT 
    FOR DEVICE TYPE DISK TO '<span class="italic">autobackup_format</span>';
  RESTORE CONTROLFILE FROM AUTOBACKUP;
}
</pre></div>
<!-- class="example" -->
<p>RMAN uses the autobackup format and DBID to determine where to hunt for the control file autobackup. If one is found, RMAN restores the control file to all control file locations listed in the <code dir="ltr">CONTROL_FILES</code> initialization parameter.</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<ul>
<li>
<p>The description of <code dir="ltr">CONFIGURE CONTROLFILE AUTOBACKUP FORMAT</code> in the entry for <code dir="ltr">CONFIGURE</code> in <a class="olink RCMRF113" href="../../backup.112/e10643/rcmsynta010.htm#RCMRF113"><span class="italic">Oracle Database Backup and Recovery Reference</span></a> to learn how to determine the correct value for the autobackup format.</p>
</li>
<li>
<p>See <a href="rcmcomre.htm#i1038112">"Determining the DBID of the Database"</a> to learn how to determine your DBID.</p>
</li>
</ul>
</div>
</div>
<!-- class="sect3" -->
<div id="BRADV89837" class="sect3"><a id="sthref1651"></a>
<h4 class="sect3">Recovery When Using a Fast Recovery Area</h4>
<p>The commands for restoring a control file are the same whether or not the database uses a fast recovery area. If the database uses a recovery area, then RMAN updates a control file restored from backup by crosschecking all disk-based backups and image copies recorded in the control file. RMAN catalogs any backups in the recovery area that are not recorded. As a result, the restored control file has a complete and accurate record of all backups in the recovery area and any other backups known to the control file at the time of the backup.</p>
<p>RMAN does not automatically crosscheck tape backups after restoring a control file. If you are using tape backups, then you can restore and mount the control file, and optionally crosscheck the backups on tape, as shown in the following example:</p>
<pre dir="ltr">
CROSSCHECK BACKUP DEVICE TYPE sbt;
</pre></div>
<!-- class="sect3" --></div>
<!-- class="sect2" -->
<a id="i1006328"></a>
<div id="BRADV89838" class="sect2">
<h3 class="sect2">Performing Recovery with a Backup Control File and No Recovery Catalog</h3>
<p><a id="sthref1652"></a>This section assumes that you have RMAN backups of the control file, but do not use a recovery catalog. It also assumes that you enabled the control file autobackup feature for the target database and can restore an autobackup of the control file.</p>
<p>Because the autobackup uses a well-known format, RMAN can restore it even though it does not have a repository available that lists the available backups. You can restore the autobackup to the default or a new location. RMAN replicates the control file to all <code dir="ltr">CONTROL_FILES</code> locations automatically.</p>
<div class="infobox-note">
<p class="notep1">Note:</p>
If you know the backup piece name that contains the control file (for example, from the media manager or because the piece is on disk), then you can specify the piece name using the <code dir="ltr">RESTORE</code> <code dir="ltr">CONTROLFILE</code> <code dir="ltr">FROM</code> <code dir="ltr"><span class="codeinlineitalic">'filename'</span></code> command. The database records the location of every autobackup in the alert log.</div>
<p>Because you are not connected to a recovery catalog, the RMAN repository contains only information about available backups at the time of the control file backup. If you know the location of other usable backup sets or image copies, then add them to the control file RMAN repository with the <code dir="ltr">CATALOG</code> command.</p>
<p class="subhead2"><a id="BRADV366"></a>To recover the database with a control file autobackup in NOCATALOG mode:</p>
<ol>
<li>
<p>Start RMAN and connect to a target database.</p>
</li>
<li>
<p>Start the target database instance without mounting the database. For example:</p>
<pre dir="ltr">
STARTUP NOMOUNT;
</pre></li>
<li>
<p>Set the database identifier for the target database with the <code dir="ltr">SET</code> <code dir="ltr">DBID</code> command.</p>
<p>RMAN displays the DBID whenever you connect to a target database. You can also obtain it by inspecting saved RMAN log files, querying the catalog, or looking at the file names of control file autobackup. For example, run:</p>
<pre dir="ltr">
SET DBID 676549873;
</pre></li>
<li>
<p>Write an RMAN command file to restore the autobackup control file and perform recovery.</p>
<p>The command file should contain the following steps:</p>
<ol>
<li>
<p>Optionally, specify the most recent backup time stamp that RMAN can use when searching for a control file autobackup to restore.</p>
</li>
<li>
<p>If you know that a different control file autobackup format was in effect when the control file autobackup was created, then specify a nondefault format for the restore of the control file.</p>
</li>
<li id="CHDIDAIJ">
<p>If an <a href="glossary.htm#CHDCCBFI"><span class="xrefglossterm">SBT</span></a> channel created the control file autobackup, then allocate one or more SBT channels. Because no recovery catalog is available, you cannot use preconfigured channels.</p>
</li>
<li>
<p>Restore the autobackup of the control file, optionally setting the maximum number of days backward that RMAN can search and the initial sequence number that it should use in its search for the first day.</p>
</li>
<li>
<p>If you know that the control file contained information about configured channels that are useful in the rest of the restore process, then you can exit RMAN to clear manually allocated channels from Step <a href="#CHDIDAIJ">c</a>.</p>
<p>If you restart the RMAN client and mount the database, then these configured channels are available for your use. If you do not care about using configured channels from your control file, then you can simply mount the database.</p>
</li>
<li>
<p>This step depends on whether the online redo logs are available. The option <code dir="ltr">OPEN RESETLOGS</code> is always required after recovery with a backup control file, regardless of whether logs are available.</p>
<p>If the online redo logs are usable, then RMAN can find and apply these logs. Perform a complete restore and recovery as described in <a href="rcmcomre.htm#CHDJBEHG">"Performing Complete Database Recovery"</a>.</p>
<p>If the online redo logs are unusable, then perform DBPITR as described in <a href="rcmflash.htm#i1011846">"Performing Database Point-in-Time Recovery"</a>. An <code dir="ltr">UNTIL</code> clause is required to specify a target time, SCN, or log sequence number for the recovery before the first SCN of the online redo logs (otherwise, RMAN issues the <code dir="ltr">RMAN-6054</code> error).</p>
<p>When you perform DBPITR with a backup control file, before opening the database with <code dir="ltr">RESETLOGS</code>, you can open the database read-only using SQL*Plus and run queries as needed to verify that the effects of the logical corruption have been reversed. If you are satisfied with the results, then you can open the database with <code dir="ltr">RESETLOGS</code>.</p>
<div class="infobox-note">
<p class="notep1">Note:</p>
When specifying log sequences, if the last created archived redo log has sequence <span class="italic">n</span>, then specify <code dir="ltr">UNTIL</code> <code dir="ltr">SEQUENCE</code> <code dir="ltr"><span class="codeinlineitalic">n</span></code><code dir="ltr">+1</code> so that RMAN applies <span class="italic">n</span> and then stops.</div>
</li>
</ol>
<p>In the following example, the online redo log files have been lost, and the most recent archived redo log sequence number is 13243. This example shows how to restore the control file autobackup and recover through the latest log.</p>
<pre dir="ltr">
<a id="CHDCEFGD"></a>
RUN 
{
  # Optionally, set upper limit for eligible time stamps of control file 
  # backups
  # SET UNTIL TIME '09/10/2007 13:45:00';
  # Specify a nondefault autobackup format only if required
  # SET CONTROLFILE AUTOBACKUP FORMAT FOR DEVICE TYPE DISK 
  #   TO '?/oradata/%F.bck';
  ALLOCATE CHANNEL c1 DEVICE TYPE sbt PARMS '...'; # allocate manually
  RESTORE CONTROLFILE FROM AUTOBACKUP
    MAXSEQ 100           # start at sequence 100 and count down
    MAXDAYS 180;         # start at UNTIL TIME and search back 6 months
  ALTER DATABASE MOUNT DATABASE;
}
# Now use automatic channels configured in restored control file
RESTORE DATABASE UNTIL SEQUENCE 13244;
RECOVER DATABASE UNTIL SEQUENCE 13244;
</pre></li>
<li>
<p>If recovery was successful, then open the database and reset the online logs:</p>
<pre dir="ltr">
ALTER DATABASE OPEN RESETLOGS;
</pre></li>
</ol>
</div>
<!-- class="sect2" --></div>
<!-- class="sect1" -->
<a id="i1006453"></a>
<div id="BRADV156" class="sect1">
<h2 class="sect1">Performing Disaster Recovery</h2>
<p>Disaster recovery includes the restoration and recovery of the target database after the loss of the entire target database, the recovery catalog database, all current control files, all online redo log files, and all parameter files.<a id="sthref1653"></a><a id="sthref1654"></a><a id="sthref1655"></a></p>
<div id="BRADV89839" class="sect2"><!-- infolevel="all" infotype="General" --><a id="sthref1656"></a>
<h3 class="sect2">Prerequisites of Disaster Recovery</h3>
<p>To perform a disaster recovery, you must have the following:</p>
<ul>
<li>
<p>Backups of all data files</p>
</li>
<li>
<p>All archived redo logs generated after the creation time of the oldest backup that you intend to restore</p>
</li>
<li>
<p>At least one control file autobackup</p>
</li>
<li>
<p>A record of the DBID of the database</p>
</li>
</ul>
</div>
<!-- class="sect2" -->
<div id="BRADV89840" class="sect2"><!-- infolevel="all" infotype="General" --><a id="sthref1657"></a>
<h3 class="sect2">Recovering the Database After a Disaster</h3>
<p>The procedure for disaster recovery is similar to the procedure for recovering the database with a backup control file in <code dir="ltr">NOCATALOG</code> mode. If you are restoring the database to a new host, then you should also review the considerations described in <a href="#i1007814">"Restoring a Database on a New Host"</a>.</p>
<p>This scenario assumes that the Linux server on which your database was running has been damaged beyond repair. Fortunately, you backed up the database to Oracle Secure Backup and have the tapes available. The scenario assumes the following:</p>
<ul>
<li>
<p>Oracle Database is already installed on the new host.</p>
</li>
<li>
<p>You are restoring the database to a new Linux host with the same directory structure as the old host.</p>
</li>
<li>
<p>You have one tape drive containing backups of all the data files and archived redo logs through log 1124, and autobackups of the control file and server parameter file.</p>
</li>
<li>
<p>You do not use a recovery catalog with the database.</p>
</li>
</ul>
<p class="subhead2"><a id="BRADV367"></a>To recover the database on the new host:</p>
<ol>
<li>
<p>If possible, restore or re-create all relevant network files such as <code dir="ltr">tnsnames.ora</code> and <code dir="ltr">listener.ora</code> and a password file.</p>
</li>
<li>
<p>Start RMAN and connect to the target database instance.</p>
<p>At this stage, no initialization parameter file exists. If you have set <code dir="ltr">ORACLE_SID</code> and <code dir="ltr">ORACLE_HOME</code>, then you can use operating system authentication to connect as <code dir="ltr">SYSDBA</code>. For example, start RMAN as follows:</p>
<pre dir="ltr">
% rman
RMAN&gt; CONNECT TARGET /
</pre></li>
<li>
<p>Specify the DBID for the target database with the <code dir="ltr">SET</code> <code dir="ltr">DBID</code> command, as described in <a href="#CHDBEDCH">"Restoring the Server Parameter File"</a>.</p>
<p>For example, enter the following command:</p>
<pre dir="ltr">
SET DBID 676549873;
</pre></li>
<li>
<p>Run the <code dir="ltr">STARTUP</code> <code dir="ltr">NOMOUNT</code> command.</p>
<p>When the server parameter file is not available, RMAN attempts to start the instance with a dummy server parameter file.</p>
</li>
<li>
<p>Allocate a channel to the media manager and then restore the server parameter file from autobackup.</p>
<p>For example, enter the following command to restore the server parameter file from Oracle Secure Backup:</p>
<pre dir="ltr">
RUN
{
  ALLOCATE CHANNEL c1 DEVICE TYPE sbt;
  RESTORE SPFILE FROM AUTOBACKUP;
}
</pre></li>
<li>
<p>Restart the instance with the restored server parameter file.</p>
<pre dir="ltr">
STARTUP FORCE NOMOUNT;
</pre></li>
<li>
<p>Write a command file to perform the restore and recovery operation, and then execute the command file. The command file should do the following:</p>
<ol>
<li>
<p>Allocate a channel to the media manager.</p>
</li>
<li>
<p>Restore a control file autobackup (see <a href="#i1006328">"Performing Recovery with a Backup Control File and No Recovery Catalog"</a>).</p>
</li>
<li>
<p>Mount the restored control file.</p>
</li>
<li>
<p>Catalog any backups not recorded in the repository with the <code dir="ltr">CATALOG</code> command.</p>
</li>
<li>
<p>Restore the data files to their original locations. If volume names have changed, then run <code dir="ltr">SET</code> <code dir="ltr">NEWNAME</code> commands before the restore operation and perform a switch after the restore operation to update the control file with the new locations for the data files, as shown in the following example.</p>
</li>
<li>
<p>Recover the data files. RMAN stops recovery when it reaches the log sequence number specified.</p>
</li>
</ol>
<pre dir="ltr">
RMAN&gt; RUN
{
  # Manually allocate a channel to the media manager
  ALLOCATE CHANNEL t1 DEVICE TYPE sbt;
  # Restore autobackup of the control file. This example assumes that you have 
  # accepted the default format for the autobackup name.
  RESTORE CONTROLFILE FROM AUTOBACKUP;
  #  The set until command is used in case the database
  #  structure has changed in the most recent backups, and you want to
  #  recover to that point in time. In this way RMAN restores the database
  #  to the same structure that the database had at the specified time.
  ALTER DATABASE MOUNT;
  SET UNTIL SEQUENCE 1124 THREAD 1;
  RESTORE DATABASE;
  RECOVER DATABASE;
}
</pre>
<p>The following example of the <code dir="ltr">RUN</code> command shows the same scenario except with new file names for the restored data files:</p>
<pre dir="ltr">
RMAN&gt; RUN
{
  #  If you must restore the files to new locations,
  #  use SET NEWNAME commands:
  SET NEWNAME FOR DATAFILE 1 TO '/dev/vgd_1_0/rlvt5_500M_1';
  SET NEWNAME FOR DATAFILE 2 TO '/dev/vgd_1_0/rlvt5_500M_2';
  SET NEWNAME FOR DATAFILE 3 TO '/dev/vgd_1_0/rlvt5_500M_3';
  ALLOCATE CHANNEL t1 DEVICE TYPE sbt;
  RESTORE CONTROLFILE FROM AUTOBACKUP;
  ALTER DATABASE MOUNT;
  SET UNTIL SEQUENCE 124 THREAD 1;
  RESTORE DATABASE;
  SWITCH DATAFILE ALL; # Update control file with new location of data files.
  RECOVER DATABASE;
}
</pre></li>
<li>
<p>If recovery was successful, then open the database and reset the online logs:</p>
<pre dir="ltr">
ALTER DATABASE OPEN RESETLOGS;
</pre></li>
</ol>
</div>
<!-- class="sect2" --></div>
<!-- class="sect1" -->
<a id="i1007814"></a>
<div id="BRADV908" class="sect1">
<h2 class="sect1">Restoring a Database on a New Host</h2>
<p>If your goal is to perform a test run of your disaster recovery procedures, or to permanently move a database to a new host, then you can use the procedure in this section. This procedure uses the <code dir="ltr">RESTORE</code> and <code dir="ltr">RECOVER</code> commands.</p>
<p>If you use the procedure in this section, then the DBID for the restored database equals the DBID for the original database. Do not register a test database created in this way in the same recovery catalog as the source database. Because the DBID of the two databases is the same, the metadata for the test database can interfere with RMAN's ability to restore and recover the source database.</p>
<p>If your goal is to create a new copy of your target database for ongoing use on a new host, then use the RMAN <code dir="ltr">DUPLICATE</code> command instead of this procedure. The <code dir="ltr">DUPLICATE</code> command assigns a new DBID to the database it creates, enabling it to be registered in the same recovery catalog as the original database.</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<a href="rcmdupdb.htm#CHDJJBCF">"Overview of RMAN Database Duplication"</a> to learn how to duplicate a database</div>
<div id="BRADV89831" class="sect2"><!-- infolevel="all" infotype="General" --><a id="sthref1658"></a>
<h3 class="sect2">Preparing to Restore a Database on a New Host</h3>
<p>To prepare for the restoration of the database to a new host, take the following steps:</p>
<ul>
<li>
<p>Record the DBID for your source database. If you do not know the DBID for your database, then see <a href="rcmcomre.htm#i1038112">"Determining the DBID of the Database"</a> to learn how to determine the DBID.</p>
</li>
<li>
<p>Make the source database initialization parameter file accessible on the new host. Copy the file from the old host to a new host by using an operating system utility.</p>
</li>
<li>
<p>If you perform a test restore operation only, then ensure that RMAN is <span class="italic">not</span> connected to the recovery catalog. Otherwise, RMAN records metadata about the restored data files in the recovery catalog. This metadata interferes with future attempts to restore and recover the primary database.</p>
<p>If you must use a recovery catalog because the control file is not large enough to contain the RMAN repository data on all of the backups that you must restore, then use Oracle Data Pump to export the catalog and import it into a different schema or database. Afterward, use the copied recovery catalog for the test restore. Otherwise, the recovery catalog considers the restored database as the current target database.</p>
</li>
<li>
<p>Ensure that backups used for the restore operation are accessible on the restore host. For example, if the backups were made with a media manager, then verify that the tape device is connected to the new host. If you are using disk copies, then use the procedure in the following section.</p>
</li>
<li>
<p>If you are performing a trial restore of the production database, then perform either of the following actions before restoring the database in the test environment:</p>
<ul>
<li>
<p>If the test database uses a fast recovery area that is physically <span class="italic">different</span> from the recovery area used by the production database, then set <code dir="ltr">DB_RECOVERY_FILE_DEST</code> in the test database instance to the new location.</p>
</li>
<li>
<p>If the test database uses a fast recovery area that is physically the <span class="italic">same</span> as the recovery area used by the production database, then set <code dir="ltr">DB_UNIQUE_NAME</code> in the test database instance to a different name from the production database.</p>
</li>
</ul>
<p>If you do not perform either of the preceding actions, then RMAN assumes that you are restoring the production database and deletes flashback logs from the fast recovery area because they are considered unusable.</p>
</li>
</ul>
<a id="i1006746"></a>
<div id="BRADV89832" class="sect3">
<h4 class="sect3">Restoring Disk Backups to a New Host</h4>
<p><a id="i1006748"></a>To move the database to a new host by using data file copies or backup sets on disk, you must transfer the files manually to the new host. This example assumes that RMAN is using a recovery catalog.</p>
<p class="subhead2"><a id="BRADV368"></a>To restore backup files to a new host:</p>
<ol>
<li>
<p>Start RMAN and connect to a target database and recovery catalog.</p>
</li>
<li>
<p>Run a <code dir="ltr">LIST</code> command to see a listing of backups of the data file and control file autobackups.</p>
<p>For example, enter the following command to view data file copies:</p>
<pre dir="ltr">
LIST COPY;
</pre>
<p>For example, enter the following command to view control file backups:</p>
<pre dir="ltr">
LIST BACKUP OF CONTROLFILE;
</pre>
<p>The piece name of the autobackup must use the <code dir="ltr">%F</code> substitution variable, so the autobackup piece name includes the string <code dir="ltr">c-IIIIIIIIII-YYYYMMDD-QQ</code>, where <code dir="ltr">IIIIIIIIII</code> stands for the DBID, <code dir="ltr">YYYYMMDD</code> is a time stamp in the Gregorian calendar of the day the backup is generated, and <code dir="ltr">QQ</code> is the sequence in hexadecimal.</p>
</li>
<li>
<p>Copy the backups to the new host with an operating system utility.</p>
<p>Enter a command such as the following to copy all data file copies to the <code dir="ltr">?/oradata/trgt</code> directory on the new host:</p>
<pre dir="ltr">
% cp -r /disk1/*dbf /net/new_host/oracle/oradata/trgt
</pre>
<p>Enter a command such as the following to copy the autobackup backup piece to the <code dir="ltr">/tmp</code> directory on the new host:</p>
<pre dir="ltr">
% cp -r /disk1/auto_bkp_loc/c-1618370911-20070208-00 /net/new_host/tmp
</pre>
<p>As explained in <a href="#CHDEIIEB">"Restoring the Server Parameter File from a Control File Autobackup"</a>, you must use the <code dir="ltr">SET CONTROLFILE AUTOBACKUP FORMAT</code> command when restoring an autobackup from a nondefault location.</p>
</li>
</ol>
</div>
<!-- class="sect3" --></div>
<!-- class="sect2" -->
<a id="i1008662"></a>
<div id="BRADV89833" class="sect2">
<h3 class="sect2">Testing the Restore of a Database on a New Host</h3>
<p>This scenario assumes that you want to test whether you can restore your database to a new host. In this scenario, you have two networked Linux hosts, <code dir="ltr">hosta</code> and <code dir="ltr">hostb</code>. A target database named <code dir="ltr">trgta</code> is on <code dir="ltr">hosta</code> and is registered in recovery catalog <code dir="ltr">catdb</code>. You want to test the restore and recovery of <code dir="ltr">trgta</code> on <code dir="ltr">hostb</code>, while keeping database <code dir="ltr">trgta</code> up and running on <code dir="ltr">hosta</code>.</p>
<p>Now, assume that the directory structure of <code dir="ltr">hostb</code> is different from <code dir="ltr">hosta</code>. The target database is located in <code dir="ltr">/net/hosta/dev3/oracle/dbs</code>, but you want to restore the database to <code dir="ltr">/net/hostb/oracle/oradata/test</code>. You have tape backups of data files, control files, archived redo logs, and the server parameter file on a media manager accessible by both hosts. The <code dir="ltr">ORACLE_SID</code> for the <code dir="ltr">trgta</code> database is <code dir="ltr">trgta</code> and does not change for the restored database.</p>
<div class="infobox-note">
<p class="notep1">Caution:</p>
If you are restoring the database for test purposes, then <span class="italic">never</span> connect RMAN to the test database and the recovery catalog.</div>
<p class="subhead2"><a id="BRADV369"></a>To restore the database on a new host:</p>
<ol>
<li>
<p>Ensure that the backups of the target database are accessible on the new host.</p>
<p>To test disaster recovery, you must have a recoverable backup of the target database. When preparing your disaster recovery strategy, ensure that the backups of the data files, control files, and server parameter file are restorable on <code dir="ltr">hostb</code>. Thus, you must configure the media management software so that <code dir="ltr">hostb</code> is a media manager client and can read the backup sets created on <code dir="ltr">hosta</code>. Consult the media management vendor for support on this issue.</p>
</li>
<li>
<p>Configure the <code dir="ltr">ORACLE_SID</code> on <code dir="ltr">hostb</code>.</p>
<p>This scenario assumes that you want to start the RMAN client on <code dir="ltr">hostb</code> and authenticate yourself through the operating system. However, you must be connected to <code dir="ltr">hostb</code> either locally or through a net service name.</p>
<p>After logging in to <code dir="ltr">hostb</code> with administrator privileges, edit the <code dir="ltr">/etc/group</code> file so that you are included in the DBA group:</p>
<pre dir="ltr">
dba:*:614:&lt;your_user_name&gt;
</pre>
<p>Set the <code dir="ltr">ORACLE_SID</code> environment variable on <code dir="ltr">hostb</code> to the same value used on <code dir="ltr">hosta</code>:</p>
<pre dir="ltr">
% setenv ORACLE_SID trgta
</pre></li>
<li>
<p>Start RMAN on <code dir="ltr">hostb</code> and connect to the target database <span class="italic">without</span> connecting to the recovery catalog.</p>
<p>For example, enter the following command:</p>
<pre dir="ltr">
% rman NOCATALOG
RMAN&gt; CONNECT TARGET /
</pre></li>
<li>
<p>Set the DBID and start the database instance without mounting the database.</p>
<p>For example, run <code dir="ltr">SET</code> <code dir="ltr">DBID</code> to set the DBID, then run <code dir="ltr">STARTUP</code> <code dir="ltr">NOMOUNT</code>:</p>
<pre dir="ltr">
SET DBID 1340752057;
STARTUP NOMOUNT
</pre>
<p>RMAN fails to find the server parameter file, which has not yet been restored, but starts the instance with a "dummy" file. Sample output follows:</p>
<pre dir="ltr">
startup failed: ORA-01078: failure in processing system parameters
LRM-00109: could not open parameter file '/net/hostb/oracle/dbs/inittrgta.ora'

trying to start the Oracle instance without parameter files ...
Oracle instance started
</pre></li>
<li>
<p>Restore and edit the server parameter file.</p>
<p>Because you enabled the control file autobackup feature when making your backups, the server parameter file is included in the backup. If you are restoring an autobackup that has a nondefault format, then use the <code dir="ltr">SET CONTROLFILE AUTOBACKUP FORMAT</code> command to indicate the format.</p>
<p>Allocate a channel to the media manager, then restore the server parameter file as a client-side parameter file and use the <code dir="ltr">SET</code> command to indicate the location of the autobackup (in this example, the autobackup is in <code dir="ltr">/tmp</code>):</p>
<pre dir="ltr">
RUN
{
  ALLOCATE CHANNEL c1 DEVICE TYPE sbt PARMS '...';
  SET CONTROLFILE AUTOBACKUP FORMAT FOR DEVICE TYPE DISK TO '/tmp/%F';
  RESTORE SPFILE 
    TO PFILE '?/oradata/test/inittrgta.ora' 
    FROM AUTOBACKUP;
  SHUTDOWN ABORT;
}
</pre></li>
<li>
<p>Edit the restored initialization parameter file.</p>
<p>Change any location-specific parameters, for example, those ending in <code dir="ltr">_DEST</code>, to reflect the new directory structure. For example, edit the following parameters:</p>
<pre dir="ltr">
  - IFILE
  - LOG_ARCHIVE_DEST_1
  - CONTROL_FILES
</pre></li>
<li>
<p>Restart the instance with the edited initialization parameter file.</p>
<p>For example, enter the following command:</p>
<pre dir="ltr">
STARTUP FORCE NOMOUNT PFILE='?/oradata/test/inittrgta.ora';
</pre></li>
<li>
<p>Restore the control file from an autobackup and then mount the database.</p>
<p>For example, enter the following command:</p>
<pre dir="ltr">
RUN 
{
  ALLOCATE CHANNEL c1 DEVICE TYPE sbt PARMS '...';
  RESTORE CONTROLFILE FROM AUTOBACKUP;
  ALTER DATABASE MOUNT;
}
</pre>
<p>RMAN restores the control file to whatever locations you specified in the <code dir="ltr">CONTROL_FILES</code> initialization parameter.</p>
</li>
<li>
<p>Catalog the data file copies that you copied in <a href="#i1006746">"Restoring Disk Backups to a New Host"</a>, using their new file names or <code dir="ltr">CATALOG START</code> <code dir="ltr">WITH</code> (if you know all the files are in directories with a common prefix easily addressed with a <code dir="ltr">CATALOG START WITH</code> command). For example, run:</p>
<pre dir="ltr">
CATALOG START WITH '/oracle/oradata/trgt/';
</pre>
<p>If you want to specify files individually, then you can execute a <code dir="ltr">CATALOG</code> command as follows:</p>
<pre dir="ltr">
CATALOG DATAFILECOPY
  '/oracle/oradata/trgt/system01.dbf', '/oracle/oradata/trgt/undotbs01.dbf', 
  '/oracle/oradata/trgt/cwmlite01.dbf', '/oracle/oradata/trgt/drsys01.dbf',
  '/oracle/oradata/trgt/example01.dbf', '/oracle/oradata/trgt/indx01.dbf', 
  '/oracle/oradata/trgt/tools01.dbf', '/oracle/oradata/trgt/users01.dbf';
</pre></li>
<li>
<p>Start a SQL*Plus session on the new database and query the database file names recorded in the control file.</p>
<p>Because the control file is from the <code dir="ltr">trgta</code> database, the recorded file names use the original <code dir="ltr">hosta</code> file names. You can query <code dir="ltr">V$</code> views to obtain this information. Run the following query in SQL*Plus:</p>
<pre dir="ltr">
COLUMN NAME FORMAT a60
SPOOL  LOG '/tmp/db_filenames.out'
SELECT FILE# AS "File/Grp#", NAME 
FROM   V$DATAFILE
UNION
SELECT GROUP#,MEMBER 
FROM   V$LOGFILE;
SPOOL OFF
EXIT
</pre></li>
<li>
<p>Write the RMAN restore and recovery script. The script must include the following steps:</p>
<ol>
<li>
<p>For each data file on the destination host that is restored to a different path than it had on the source host, use a <code dir="ltr">SET</code> <code dir="ltr">NEWNAME</code> command to specify the new path on the destination host. If the file systems on the destination system are set up to have the same paths as the source host, then do not use <code dir="ltr">SET NEWNAME</code> for those files restored to the same path as on the source host.</p>
</li>
<li>
<p>For each online redo log that is to be created at a different location than it had on the source host, use SQL <code dir="ltr">ALTER</code> <code dir="ltr">DATABASE</code> <code dir="ltr">RENAME</code> <code dir="ltr">FILE</code> commands to specify the path name on the destination host. If the file systems on the destination system are set up to have the same paths as the source host, then do not use <code dir="ltr">ALTER DATABASE RENAME FILE</code> for those files restored to the same path as on the source host.</p>
</li>
<li>
<p>Perform a <code dir="ltr">SET UNTIL</code> operation to limit recovery to the end of the archived redo logs. The recovery stops with an error if no <code dir="ltr">SET UNTIL</code> command is specified.</p>
</li>
<li>
<p>Restore and recover the database.</p>
</li>
<li>
<p>Run the <code dir="ltr">SWITCH DATAFILE ALL</code> command so that the control file recognizes the new path names as the official new names of the data files.</p>
</li>
</ol>
<p><a href="#CHDDGIFI">Example 20-3</a> shows the RMAN script <code dir="ltr">reco_test.rman</code> that can perform the restore and recovery operation.</p>
<div id="BRADV370" class="example">
<p class="titleinexample"><a id="CHDDGIFI"></a>Example 20-3 Restoring a Database on a New Host</p>
<pre dir="ltr">
RUN
{
  # allocate a channel to the tape device
  ALLOCATE CHANNEL c1 DEVICE TYPE sbt PARMS '...';

  # rename the data files and online redo logs
  SET NEWNAME FOR DATAFILE 1 TO '?/oradata/test/system01.dbf';
  SET NEWNAME FOR DATAFILE 2 TO '?/oradata/test/undotbs01.dbf';
  SET NEWNAME FOR DATAFILE 3 TO '?/oradata/test/cwmlite01.dbf';
  SET NEWNAME FOR DATAFILE 4 TO '?/oradata/test/drsys01.dbf';
  SET NEWNAME FOR DATAFILE 5 TO '?/oradata/test/example01.dbf';
  SET NEWNAME FOR DATAFILE 6 TO '?/oradata/test/indx01.dbf';
  SET NEWNAME FOR DATAFILE 7 TO '?/oradata/test/tools01.dbf';
  SET NEWNAME FOR DATAFILE 8 TO '?/oradata/test/users01.dbf';
  SQL "ALTER DATABASE RENAME FILE ''/dev3/oracle/dbs/redo01.log''
      TO ''?/oradata/test/redo01.log'' ";
  SQL "ALTER DATABASE RENAME FILE ''/dev3/oracle/dbs/redo02.log''
      TO ''?/oradata/test/redo02.log'' ";

  # Do a SET UNTIL to prevent recovery of the online logs
  SET UNTIL SCN 123456;
  # restore the database and switch the data file names
  RESTORE DATABASE;
  SWITCH DATAFILE ALL;

  # recover the database
  RECOVER DATABASE;
}
EXIT
</pre></div>
<!-- class="example" --></li>
<li>
<p>Execute the script created in the previous step.</p>
<p>For example, start RMAN to connect to the target database and run the <code dir="ltr">@</code> command:</p>
<pre dir="ltr">
% rman TARGET / NOCATALOG
RMAN&gt; @reco_test.rman
</pre></li>
<li>
<p>Open the restored database with the <code dir="ltr">RESETLOGS</code> option.</p>
<p>From the RMAN prompt, open the database with the <code dir="ltr">RESETLOGS</code> option:</p>
<pre dir="ltr">
ALTER DATABASE OPEN RESETLOGS;
</pre>
<div class="infobox-note">
<p class="notep1">Caution:</p>
When you re-open your database in the next step, do not connect to the recovery catalog. Otherwise, the new database incarnation created is registered automatically in the recovery catalog, and the file names of the production database are replaced by the new file names specified in the script.</div>
</li>
<li>
<p>Optionally, delete the test database with all of its files.</p>
<div class="infobox-note">
<p class="notep1">Note:</p>
If you used an ASM disk group, then the <code dir="ltr">DROP DATABASE</code> command is the only way to safely remove the files of the test database. If you restored to non-ASM storage then you can also use operating system commands to remove the database.</div>
<p>Use the <code dir="ltr">DROP DATABASE</code> command to delete all files associated with the database automatically. The following example deletes the database files:</p>
<pre dir="ltr">
STARTUP FORCE NOMOUNT PFILE='?/oradata/test/inittrgta.ora';
DROP DATABASE;
</pre>
<p>Because you did not perform the restore and recovery operation when connected to the recovery catalog, the recovery catalog contains no records for any of the restored files or the procedures performed during the test. Likewise, the control file of the <code dir="ltr">trgta</code> database is completely unaffected by the test.</p>
</li>
</ol>
</div>
<!-- class="sect2" --></div>
<!-- class="sect1" --></div>
<!-- class="chapter" --></div>
<!-- class="ind" -->
<!-- Start Footer -->
</div>
<!-- add extra wrapper close div-->
<footer><!--
<hr />
<table class="cellalignment1933">
<tr>
<td class="cellalignment1942">
<table class="cellalignment1938">
<tr>
<td class="cellalignment1937"><a href="rcmblock.htm"><img width="24" height="24" src="../../dcommon/gifs/leftnav.gif" alt="Go to previous page" /><br />
<span class="icon">Previous</span></a></td>
<td class="cellalignment1937"><a href="rcmtspit.htm"><img width="24" height="24" src="../../dcommon/gifs/rightnav.gif" alt="Go to next page" /><br />
<span class="icon">Next</span></a></td>
</tr>
</table>
</td>
<td class="cellalignment-copyrightlogo"><img width="144" height="18" src="../../dcommon/gifs/oracle.gif" alt="Oracle" /><br />
Copyright&nbsp;&copy;&nbsp;2003, 2015,&nbsp;Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved.<br />
<a href="../../dcommon/html/cpyr.htm">Legal Notices</a></td>
<td class="cellalignment1944">
<table class="cellalignment1936">
<tr>
<td class="cellalignment1937"><a href="../../index.htm"><img width="24" height="24" src="../../dcommon/gifs/doclib.gif" alt="Go to Documentation Home" /><br />
<span class="icon">Home</span></a></td>
<td class="cellalignment1937"><a href="../../nav/portal_booklist.htm"><img width="24" height="24" src="../../dcommon/gifs/booklist.gif" alt="Go to Book List" /><br />
<span class="icon">Book List</span></a></td>
<td class="cellalignment1937"><a href="toc.htm"><img width="24" height="24" src="../../dcommon/gifs/toc.gif" alt="Go to Table of Contents" /><br />
<span class="icon">Contents</span></a></td>
<td class="cellalignment1937"><a href="index.htm"><img width="24" height="24" src="../../dcommon/gifs/index.gif" alt="Go to Index" /><br />
<span class="icon">Index</span></a></td>
<td class="cellalignment1937"><a href="../../nav/mindx.htm"><img width="24" height="24" src="../../dcommon/gifs/masterix.gif" alt="Go to Master Index" /><br />
<span class="icon">Master Index</span></a></td>
<td class="cellalignment1937"><a href="../../dcommon/html/feedback.htm"><img width="24" height="24" src="../../dcommon/gifs/feedbck2.gif" alt="Go to Feedback page" /><br />
<span class="icon">Contact Us</span></a></td>
</tr>
</table>
</td>
</tr>
</table>
--></footer>
<noscript>
<p>Scripting on this page enhances content navigation, but does not change the content in any way.</p>
</noscript>
</body>
</html>
