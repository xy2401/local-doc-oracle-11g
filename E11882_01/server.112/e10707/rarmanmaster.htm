<!DOCTYPE html>
<html lang="en" >
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta charset="utf-8">
<title>Managing a Master Replication Environment</title>
<meta name="generator" content="Oracle DARB XHTML Converter (Mode = document) - Version 5.1.2 Build 732" />
<meta name="dcterms.created" content="2013-06-04T10:28:45Z" />
<meta name="robots" content="all" />
<meta name="dcterms.title" content="Database Advanced Replication Management API Reference" />
<meta name="dcterms.identifier" content="E10707-05" />
<meta name="dcterms.isVersionOf" content="REPMA" />
<meta name="dcterms.rights" content="Copyright&nbsp;&copy;&nbsp;1996, 2013,&nbsp;Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved." />
<link rel="Start" href="../../index.htm" title="Home" type="text/html" />
<link rel="Copyright" href="../../dcommon/html/cpyr.htm" title="Copyright" type="text/html" />

<script type="application/javascript"  src="../../dcommon/js/headfoot.js"></script>
<script type="application/javascript"  src="../../nav/js/doccd.js"></script>
<link rel="Contents" href="toc.htm" title="Contents" type="text/html" />
<link rel="Index" href="index.htm" title="Index" type="text/html" />
<link rel="Prev" href="rarpart2.htm" title="Previous" type="text/html" />
<link rel="Next" href="rarmanmv.htm" title="Next" type="text/html" />
<link rel="alternate" href="../e10707.pdf" title="PDF version" type="application/pdf" />
<link rel="schema.dcterms" href="http://purl.org/dc/terms/" />
<link rel="stylesheet" href="../../dcommon/css/fusiondoc.css">
<link rel="stylesheet" type="text/css"  href="../../dcommon/css/header.css">
<link rel="stylesheet" type="text/css"  href="../../dcommon/css/footer.css">
<link rel="stylesheet" type="text/css"  href="../../dcommon/css/fonts.css">
<link rel="stylesheet" href="../../dcommon/css/foundation.css">
<link rel="stylesheet" href="../../dcommon/css/codemirror.css">
<link rel="stylesheet" type="text/css" title="Default" href="../../nav/css/html5.css">
<link rel="stylesheet" href="../../dcommon/css/respond-480-tablet.css">
<link rel="stylesheet" href="../../dcommon/css/respond-768-laptop.css">
<link rel="stylesheet" href="../../dcommon/css/respond-1140-deskop.css">
<script type="application/javascript" src="../../dcommon/js/modernizr.js"></script>
<script type="application/javascript" src="../../dcommon/js/codemirror.js"></script>
<script type="application/javascript" src="../../dcommon/js/jquery.js"></script>
<script type="application/javascript" src="../../dcommon/js/foundation.min.js"></script>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-552992c80ef99c8d" async="async"></script>
<script type="application/javascript" src="../../dcommon/js/jqfns.js"></script>
<script type="application/javascript" src="../../dcommon/js/ohc-inline-videos.js"></script>
<!-- Add fancyBox -->
<link rel="stylesheet" href="../../dcommon/fancybox/jquery.fancybox.css?v=2.1.5" type="text/css" media="screen" />
<script type="text/javascript" src="../../dcommon/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>
<!-- Optionally add helpers - button, thumbnail and/or media -->
<link rel="stylesheet"  href="../../dcommon/fancybox/helpers/jquery.fancybox-buttons.css?v=1.0.5"  type="text/css" media="screen" />
<script type="text/javascript" src="../../dcommon/fancybox/helpers/jquery.fancybox-buttons.js?v=1.0.5"></script>
<script type="text/javascript" src="../../dcommon/fancybox/helpers/jquery.fancybox-media.js?v=1.0.6"></script>
<link rel="stylesheet"  href="../../dcommon/fancybox/helpers/jquery.fancybox-thumbs.css?v=1.0.7"  type="text/css" media="screen" />
<script type="text/javascript" src="../../dcommon/fancybox/helpers/jquery.fancybox-thumbs.js?v=1.0.7"></script>
</head>
<body>
<a href="#BEGIN" class="accessibility-top skipto" tabindex="0">Go to main content</a><header><!--
<div class="zz-skip-header"><a id="top" href="#BEGIN">Go to main content</a>--></header>
<div class="row" id="CONTENT">
<div class="IND large-9 medium-8 columns" dir="ltr">
<a id="BEGIN" name="BEGIN"></a>
<span id="PAGE" style="display:none;">12/37</span> <!-- End Header -->
<div id="REPMA007" class="chapter"><a id="i22117"></a><a id="CHDBCBCI"></a>
<h1 class="chapter"><span class="secnum">7</span> Managing a Master Replication Environment</h1>
<p>As your data delivery needs change due to growth, shrinkage, or emergencies, you are undoubtedly going to need to change the configuration of your replication environment. This chapter discusses managing the master sites of your replication environment. Specifically, this section describes altering and reconfiguring your master sites.</p>
<p>This chapter contains these topics:</p>
<ul>
<li>
<p><a href="#i14563">Changing the Master Definition Site</a></p>
</li>
<li>
<p><a href="#i33123">Adding New Master Sites</a></p>
</li>
<li>
<p><a href="#i30502">Removing a Master Site from a Master Group</a></p>
</li>
<li>
<p><a href="#i20106">Updating the Comments Fields in Data Dictionary Views</a></p>
</li>
<li>
<p><a href="#i22642">Using Procedural Replication</a></p>
</li>
</ul>
<a id="i14563"></a>
<div id="REPMA368" class="sect1">
<h2 class="sect1">Changing the Master Definition Site<a id="sthref475"></a></h2>
<p>Many replication administrative tasks can be performed only from the master definition site. Use the <code>RELOCATE_MASTERDEF</code> procedure in the <code>DBMS_REPCAT</code> package to move the master definition site to another master site. This API is especially useful when the master definition site becomes unavailable and you must specify a new master definition site (see <a href="#i12993">"Option 2: The Old Master Definition Site Is Not Available"</a>).</p>
<div id="REPMA369" class="sect2"><a id="sthref476"></a>
<h3 class="sect2">Option 1: All Master Sites Are Available</h3>
<p>Perform the actions in this section to change the master definition site if all master sites are available. Meet the following requirements to complete these actions:</p>
<p><span class="bold">Executed As</span>: Replication Administrator</p>
<p><span class="bold">Executed At</span>: Any Master Site</p>
<p><span class="bold">Replication Status</span>: Running Normally (Not Quiesced)</p>
<p>Complete the following steps:</p>
<dl>
<dd><a id="REPMA1211"></a><a id="sthref477"></a></dd>
<dt class="seghead">Step 1&nbsp;&nbsp;&nbsp;In SQL*Plus, connect to a master site as the replication administrator.</dt>
<dd>
<p>See <a class="olink ADMIN00102" href="../../server.112/e25494/dba.htm#ADMIN00102"><span class="italic">Oracle Database Administrator's Guide</span></a> for information about connecting to a database in SQL*Plus.</p>
</dd>
<dd><a id="REPMA1212"></a><a id="sthref478"></a></dd>
<dt class="seghead">Step 2&nbsp;&nbsp;&nbsp;Relocate the master definition site.</dt>
<dd>
<pre>
BEGIN
</pre>
<pre>
   <a href="rarrcatpac.htm#i98605">DBMS_REPCAT.RELOCATE_MASTERDEF (</a><a id="sthref479"></a><a id="sthref480"></a>
      gname =&gt; 'hr_repg',
      old_masterdef =&gt; 'orc1.example.com',
      new_masterdef =&gt; 'orc2.example.com',
      notify_masters =&gt; TRUE,
      include_old_masterdef =&gt; TRUE);
END;
/
</pre></dd>
</dl>
</div>
<!-- class="sect2" -->
<a id="i12993"></a>
<div id="REPMA370" class="sect2">
<h3 class="sect2">Option 2: The Old Master Definition Site Is Not Available</h3>
<p>Perform the actions in this section to change the master definition site if the old master definition site is <span class="italic">not</span> available. Meet the following requirements to complete these actions:</p>
<p><span class="bold">Executed As</span>: Replication Administrator</p>
<p><span class="bold">Executed At</span>: Any Master Site</p>
<p><span class="bold">Replication Status</span>: Normal</p>
<p>Complete the following steps:</p>
<dl>
<dd><a id="REPMA1213"></a><a id="sthref481"></a></dd>
<dt class="seghead">Step 1&nbsp;&nbsp;&nbsp;In SQL*Plus, connect to a master site as the replication administrator.</dt>
<dd>
<p>See <a class="olink ADMIN00102" href="../../server.112/e25494/dba.htm#ADMIN00102"><span class="italic">Oracle Database Administrator's Guide</span></a> for information about connecting to a database in SQL*Plus.</p>
</dd>
<dd><a id="REPMA1214"></a><a id="sthref482"></a></dd>
<dt class="seghead">Step 2&nbsp;&nbsp;&nbsp;Relocate the master definition site.</dt>
<dd>
<pre>
BEGIN
</pre>
<pre>
   <a href="rarrcatpac.htm#i98605">DBMS_REPCAT.RELOCATE_MASTERDEF (</a>
      gname =&gt; 'hr_repg',
      old_masterdef =&gt; 'orc1.example.com',
      new_masterdef =&gt; 'orc2.example.com',
      notify_masters =&gt; TRUE,
      include_old_masterdef =&gt; FALSE);
END;
/
</pre></dd>
</dl>
</div>
<!-- class="sect2" --></div>
<!-- class="sect1" -->
<a id="i33123"></a>
<div id="REPMA371" class="sect1">
<h2 class="sect1">Adding New Master Site<a id="sthref483"></a><a id="sthref484"></a><a id="sthref485"></a>s</h2>
<p>As your replication environment expands, you might need to add new master sites to a master group. You can either add new master sites to a master group that is running normally or to a master group that is quiesced. If the master group is not quiesced, then users can perform data manipulation language (DML) operations on the data while the new master sites are being added. However, more administrative actions are required when adding new master sites if the master group is not quiesced.</p>
<div class="infobox-note">
<p class="notep1"><a id="i36060"></a>Note:</p>
<a id="sthref486"></a><a id="sthref487"></a>When adding a master site to a master group that contains tables with circular dependencies or a table that contains a self-referential constraint, you must precreate the table definitions and manually load the data at the new master site. The following is an example of a circular dependency: Table A has a foreign key constraint on table B, and table B has a foreign key constraint on table A.</div>
<p>Follow the instructions in the appropriate section to add new master sites to a master group:</p>
<ul>
<li>
<p><a href="#i23751">Adding New Master Sites without Quiescing the Master Group</a></p>
</li>
<li>
<p><a href="#i23756">Adding New Master Sites to a Quiesced Master Group</a></p>
</li>
</ul>
<a id="i23751"></a>
<div id="REPMA372" class="sect2">
<h3 class="sect2">Adding New Master Sites without Quiescing the Master Group<a id="sthref488"></a><a id="sthref489"></a><a id="sthref490"></a><a id="sthref491"></a><a id="sthref492"></a></h3>
<p>This section contains procedures for adding new master sites to an existing master group that is not quiesced. These new sites might or might not already be replication sites (master sites or materialized view sites) in other replication groups.</p>
<p>You can use one of the following methods when you are adding a new master site without quiescing the master group:</p>
<ul>
<li>
<p>Use full database export/import or change-based recovery to add a new master site that does not currently have any replication groups. See <a href="#i28373">"Using Full Database Export/Import or Change-Based Recovery"</a> for instructions.</p>
</li>
<li>
<p>Use object-level export/import to add a new master site that already has other replication groups or to add a new master site that does not currently have any replication groups. See <a href="#i24655">"Using Object-Level Export/Import"</a> for instructions.</p>
</li>
</ul>
<p><a id="sthref493"></a><a id="sthref494"></a>Use full database export/import and change-based recovery to add all of the replication groups at the master definition site to the new master sites. When you use this method, the following conditions apply:</p>
<ul>
<li>
<p>The new master sites cannot have any existing replication groups.</p>
</li>
<li>
<p>The master definition site cannot have any materialized view groups.</p>
</li>
<li>
<p>The master definition site must be the same for all of the master groups. If one or more of these master groups have a different master definition site, then do not use full database export/import or change-based recovery. Use object-level export/import instead.</p>
</li>
<li>
<p>The new master site must include all of the replication groups in the master definition site when the extension process is complete. That is, you cannot add a subset of the master groups at the master definition site to the new master site. All of the groups must be added.</p>
</li>
</ul>
<p>If your environment does not meet all of these conditions, then you must use object-level export/import to add the new master sites. <a href="#i34005">Figure 7-1</a> summarizes these conditions.</p>
<div class="infobox-note">
<p class="notep1">Note:</p>
To use change-based recovery, the existing master site and the new master site must be running under the same operating system, although the release of the operating system can differ. This condition does not apply to full database export/import.</div>
<div id="REPMA373" class="figure">
<p class="titleinfigure"><a id="i34005"></a>Figure 7-1 Determining Which Method to Use When Adding Master Sites<a id="sthref495"></a></p>
<img width="600" height="538" src="img/repma017.gif" alt="Description of Figure 7-1 follows" /><br />
<a id="sthref496" href="img_text/repma017.htm">Description of "Figure 7-1 Determining Which Method to Use When Adding Master Sites"</a><br />
<br /></div>
<!-- class="figure" -->
<p>Use object-level export/import to add a master group to master sites that already have other replication groups or to add a master group to master sites that do not currently have any replication groups. This method can add one or more master groups to new master sites at a time, and you can choose a subset of the master groups at the master definition site to add to the new master sites during the operation.</p>
<p>If you use object-level export/import and there are integrity constraints that span multiple master groups, then you must temporarily disable these integrity constraints on the table being added to a new master site, if the other tables to which these constraints refer exist at the new master site. Initially, there are two rows in the <code>DEFSCHEDULE</code> data dictionary view that refer to the new master sites. When propagation is caught up, there is one row in this view, and when propagation from all the master sites to the new master site is caught up, you can reenable the integrity constraints you disabled.</p>
<p>Again, the two methods for adding new master sites without quiescing the master groups are the following:</p>
<ul>
<li>
<p>Full database export/import or change-based recovery</p>
</li>
<li>
<p>Object-level export/import</p>
</li>
</ul>
<p>When you use either method, propagation of deferred transactions to the new master site is partially or completely disabled while the new master sites are being added. Therefore, ensure that each existing master site has enough free space to store the largest unpropagated deferred transaction queue that you might encounter.</p>
<p><a id="sthref497"></a>In addition, the following restrictions apply to both methods:</p>
<ul>
<li>
<p>All affected master groups must be using asynchronous replication. Synchronous replication is not allowed.</p>
</li>
<li>
<p>All scheduled links must use parallel propagation with parallelism set to 1 or higher.</p>
</li>
<li>
<p>Either the database links of all affected master groups must have no connection qualifier or they must all have the same connection qualifier.</p>
</li>
<li>
<p>After you begin the process of adding new master sites to one or more master groups, you must wait until these new master sites are added before you begin to add another set of master sites to any of the affected master groups. If there is information about an affected master group in the <code>DBA_NEW_REPSITES</code> data dictionary view at the master definition site, then the process is started and is not yet complete for that master group.</p>
</li>
<li>
<p>After you begin the process of adding new master sites to one or more master groups, you cannot relocate the master definition site for these master groups until the new master sites are added. If there is information about an affected master group in the <code>DBA_NEW_REPSITES</code> data dictionary view, then the process is started and is not yet complete for that master group.</p>
</li>
<li>
<p>Only one add master site request at a time is allowed at a master site. For example, if <code>hq1.example.com</code> is the master definition site for <code>mgroup1</code> and <code>hq2.example.com</code> is the master definition site for <code>mgroup2</code>, then you cannot add <code>hq1.example.com</code> to <code>mgroup2</code> and <code>hq2.example.com</code> to <code>mgroup1</code> at the same time.</p>
</li>
<li>
<p>If you are using object-level or full database export/import, then ensure that there is enough space in your rollback segments or undo tablespace for the export.</p>
</li>
</ul>
<p>Also, before adding new master sites with either method, ensure that you properly set up your new master sites for multimaster replication.</p>
<div class="infobox-note">
<p class="notep1">Note:</p>
If progress appears to stop during one of the procedures described in the following sections, then check your trace files and the alert log for messages.</div>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<ul>
<li>
<p><a href="rarrepsite.htm#i10539">"Setting Up Master Sites"</a> for information about setting up your new master sites for multimaster replication</p>
</li>
<li>
<p><a class="olink ADMIN005" href="../../server.112/e25494/monitoring.htm#ADMIN005"><span class="italic">Oracle Database Administrator's Guide</span></a> for more information about trace files and the alert log</p>
</li>
<li>
<p><a class="olink ADMIN013" href="../../server.112/e25494/undo.htm#ADMIN013"><span class="italic">Oracle Database Administrator's Guide</span></a> for information about managing undo space</p>
</li>
</ul>
</div>
<a id="i28373"></a>
<div id="REPMA374" class="sect3">
<h4 class="sect3">Using Full Database Export/Import or Change-Based Recovery<a id="sthref498"></a><a id="sthref499"></a></h4>
<p><a href="#i37539">Figure 7-2</a> shows the major steps for using full database export/import or change-based recovery to add new master sites to a master group without quiescing. The following example script adds the new master sites <code>orc4.example.com</code> and <code>orc5.example.com</code> to the <code>hr_repg</code> master group. In this example, <code>orc4.example.com</code> is added using full database export/import and <code>orc5.example.com</code> is added using change-based recovery.</p>
<div id="REPMA375" class="figure">
<p class="titleinfigure"><a id="i37539"></a>Figure 7-2 Using Full Database Export/Import or Change-Based Recovery</p>
<img width="600" height="592" src="img/repma022.gif" alt="Description of Figure 7-2 follows" /><br />
<a id="sthref500" href="img_text/repma022.htm">Description of "Figure 7-2 Using Full Database Export/Import or Change-Based Recovery"</a><br />
<br /></div>
<!-- class="figure" -->
<p>Meet the following requirements to complete these actions:</p>
<p><span class="bold">Executed As</span>: Replication Administrator, unless specified otherwise</p>
<p><span class="bold">Executed At</span>:</p>
<ul>
<li>
<p>Step <a href="#CHDHHHHB">1</a> at Each New Master Site</p>
</li>
<li>
<p>Steps <a href="#CHDDEDGE">2</a> - <a href="#CHDFDABF">5</a> at Master Definition Site</p>
</li>
<li>
<p>Step <a href="#CHDJGBIG">6</a> at the Master Definition Site and at Each New Master Site</p>
</li>
<li>
<p>Step <a href="#CHDHFADI">7</a> requires an export at the Master Definition site and a file transfer between sites.</p>
</li>
<li>
<p>Steps <a href="#i31448">8</a> - <a href="#CHDDBGBB">10</a> at Each New Master Site</p>
</li>
</ul>
<p><span class="bold">Replication Status</span>: Running Normally (Not Quiesced)</p>
<p>Complete the following steps to use full database export/import or change-based recovery to add sites to a master group.</p>
<div class="infobox-note">
<p class="notep1">Note:</p>
If you are viewing this document online, then you can copy the text from the "BEGINNING OF SCRIPT" line after this note to the "END OF SCRIPT" line into a text editor and then edit the text to create a script for your environment.</div>
<pre>
/************************* BEGINNING OF SCRIPT ******************************
</pre>
<a id="i23892"></a>
<dl>
<dd><a id="REPMA1215"></a><a id="CHDHHHHB"></a></dd>
<dt class="seghead">Step 1&nbsp;&nbsp;&nbsp;If you are using full database export/import, then create the databases that you want to add to the master group.</dt>
<dd>
<p>This step is not required if you are using change-based recovery.</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<a class="olink ADMIN002" href="../../server.112/e25494/create.htm#ADMIN002"><span class="italic">Oracle Database Administrator's Guide</span></a> for information about creating a database</div>
<pre>
*/

SET ECHO ON

SPOOL add_masters_full.out

PAUSE Press &lt;RETURN&gt; when the databases for the new master sites are created.

/*
</pre></dd>
<dd><a id="REPMA1216"></a><a id="CHDDEDGE"></a></dd>
<dt class="seghead">Step 2&nbsp;&nbsp;&nbsp;Set up each new master site as a replication site.</dt>
<dd>
<p>Remember that you must configure the following:</p>
<pre>
*/

PAUSE Press &lt;RETURN&gt; to continue the new master sites have been setup and the 
required scheduled links have been created.

/*
</pre>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<ul>
<li>
<p><a class="olink REPLN103" href="../../server.112/e10706/repplan.htm#REPLN103"><span class="italic">Oracle Database Advanced Replication</span></a> for information about scheduled links</p>
</li>
<li>
<p><a href="rarrepsite.htm#i10539">"Setting Up Master Sites"</a></p>
</li>
<li>
<p><a href="rarrepsite.htm#i23014">"Creating Scheduled Links Between the Master Sites"</a></p>
</li>
</ul>
</div>
<ul>
<li>
<p>The replication administrator at each new master site</p>
</li>
<li>
<p>A scheduled link from each existing master site to each new master site</p>
</li>
<li>
<p>A scheduled link from each new master site to each existing master site</p>
</li>
<li>
<p>A schedule purge job at each new master site</p>
</li>
</ul>
</dd>
<dd><a id="REPMA1217"></a><a id="sthref501"></a></dd>
<dt class="seghead">Step 3&nbsp;&nbsp;&nbsp;Connect as the replication administrator to the master definition site.</dt>
<dd>
<pre>
*/
</pre>
<pre>
CONNECT repadmin@orc1.example.com

/*
</pre></dd>
<dd><a id="REPMA1218"></a><a id="CHDJEDCF"></a></dd>
<dt class="seghead">Step 4&nbsp;&nbsp;&nbsp;Specify new master sites for each master group<a id="sthref502"></a><a id="sthref503"></a>.</dt>
<dd>
<p>Before you begin, create the required scheduled links between existing master sites and each new master site if they do not exist.</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<ul>
<li>
<p><a class="olink REPLN103" href="../../server.112/e10706/repplan.htm#REPLN103"><span class="italic">Oracle Database Advanced Replication</span></a> for information about scheduled links</p>
</li>
<li>
<p><a href="rarrepsite.htm#i23014">"Creating Scheduled Links Between the Master Sites"</a> for examples</p>
</li>
</ul>
</div>
<pre>
*/

BEGIN
   <a href="rarrcatpac.htm#i103954">DBMS_REPCAT.SPECIFY_NEW_MASTERS (</a>
      gname =&gt; 'HR_REPG',
      master_list =&gt; 'orc4.example.com,orc5.example.com');
END;
/

/*
</pre>
<p>You can begin to track the extension process by querying the following data dictionary views in another SQL*Plus session:</p>
<ul>
<li>
<p><code>DBA_REPSITES_NEW</code></p>
</li>
<li>
<p><code>DBA_REPEXTENSIONS</code></p>
</li>
</ul>
<pre>
*/

PAUSE Press &lt;RETURN&gt; when you have completed the these steps.

/*
</pre></dd>
<dd><a id="REPMA1219"></a><a id="CHDFDABF"></a></dd>
<dt class="seghead">Step 5&nbsp;&nbsp;&nbsp;Add the new master sites<a id="sthref504"></a><a id="sthref505"></a>.</dt>
<dd>
<p>Before running the following procedure, ensure that there are an adequate number of background jobs running at each new master site. If you are using full database export/import, then ensure that there is enough space in your rollback segments or undo tablespace for the export before you run this procedure.</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<ul>
<li>
<p><a class="olink REPLN104" href="../../server.112/e10706/repplan.htm#REPLN104"><span class="italic">Oracle Database Advanced Replication</span></a> for information about setting the <code>JOB_QUEUE_PROCESSES</code> initialization parameter properly for a replication environment</p>
</li>
<li>
<p><a class="olink ADMIN013" href="../../server.112/e25494/undo.htm#ADMIN013"><span class="italic">Oracle Database Administrator's Guide</span></a> for information about managing undo space</p>
</li>
</ul>
</div>
<pre>
*/
 
VARIABLE masterdef_flashback_scn NUMBER;
VARIABLE extension_id VARCHAR2(32);
BEGIN
   <a href="rarrcatpac.htm#i104032">DBMS_REPCAT.ADD_NEW_MASTERS (</a>
      export_required =&gt; TRUE,
      available_master_list =&gt; NULL, 
      masterdef_flashback_scn =&gt; :masterdef_flashback_scn, 
      extension_id =&gt; :extension_id,
      break_trans_to_masterdef =&gt; FALSE,    
      break_trans_to_new_masters =&gt; FALSE,    
      percentage_for_catchup_mdef =&gt; 80,    
      cycle_seconds_mdef =&gt; 60,    
      percentage_for_catchup_new =&gt; 80,    
      cycle_seconds_new =&gt; 60);
END;
/

/*
</pre>
<p>The values for <code>masterdef_flashback_scn</code> and <code>extension_id</code> are saved into variables to be used later in the process. To see these values, you can query the <code>DBA_REPSITES_NEW</code> and <code>DBA_REPEXTENSIONS</code> data dictionary views.</p>
<pre>
*/

PAUSE Press &lt;RETURN&gt; when you have completed the these steps.

/*
</pre>
<p>If you must undo the changes made to a particular master site by the <code>SPECIFY_NEW_MASTERS</code> and <code>ADD_NEW_MASTERS</code> procedures, then use the <code>DBMS_REPCAT.UNDO_ADD_NEW_MASTERS_REQUEST</code> procedure.</p>
<p>For the <code>export_required</code> parameter, <code>TRUE</code> is specified because <code>orc4.example.com</code> is being added using full database export/import. Although <code>orc5.example.com</code> is using change-based recovery, the <code>TRUE</code> setting is correct because at least one new master site is added using export/import.</p>
<p>After successfully executing this procedure, monitor its progress by querying the <code>DBA_REPCATLOG</code> data dictionary view in another SQL*Plus session. Do not proceed to Step <a href="#CHDHFADI">7</a> until there is no remaining information in this view about adding the new master sites. Assuming no extraneous information exists in <code>DBA_REPCATLOG</code> from other operations, you can enter the following statement:</p>
<pre>
SELECT COUNT(*) FROM DBA_REPCATLOG;
</pre>
<p>All of the processing is complete when this statement returns zero (0).</p>
<pre>
*/

PAUSE Press &lt;RETURN&gt; to continue when DBA_REPCATLOG is empty.

/*
</pre></dd>
<dd><a id="REPMA1220"></a><a id="CHDJGBIG"></a></dd>
<dt class="seghead">Step 6&nbsp;&nbsp;&nbsp;If you are using full database export/import, then create a directory object at each database.</dt>
<dd>
<p>For master sites being added using change-based recovery, this step is not required and you can proceed to Step <a href="#i31448">8</a>.</p>
<p>Each database involved in this operation must have a directory object to hold the Data Pump dump file, and the user who will perform the export or import must have <code>READ</code> and <code>WRITE</code> privileges on this directory object. In this example, a Data Pump export is performed at the master definition site, and a Data Pump import is performed at each new master site.</p>
<p>If you are using full database export/import, then, while connected in SQL*Plus to the a database as an administrative user who can create directory objects using the SQL statement <code>CREATE</code> <code>DIRECTORY</code>, create a directory object to hold the Data Pump dump file and log files. For example:</p>
<pre>
*/

CONNECT system@orc1.example.com

CREATE DIRECTORY DPUMP_DIR AS '/usr/dpump_dir';

CONNECT system@orc4.example.com

CREATE DIRECTORY DPUMP_DIR AS '/usr/dpump_dir';

CONNECT system@orc5.example.com

CREATE DIRECTORY DPUMP_DIR AS '/usr/dpump_dir';

/*
</pre>
<p>In this example, <code>SYSTEM</code> user performs all exports and imports. If a user other than the user who created the directory object will perform the export or import, then grant this user <code>READ</code> and <code>WRITE</code> privileges on the directory object.</p>
<p>Ensure that you complete these actions at each database involved in the operation.</p>
</dd>
<dd><a id="REPMA1221"></a><a id="CHDHFADI"></a></dd>
<dt class="seghead">Step 7&nbsp;&nbsp;&nbsp;Perform the following substeps for the master sites being added using full database export/import.</dt>
<dd>
<p>For master sites being added using change-based recovery, these substeps are not required and you can proceed to Step <a href="#i31448">8</a>.</p>
<p><a id="i31459"></a>Perform full database export of the master definition database. Use the system change number (SCN) returned by the <code>masterdef_flashback_scn</code> parameter in Step <a href="#CHDFDABF">5</a> for the <code>FLASHBACK_SCN</code> export parameter.</p>
<p>You can query the <code>DBA_REPEXTENSIONS</code> data dictionary view for the <code>FLASHBACK_SCN</code> value:</p>
<pre>
SELECT FLASHBACK_SCN FROM DBA_REPEXTENSIONS; 
</pre>
<p>In this example, assume that the value returned by this query is <code>124723</code>.</p>
<p>In this example, <code>orc4.example.com</code> is using full database export/import. Therefore, perform the full database export of the master definition database so that it can be imported into <code>orc4.example.com</code> during a later step. However, the <code>orc5.example.com</code> database is using change-based recovery. Therefore, the export would not be required if you were adding only <code>orc5.example.com</code>.</p>
<p>On a command line, perform the export. This example connects as the <code>SYSTEM</code> user. The following is an example Data Pump export command:</p>
<pre>
expdp system FULL=y DIRECTORY=DPUMP_DIR DUMPFILE=fulldb_orc1.dmp FLASHBACK_SCN=124723
</pre>
<p>Consider the following when you run the Export utility:</p>
<ul>
<li>
<p>Only users with the <code>DBA</code> role or the <code>EXP_FULL_DATABASE</code> role can export in full database mode.</p>
</li>
<li>
<p>Ensure that the <code>UNDO_RETENTION</code> initialization parameter is set correctly before performing the export.</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<ul>
<li>
<p><a class="olink SUTIL200" href="../../server.112/e22490/dp_export.htm#SUTIL200"><span class="italic">Oracle Database Utilities</span></a> for information about performing a Data Pump export</p>
</li>
<li>
<p><a class="olink ADMIN013" href="../../server.112/e25494/undo.htm#ADMIN013"><span class="italic">Oracle Database Administrator's Guide</span></a> for information about managing undo space and setting this parameter</p>
</li>
</ul>
</div>
</li>
</ul>
<pre>
*/

PAUSE Press &lt;RETURN&gt; to continue when the export is complete.

/*
</pre>
<p><a id="i31253"></a>Resume propagation to the master definition site<a id="sthref506"></a><a id="sthref507"></a>.</p>
<p>Running the following procedure indicates that export is effectively finished and propagation can be enabled for both extended and unaffected master groups at the master sites.</p>
<pre>
*/

BEGIN
   <a href="rarrcatpac.htm#i112773">DBMS_REPCAT.RESUME_PROPAGATION_TO_MDEF (</a>
      extension_id =&gt; :extension_id);
END;
/

/*
</pre>
<p>You can find the <code>extension_id</code> by querying the <code>DBA_REPSITES_NEW</code> data dictionary view.</p>
<p>Transfer the export dump file to the new master sites.</p>
<p>Using the <code>DBMS_FILE_TRANSFER</code> package, FTP, or some other method, transfer the export dump file to the other new master sites that are being added with full database export/import. You will need this export dump file at each new site to perform the import described in the next step.</p>
<pre>
*/

PAUSE Press &lt;RETURN&gt; to continue after transferring the dump file. 

/*
</pre>
<p><a id="i35086"></a>Set the <code>JOB_QUEUE_PROCESSES</code> initialization parameter to zero for each new master site.</p>
<pre>
*/

PAUSE Press &lt;RETURN&gt; to continue after JOB_QUEUE_PROCESSES is set to zero at each new master site.

/*
</pre></dd>
<dd><a id="REPMA1222"></a><a id="i31448"></a></dd>
<dt class="seghead">Step 8&nbsp;&nbsp;&nbsp;Perform import or change-based recovery at each new master site.</dt>
<dd>
<p>If you are using full database export/import, then complete the full database import of the database you exported in Step <a href="#CHDHFADI">7</a> at each new master site that is being added with full database export/import.</p>
<p>Perform the import. This example connects as the <code>SYSTEM</code> user to perform the import at <code>orc4.example.com</code>. The following is an example import command:</p>
<pre>
impdp system FULL=y DIRECTORY=DPUMP_DIR DUMPFILE=fulldb_orc1.dmp
</pre>
<p>Only users with the <code>DBA</code> role or the <code>IMP_FULL_DATABASE</code> role can import in full database mode.</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<a class="olink SUTIL300" href="../../server.112/e22490/dp_import.htm#SUTIL300"><span class="italic">Oracle Database Utilities</span></a> for information about performing a Data Pump import</div>
<pre>
*/

PAUSE Press &lt;RETURN&gt; to continue when the import is complete.

/*
</pre>
<p>If you are using change-based recovery, then perform change-based recovery using the system change number (SCN) returned by the <code>masterdef_flashback_scn</code> parameter in Step <a href="#CHDFDABF">5</a>. You can query the <code>DBA_REPEXTENSIONS</code> data dictionary view for the <code>masterdef_flashback_scn</code> value.</p>
<p>You can perform a change-based recovery in one of the following ways:</p>
<ul>
<li>
<p>Using the SQL*Plus <code>RECOVER</code> command. See the <a class="olink BRADV" href="../../backup.112/e10642/toc.htm"><span class="italic">Oracle Database Backup and Recovery User's Guide</span></a> for instructions.</p>
</li>
<li>
<p>Using the Recovery Manager (RMAN) <code>DUPLICATE</code> command. See the <a class="olink BRADV010" href="../../backup.112/e10642/rcmdupdb.htm#BRADV010"><span class="italic">Oracle Database Backup and Recovery User's Guide</span></a> for instructions.</p>
</li>
</ul>
<p>Connect to the site where you will perform the change-based recovery:</p>
<pre>
*/

CONNECT repadmin@orc5.example.com

PAUSE Press &lt;RETURN&gt; to continue when the change-based recovery is complete. You
can use a separate terminal window to perform the change-based recovery.

/*
</pre></dd>
<dd><a id="REPMA1223"></a><a id="i34953"></a></dd>
<dt class="seghead">Step 9&nbsp;&nbsp;&nbsp;Configure the new sites for multimaster replication by completing the following steps:</dt>
<dd>
<ol>
<li>
<p>Ensure that the database structures, such as the data files, exist for the replicated schemas at each new master site. In this example, the replicated schema is <code>hr</code>.</p>
</li>
<li>
<p>Set the global name for each new master site. The global name for each new master site must match the global names specified in the <code>SPECIFY_NEW_MASTERS</code> procedure that you ran in Step <a href="#CHDJEDCF">4</a>. You can query the <code>DBLINK</code> column in the <code>DBA_REPSITES_NEW</code> data dictionary view to see the global name for each new master site.</p>
<p>You can set the global name using the <code>ALTER</code> <code>DATABASE</code> statement, as in the following example:</p>
<pre>
ALTER DATABASE RENAME GLOBAL_NAME TO orc4.example.com;
</pre></li>
<li>
<p>Create the appropriate scheduled links between the new master sites and the existing master sites, including the master definition site.</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<a href="rarrepsite.htm#i23014">"Creating Scheduled Links Between the Master Sites"</a> for information</div>
</li>
</ol>
<pre>
*/

PAUSE Press &lt;RETURN&gt; when you have completed the these steps.

/*
</pre></dd>
<dd><a id="REPMA1224"></a><a id="CHDDBGBB"></a></dd>
<dt class="seghead">Step 10&nbsp;&nbsp;&nbsp;Allow new masters to receive deferred transactions<a id="sthref508"></a><a id="sthref509"></a>.</dt>
<dd>
<p>The following procedure enables the propagation of deferred transactions from other prepared new master sites and existing master sites to the invocation master site. This procedure also enables the propagation of deferred transactions from the invocation master site to the other new master sites and existing master sites.</p>
<div class="infobox-note">
<p class="notep1">Caution:</p>
Do not invoke this procedure until instantiation (export/import or change-based recovery) of the new master site is complete.
<p>Do not allow any data manipulation language (DML) statements directly on the objects in the extended master group in the new master site until execution of this procedure returns successfully, because these DML statements might not be replicated.</p>
</div>
<pre>
*/

CONNECT repadmin@orc4.example.com

BEGIN
   <a href="rarrcatpac.htm#i104100">DBMS_REPCAT.PREPARE_INSTANTIATED_MASTER (</a>
      extension_id  =&gt; :extension_id);
END;
/

CONNECT repadmin@orc5.example.com

BEGIN
   <a href="rarrcatpac.htm#i104100">DBMS_REPCAT.PREPARE_INSTANTIATED_MASTER (</a>
      extension_id  =&gt; :extension_id);
END;
/

SET ECHO OFF

SPOOL OFF

/*
</pre>
<div class="infobox-note">
<p class="notep1">Note:</p>
You can find the <code>extension_id</code> by querying the <code>DBA_REPSITES_NEW</code> data dictionary view.</div>
<pre>
<a id="i31673"></a>
************************** END OF SCRIPT **********************************/
</pre></dd>
</dl>
</div>
<!-- class="sect3" -->
<a id="i24655"></a>
<div id="REPMA376" class="sect3">
<h4 class="sect3">Using Object-Level Export/Import<a id="sthref510"></a></h4>
<p><a href="#i35486">Figure 7-3</a> shows the major steps for using object-level export/import to add new master sites to a master group without quiescing. The following example procedure adds the new master sites <code>orc4.example.com</code> and <code>orc5.example.com</code> to the <code>hr_repg</code> master group. An object-level export/import involves exporting and importing the tables in a master group. When you export and import the tables, other dependent database objects, such as indexes, are exported and imported as well.</p>
<p>If you have an integrity constraint that spans two master groups, then you have a child table in one master group (the child master group) and a parent table in a different master group (the parent master group). In this case, Oracle recommends that you add new master sites to both master groups at the same time. However, if you cannot do this, then you must quiesce the child master group before adding new master sites to it. Here, the child table includes a foreign key, which makes it dependent on the values in the parent table. If you do not quiesce the child master group, then conflicts might result when you add master sites to it. You can still add master sites to the parent master group without quiescing it.</p>
<div id="REPMA377" class="figure">
<p class="titleinfigure"><a id="i35486"></a>Figure 7-3 Using Object-Level Export/Import<a id="sthref511"></a></p>
<img width="600" height="584" src="img/repma023.gif" alt="Description of Figure 7-3 follows" /><br />
<a id="sthref512" href="img_text/repma023.htm">Description of "Figure 7-3 Using Object-Level Export/Import"</a><br />
<br /></div>
<!-- class="figure" -->
<p>Meet the following requirements to complete these actions:</p>
<p><span class="bold">Executed As</span>: Replication Administrator, unless specified otherwise</p>
<p><span class="bold">Executed At</span>:</p>
<ul>
<li>
<p>Steps <a href="#CHDFGGJD">1</a> - <a href="#CHDGBGHI">6</a> at Master Definition Site</p>
</li>
<li>
<p>Step <a href="#CHDJCHAJ">7</a> at the Master Definition Site and at Each New Master Site</p>
</li>
<li>
<p>Steps <a href="#CHDFIHCA">8</a> - <a href="#CHDEIFDA">9</a> at Master Definition Site</p>
</li>
<li>
<p>Step <a href="#CHDGHGBJ">10</a> requires a file transfer between sites.</p>
</li>
<li>
<p>Steps <a href="#CHDGGDCF">11</a> - <a href="#CHDGAGCG">12</a> at Each New Master Site</p>
</li>
</ul>
<p><span class="bold">Replication Status</span>: Running Normally (Not Quiesced)</p>
<p>Complete the following steps to use object-level export/import to add sites to a master group.</p>
<div class="infobox-note">
<p class="notep1">Note:</p>
If you are viewing this document online, then you can copy the text from the "BEGINNING OF SCRIPT" line after this note to the "END OF SCRIPT" line into a text editor and then edit the text to create a script for your environment.</div>
<pre>
/************************* BEGINNING OF SCRIPT ******************************
</pre>
<a id="i32177"></a>
<dl>
<dd><a id="REPMA1225"></a><a id="CHDFGGJD"></a></dd>
<dt class="seghead">Step 1&nbsp;&nbsp;&nbsp;If the users for the replicated schemas do not exist at the new master sites, then create them now.</dt>
<dd>
<p>In this example, the replicated schema is <code>hr</code>. This schema probably exists at the new master sites because it is a sample schema that is installed when you install Oracle.</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<a class="olink COMSC" href="../e10831/toc.htm"><span class="italic">Oracle Database Sample Schemas</span></a> for general information about the sample schemas and for information about installing them</div>
<pre>
*/

SET ECHO ON

SPOOL add_masters_object.out

PAUSE Press &lt;RETURN&gt; to continue when the users are created at the new master sites.

/*
</pre></dd>
<dd><a id="REPMA1226"></a><a id="sthref513"></a></dd>
<dt class="seghead">Step 2&nbsp;&nbsp;&nbsp;If any of the tables in the master group have circular dependencies, then precreate these tables at the new master sites.</dt>
<dd>
<p>Failure to precreate these tables will result in errors later in the procedure. If there are no circular dependencies, then this step is not required, and you can proceed to Step <a href="#CHDJGCFI">3</a>.</p>
<p>Some tables in the <code>hr</code> schema contain circular dependencies. Therefore, in this example, the tables in the <code>hr</code> schema must be precreated at each new master site. Again, the <code>hr</code> schema tables are typically created during Oracle installation and so might exist at the new master sites.</p>
<p>If you must precreate tables, then disable referential integrity constraints for these tables at the new master sites before the import. Referential integrity constraints can cause errors when you import data into existing tables. This example disables the referential integrity constraints for the precreated tables in the <code>hr</code> schema at the new master sites.</p>
<p>Further, the precreated tables at the new master sites should not contain any data. This example truncates the tables in the <code>hr</code> schema at the new master sites to ensure that they do not contain any data.</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<ul>
<li>
<p>The note under <a href="#i33123">"Adding New Master Sites"</a> for more information about circular dependencies</p>
</li>
<li>
<p><a class="olink SUTIL" href="../e22490/toc.htm"><span class="italic">Oracle Database Utilities</span></a> for information about importing data into existing tables</p>
</li>
</ul>
</div>
<pre>
*/

PAUSE Press &lt;RETURN&gt; to continue when the tables are precreated at the new 
master sites, if table precreation is required. After the tables are 
precreated, the following statements disable the referential integrity 
constraints related to the hr schema and truncate the tables in the hr schema 
at the new site.

CONNECT oe@orc4.example.com

ALTER TABLE oe.warehouses 
  DISABLE CONSTRAINT warehouses_location_fk;

ALTER TABLE oe.customers 
  DISABLE CONSTRAINT customers_account_manager_fk;

ALTER TABLE oe.orders 
  DISABLE CONSTRAINT orders_sales_rep_fk;

CONNECT hr@orc4.example.com

ALTER TABLE hr.countries 
  DISABLE CONSTRAINT countr_reg_fk;

ALTER TABLE hr.departments 
  DISABLE CONSTRAINT dept_mgr_fk
  DISABLE CONSTRAINT dept_loc_fk;

ALTER TABLE hr.employees
  DISABLE CONSTRAINT emp_dept_fk
  DISABLE CONSTRAINT emp_job_fk
  DISABLE CONSTRAINT emp_manager_fk;

ALTER TABLE hr.job_history
  DISABLE CONSTRAINT jhist_job_fk
  DISABLE CONSTRAINT jhist_emp_fk
  DISABLE CONSTRAINT jhist_dept_fk;

ALTER TABLE hr.locations 
  DISABLE CONSTRAINT loc_c_id_fk;

TRUNCATE TABLE hr.countries;
TRUNCATE TABLE hr.departments;
TRUNCATE TABLE hr.employees;
TRUNCATE TABLE hr.jobs;
TRUNCATE TABLE hr.job_history;
TRUNCATE TABLE hr.locations;
TRUNCATE TABLE hr.regions;

CONNECT oe@orc5.example.com

ALTER TABLE oe.warehouses 
  DISABLE CONSTRAINT warehouses_location_fk;

ALTER TABLE oe.customers 
  DISABLE CONSTRAINT customers_account_manager_fk;

ALTER TABLE oe.orders 
  DISABLE CONSTRAINT orders_sales_rep_fk;

CONNECT hr@orc5.example.com

ALTER TABLE hr.countries 
  DISABLE CONSTRAINT countr_reg_fk;

ALTER TABLE hr.departments 
  DISABLE CONSTRAINT dept_mgr_fk
  DISABLE CONSTRAINT dept_loc_fk;

ALTER TABLE hr.employees
  DISABLE CONSTRAINT emp_dept_fk
  DISABLE CONSTRAINT emp_job_fk
  DISABLE CONSTRAINT emp_manager_fk;

ALTER TABLE hr.job_history
  DISABLE CONSTRAINT jhist_job_fk
  DISABLE CONSTRAINT jhist_emp_fk
  DISABLE CONSTRAINT jhist_dept_fk;

ALTER TABLE hr.locations 
  DISABLE CONSTRAINT loc_c_id_fk;

TRUNCATE TABLE hr.countries;
TRUNCATE TABLE hr.departments;
TRUNCATE TABLE hr.employees;
TRUNCATE TABLE hr.jobs;
TRUNCATE TABLE hr.job_history;
TRUNCATE TABLE hr.locations;
TRUNCATE TABLE hr.regions;

/*
</pre></dd>
<dd><a id="REPMA1227"></a><a id="CHDJGCFI"></a></dd>
<dt class="seghead">Step 3&nbsp;&nbsp;&nbsp;Set up each new master site as a replication site.</dt>
<dd>
<p>Remember that you must configure the following:</p>
<ul>
<li>
<p>The replication administrator at each new master site</p>
</li>
<li>
<p>A scheduled link from each existing master site to each new master site</p>
</li>
<li>
<p>A scheduled link from each new master site to each existing master site</p>
</li>
<li>
<p>A schedule purge job at each new master site</p>
</li>
</ul>
<pre>
*/

PAUSE Press &lt;RETURN&gt; to continue the new master sites have been setup and the 
required scheduled links have been created.

/*
</pre>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<ul>
<li>
<p><a class="olink REPLN103" href="../../server.112/e10706/repplan.htm#REPLN103"><span class="italic">Oracle Database Advanced Replication</span></a> for information about scheduled links</p>
</li>
<li>
<p><a href="rarrepsite.htm#i10539">"Setting Up Master Sites"</a></p>
</li>
<li>
<p><a href="rarrepsite.htm#i23014">"Creating Scheduled Links Between the Master Sites"</a></p>
</li>
</ul>
</div>
</dd>
<dd><a id="REPMA1228"></a><a id="sthref514"></a></dd>
<dt class="seghead">Step 4&nbsp;&nbsp;&nbsp;Connect to the master definition site as the replication administrator.</dt>
<dd>
<pre>
*/
</pre>
<pre>
CONNECT repadmin@orc1.example.com

/*
</pre></dd>
<dd><a id="REPMA1229"></a><a id="CHDBDCEF"></a></dd>
<dt class="seghead">Step 5&nbsp;&nbsp;&nbsp;Specify new master sites for each master group<a id="sthref515"></a>.</dt>
<dd>
<pre>
*/
</pre>
<pre>
BEGIN
   <a href="rarrcatpac.htm#i103954">DBMS_REPCAT.SPECIFY_NEW_MASTERS (</a>
      gname =&gt; 'hr_repg',
      master_list =&gt; 'orc4.example.com,orc5.example.com');
END;
/

/*
</pre>
<p>You can begin to track the extension process by querying the following data dictionary views in another SQL*Plus session:</p>
<ul>
<li>
<p><code>DBA_REPSITES_NEW</code></p>
</li>
<li>
<p><code>DBA_REPEXTENSIONS</code></p>
</li>
</ul>
</dd>
<dd><a id="REPMA1230"></a><a id="CHDGBGHI"></a></dd>
<dt class="seghead">Step 6&nbsp;&nbsp;&nbsp;Add the new master sites<a id="sthref516"></a><a id="sthref517"></a>.</dt>
<dd>
<p>Before running the following procedure, ensure that there are an adequate number of background jobs running at each new master site. Also, ensure that there is enough space in your rollback segments or undo tablespace for the export before you run this procedure.</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<ul>
<li>
<p><a class="olink REPLN104" href="../../server.112/e10706/repplan.htm#REPLN104"><span class="italic">Oracle Database Advanced Replication</span></a> for information about setting the <code>JOB_QUEUE_PROCESSES</code> initialization parameter properly for a replication environment</p>
</li>
<li>
<p><a class="olink ADMIN013" href="../../server.112/e25494/undo.htm#ADMIN013"><span class="italic">Oracle Database Administrator's Guide</span></a> for information about managing undo space</p>
</li>
</ul>
</div>
<pre>
*/

VARIABLE masterdef_flashback_scn NUMBER;
VARIABLE extension_id VARCHAR2(32);
BEGIN
   <a href="rarrcatpac.htm#i104032">DBMS_REPCAT.ADD_NEW_MASTERS (</a>
      export_required =&gt; TRUE,
      available_master_list =&gt; 'orc4.example.com,orc5.example.com', 
      masterdef_flashback_scn =&gt; :masterdef_flashback_scn, 
      extension_id =&gt; :extension_id,
      break_trans_to_masterdef =&gt; FALSE,    
      break_trans_to_new_masters =&gt; FALSE,    
      percentage_for_catchup_mdef =&gt; 80,    
      cycle_seconds_mdef =&gt; 60,    
      percentage_for_catchup_new =&gt; 80,    
      cycle_seconds_new =&gt; 60);
END;
/

/*
</pre>
<p>The sites specified for the <code>available_master_list</code> parameter must be same as the sites specified in the <code>SPECIFY_NEW_MASTERS</code> procedure in Step <a href="#CHDBDCEF">5</a>.</p>
<p>The values for <code>masterdef_flashback_scn</code> and <code>extension_id</code> are saved into variables to be used later in the process. To see these values, you can also query the <code>DBA_REPSITES_NEW</code> and <code>DBA_REPEXTENSIONS</code> data dictionary views.</p>
<p>If you must undo the changes made to a particular master site by the <code>SPECIFY_NEW_MASTERS</code> and <code>ADD_NEW_MASTERS</code> procedures, then use the <code>UNDO_ADD_NEW_MASTERS_REQUEST</code> procedure.</p>
<p>After successfully executing this procedure, monitor its progress by querying the <code>DBA_REPCATLOG</code> data dictionary view in another SQL*Plus session. Do not proceed to Step <a href="#CHDFIHCA">8</a> until there is no remaining information in this view about adding the new master sites. Assuming there is no extraneous information in <code>DBA_REPCATLOG</code> from other operations, you can enter the following statement:</p>
<pre>
SELECT COUNT(*) FROM DBA_REPCATLOG;
</pre>
<p>All of the processing is complete when this statement returns zero (0).</p>
<pre>
*/

PAUSE Press &lt;RETURN&gt; to continue when DBA_REPCATLOG is empty.

/*
</pre></dd>
<dd><a id="REPMA1231"></a><a id="CHDJCHAJ"></a></dd>
<dt class="seghead">Step 7&nbsp;&nbsp;&nbsp;Create a directory object at each database.</dt>
<dd>
<p>Each database involved in this operation must have a directory object to hold the Data Pump dump file, and the user who will perform the export or import must have <code>READ</code> and <code>WRITE</code> privileges on this directory object. In this example, a Data Pump export is performed at the master definition site, and a Data Pump import is performed at each new master site.</p>
<p>While connected in SQL*Plus to the a database as an administrative user who can create directory objects using the SQL statement <code>CREATE</code> <code>DIRECTORY</code>, create a directory object to hold the Data Pump dump file and log files. For example:</p>
<pre>
*/

CONNECT system@orc1.example.com

CREATE DIRECTORY DPUMP_DIR AS '/usr/dpump_dir';

CONNECT system@orc4.example.com

CREATE DIRECTORY DPUMP_DIR AS '/usr/dpump_dir';

CONNECT system@orc5.example.com

CREATE DIRECTORY DPUMP_DIR AS '/usr/dpump_dir';

/*
</pre>
<p>In this example, <code>SYSTEM</code> user performs all exports and imports. If a user other than the user who created the directory object will perform the export or import, then grant this user <code>READ</code> and <code>WRITE</code> privileges on the directory object.</p>
<p>Ensure that you complete these actions at each database involved in the operation.</p>
</dd>
<dd><a id="REPMA1232"></a><a id="CHDFIHCA"></a></dd>
<dt class="seghead">Step 8&nbsp;&nbsp;&nbsp;Perform object-level export of tables at master definition database.</dt>
<dd>
<p>At the master definition database, perform an object-level export for each master table in the master groups that will be created at the new master sites. An object-level export includes exports performed in table mode, user mode, or tablespace mode.</p>
<p>Use the system change number (SCN) returned by the <code>masterdef_flashback_scn</code> parameter in Step <a href="#CHDGBGHI">6</a> for the <code>FLASHBACK_SCN</code> export parameter. You can query the <code>DBA_REPEXTENSIONS</code> data dictionary view for the <code>FLASHBACK_SCN</code> value:</p>
<pre>
SELECT FLASHBACK_SCN FROM DBA_REPEXTENSIONS; 
</pre>
<p>In this example, assume that the SCN value is <code>3456871</code>.</p>
<p>On a command line, perform the export. This example connects as the <code>SYSTEM</code> user. The following is an example Data Pump export command:</p>
<pre>
expdp system TABLES=HR.COUNTRIES,HR.DEPARTMENTS,HR.EMPLOYEES,
HR.JOB_HISTORY,HR.JOBS,HR.LOCATIONS,HR.REGIONS DIRECTORY=DPUMP_DIR 
DUMPFILE=hr_tables.dmp CONTENT=data_only FLASHBACK_SCN=3456871
</pre>
<p>The <code>CONTENT</code> parameter is used in this example because the tables exist at the import sites. You might not need to specify this parameter.</p>
<p>Ensure that the <code>UNDO_RETENTION</code> initialization parameter is set correctly before performing the export.</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<ul>
<li>
<p><a class="olink SUTIL200" href="../../server.112/e22490/dp_export.htm#SUTIL200"><span class="italic">Oracle Database Utilities</span></a> for information about performing a Data Pump export</p>
</li>
<li>
<p><a class="olink ADMIN013" href="../../server.112/e25494/undo.htm#ADMIN013"><span class="italic">Oracle Database Administrator's Guide</span></a> for information about managing undo space and setting the <code>UNDO_RETENTION</code> initialization parameter</p>
</li>
</ul>
</div>
<pre>
*/

PAUSE Press &lt;RETURN&gt; to continue when the export is complete.

/*
</pre></dd>
<dd><a id="REPMA1233"></a><a id="CHDEIFDA"></a></dd>
<dt class="seghead">Step 9&nbsp;&nbsp;&nbsp;Resume propagation to the master definition site<a id="sthref518"></a><a id="sthref519"></a>.</dt>
<dd>
<p>Running the following procedure indicates that export is effectively finished and propagation can be enabled for both extended and unaffected master groups at the master sites.</p>
<pre>
*/

CONNECT repadmin@orc1.example.com

BEGIN
   <a href="rarrcatpac.htm#i112773">DBMS_REPCAT.RESUME_PROPAGATION_TO_MDEF (</a>
      extension_id =&gt; :extension_id);
END;
/

/*
</pre>
<p>You can find the <code>extension_id</code> by querying the <code>DBA_REPSITES_NEW</code> data dictionary view.</p>
</dd>
<dd><a id="REPMA1234"></a><a id="CHDGHGBJ"></a></dd>
<dt class="seghead">Step 10&nbsp;&nbsp;&nbsp;Transfer the export dump files to the new master sites.</dt>
<dd>
<p>Using the <code>DBMS_FILE_TRANSFER</code> package, FTP, or some other method, transfer the export dump files to the other new master sites that are being added with object-level export/import. You will need these export dump files at each new site to perform the import described in the next step.</p>
<pre>
*/

PAUSE Press &lt;RETURN&gt; to continue when the export dump files have been
transfered to the new master sites that are being added with object-level
export/import.

/*
</pre></dd>
<dd><a id="REPMA1235"></a><a id="CHDGGDCF"></a></dd>
<dt class="seghead">Step 11&nbsp;&nbsp;&nbsp;Perform object-level imports at each new master site of each object you exported in Step <a href="#CHDFIHCA">8</a>.</dt>
<dd>
<p>On a command line, perform the import. This example connects as the <code>SYSTEM</code> user. The following is an example import command:</p>
<pre>
impdp system TABLES=HR.COUNTRIES,HR.DEPARTMENTS,HR.EMPLOYEES,
HR.JOB_HISTORY,HR.JOBS,HR.LOCATIONS,HR.REGIONS DIRECTORY=DPUMP_DIR 
DUMPFILE=hr_tables.dmp CONTENT=data_only TABLE_EXISTS_ACTION=append
</pre>
<p>Other objects, such as the indexes based on the tables, are imported automatically. The <code>CONTENT</code> and <code>TABLE_EXISTS_ACTION</code> parameters are used in this example because the tables exist at the import sites. You might not need to specify these parameters.</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<a class="olink SUTIL300" href="../../server.112/e22490/dp_import.htm#SUTIL300"><span class="italic">Oracle Database Utilities</span></a> for information about performing a Data Pump import</div>
<p>Perform the object-level imports at each site:</p>
<pre>
*/

PAUSE Press &lt;RETURN&gt; to continue when the imports are complete at each site. You
can use a separate terminal window to perform the object-level imports.

/*
</pre></dd>
<dd><a id="REPMA1236"></a><a id="CHDGAGCG"></a></dd>
<dt class="seghead">Step 12&nbsp;&nbsp;&nbsp;Allow new masters to receive deferred transactions<a id="sthref520"></a><a id="sthref521"></a>.</dt>
<dd>
<p>The following procedure enables the propagation of deferred transactions from other prepared new master sites and existing master sites to the invocation master site. This procedure also enables the propagation of deferred transactions from the invocation master site to the other new master sites and existing master sites.</p>
<div class="infobox-note">
<p class="notep1">Caution:</p>
Do not invoke this procedure until object-level export/import for the new master site is complete.
<p>Do not allow any data manipulation language (DML) statements directly on the objects in the extended master group in the new master site until execution of this procedure returns successfully, because these DML statements might not be replicated.</p>
</div>
<pre>
*/

CONNECT repadmin@orc4.example.com

BEGIN
   <a href="rarrcatpac.htm#i104100">DBMS_REPCAT.PREPARE_INSTANTIATED_MASTER (</a>
      extension_id  =&gt; :extension_id);
END;
/

CONNECT repadmin@orc5.example.com

BEGIN
   <a href="rarrcatpac.htm#i104100">DBMS_REPCAT.PREPARE_INSTANTIATED_MASTER (</a>
      extension_id  =&gt; :extension_id);
END;
/

SET ECHO OFF

SPOOL OFF

/*
</pre>
<div class="infobox-note">
<p class="notep1">Note:</p>
You can find the <code>extension_id</code> by querying the <code>DBA_REPSITES_NEW</code> data dictionary view.</div>
<pre>
<a id="i32162"></a>
************************** END OF SCRIPT **********************************/
</pre></dd>
</dl>
</div>
<!-- class="sect3" --></div>
<!-- class="sect2" -->
<a id="i23756"></a>
<div id="REPMA378" class="sect2">
<h3 class="sect2">Adding New Master Sites to a Quiesced Master Group<a id="sthref522"></a><a id="sthref523"></a><a id="sthref524"></a><code><a id="sthref525"></a><a id="sthref526"></a></code></h3>
<p>You can add new master sites to a quiesced master group in one of the following ways:</p>
<ul>
<li>
<p><a href="#i30830">Adding New Master Sites Using the ADD_MASTER_DATABASE Procedure</a></p>
</li>
<li>
<p><a href="#i37719">Adding New Master Sites with Offline Instantiation Using Export/Import</a></p>
</li>
</ul>
<p>Typically, you should only use the <code>ADD_MASTER_DATABASE</code> procedure if you have a relatively small master group or if you plan to precreate the replication tables and load the data into them at the new master sites. If this is not the case, the <code>ADD_MASTER_DATABASE</code> procedure might not be a good option because the entire master group is copied over the network. For larger master groups, either precreate the objects in the master group at the new master sites or use offline instantiation.</p>
<a id="i30830"></a>
<div id="REPMA379" class="sect3">
<h4 class="sect3">Adding New Master Sites Using the ADD_MASTER_DATABASE Procedure</h4>
<p>You can use the <code>ADD_MASTER_DATABASE</code> procedure to add additional master sites to an existing master group that is quiesced. Executing this procedure replicates existing master objects to the new site.</p>
<p>Meet the following requirements to complete these actions:</p>
<p><span class="bold">Executed As</span>: Replication Administrator</p>
<p><span class="bold">Executed At</span>: Master Definition Site</p>
<p><span class="bold">Replication Status</span>: Quiesced</p>
<p>Complete the following steps to use the <code>ADD_MASTER_DATABASE</code> procedure to add sites to a master group.</p>
<div class="infobox-note">
<p class="notep1">Note:</p>
If you are viewing this document online, then you can copy the text from the "BEGINNING OF SCRIPT" line after this note to the "END OF SCRIPT" line into a text editor and then edit the text to create a script for your environment.</div>
<pre>
/************************* BEGINNING OF SCRIPT ******************************
</pre>
<dl>
<dd><a id="REPMA1237"></a><a id="sthref527"></a></dd>
<dt class="seghead">Step 1&nbsp;&nbsp;&nbsp;Set up the new master site.</dt>
<dd>
<p>Ensure that the appropriate schema and database links have been created before adding your new master site. Be sure to create the database links from the new master site to each of the existing masters sites. Also, create a database link from each of the existing master sites to the new master site. After the database links have been created, ensure that you also define the scheduled links for each of the new database links.</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<ul>
<li>
<p><a href="rarrepsite.htm#i10539">"Setting Up Master Sites"</a></p>
</li>
<li>
<p><a href="rarrepsite.htm#i23014">"Creating Scheduled Links Between the Master Sites"</a></p>
</li>
</ul>
</div>
<pre>
*/

SET ECHO ON

SPOOL add_masters_quiesced.out

PAUSE Press &lt;RETURN&gt; to the new master site has been set up.

/*
</pre></dd>
<dd><a id="REPMA1238"></a><a id="sthref528"></a></dd>
<dt class="seghead">Step 2&nbsp;&nbsp;&nbsp;Connect to the master definition site as the replication administrator.</dt>
<dd>
<pre>
*/
</pre>
<pre>
CONNECT repadmin@orc1.example.com

/*
</pre></dd>
<dd><a id="REPMA1239"></a><a id="sthref529"></a></dd>
<dt class="seghead">Step 3&nbsp;&nbsp;&nbsp;If the replication status is normal, then change the status to quiesced.</dt>
<dd>
<pre>
*/
</pre>
<pre>
BEGIN
   <a href="rarrcatpac.htm#i99057">DBMS_REPCAT.SUSPEND_MASTER_ACTIVITY (</a>
      gname =&gt; 'hr_repg');
END;
/

/*
</pre></dd>
<dd><a id="REPMA1240"></a><a id="sthref530"></a></dd>
<dt class="seghead">Step 4&nbsp;&nbsp;&nbsp;Add the new master sites.</dt>
<dd>
<p>This example assumes that the replicated objects do not exist at the new master site. Therefore, the <code>copy_rows</code> parameter is set to <code>TRUE</code> to copy the rows in the replicated objects at the master definition site to the new master site, and the <code>use_existing_objects</code> parameter is set to <code>FALSE</code> so that Advanced Replication creates the replicated objects at the new site. If the replicated objects exist at the new site but do not contain any data, then set <code>use_existing_objects</code> to <code>TRUE</code>.</p>
<pre>
*/

BEGIN
   <a href="rarrcatpac.htm#i94506">DBMS_REPCAT.ADD_MASTER_DATABASE (</a><a id="sthref531"></a><a id="sthref532"></a>
      gname =&gt; 'hr_repg',
      master =&gt; 'orc4.example.com',
      use_existing_objects =&gt; FALSE,
      copy_rows =&gt; TRUE,
      propagation_mode =&gt; 'ASYNCHRONOUS');
END;
/

/*
</pre>
<p>You should wait until the <code>DBA_REPCATLOG</code> view is empty. This view has temporary information that is cleared after successful execution. Execute the following <code>SELECT</code> statement in another SQL*Plus session to monitor the <code>DBA_REPCATLOG</code> view:</p>
<pre>
SELECT COUNT(*) FROM DBA_REPCATLOG WHERE GNAME = 'HR_REPG';
</pre>
<p>All of the processing is complete when this statement returns zero (0).</p>
<pre>
*/

PAUSE Press &lt;RETURN&gt; to continue when DBA_REPCATLOG is empty.

/*
</pre></dd>
<dd><a id="REPMA1241"></a><a id="sthref533"></a></dd>
<dt class="seghead">Step 5&nbsp;&nbsp;&nbsp;Resume replication activity.</dt>
<dd>
<pre>
*/
</pre>
<pre>
BEGIN
   <a href="rarrcatpac.htm#i98820">DBMS_REPCAT.RESUME_MASTER_ACTIVITY (</a>
      gname =&gt; 'hr_repg');
END;
/

SET ECHO OFF

SPOOL OFF

<a id="i37716"></a>/************************* END OF SCRIPT **********************************/
</pre></dd>
</dl>
</div>
<!-- class="sect3" -->
<a id="i37719"></a>
<div id="REPMA102" class="sect3">
<h4 class="sect3">Adding New Master Sites with Offline Instantiation Using Export/Import<a id="sthref534"></a><a id="sthref535"></a></h4>
<p>Expanding established replication environments can cause network traffic when you add a new master site to your replication environment using the <code>ADD_MASTER_DATABASE</code> procedure. This is caused by propagating the entire contents of the table or materialized view through the network to the new replicated site.</p>
<p>To minimize such network traffic, you can expand your replication environment by using the offline instantiation procedure. Offline instantiation takes advantage of Oracle's Export and Import utilities, which allow you to create an export file and transfer the data to the new site through another storage medium, such as CD-ROM, tape, and so on.</p>
<p>The following script is an example of how to perform an offline instantiation of a master site. This script can potentially eliminate large amounts of network traffic caused by the other method of adding a new master site to an existing quiesced master group. The script assumes that the <code>hr</code> schema does not exist at the new master site and instantiates this schema at the new master site. The <code>hr</code> schema is created automatically when Oracle is installed. You can choose to drop the <code>hr</code> schema at the new master site before you start this example.</p>
<p>Meet the following requirements to complete these actions:</p>
<p><span class="bold">Executed As</span>: Replication Administrator, unless specified otherwise</p>
<p><span class="bold">Executed At</span>: Master Definition Site and New Master Site</p>
<p><span class="bold">Replication Status</span>: Quiesced and Partial</p>
<p>Complete the following steps to use offline instantiation to add sites to a master group.</p>
<div class="infobox-note">
<p class="notep1">Note:</p>
If you are viewing this document online, then you can copy the text from the "BEGINNING OF SCRIPT" line after this note to the "END OF SCRIPT" line into a text editor and then edit the text to create a script for your environment.</div>
<pre>
/************************* BEGINNING OF SCRIPT ******************************
</pre>
<dl>
<dd><a id="REPMA1242"></a><a id="sthref536"></a></dd>
<dt class="seghead">Step 1&nbsp;&nbsp;&nbsp;Set up the new master site.</dt>
<dd>
<p>Ensure that the appropriate schema and database links have been created before performing the offline instantiation of your new master site. Be sure to create the database links from the new master site to each of the existing masters sites. Also, create a database link from each of the existing master sites to the new master site. After the database links have been created, ensure that you also define the scheduled links for each of the new database links.</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<ul>
<li>
<p><a href="rarrepsite.htm#i10539">"Setting Up Master Sites"</a></p>
</li>
<li>
<p><a href="rarrepsite.htm#i23014">"Creating Scheduled Links Between the Master Sites"</a></p>
</li>
</ul>
</div>
<pre>
*/

SET ECHO ON

SPOOL add_masters_instant.out

PAUSE Press &lt;RETURN&gt; to the new master site has been set up.

/*
</pre></dd>
<dd><a id="REPMA1243"></a><a id="sthref537"></a></dd>
<dt class="seghead">Step 2&nbsp;&nbsp;&nbsp;Connect to the master definition site as the replication administrator.</dt>
<dd>
<pre>
*/
</pre>
<pre>
CONNECT repadmin@orc1.example.com

/*
</pre></dd>
<dd><a id="REPMA1244"></a><a id="sthref538"></a></dd>
<dt class="seghead">Step 3&nbsp;&nbsp;&nbsp;Suspend master activity.</dt>
<dd>
<p>You must suspend master activity for the existing master sites before exporting your master data and beginning the offline instantiation process.</p>
<pre>
*/

BEGIN
   <a href="rarrcatpac.htm#i99057">DBMS_REPCAT.SUSPEND_MASTER_ACTIVITY (</a>
      gname =&gt; 'hr_repg');
END;
/

/*
</pre></dd>
<dd><a id="REPMA1245"></a><a id="sthref539"></a></dd>
<dt class="seghead">Step 4&nbsp;&nbsp;&nbsp;Verify that there are no pending transactions in a separate SQL*Plus session.<a id="sthref540"></a></dt>
<dd>
<p>This includes pushing any outstanding deferred transactions, resolving any error transactions, and pushing any administrative transactions. This step must be performed at each of the existing master sites.</p>
<p>Check the error transaction queue.</p>
<pre>
SELECT * FROM DEFERROR;
</pre>
<p>If any deferred transactions have been entered into the error queue, then you must resolve the error situation and then manually reexecute the deferred transaction. The following is an example:</p>
<pre>
BEGIN
   <a href="rardefsyspac.htm#i94273">DBMS_DEFER_SYS.EXECUTE_ERROR (</a><a id="sthref541"></a><a id="sthref542"></a>
      deferred_tran_id =&gt; '128323',
      destination =&gt; 'orc1.example.com');
END;
/
</pre>
<p>Check for outstanding administrative requests.</p>
<pre>
SELECT * FROM DBA_REPCATLOG;
</pre>
<p>If any administrative requests remain, then you can manually execute these requests or wait for them to be executed automatically. You might need to execute the <code>DBMS_REPCAT.DO_DEFERRED_REPCAT_ADMIN</code> procedure several times, because some administrative operations have multiple steps. The following is an example:</p>
<pre>
BEGIN
   <a href="rarrcatpac.htm#i96992">DBMS_REPCAT.DO_DEFERRED_REPCAT_ADMIN (</a><a id="sthref543"></a><a id="sthref544"></a>
      gname =&gt; 'hr_repg',
      all_sites =&gt; TRUE);
END;
/

*/

PAUSE Press &lt;RETURN&gt; to continue when you have verified that there are no pending requests.

/*
</pre></dd>
<dd><a id="REPMA1246"></a><a id="sthref545"></a></dd>
<dt class="seghead">Step 5&nbsp;&nbsp;&nbsp;Begin offline instantiation procedure.</dt>
<dd>
<pre>
*/
</pre>
<pre>
BEGIN
   <a href="raroffogpac.htm#BHCIEDEF">DBMS_OFFLINE_OG.BEGIN_INSTANTIATION (</a><a id="sthref546"></a><a id="sthref547"></a>
      gname =&gt; 'hr_repg',
      new_site =&gt; 'orc4.example.com');
END;
/

/*
</pre>
<p>You should wait until the <code>DBA_REPCATLOG</code> view is empty. This view has temporary information that is cleared after successful execution. Execute the following <code>SELECT</code> statement in another SQL*Plus session to monitor the <code>DBA_REPCATLOG</code> view:</p>
<pre>
SELECT * FROM DBA_REPCATLOG WHERE GNAME = 'HR_REPG';

*/

PAUSE Press &lt;RETURN&gt; to continue when DBA_REPCATLOG is empty.

/*
</pre></dd>
<dd><a id="REPMA1247"></a><a id="sthref548"></a></dd>
<dt class="seghead">Step 6&nbsp;&nbsp;&nbsp;Create a directory object at each database.</dt>
<dd>
<p>Each database involved in this operation must have a directory object to hold the Data Pump dump file, and the user who will perform the export or import must have <code>READ</code> and <code>WRITE</code> privileges on this directory object. In this example, a Data Pump export is performed at the master definition site, and a Data Pump import is performed at the new master site.</p>
<p>While connected in SQL*Plus to a database as an administrative user who can create directory objects using the SQL statement <code>CREATE</code> <code>DIRECTORY</code>, create a directory object to hold the Data Pump dump file and log files. For example:</p>
<pre>
*/

CONNECT system@orc1.example.com

CREATE DIRECTORY DPUMP_DIR AS '/usr/dpump_dir';

CONNECT system@orc4.example.com

CREATE DIRECTORY DPUMP_DIR AS '/usr/dpump_dir';

/*
</pre>
<p>Ensure that you complete these actions at both databases involved in the operation. In this example, <code>SYSTEM</code> user creates the directory objects and performs all exports and imports. If a user who does not own the directory object will perform the export or import, then grant the user <code>READ</code> and <code>WRITE</code> privileges on the directory object.</p>
</dd>
<dd><a id="REPMA1248"></a><a id="sthref549"></a></dd>
<dt class="seghead">Step 7&nbsp;&nbsp;&nbsp;In a separate terminal window, perform the export.</dt>
<dd>
<p>On a command line, perform the export. This example connects as the <code>SYSTEM</code> user. The following is an example Data Pump export command:</p>
<pre>
expdp system SCHEMAS=hr DIRECTORY=DPUMP_DIR DUMPFILE=hr_schema.dmp
</pre>
<p>When you export tables, their indexes are exported automatically.</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<a class="olink SUTIL200" href="../../server.112/e22490/dp_export.htm#SUTIL200"><span class="italic">Oracle Database Utilities</span></a> for information about performing a Data Pump export</div>
<pre>
*/

PAUSE Press &lt;RETURN&gt; to continue when the export is complete.

/*
</pre></dd>
<dd><a id="REPMA1249"></a><a id="sthref550"></a></dd>
<dt class="seghead">Step 8&nbsp;&nbsp;&nbsp;Resume partial replication activity.</dt>
<dd>
<p>Because it might take some time to complete the offline instantiation process, you can resume replication activity for the remaining master sites (excluding the new master site) by executing the <code>RESUME_SUBSET_OF_MASTERS</code> procedure in the <code>DBMS_OFFLINE_OG</code> package after the export is complete. In the following example, replication activity is resumed at all master sites except the new master site -- <code>orc4.example.com</code>.</p>
<pre>
*/

CONNECT repadmin@orc1.example.com

BEGIN
   <a href="raroffogpac.htm#i94281">DBMS_OFFLINE_OG.RESUME_SUBSET_OF_MASTERS (</a><a id="sthref551"></a><a id="sthref552"></a>
      gname =&gt; 'hr_repg',
      new_site =&gt; 'orc4.example.com');
END;
/

/*
</pre></dd>
<dd><a id="REPMA1250"></a><a id="sthref553"></a></dd>
<dt class="seghead">Step 9&nbsp;&nbsp;&nbsp;Transfer the export dump files to the new master site.</dt>
<dd>
<p>Using the <code>DBMS_FILE_TRANSFER</code> package, FTP, or some other method, transfer the export dump file to the new master site. You will need this export dump file at the new site to perform the import described in the next step.</p>
<pre>
*/

PAUSE Press &lt;RETURN&gt; to continue when the export dump file has been
transfered to the new master site.

/*
</pre></dd>
<dd><a id="REPMA1251"></a><a id="sthref554"></a></dd>
<dt class="seghead">Step 10&nbsp;&nbsp;&nbsp;Connect to the new master site as the replication administrator.</dt>
<dd>
<pre>
*/
</pre>
<pre>
CONNECT repadmin@orc4.example.com

/*
</pre></dd>
<dd><a id="REPMA1252"></a><a id="sthref555"></a></dd>
<dt class="seghead">Step 11&nbsp;&nbsp;&nbsp;Prepare the new master site.</dt>
<dd>
<p>You must prepare the new site to import the data in your export file. Ensure that you execute the following procedure at the new master site.</p>
<pre>
*/

BEGIN
   <a href="raroffogpac.htm#i94025">DBMS_OFFLINE_OG.BEGIN_LOAD (</a><a id="sthref556"></a><a id="sthref557"></a>
      gname =&gt; 'hr_repg',
      new_site =&gt; 'orc4.example.com');
END;
/

/*
</pre></dd>
<dd><a id="REPMA1253"></a><a id="sthref558"></a></dd>
<dt class="seghead">Step 12&nbsp;&nbsp;&nbsp;In a separate terminal window, import data from export dump file.</dt>
<dd>
<p>On a command line, perform the import. This example connects as the <code>SYSTEM</code> user. The following is an example import command:</p>
<pre>
impdp system SCHEMAS=hr DIRECTORY=DPUMP_DIR DUMPFILE=hr_schema.dmp
</pre>
<p>Other objects, such as the indexes based on the tables, are imported automatically.</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<a class="olink SUTIL300" href="../../server.112/e22490/dp_import.htm#SUTIL300"><span class="italic">Oracle Database Utilities</span></a> for information about performing a Data Pump import</div>
<pre>
*/

PAUSE Press &lt;RETURN&gt; to continue when the import is complete.

/*
</pre></dd>
<dd><a id="REPMA1254"></a><a id="sthref559"></a></dd>
<dt class="seghead">Step 13&nbsp;&nbsp;&nbsp;Complete the load process at new master site.</dt>
<dd>
<p>After importing the export file, you are ready to complete the offline instantiation process at the new master site. Executing the <code>DBMS_OFFLINE_OG.END_LOAD</code> procedure prepares the new site for normal replication activity.</p>
<pre>
*/

BEGIN
   <a href="raroffogpac.htm#i94187">DBMS_OFFLINE_OG.END_LOAD (</a><a id="sthref560"></a><a id="sthref561"></a>
      gname =&gt; 'hr_repg',
      new_site =&gt; 'orc4.example.com');
END;
/

/*
</pre></dd>
<dd><a id="REPMA1255"></a><a id="sthref562"></a></dd>
<dt class="seghead">Step 14&nbsp;&nbsp;&nbsp;Connect to the master definition site as the replication administrator.</dt>
<dd>
<pre>
*/
</pre>
<pre>
CONNECT repadmin@orc1.example.com

/*
</pre></dd>
<dd><a id="REPMA1256"></a><a id="sthref563"></a></dd>
<dt class="seghead">Step 15&nbsp;&nbsp;&nbsp;Complete instantiation process.</dt>
<dd>
<p>After completing the steps at the new master site, you are ready to complete the offline instantiation process. Executing the <code>END_INSTANTIATION</code> procedure in the <code>DBMS_OFFLINE_OG</code> package completes the process and resumes normal replication activity at all master sites. Ensure that you execute the following procedure at the master definition site.</p>
<pre>
*/

BEGIN
   <a href="raroffogpac.htm#i94106">DBMS_OFFLINE_OG.END_INSTANTIATION (</a><a id="sthref564"></a><a id="sthref565"></a>
      gname =&gt; 'hr_repg',
      new_site =&gt; 'orc4.example.com');
END;
/

SET ECHO OFF

SPOOL OFF

<a id="i32804"></a>/************************* END OF SCRIPT **********************************/
</pre></dd>
</dl>
</div>
<!-- class="sect3" --></div>
<!-- class="sect2" --></div>
<!-- class="sect1" -->
<a id="i30502"></a>
<div id="REPMA380" class="sect1">
<h2 class="sect1">Removing a Master Site<a id="sthref566"></a><a id="sthref567"></a> from a Master Group</h2>
<p>When it becomes necessary to remove a master site from a master group, use the <code>REMOVE_MASTER_DATABASES</code> procedure to drop one or more master sites.</p>
<p>Meet the following requirements to complete these actions:</p>
<p><span class="bold">Executed As</span>: Replication Administrator</p>
<p><span class="bold">Executed At</span>: Master Definition Site</p>
<p><span class="bold">Replication Status</span>: Quiesced</p>
<p>Complete the following steps to remove a master site.</p>
<div class="infobox-note">
<p class="notep1">Note:</p>
If you are viewing this document online, then you can copy the text from the "BEGINNING OF SCRIPT" line after this note to the "END OF SCRIPT" line into a text editor and then edit the text to create a script for your environment.</div>
<pre>
/************************* BEGINNING OF SCRIPT ******************************
</pre>
<dl>
<dd><a id="REPMA1257"></a><a id="sthref568"></a></dd>
<dt class="seghead">Step 1&nbsp;&nbsp;&nbsp;Connect to the master definition site as the replication administrator.</dt>
<dd>
<pre>
*/
</pre>
<pre>
SET ECHO ON

SPOOL remove_masters.out

CONNECT repadmin@orc1.example.com

/*
</pre></dd>
<dd><a id="REPMA1258"></a><a id="sthref569"></a></dd>
<dt class="seghead">Step 2&nbsp;&nbsp;&nbsp;If the replication status is normal for the master group, then change the status to quiesced.</dt>
<dd>
<pre>
*/
</pre>
<pre>
BEGIN
   <a href="rarrcatpac.htm#i99057">DBMS_REPCAT.SUSPEND_MASTER_ACTIVITY (</a>
      gname =&gt; 'hr_repg');
END;
/

/*
</pre></dd>
<dd><a id="REPMA1259"></a><a id="sthref570"></a></dd>
<dt class="seghead">Step 3&nbsp;&nbsp;&nbsp;Remove the master site.</dt>
<dd>
<pre>
*/
</pre>
<pre>
BEGIN
   <a href="rarrcatpac.htm#i98685">DBMS_REPCAT.REMOVE_MASTER_DATABASES (</a><a id="sthref571"></a><a id="sthref572"></a>
      gname =&gt; 'hr_repg',
      master_list =&gt; 'orc4.example.com');
END;
/

/*
</pre>
<p>You should wait until the <code>DBA_REPCATLOG</code> view is empty. Execute the following <code>SELECT</code> statement in another SQL*Plus session to monitor the <code>DBA_REPCATLOG</code> view:</p>
<pre>
SELECT * FROM DBA_REPCATLOG WHERE GNAME = 'HR_REPG';

*/

PAUSE Press &lt;RETURN&gt; to continue when DBA_REPCATLOG is empty for the master group.

/*
</pre></dd>
<dd><a id="REPMA1260"></a><a id="sthref573"></a></dd>
<dt class="seghead">Step 4&nbsp;&nbsp;&nbsp;Resume master activity for the master group.</dt>
<dd>
<pre>
*/
</pre>
<pre>
BEGIN
   <a href="rarrcatpac.htm#i98820">DBMS_REPCAT.RESUME_MASTER_ACTIVITY (</a>
      gname =&gt; 'hr_repg');
END;
/

SET ECHO OFF

SPOOL OFF

<a id="i32876"></a>/************************* END OF SCRIPT **********************************/
</pre></dd>
</dl>
<div id="REPMA381" class="sect2"><a id="sthref574"></a>
<h3 class="sect2">Removing an Unavailable Master Site</h3>
<p>The sites being removed from a master group do not have to be accessible. When a master site will not be available for an extended period of time due to a system or network failure, you might decide to drop the master site from the master group.</p>
<p>However, because the site is unavailable, you most likely cannot suspend replication activity for the master group. You can use the <code>REMOVE_MASTER_DATABASES</code> procedure in the <code>DBMS_REPCAT</code> package to remove master sites from a master group, even if the master group is not quiesced.</p>
<p>If this is the case, you are responsible for:</p>
<ul>
<li>
<p>Cleaning the deferred transaction queue</p>
</li>
<li>
<p>Removing any data inconsistencies</p>
</li>
</ul>
<p>Specifically, the next time that you suspend replication activity for a master group, you must complete the following steps as soon as possible after the unavailable master sites are removed:</p>
<dl>
<dd><a id="REPMA1261"></a><a id="sthref575"></a></dd>
<dt class="seghead">Step 1&nbsp;&nbsp;&nbsp;Suspend replication activity for the master group.</dt>
<dd>
<p>See <a href="rarrcatpac.htm#i100994">"SUSPEND_MASTER_ACTIVITY Procedure"</a> for information.</p>
</dd>
<dd><a id="REPMA1262"></a><a id="sthref576"></a></dd>
<dt class="seghead">Step 2&nbsp;&nbsp;&nbsp;Delete all deferred transactions from each master site where the destination for the transaction is a removed master site.</dt>
<dd>
<p>See <a href="rardefsyspac.htm#i94124">"DELETE_TRAN Procedure"</a> for information.</p>
</dd>
<dd><a id="REPMA1263"></a><a id="sthref577"></a></dd>
<dt class="seghead">Step 3&nbsp;&nbsp;&nbsp;Remove all deferred transactions from removed master sites.</dt>
<dd>
<p>See <a href="rardefsyspac.htm#i94124">"DELETE_TRAN Procedure"</a> for information.</p>
</dd>
<dd><a id="REPMA1264"></a><a id="sthref578"></a></dd>
<dt class="seghead">Step 4&nbsp;&nbsp;&nbsp;Reexecute or delete all error transactions at each remaining master site.</dt>
<dd>
<p>See <a href="rarmanage.htm#i30415">"Managing the Error Queue"</a> for information about reexecuting error transactions, and see <a href="rardefsyspac.htm#i94124">"DELETE_TRAN Procedure"</a> for information about removing error transactions.</p>
</dd>
<dd><a id="REPMA1265"></a><a id="sthref579"></a></dd>
<dt class="seghead">Step 5&nbsp;&nbsp;&nbsp;Ensure that no deferred or error transactions exist at each remaining master.</dt>
<dd>
<p>If you cannot remove one or more deferred transactions from a remaining master, execute the <code>DBMS_DEFER_SYS.DELETE_TRAN</code> procedure at the master site.</p>
</dd>
<dd><a id="REPMA1266"></a><a id="sthref580"></a></dd>
<dt class="seghead">Step 6&nbsp;&nbsp;&nbsp;Ensure that all replicated data is consistent.</dt>
<dd>
<p>See <a href="rarrectdifpac.htm#g100137">Chapter 16, "DBMS_RECTIFIER_DIFF"</a> for information about determining and correcting differences.</p>
</dd>
<dd><a id="REPMA1267"></a><a id="sthref581"></a></dd>
<dt class="seghead">Step 7&nbsp;&nbsp;&nbsp;Resume replication activity for the master group.</dt>
<dd>
<p>See <a href="rarrcatpac.htm#i98814">"RESUME_MASTER_ACTIVITY Procedure"</a> for information.</p>
<div class="infobox-note">
<p class="notep1">Note:</p>
After dropping an unavailable master site from a master group, you should also remove the master group from the dropped site to finish the cleanup.</div>
</dd>
</dl>
</div>
<!-- class="sect2" --></div>
<!-- class="sect1" -->
<a id="i20106"></a>
<div id="REPMA382" class="sect1"><a id="CHDHJFEC"></a>
<h2 class="sect1">Updating the Comments Fields in Data Dictionary Views<a id="sthref582"></a><a id="sthref583"></a><a id="sthref584"></a><a id="sthref585"></a><a id="sthref586"></a><a id="sthref587"></a><a id="sthref588"></a><a id="sthref589"></a></h2>
<p>Several procedures in the <code>DBMS_REPCAT</code> package enable you to update the comment information in the various data dictionary views associated with replication. <a href="#g51804">Table 7-1</a> lists the appropriate procedure to call for each view.</p>
<div id="REPMA383" class="tblformalwide">
<p class="titleintable"><a id="sthref590"></a><a id="g51804"></a>Table 7-1 Updating Comments in Advanced Replication Views</p>
<table class="cellalignment1780" title="Updating Comments in Advanced Replication Views " summary="This table lists data dictionary views and specifies which DBMS_REPCAT procedure to use to update comments in the view. This table also includes a cross reference to each procedure." dir="ltr">
<thead>
<tr class="cellalignment1769">
<th class="cellalignment1776" id="r1c1-t33">View</th>
<th class="cellalignment1776" id="r1c2-t33">DBMS_REPCAT Procedure</th>
<th class="cellalignment1776" id="r1c3-t33">See for Parameter Information</th>
</tr>
</thead>
<tbody>
<tr class="cellalignment1769">
<td class="cellalignment1777" id="r2c1-t33" headers="r1c1-t33">
<pre>
DBA_REPGROUP
</pre></td>
<td class="cellalignment1777" headers="r2c1-t33 r1c2-t33">
<pre>
COMMENT_ON_REPGROUP(
 gname            IN VARCHAR2,
 comment          IN VARCHAR2)
</pre></td>
<td class="cellalignment1777" headers="r2c1-t33 r1c3-t33">
<p><a href="rarrcatpac.htm#i119319">"COMMENT_ON_REPGROUP Procedure"</a>.</p>
</td>
</tr>
<tr class="cellalignment1769">
<td class="cellalignment1777" id="r3c1-t33" headers="r1c1-t33">
<pre>
DBA_REPOBJECT
</pre></td>
<td class="cellalignment1777" headers="r3c1-t33 r1c2-t33">
<pre>
COMMENT_ON_REPOBJECT(
 sname            IN VARCHAR2, 
 oname            IN VARCHAR2, 
 type             IN VARCHAR2, 
 comment          IN VARCHAR2)
</pre></td>
<td class="cellalignment1777" headers="r3c1-t33 r1c3-t33">
<p><a href="rarrcatpac.htm#i95844">"COMMENT_ON_REPOBJECT Procedure"</a>.</p>
</td>
</tr>
<tr class="cellalignment1769">
<td class="cellalignment1777" id="r4c1-t33" headers="r1c1-t33">
<pre>
DBA_REPSITES
</pre></td>
<td class="cellalignment1777" headers="r4c1-t33 r1c2-t33">
<pre>
COMMENT_ON_REPSITES(
 gname            IN VARCHAR2, 
 master           IN VARCHAR, 
 comment          IN VARCHAR2)
</pre></td>
<td class="cellalignment1777" headers="r4c1-t33 r1c3-t33">
<p><a href="rarrcatpac.htm#i95910">"COMMENT_ON_REPSITES Procedure"</a>.</p>
</td>
</tr>
<tr class="cellalignment1769">
<td class="cellalignment1777" id="r5c1-t33" headers="r1c1-t33">
<pre>
DBA_REPCOLUMN_GROUP
</pre></td>
<td class="cellalignment1777" headers="r5c1-t33 r1c2-t33">
<pre>
COMMENT_ON_COLUMN_GROUP(
 sname            IN VARCHAR2, 
 oname            IN VARCHAR2, 
 column_group     IN VARCHAR2, 
 comment          IN VARCHAR2)
</pre></td>
<td class="cellalignment1777" headers="r5c1-t33 r1c3-t33">
<p><a href="rarrcatpac.htm#i95668">"COMMENT_ON_COLUMN_GROUP Procedure"</a>.</p>
</td>
</tr>
<tr class="cellalignment1769">
<td class="cellalignment1777" id="r6c1-t33" headers="r1c1-t33">
<pre>
DBA_REPPRIORITY_GROUP
</pre></td>
<td class="cellalignment1777" headers="r6c1-t33 r1c2-t33">
<pre>
COMMENT_ON_PRIORITY_GROUP(
 gname            IN VARCHAR2, 
 pgroup           IN VARCHAR2)
 comment          IN VARCHAR2)
</pre></td>
<td class="cellalignment1777" headers="r6c1-t33 r1c3-t33">
<p><a href="rarrcatpac.htm#i119249">"COMMENT_ON_PRIORITY_GROUP Procedures"</a>.</p>
</td>
</tr>
<tr class="cellalignment1769">
<td class="cellalignment1777" id="r7c1-t33" headers="r1c1-t33">
<pre>
DBA_REPPRIORITY_GROUP (site priority group)
</pre></td>
<td class="cellalignment1777" headers="r7c1-t33 r1c2-t33">
<pre>
COMMENT_ON_SITE_PRIORITY(
 gname            IN VARCHAR2, 
 name             IN VARCHAR2, 
 comment          IN VARCHAR2)
</pre></td>
<td class="cellalignment1777" headers="r7c1-t33 r1c3-t33">
<p><a href="rarrcatpac.htm#i119249">"COMMENT_ON_PRIORITY_GROUP Procedures"</a>.</p>
</td>
</tr>
<tr class="cellalignment1769">
<td class="cellalignment1777" id="r8c1-t33" headers="r1c1-t33">
<pre>
DBA_REPRESOLUTION (uniqueness conflicts)
</pre></td>
<td class="cellalignment1777" headers="r8c1-t33 r1c2-t33">
<pre>
COMMENT_ON_UNIQUE_RESOLUTION(
 sname            IN VARCHAR2,
 oname            IN VARCHAR2,
 constraint_name  IN VARCHAR2,
 sequence_no      IN NUMBER, 
 comment          IN VARCHAR2)
</pre></td>
<td class="cellalignment1777" headers="r8c1-t33 r1c3-t33">
<p>The parameters for the <code>COMMENT_ON_UNIQUE_RESOLUTION</code> procedures are described in <a href="rarrcatpac.htm#i96042">"COMMENT_ON_<span class="italic">conflicttype</span>_RESOLUTION Procedure"</a>.</p>
</td>
</tr>
<tr class="cellalignment1769">
<td class="cellalignment1777" id="r9c1-t33" headers="r1c1-t33">
<pre>
DBA_REPRESOLUTION (update conflicts)
</pre></td>
<td class="cellalignment1777" headers="r9c1-t33 r1c2-t33">
<pre>
COMMENT_ON_UPDATE_RESOLUTION(
 sname            IN VARCHAR2,
 oname            IN VARCHAR2,
 column_group     IN VARCHAR2,
 sequence_no      IN NUMBER, 
 comment          IN VARCHAR2)
</pre></td>
<td class="cellalignment1777" headers="r9c1-t33 r1c3-t33">
<p>The parameters for the <code>COMMENT_ON_UNIQUE_RESOLUTION</code> procedures are described in <a href="rarrcatpac.htm#i96042">"COMMENT_ON_<span class="italic">conflicttype</span>_RESOLUTION Procedure"</a>.</p>
</td>
</tr>
<tr class="cellalignment1769">
<td class="cellalignment1777" id="r10c1-t33" headers="r1c1-t33">
<pre>
DBA_REPRESOLUTION (delete conflicts)
</pre></td>
<td class="cellalignment1777" headers="r10c1-t33 r1c2-t33">
<pre>
COMMENT_ON_DELETE_RESOLUTION(
 sname            IN VARCHAR2,
 oname            IN VARCHAR2,
 sequence_no      IN NUMBER, 
 comment          IN VARCHAR2)
</pre></td>
<td class="cellalignment1777" headers="r10c1-t33 r1c3-t33">
<p>The parameters for the <code>COMMENT_ON_UNIQUE_RESOLUTION</code> procedures are described in <a href="rarrcatpac.htm#i96042">"COMMENT_ON_<span class="italic">conflicttype</span>_RESOLUTION Procedure"</a>.</p>
</td>
</tr>
</tbody>
</table>
<br /></div>
<!-- class="tblformalwide" --></div>
<!-- class="sect1" -->
<a id="i22642"></a>
<div id="REPMA103" class="sect1">
<h2 class="sect1">Using Procedural Replication<a id="sthref591"></a><a id="sthref592"></a></h2>
<p>Procedural replication can offer performance advantages for large batch-oriented operations operating on large numbers of rows that can be run serially within a replication environment.</p>
<p>A good example of an appropriate application is a purge operation, also referred to as an archive operation, that you run infrequently (for example, once in each quarter) during off hours to remove old data, or data that was "logically" deleted from the online database. An example using procedural replication to purge deleted rows is described in the "Avoiding Delete Conflicts" section in Chapter 5, "Conflict Resolution Concepts and Architecture", of <a class="olink REPLN005" href="../../server.112/e10706/repconflicts.htm#REPLN005"><span class="italic">Oracle Database Advanced Replication</span></a>.</p>
<div id="REPMA384" class="sect2"><a id="sthref593"></a>
<h3 class="sect2">Restrictions on Procedural Replication<a id="sthref594"></a><a id="sthref595"></a></h3>
<p>All parameters for a replicated procedure must be <code>IN</code> parameters; <code>OUT</code> and <code>IN/OUT</code> modes are not supported. The following data types are supported for these parameters:</p>
<ul>
<li>
<p><code>VARCHAR2</code></p>
</li>
<li>
<p><code>NVARCHAR2</code></p>
</li>
<li>
<p><code>NUMBER</code></p>
</li>
<li>
<p><code>DATE</code></p>
</li>
<li>
<p><code>TIMESTAMP</code></p>
</li>
<li>
<p><code>TIMESTAMP</code> <code>WITH</code> <code>TIME</code> <code>ZONE</code></p>
</li>
<li>
<p><code>TIMESTAMP</code> <code>LOCAL</code> <code>TIME</code> <code>ZONE</code></p>
</li>
<li>
<p><code>INTERVAL</code> <code>YEAR</code> <code>TO</code> <code>MONTH</code></p>
</li>
<li>
<p><code>INTERVAL</code> <code>DAY</code> <code>TO</code> <code>SECOND</code></p>
</li>
<li>
<p><code>RAW</code></p>
</li>
<li>
<p><code>ROWID</code></p>
</li>
<li>
<p><code>CHAR</code></p>
</li>
<li>
<p><code>NCHAR</code></p>
</li>
<li>
<p><code>CLOB</code> with <code>BASICFILE</code> storage</p>
</li>
<li>
<p><code>NCLOB</code> with <code>BASICFILE</code> storage</p>
</li>
<li>
<p><code>BLOB</code> with <code>BASICFILE</code> storage</p>
</li>
<li>
<p><code>XMLType</code> stored as <code>CLOB</code></p>
</li>
<li>
<p>User-defined types that do not use type inheritance or type evolution</p>
</li>
<li>
<p>Oracle-supplied types that do not use type inheritance or type evolution</p>
</li>
</ul>
<p>The following data types are not supported for these parameters:</p>
<ul>
<li>
<p><code>FLOAT</code></p>
</li>
<li>
<p><code>BINARY_FLOAT</code></p>
</li>
<li>
<p><code>BINARY_DOUBLE</code></p>
</li>
<li>
<p><code>LONG</code></p>
</li>
<li>
<p><code>LONG</code> <code>RAW</code></p>
</li>
<li>
<p><code>CLOB</code> with <code>SECUREFILE</code> storage</p>
</li>
<li>
<p><code>NCLOB</code> with <code>SECUREFILE</code> storage</p>
</li>
<li>
<p><code>BLOB</code> with <code>SECUREFILE</code> storage</p>
</li>
<li>
<p><code>BFILE</code></p>
</li>
<li>
<p><code>XMLType</code> stored object relationally or as binary XML</p>
</li>
<li>
<p><code>Expression</code> type</p>
</li>
<li>
<p>User-defined types that use type inheritance or type evolution</p>
</li>
<li>
<p>Oracle-supplied types that use type inheritance or type evolution</p>
</li>
</ul>
<p>Oracle cannot detect update conflicts produced by replicated procedures. Replicated procedures must detect and resolve conflicts themselves. Because of the difficulties involved in writing your own conflict resolution routines, it is best to simply avoid the possibility of conflicts altogether.</p>
<p>Adhering to the following guidelines helps you ensure that your tables remain consistent at all sites when you plan to use procedural replication:</p>
<ul>
<li>
<p>You must disable row-level replication within the body of the deferred procedure. See <a href="#CHDHJFEC">"Updating the Comments Fields in Data Dictionary Views"</a>.</p>
</li>
<li>
<p>Run only one replicated procedure at a time, as described in <a href="#CHDIACGA">"Serializing Transactions"</a>.</p>
</li>
<li>
<p>Propagate deferred transactions serially. For more information about guidelines for scheduled links, see <a class="olink REPLN103" href="../../server.112/e10706/repplan.htm#REPLN103"><span class="italic">Oracle Database Advanced Replication</span></a>.</p>
</li>
<li>
<p>The replicated procedure must be packaged and the package cannot contain any functions. Standalone deferred procedures and standalone or packaged deferred functions are not currently supported.</p>
</li>
<li>
<p>The deferred procedures must reference only locally owned data.</p>
</li>
<li>
<p>The procedures should not use locally generated fields, values, or environmentally dependent SQL functions. For example, the procedure should not call <code>SYSDATE</code>.</p>
</li>
<li>
<p>Your data ownership should be statically partitioned. That is, ownership of a row should not change between sites.</p>
</li>
<li>
<p>If you have multiple master groups at a master site, and one or more master groups are quiesced, then you cannot perform procedural replication on any master group at the master site. This restriction is enforced because a procedure in one master group can update objects in another master group. You can only perform procedural replication when all of the master groups on a master site are replicating data normally (that is, when none of the master groups is quiesced).</p>
<p>For example, if you have a procedure named <code>sal_raise</code> in master group A on master site <code>db1</code>, then you cannot run the <code>sal_raise</code> procedure if master group B on master site <code>db1</code> is quiesced, even if master group A is replicating normally.</p>
</li>
<li>
<p>When using procedural replication, a procedure call is only propagated to master replication sites. The procedure call is not propagated to materialized view sites. However, procedural replication can be initiated at a materialized view site. In this case, the procedure call is propagated to all of the master sites in the replication environment, but the procedure call is not propagated to any other materialized view sites. Other materialized view sites must pull changes made at the master site by performing a materialized view refresh.</p>
<p>For example, suppose a replication environment includes two master sites named <code>msite1</code> and <code>msite2</code> and two materialized view sites named <code>mview1</code> and <code>mview2</code>. If procedural replication is initiated at <code>mview1</code>, then the procedure is run at <code>mview1</code> and the procedure call is propagated to the two master sites, <code>msite1</code> and <code>msite2</code>, where the procedure is also run. However, the procedure call is not propagated to <code>mview2</code>. Therefore, during the next refresh, <code>mview2</code> pulls down all of the changes made by the procedure at its master site.</p>
</li>
</ul>
</div>
<!-- class="sect2" -->
<div id="REPMA385" class="sect2"><a id="sthref596"></a>
<h3 class="sect2">User-Defined Types and Procedural Replication<a id="sthref597"></a><a id="sthref598"></a></h3>
<p>When using procedural replication, the user-defined types and the objects referenced in the procedure must meet the following conditions:</p>
<ul>
<li>
<p>For an object type, all replication sites must agree about the order of attributes in the object type. You establish the attribute order when you create the object type. Consider the following object type:</p>
<pre>
CREATE TYPE cust_address_typ AS OBJECT
     (street_address     VARCHAR2(40), 
      postal_code        VARCHAR2(10), 
      city               VARCHAR2(30), 
      state_province     VARCHAR2(10), 
      country_id         CHAR(2));
/
</pre>
<p>At all replication sites, <code>street_address</code> must be the first attribute, <code>postal_code</code> must be the second attribute, <code>city</code> must be the third attribute, and so on.</p>
</li>
<li>
<p>For an Oracle object, all replication sites must have the same object identifier (OID), schema owner, and type name for each replicated object type.</p>
<p>You can meet these conditions by always using distributed schema management to create or modify any replicated object, including object types, tables with column objects, and object tables. If you do not use distributed schema management to create and modify object types, then replication errors can result.</p>
</li>
</ul>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<a class="olink REPLN" href="../e10706/toc.htm"><span class="italic">Oracle Database Advanced Replication</span></a> for more information about type agreement at replication sites</div>
</div>
<!-- class="sect2" -->
<a id="i22811"></a>
<div id="REPMA386" class="sect2"><a id="CHDIACGA"></a>
<h3 class="sect2">Serializing Transactions<a id="sthref599"></a><a id="sthref600"></a><a id="sthref601"></a></h3>
<p><a id="sthref602"></a><a id="sthref603"></a>Serial execution ensures that your data remains consistent. The replication facility propagates and executes replicated transactions one at a time. For example, assume that you have two procedures, A and B, that perform updates on local data. Now assume that you perform the following actions, in order:</p>
<ol>
<li>
<p>Execute A and B locally.</p>
</li>
<li>
<p>Queue requests to execute other replicas of A and B on other nodes.</p>
</li>
<li>
<p>Commit.</p>
</li>
</ol>
<p>The replicas of A and B on the other nodes are executed completely serially, in the same order that they were committed at the originating site. If A and B execute concurrently at the originating site, however, then they can produce different results locally than they do remotely. Executing A and B serially at the originating site ensures that all sites have identical results. Propagating the transaction serially ensures that A and B are executing in serial order at the target site in all cases.</p>
<p>Alternatively, you could write the procedures carefully, to ensure serialization. For example, you could use <code>SELECT...</code> <code>FOR</code> <code>UPDATE</code> for queries to ensure serialization at the originating site and at the target site if you are using parallel propagation.</p>
</div>
<!-- class="sect2" -->
<div id="REPMA387" class="sect2"><a id="sthref604"></a>
<h3 class="sect2">Generating Support for Replicated Procedures<a id="sthref605"></a><a id="sthref606"></a><a id="sthref607"></a><a id="sthref608"></a><a id="sthref609"></a><a id="sthref610"></a><a id="sthref611"></a><a id="sthref612"></a></h3>
<p>You must disable row-level replication support at the start of your procedure, and then reenable support at the end. This operation ensures that any updates that occur because of executing the procedure are not propagated to other sites. Row-level replication is enabled and disabled by calling the following procedures, respectively:</p>
<ul>
<li>
<p><code>DBMS_REPUTIL.REPLICATION_ON</code></p>
</li>
<li>
<p><code>DBMS_REPUTIL.REPLICATION_OFF</code></p>
</li>
</ul>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<ul>
<li>
<p><a href="rarmanage.htm#i22669">"Disabling Replication"</a></p>
</li>
<li>
<p><a href="rarreputilpac.htm#i93903">"REPLICATION_ON Procedure"</a></p>
</li>
<li>
<p><a href="rarreputilpac.htm#i93895">"REPLICATION_OFF Procedure"</a></p>
</li>
</ul>
</div>
<p>When you generate replication support for your replicated package, Oracle creates a wrapper package in the schema of the replication propagator.</p>
<div class="infobox-note">
<p class="notep1"><span class="bold">Note</span>:</p>
Unregistering the current propagator drops all existing generated wrappers in the propagator's schema. Replication support for wrapped stored procedures must be regenerated after you register a new propagator.</div>
<p>The wrapper package has the same name as the original package, but its name is prefixed with the string you supply when you generate replication support for the procedure. If you do not supply a prefix, then Oracle uses the default prefix, <code>defer_</code>. The wrapper procedure has the same parameters as the original, along with two additional parameters: <code>call_local</code> and <code>call_remote</code>. These two <code>CHAR</code> parameters determine where the procedure is executed. When <code>call_local</code> is <code>'Y'</code>, the procedure is executed locally. When <code>call_remote</code> is <code>'Y'</code>, the procedure will ultimately be executed at all other master sites in the replication environment.</p>
<p>The remote procedures are called directly if you are propagating changes synchronously, or calls to these procedures are added to the deferred transaction queue if you are propagating changes asynchronously. By default, <code>call_local</code> is <code>'N'</code>, and <code>call_remote</code> is <code>'Y'</code>.</p>
<p>Oracle generates replication support for a package in two phases. The first phase creates the package specification at all sites. Phase two generates the package body at all sites. These two phases are necessary to support synchronous replication.</p>
<p>For example, suppose you create the package <code>emp_mgmt</code> containing the procedure <code>new_dept</code>, which takes one argument, <code>email</code>. To replicate this package to all master sites in your system, you can use the Advanced Replication interface in Oracle Enterprise Manager to add the package to a master group and then generate replication support for the object. After completing these steps, an application can call procedure in the replicated package as follows:</p>
<pre>
BEGIN
defer_emp_mgmt.new_dept( email        =&gt; 'jones',
                         call_local   =&gt; 'Y',
                         call_remote  =&gt; 'Y');
END;
/
</pre>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
The Advanced Replication interface's online Help for more information about managing master groups and replicated objects using the Advanced Replication interface in Oracle Enterprise Manager</div>
<p>As shown in <a href="#i22631">Figure 7-4</a>, the logic of the wrapper procedure ensures that the procedure is called at the local site and subsequently at all remote sites. The logic of the wrapper procedure also ensures that when the replicated procedure is called at the remote sites, <code>call_remote</code> is <code>FALSE</code>, ensuring that the procedure is not further propagated.</p>
<p>If you are operating in a mixed replication environment with static partitioning of data ownership (that is, if you are not preventing row-level replication), then Advanced Replication preserves the order of operations at the remote node, because both row-level and procedural replication use the same asynchronous queue.</p>
<div id="REPMA388" class="figure">
<p class="titleinfigure"><a id="i22631"></a>Figure 7-4 Asynchronous Procedural Replication</p>
<img width="600" height="597" src="img/repma008.gif" alt="Description of Figure 7-4 follows" /><br />
<a id="sthref613" href="img_text/repma008.htm">Description of "Figure 7-4 Asynchronous Procedural Replication"</a><br />
<br /></div>
<!-- class="figure" --></div>
<!-- class="sect2" --></div>
<!-- class="sect1" --></div>
<!-- class="chapter" --></div>
<!-- class="ind" -->
<!-- Start Footer -->
</div>
<!-- add extra wrapper close div-->
<footer><!--
<hr />
<table class="cellalignment1768">
<tr>
<td class="cellalignment1777">
<table class="cellalignment1773">
<tr>
<td class="cellalignment1772"><a href="rarpart2.htm"><img width="24" height="24" src="../../dcommon/gifs/leftnav.gif" alt="Go to previous page" /><br />
<span class="icon">Previous</span></a></td>
<td class="cellalignment1772"><a href="rarmanmv.htm"><img width="24" height="24" src="../../dcommon/gifs/rightnav.gif" alt="Go to next page" /><br />
<span class="icon">Next</span></a></td>
</tr>
</table>
</td>
<td class="cellalignment-copyrightlogo"><img width="144" height="18" src="../../dcommon/gifs/oracle.gif" alt="Oracle" /><br />
Copyright&nbsp;&copy;&nbsp;1996, 2013,&nbsp;Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved.<br />
<a href="../../dcommon/html/cpyr.htm">Legal Notices</a></td>
<td class="cellalignment1779">
<table class="cellalignment1771">
<tr>
<td class="cellalignment1772"><a href="../../index.htm"><img width="24" height="24" src="../../dcommon/gifs/doclib.gif" alt="Go to Documentation Home" /><br />
<span class="icon">Home</span></a></td>
<td class="cellalignment1772"><a href="../../nav/portal_booklist.htm"><img width="24" height="24" src="../../dcommon/gifs/booklist.gif" alt="Go to Book List" /><br />
<span class="icon">Book List</span></a></td>
<td class="cellalignment1772"><a href="toc.htm"><img width="24" height="24" src="../../dcommon/gifs/toc.gif" alt="Go to Table of Contents" /><br />
<span class="icon">Contents</span></a></td>
<td class="cellalignment1772"><a href="index.htm"><img width="24" height="24" src="../../dcommon/gifs/index.gif" alt="Go to Index" /><br />
<span class="icon">Index</span></a></td>
<td class="cellalignment1772"><a href="../../nav/mindx.htm"><img width="24" height="24" src="../../dcommon/gifs/masterix.gif" alt="Go to Master Index" /><br />
<span class="icon">Master Index</span></a></td>
<td class="cellalignment1772"><a href="../../dcommon/html/feedback.htm"><img width="24" height="24" src="../../dcommon/gifs/feedbck2.gif" alt="Go to Feedback page" /><br />
<span class="icon">Contact Us</span></a></td>
</tr>
</table>
</td>
</tr>
</table>
--></footer>
<noscript>
<p>Scripting on this page enhances content navigation, but does not change the content in any way.</p>
</noscript>
</body>
</html>
