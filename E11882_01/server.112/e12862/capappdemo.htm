<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta charset="utf-8">
<title>Single-Database Capture and Apply&nbsp;Example</title>
<meta name="generator" content="Oracle DARB XHTML Converter (Mode = document) - Version 5.1.2 Build 732" />
<meta name="dcterms.created" content="2013-06-04T17:50:50Z" />
<meta name="robots" content="all" />
<meta name="dcterms.title" content="Streams Extended Examples" />
<meta name="dcterms.identifier" content="E12862-05" />
<meta name="dcterms.isVersionOf" content="STREX" />
<meta name="dcterms.rights" content="Copyright&nbsp;&copy;&nbsp;2008, 2013,&nbsp;Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved." />
<link rel="Start" href="../../index.htm" title="Home" type="text/html" />
<link rel="Copyright" href="../../dcommon/html/cpyr.htm" title="Copyright" type="text/html" />

<script type="application/javascript"  src="../../dcommon/js/headfoot.js"></script>
<script type="application/javascript"  src="../../nav/js/doccd.js"></script>
<link rel="Contents" href="toc.htm" title="Contents" type="text/html" />
<link rel="Index" href="index.htm" title="Index" type="text/html" />
<link rel="Prev" href="repmultdemo.htm" title="Previous" type="text/html" />
<link rel="Next" href="loblcrdemo.htm" title="Next" type="text/html" />
<link rel="schema.dcterms" href="http://purl.org/dc/terms/" />
<link rel="stylesheet" href="../../dcommon/css/fusiondoc.css">
<link rel="stylesheet" type="text/css"  href="../../dcommon/css/header.css">
<link rel="stylesheet" type="text/css"  href="../../dcommon/css/footer.css">
<link rel="stylesheet" type="text/css"  href="../../dcommon/css/fonts.css">
<link rel="stylesheet" href="../../dcommon/css/foundation.css">
<link rel="stylesheet" href="../../dcommon/css/codemirror.css">
<link rel="stylesheet" type="text/css" title="Default" href="../../nav/css/html5.css">
<link rel="stylesheet" href="../../dcommon/css/respond-480-tablet.css">
<link rel="stylesheet" href="../../dcommon/css/respond-768-laptop.css">
<link rel="stylesheet" href="../../dcommon/css/respond-1140-deskop.css">
<script type="application/javascript" src="../../dcommon/js/modernizr.js"></script>
<script type="application/javascript" src="../../dcommon/js/codemirror.js"></script>
<script type="application/javascript" src="../../dcommon/js/jquery.js"></script>
<script type="application/javascript" src="../../dcommon/js/foundation.min.js"></script>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-552992c80ef99c8d" async="async"></script>
<script type="application/javascript" src="../../dcommon/js/jqfns.js"></script>
<script type="application/javascript" src="../../dcommon/js/ohc-inline-videos.js"></script>
<!-- Add fancyBox -->
<link rel="stylesheet" href="../../dcommon/fancybox/jquery.fancybox.css?v=2.1.5" type="text/css" media="screen" />
<script type="text/javascript" src="../../dcommon/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>
<!-- Optionally add helpers - button, thumbnail and/or media -->
<link rel="stylesheet"  href="../../dcommon/fancybox/helpers/jquery.fancybox-buttons.css?v=1.0.5"  type="text/css" media="screen" />
<script type="text/javascript" src="../../dcommon/fancybox/helpers/jquery.fancybox-buttons.js?v=1.0.5"></script>
<script type="text/javascript" src="../../dcommon/fancybox/helpers/jquery.fancybox-media.js?v=1.0.6"></script>
<link rel="stylesheet"  href="../../dcommon/fancybox/helpers/jquery.fancybox-thumbs.css?v=1.0.7"  type="text/css" media="screen" />
<script type="text/javascript" src="../../dcommon/fancybox/helpers/jquery.fancybox-thumbs.js?v=1.0.7"></script>
</head>
<body>
<a href="#BEGIN" class="accessibility-top skipto" tabindex="0">Go to main content</a><header><!--
<div class="zz-skip-header"><a id="top" href="#BEGIN">Go to main content</a>--></header>
<div class="row" id="CONTENT">
<div class="IND large-9 medium-8 columns">
<a id="BEGIN" name="BEGIN"></a>
<span id="PAGE" style="display:none;">7/10</span> <!-- End Header -->
<div id="STREX016" class="chapter"><a id="BCGBIEDJ"></a><a id="BCGGBIJE"></a>
<h1 class="chapter"><span class="secnum">4</span> Single-Database Capture and Apply&nbsp;Example</h1>
<p><a id="sthref66"></a><a id="sthref67"></a>This chapter illustrates an example of a single database that captures changes to a table with a capture process, reenqueues the captured changes into a queue, and then uses a procedure DML handler during apply to insert a subset of the changes into a different table.</p>
<p>The following topics describe configuring an example single-database capture and apply example:</p>
<ul>
<li>
<p><a href="#i1006108">Overview of the Single-Database Capture and Apply Example</a></p>
</li>
<li>
<p><a href="#BCGIJAIF">Prerequisites</a></p>
</li>
<li>
<p><a href="#BCGFEGAA">Set Up the Environment</a></p>
</li>
<li>
<p><a href="#BCGDJFCJ">Configure Capture and Apply</a></p>
</li>
<li>
<p><a href="#BCGCDHJB">Make DML Changes, Query for Results, and Dequeue Messages</a></p>
</li>
</ul>
<a id="i1006108"></a>
<div id="STREX1150" class="sect1">
<h2 class="sect1">Overview of the Single-Database Capture and Apply Example</h2>
<p>The example in this chapter illustrates using Oracle Streams to capture and apply data manipulation language (DML) changes at a single database named <code>cpap.example.com</code>. Specifically, this example captures DML changes to the <code>employees</code> table in the <code>hr</code> schema, placing row logical change records (LCRs) into a queue named <code>streams_queue</code>. Next, an apply process dequeues these row LCRs from the same queue, reenqueues them into this queue, and sends them to a procedure DML handler.</p>
<p>When the row LCRs are captured, they reside in the buffered queue and cannot be dequeued explicitly. After the row LCRs are reenqueued during apply, they are available for explicit dequeue by an application. This example does not create the application that dequeues these row LCRs.</p>
<p>This example illustrates a procedure DML handler that inserts records of deleted employees into an <code>emp_del</code> table in the <code>hr</code> schema. This example assumes that the <code>emp_del</code> table is used to retain the records of all deleted employees. The procedure DML handler is used to determine whether each row LCR contains a <code>DELETE</code> statement. When the procedure DML handler finds a row LCR containing a <code>DELETE</code> statement, it converts the <code>DELETE</code> into an <code>INSERT</code> on the <code>emp_del</code> table and then inserts the row.</p>
<p><a href="#i1006120">Figure 4-1</a> provides an overview of the environment.</p>
<div id="STREX1151" class="figure">
<p class="titleinfigure"><a id="i1006120"></a>Figure 4-1 Single Database Capture and Apply Example</p>
<img width="500" height="345" src="img/strex036.gif" alt="Description of Figure 4-1 follows" /><br />
<a id="sthref68" href="img_text/strex036.htm">Description of "Figure 4-1 Single Database Capture and Apply Example"</a><br />
<br /></div>
<!-- class="figure" -->
<div class="infoboxnotealso">
<p class="notep1"><span class="bold">See Also</span>:</p>
<a class="olink STRMS" href="../e17069/toc.htm"><span class="italic">Oracle Streams Concepts and Administration</span></a></div>
</div>
<!-- class="sect1" -->
<a id="BCGIJAIF"></a>
<div id="STREX1152" class="sect1">
<h2 class="sect1">Prerequisites</h2>
<p>The following prerequisites must be completed before you begin the example in this chapter.</p>
<ul>
<li>
<p>Optionally set the <code>STREAMS_POOL_SIZE</code> initialization parameter to an appropriate value. This parameter specifies the size of the Oracle Streams pool. The Oracle Streams pool stores messages in a buffered queue and is used for internal communications during parallel capture and apply. When the <code>MEMORY_TARGET</code>, <code>MEMORY_MAX_TARGET</code>, or <code>SGA_TARGET</code> initialization parameter is set to a nonzero value, the Oracle Streams pool size is managed automatically.</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<a class="olink STREP201" href="../../server.112/e10705/prep_rep.htm#STREP201"><span class="italic">Oracle Streams Replication Administrator's Guide</span></a> for information about setting initialization parameters that are relevant to Oracle Streams</div>
</li>
<li>
<p><a id="sthref69"></a><a id="sthref70"></a>Set the database to run in <code>ARCHIVELOG</code> mode. Any database producing changes that will be captured must run in <code>ARCHIVELOG</code> mode.</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<a class="olink ADMIN008" href="../../server.112/e25494/archredo.htm#ADMIN008"><span class="italic">Oracle Database Administrator's Guide</span></a> for information about running a database in <code>ARCHIVELOG</code> mode</div>
</li>
<li>
<p>Create an Oracle Streams administrator at the database. This example assumes that the user name of the Oracle Streams administrator is <code>strmadmin</code>.</p>
<p>This example executes a subprogram in an Oracle Streams packages within a stored procedure. Specifically, the <code>emp_dq</code> procedure created in Step <a href="#BCGBDCGF">8</a> runs the <code>DEQUEUE</code> procedure in the <code>DBMS_STREAMS_MESSAGING</code> package. Therefore, the Oracle Streams administrator must be granted <code>EXECUTE</code> privilege explicitly on the package. In this case, <code>EXECUTE</code> privilege cannot be granted through a role. The <code>DBMS_STREAMS_AUTH.GRANT_ADMIN_PRIVILEGE</code> procedure grants <code>EXECUTE</code> on all Oracle Streams packages, as well as other privileges relevant to Oracle Streams. You can either grant the <code>EXECUTE</code> privilege on the package directly, or use the <code>GRANT_ADMIN_PRIVILEGE</code> procedure to grant it.</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<a class="olink STREP200" href="../../server.112/e10705/prep_rep.htm#STREP200"><span class="italic">Oracle Streams Replication Administrator's Guide</span></a> for information about creating an Oracle Streams administrator</div>
</li>
</ul>
</div>
<!-- class="sect1" -->
<a id="BCGFEGAA"></a>
<div id="STREX1153" class="sect1">
<h2 class="sect1">Set Up the Environment</h2>
<p>Complete the following steps to create the <code>hr.emp_del</code> table, set up the Oracle Streams administrator, and create the queue.</p>
<ol>
<li>
<p><a href="#i1048981">Show Output and Spool Results</a></p>
</li>
<li>
<p><a href="#BCGFEIJC">Create the hr.emp_del Table</a></p>
</li>
<li>
<p><a href="#BCGCFFDF">Grant Additional Privileges to the Oracle Streams Administrator</a></p>
</li>
<li>
<p><a href="#BCGBBCJI">Create the ANYDATA Queue at cpap.example.com</a></p>
</li>
<li id="BCGHHFAB">
<p><a href="#BCGCAGAA">Check the Spool Results</a></p>
</li>
</ol>
<div class="infobox-note">
<p class="notep1">Note:</p>
If you are viewing this document online, then you can copy the text from the "BEGINNING OF SCRIPT" line after this note to the next "END OF SCRIPT" line into a text editor and then edit the text to create a script for your environment. Run the script with SQL*Plus on a computer that can connect to the database.</div>
<pre>
/************************* BEGINNING OF SCRIPT ******************************
</pre>
<a id="i1048981"></a>
<dl>
<dd><a id="STREX1308"></a><a id="sthref71"></a></dd>
<dt class="seghead">Step 1&nbsp;&nbsp;&nbsp;Show Output and Spool Results</dt>
<dd>
<p>Run <code>SET</code> <code>ECHO</code> <code>ON</code> and specify the spool file for the script. Check the spool file for errors after you run this script.</p>
<pre>
*/

SET ECHO ON
SPOOL streams_setup_capapp.out

/*
</pre></dd>
<dd><a id="STREX1309"></a><a id="BCGFEIJC"></a></dd>
<dt class="seghead">Step 2&nbsp;&nbsp;&nbsp;Create the hr.emp_del Table</dt>
<dd>
<p>Connect to <code>cpap.example.com</code> as the <code>hr</code> user.</p>
<pre>
*/
 
CONNECT hr@cpap.example.com

/*
</pre>
<p>Create the <code>hr.emp_del</code> table. The columns in the <code>emp_del</code> table is the same as the columns in the <code>employees</code> table, except for one added <code>timestamp</code> column that will record the date when a row is inserted into the <code>emp_del</code> table.</p>
<pre>
*/

CREATE TABLE emp_del( 
  employee_id    NUMBER(6), 
  first_name     VARCHAR2(20), 
  last_name      VARCHAR2(25), 
  email          VARCHAR2(25), 
  phone_number   VARCHAR2(20), 
  hire_date      DATE, 
  job_id         VARCHAR2(10), 
  salary         NUMBER(8,2), 
  commission_pct NUMBER(2,2), 
  manager_id     NUMBER(6), 
  department_id  NUMBER(4),
  timestamp      DATE);

CREATE UNIQUE INDEX emp_del_id_pk ON emp_del (employee_id);

ALTER TABLE emp_del ADD (CONSTRAINT emp_del_id_pk PRIMARY KEY (employee_id));

/*
</pre></dd>
<dd><a id="STREX1310"></a><a id="BCGCFFDF"></a></dd>
<dt class="seghead">Step 3&nbsp;&nbsp;&nbsp;Grant Additional Privileges to the Oracle Streams Administrator</dt>
<dd>
<p>Connect to <code>cpap.example.com</code> as <code>SYSTEM</code> user.</p>
<pre>
*/
 
CONNECT SYSTEM@cpap.example.com

/*
</pre>
<p>Grant the Oracle Streams administrator all privileges on the <code>emp_del</code> table, because the Oracle Streams administrator will be the apply user and must be able to insert records into this table. Alternatively, you can alter the apply process to specify that <code>hr</code> is the apply user.</p>
<pre>
*/

GRANT ALL ON hr.emp_del TO STRMADMIN;

/*
</pre></dd>
<dd><a id="STREX1311"></a><a id="BCGBBCJI"></a></dd>
<dt class="seghead">Step 4&nbsp;&nbsp;&nbsp;Create the ANYDATA Queue at cpap.example.com</dt>
<dd>
<p>Connect to <code>cpap.example.com</code> as the <code>strmadmin</code> user.</p>
<pre>
*/

CONNECT strmadmin@cpap.example.com

/*
</pre>
<p>Run the <code>SET_UP_QUEUE</code> procedure to create a queue named <code>streams_queue</code> at <code>cpap.example.com</code>. This queue is an <code>ANYDATA</code> queue that will stage the captured changes to be dequeued by an apply process and the user-constructed changes to be dequeued by a dequeue procedure.</p>
<p>Running the <code>SET_UP_QUEUE</code> procedure performs the following actions:</p>
<ul>
<li>
<p>Creates a queue table named <code>streams_queue_table</code>. This queue table is owned by the Oracle Streams administrator (<code>strmadmin</code>) and uses the default storage of this user.</p>
</li>
<li>
<p>Creates a queue named <code>streams_queue</code> owned by the Oracle Streams administrator (<code>strmadmin</code>).</p>
</li>
<li>
<p>Starts the queue.</p>
</li>
</ul>
<pre>
*/

BEGIN
  DBMS_STREAMS_ADM.SET_UP_QUEUE(
    queue_table  =&gt; 'strmadmin.streams_queue_table',
    queue_name   =&gt; 'strmadmin.streams_queue');
END;
/

/*
</pre></dd>
<dd><a id="STREX1312"></a><a id="BCGCAGAA"></a></dd>
<dt class="seghead">Step 5&nbsp;&nbsp;&nbsp;Check the Spool Results</dt>
<dd>
<p>Check the <code>streams_setup_capapp.out</code> spool file to ensure that all actions finished successfully after this script is completed.</p>
<pre>
*/

SET ECHO OFF
SPOOL OFF

<a id="i1049117"></a>/*************************** END OF SCRIPT ******************************/
</pre></dd>
</dl>
</div>
<!-- class="sect1" -->
<a id="BCGDJFCJ"></a>
<div id="STREX1154" class="sect1">
<h2 class="sect1">Configure Capture and Apply</h2>
<p>Complete the following steps to capture changes to the <code>hr.employees</code> table and apply these changes on single database in a customized way using a procedure DML handler.</p>
<ol>
<li>
<p><a href="#i1049180">Show Output and Spool Results</a></p>
</li>
<li>
<p><a href="#BCGIIGJG">Configure the Capture Process at cpap.example.com</a></p>
</li>
<li>
<p><a href="#BCGCHEJI">Set the Instantiation SCN for the hr.employees Table</a></p>
</li>
<li>
<p><a href="#BCGIBEIF">Create the Procedure DML Handler handler Procedure</a></p>
</li>
<li>
<p><a href="#BCGEJIFC">Set the Procedure DML Handler for the hr.employees Table</a></p>
</li>
<li>
<p><a href="#BCGHAFHC">Create a Messaging Client for the Queue</a></p>
</li>
<li>
<p><a href="#BCGDJEEC">Configure the Apply Process at cpap.example.com</a></p>
</li>
<li>
<p><a href="#BCGBDCGF">Create a Procedure to Dequeue the Messages</a></p>
</li>
<li>
<p><a href="#BCGIBCGB">Start the Apply Process at cpap.example.com</a></p>
</li>
<li>
<p><a href="#BCGEFIAC">Start the Capture Process at cpap.example.com</a></p>
</li>
<li>
<p><a href="#BCGEHBBB">Check the Spool Results</a></p>
</li>
</ol>
<div class="infobox-note">
<p class="notep1">Note:</p>
If you are viewing this document online, then you can copy the text from the "BEGINNING OF SCRIPT" line after this note to the next "END OF SCRIPT" line into a text editor and then edit the text to create a script for your environment. Run the script with SQL*Plus on a computer that can connect the database.</div>
<pre>
/************************* BEGINNING OF SCRIPT ******************************
</pre>
<a id="i1049180"></a>
<dl>
<dd><a id="STREX1313"></a><a id="sthref72"></a></dd>
<dt class="seghead">Step 1&nbsp;&nbsp;&nbsp;Show Output and Spool Results</dt>
<dd>
<p>Run <code>SET</code> <code>ECHO</code> <code>ON</code> and specify the spool file for the script. Check the spool file for errors after you run this script.</p>
<pre>
*/

SET ECHO ON
SPOOL streams_config_capapp.out

/*
</pre></dd>
<dd><a id="STREX1314"></a><a id="BCGIIGJG"></a></dd>
<dt class="seghead">Step 2&nbsp;&nbsp;&nbsp;Configure the Capture Process at cpap.example.com</dt>
<dd>
<p>Connect to <code>cpap.example.com</code> as the <code>strmadmin</code> user.</p>
<pre>
*/
 
CONNECT strmadmin@cpap.example.com

/*
</pre>
<p>Configure the capture process to capture DML changes to the <code>hr.employees</code> table at <code>cpap.example.com</code>. This step creates the capture process and adds a rule to its positive rule set that instructs the capture process to capture DML changes to this table. This step also prepares the <code>hr.employees</code> table for instantiation and enables supplemental logging for any primary key, unique key, bitmap index, and foreign key columns in the table.</p>
<p>Supplemental logging places additional information in the redo log for changes made to tables. The apply process needs this extra information to perform some operations, such as unique row identification.</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<a class="olink STREP107" href="../../server.112/e10705/prep_rep.htm#STREP107"><span class="italic">Oracle Streams Replication Administrator's Guide</span></a></div>
<pre>
*/

BEGIN
  DBMS_STREAMS_ADM.ADD_TABLE_RULES(
    table_name     =&gt; 'hr.employees',   
    streams_type   =&gt; 'capture',
    streams_name   =&gt; 'capture_emp',
    queue_name     =&gt; 'strmadmin.streams_queue',
    include_dml    =&gt;  TRUE,
    include_ddl    =&gt;  FALSE,
    inclusion_rule =&gt;  TRUE);
END;
/

/*
</pre></dd>
<dd><a id="STREX1315"></a><a id="BCGCHEJI"></a></dd>
<dt class="seghead">Step 3&nbsp;&nbsp;&nbsp;Set the Instantiation SCN for the hr.employees Table</dt>
<dd>
<p>Because this example captures and applies changes in a single database, no instantiation is necessary. However, the apply process at the <code>cpap.example.com</code> database still must be instructed to apply changes that were made to the <code>hr.employees</code> table after a specific system change number (SCN).</p>
<p>This example uses the <code>GET_SYSTEM_CHANGE_NUMBER</code> function in the <code>DBMS_FLASHBACK</code> package to obtain the current SCN for the database. This SCN is used to run the <code>SET_TABLE_INSTANTIATION_SCN</code> procedure in the <code>DBMS_APPLY_ADM</code> package.</p>
<p>The <code>SET_TABLE_INSTANTIATION_SCN</code> procedure controls which LCRs for a table are ignored by an apply process and which LCRs for a table are applied by an apply process. If the commit SCN of an LCR for a table from a source database is less than or equal to the instantiation SCN for that table at a destination database, then the apply process at the destination database discards the LCR. Otherwise, the apply process applies the LCR. In this example, the <code>cpap.example.com</code> database is both the source database and the destination database.</p>
<p>The apply process will apply transactions to the <code>hr.employees</code> table with SCNs that were committed after SCN obtained in this step.</p>
<div class="infobox-note">
<p class="notep1">Note:</p>
The <code>hr.employees</code> table also must be prepared for instantiation. This preparation was done automatically when the capture process was configured with a rule to capture DML changes to the <code>hr.employees</code> table in Step <a href="#BCGIIGJG">2</a>.</div>
<pre>
*/

DECLARE
  iscn  NUMBER;         -- Variable to hold instantiation SCN value
BEGIN
  iscn := DBMS_FLASHBACK.GET_SYSTEM_CHANGE_NUMBER();
  DBMS_APPLY_ADM.SET_TABLE_INSTANTIATION_SCN(
    source_object_name    =&gt; 'hr.employees',
    source_database_name  =&gt; 'cpap.example.com',
    instantiation_scn     =&gt; iscn);
END;
/

/*
</pre></dd>
<dd><a id="STREX1316"></a><a id="BCGIBEIF"></a></dd>
<dt class="seghead">Step 4&nbsp;&nbsp;&nbsp;Create the Procedure DML Handler handler Procedure<a id="sthref73"></a><a id="sthref74"></a><a id="sthref75"></a><a id="sthref76"></a><a id="sthref77"></a><a id="sthref78"></a><a id="sthref79"></a><a id="sthref80"></a><a id="sthref81"></a></dt>
<dd>
<p>This step creates the <code>emp_dml_handler</code> procedure. This procedure will be the procedure DML handler for <code>DELETE</code> changes to the <code>hr.employees</code> table. It converts any row LCR containing a <code>DELETE</code> command type into an <code>INSERT</code> row LCR and then inserts the converted row LCR into the <code>hr.emp_del</code> table by executing the row&nbsp;LCR.</p>
<pre>
*/

CREATE OR REPLACE PROCEDURE emp_dml_handler(in_any IN ANYDATA) IS
  lcr          SYS.LCR$_ROW_RECORD;
  rc           PLS_INTEGER;
  command      VARCHAR2(30);
  old_values   SYS.LCR$_ROW_LIST;
BEGIN    
  -- Access the LCR
  rc := in_any.GETOBJECT(lcr);
  -- Get the object command type
  command := lcr.GET_COMMAND_TYPE();
  -- Check for DELETE command on the hr.employees table
  IF command = 'DELETE' THEN
    -- Set the command_type in the row LCR to INSERT
    lcr.SET_COMMAND_TYPE('INSERT');
    -- Set the object_name in the row LCR to EMP_DEL
    lcr.SET_OBJECT_NAME('EMP_DEL');
    -- Get the old values in the row LCR
    old_values := lcr.GET_VALUES('old');
    -- Set the old values in the row LCR to the new values in the row LCR
    lcr.SET_VALUES('new', old_values);
    -- Set the old values in the row LCR to NULL
    lcr.SET_VALUES('old', NULL);
    -- Add a SYSDATE value for the timestamp column
    lcr.ADD_COLUMN('new', 'TIMESTAMP', ANYDATA.ConvertDate(SYSDATE));
    -- Apply the row LCR as an INSERT into the hr.emp_del table
    lcr.EXECUTE(TRUE);
  END IF;
END;
/

/*
</pre></dd>
<dd><a id="STREX1317"></a><a id="BCGEJIFC"></a></dd>
<dt class="seghead">Step 5&nbsp;&nbsp;&nbsp;Set the Procedure DML Handler for the hr.employees Table</dt>
<dd>
<p>Set the procedure DML handler for the <code>hr.employees</code> table to the procedure created in Step&nbsp;<a href="#BCGIBEIF">4</a>. Notice that the <code>operation_name</code> parameter is set to <code>DEFAULT</code> so that the procedure DML handler is used for each possible operation on the table, including <code>INSERT</code>, <code>UPDATE</code>, and <code>DELETE</code>.</p>
<pre>
*/

BEGIN
  DBMS_APPLY_ADM.SET_DML_HANDLER(
    object_name         =&gt; 'hr.employees',
    object_type         =&gt; 'TABLE',
    operation_name      =&gt; 'DEFAULT',
    error_handler       =&gt; FALSE,
    user_procedure      =&gt; 'strmadmin.emp_dml_handler',
    apply_database_link =&gt; NULL,
    apply_name          =&gt; NULL);
END;
/

/*
</pre></dd>
<dd><a id="STREX1318"></a><a id="BCGHAFHC"></a></dd>
<dt class="seghead">Step 6&nbsp;&nbsp;&nbsp;Create a Messaging Client for the Queue<a id="sthref82"></a></dt>
<dd>
<p>Create a messaging client that can be used by an application to dequeue the reenqueued messages. A messaging client must be specified before the messages can be reenqueued into the queue.</p>
<pre>
*/

BEGIN
  DBMS_STREAMS_ADM.ADD_TABLE_RULES(
    table_name     =&gt; 'hr.employees',   
    streams_type   =&gt; 'dequeue',
    streams_name   =&gt; 'hr',
    queue_name     =&gt; 'strmadmin.streams_queue',
    include_dml    =&gt;  TRUE,
    include_ddl    =&gt;  FALSE,
    inclusion_rule =&gt;  TRUE);
END;
/

/*
</pre></dd>
<dd><a id="STREX1319"></a><a id="BCGDJEEC"></a></dd>
<dt class="seghead">Step 7&nbsp;&nbsp;&nbsp;Configure the Apply Process at cpap.example.com<a id="sthref83"></a><a id="sthref84"></a></dt>
<dd>
<p>Create an apply process to apply DML changes to the <code>hr.employees</code> table. Although the procedure DML handler for the apply process causes deleted employees to be inserted into the <code>emp_del</code> table, this rule specifies the <code>employees</code> table, because the row LCRs in the queue contain changes to the <code>employees</code> table, not the <code>emp_del</code> table. When you run the <code>ADD_TABLE_RULES</code> procedure to create the apply process, the out parameter <code>dml_rule_name</code> contains the name of the DML rule created. This rule name is then passed to the <code>SET_ENQUEUE_DESTINATION</code> procedure.</p>
<p>The <code>SET_ENQUEUE_DESTINATION</code> procedure in the <code>DBMS_APPLY_ADM</code> package specifies that any apply process using the DML rule generated by <code>ADD_TABLE_RULES</code> will enqueue messages that satisfy this rule into <code>streams_queue</code>. In this case, the DML rule is for row LCRs with DML changes to the <code>hr.employees</code> table. A local queue other than the apply process queue can be specified if appropriate.</p>
<pre>
*/

DECLARE
          emp_rule_name_dml  VARCHAR2(30);
          emp_rule_name_ddl  VARCHAR2(30);
BEGIN
  DBMS_STREAMS_ADM.ADD_TABLE_RULES(
    table_name      =&gt; 'hr.employees',
    streams_type    =&gt; 'apply', 
    streams_name    =&gt; 'apply_emp',
    queue_name      =&gt; 'strmadmin.streams_queue',
    include_dml     =&gt;  TRUE,
    include_ddl     =&gt;  FALSE,
    source_database =&gt; 'cpap.example.com',
    dml_rule_name   =&gt; emp_rule_name_dml,
    ddl_rule_name   =&gt; emp_rule_name_ddl);
  DBMS_APPLY_ADM.SET_ENQUEUE_DESTINATION(
    rule_name               =&gt;  emp_rule_name_dml,
    destination_queue_name  =&gt;  'strmadmin.streams_queue');
END;
/

/*
</pre></dd>
<dd><a id="STREX1320"></a><a id="BCGBDCGF"></a></dd>
<dt class="seghead">Step 8&nbsp;&nbsp;&nbsp;Create a Procedure to Dequeue the Messages<a id="sthref85"></a><a id="sthref86"></a></dt>
<dd>
<p>The <code>emp_dq</code> procedure created in this step can be used to dequeue the messages that are reenqueued by the apply process. In Step <a href="#BCGDJEEC">7</a>, the <code>SET_ENQUEUE_DESTINATION</code> procedure was used to instruct the apply process to enqueue row LCRs containing changes to the <code>hr.employees</code> table into <code>streams_queue</code>. When the <code>emp_dq</code> procedure is executed, it dequeues each row LCR in the queue and displays the type of command in the row LCR, either <code>INSERT</code>, <code>UPDATE</code>, or <code>DELETE</code>. Any information in the row LCRs can be accessed and displayed, not just the command type.</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<a class="olink STRMS143" href="../../server.112/e17069/strms_apmon.htm#STRMS143"><span class="italic">Oracle Streams Concepts and Administration</span></a> for more information about displaying information in LCRs</div>
<pre>
*/

CREATE OR REPLACE PROCEDURE emp_dq (consumer IN VARCHAR2) AS
  msg            ANYDATA;
  row_lcr        SYS.LCR$_ROW_RECORD;
  num_var        pls_integer;
  more_messages  BOOLEAN := TRUE;
  navigation     VARCHAR2(30);
BEGIN
  navigation := 'FIRST MESSAGE';
  WHILE (more_messages) LOOP
    BEGIN
      DBMS_STREAMS_MESSAGING.DEQUEUE(
        queue_name   =&gt; 'strmadmin.streams_queue',
        streams_name =&gt; consumer,
        payload      =&gt; msg,
        navigation   =&gt; navigation,
        wait         =&gt; DBMS_STREAMS_MESSAGING.NO_WAIT);
      IF msg.GETTYPENAME() = 'SYS.LCR$_ROW_RECORD' THEN
        num_var := msg.GetObject(row_lcr);   
        DBMS_OUTPUT.PUT_LINE(row_lcr.GET_COMMAND_TYPE || ' row LCR dequeued');
      END IF;
      navigation := 'NEXT MESSAGE';
    COMMIT;
    EXCEPTION WHEN SYS.DBMS_STREAMS_MESSAGING.ENDOFCURTRANS THEN
                navigation := 'NEXT TRANSACTION';
              WHEN DBMS_STREAMS_MESSAGING.NOMOREMSGS THEN
                more_messages := FALSE;
                DBMS_OUTPUT.PUT_LINE('No more messages.');
              WHEN OTHERS THEN
                RAISE; 
    END;
  END LOOP;
END;
/

/*
</pre></dd>
<dd><a id="STREX1321"></a><a id="BCGIBCGB"></a></dd>
<dt class="seghead">Step 9&nbsp;&nbsp;&nbsp;Start the Apply Process at cpap.example.com</dt>
<dd>
<p>Set the <code>disable_on_error</code> parameter to <code>n</code> so that the apply process will not be disabled if it encounters an error, and start the apply process at <code>cpap.example.com</code>.</p>
<pre>
*/

BEGIN
  DBMS_APPLY_ADM.SET_PARAMETER(
    apply_name  =&gt; 'apply_emp', 
    parameter   =&gt; 'disable_on_error', 
    value       =&gt; 'N');
END;
/
 
BEGIN
  DBMS_APPLY_ADM.START_APPLY(
    apply_name  =&gt; 'apply_emp');
END;
/

/*
</pre></dd>
<dd><a id="STREX1322"></a><a id="BCGEFIAC"></a></dd>
<dt class="seghead">Step 10&nbsp;&nbsp;&nbsp;Start the Capture Process at cpap.example.com</dt>
<dd>
<p>Start the capture process at <code>cpap.example.com</code>.</p>
<pre>
*/

BEGIN
  DBMS_CAPTURE_ADM.START_CAPTURE(
    capture_name  =&gt; 'capture_emp');
END;
/

/*
</pre></dd>
<dd><a id="STREX1323"></a><a id="BCGEHBBB"></a></dd>
<dt class="seghead">Step 11&nbsp;&nbsp;&nbsp;Check the Spool Results</dt>
<dd>
<p>Check the <code>streams_config_capapp.out</code> spool file to ensure that all actions finished successfully after this script is completed.</p>
<pre>
*/

SET ECHO OFF
SPOOL OFF

<a id="i1049504"></a>/*************************** END OF SCRIPT ******************************/
</pre></dd>
</dl>
</div>
<!-- class="sect1" -->
<a id="BCGCDHJB"></a>
<div id="STREX1155" class="sect1">
<h2 class="sect1">Make DML Changes, Query for Results, and Dequeue Messages</h2>
<p>Complete the following steps to confirm that apply process is configured correctly, make DML changes to the <code>hr.employees</code> table, query for the resulting inserts into the <code>hr.emp_del</code> table and the reenqueued messages in the <code>streams_queue_table</code>, and dequeue the messages that were reenqueued by the apply process:</p>
<ol>
<li>
<p><a href="#BCGEJEHA">Confirm the Rule Action Context</a></p>
</li>
<li>
<p><a href="#BCGFIAAD">Perform an INSERT, UPDATE, and DELETE on hr.employees</a></p>
</li>
<li>
<p><a href="#BCGEAGAB">Query the hr.emp_del Table and the streams_queue_table</a></p>
</li>
<li>
<p><a href="#BCGFEDFH">Dequeue Messages Reenqueued by the Procedure DML Handler</a></p>
</li>
</ol>
<dl>
<dd><a id="STREX1324"></a><a id="BCGEJEHA"></a></dd>
<dt class="seghead">Step 1&nbsp;&nbsp;&nbsp;Confirm the Rule Action Context</dt>
<dd>
<p>Step <a href="#BCGDJEEC">7</a> creates an apply process rule that specifies a destination queue into which LCRs that satisfy the rule are enqueued. In this case, LCRs that satisfy the rule are row LCRs with changes to the <code>hr.employees</code> table.</p>
<p>Complete the following steps to confirm that the rule specifies a destination queue:</p>
<a id="i1049518"></a>
<ol>
<li id="BCGDGHJG">
<p>Run the following query to determine the name of the rule for DML changes to the <code>hr.employees</code> table used by the apply process <code>apply_emp</code>:</p>
<pre>
CONNECT strmadmin@cpap.example.com
Enter password: <span class="italic">password</span>

SELECT RULE_OWNER, RULE_NAME FROM DBA_STREAMS_RULES 
  WHERE STREAMS_NAME = 'APPLY_EMP' AND
        STREAMS_TYPE = 'APPLY' AND
        SCHEMA_NAME  = 'HR' AND
        OBJECT_NAME  = 'EMPLOYEES' AND
        RULE_TYPE    = 'DML'
  ORDER BY RULE_NAME;
</pre>
<p>Your output looks similar to the following:</p>
<pre>
RULE_OWNER                     RULE_NAME
------------------------------ ------------------------------
STRMADMIN                      EMPLOYEES3
</pre></li>
<li>
<p>View the action context for the rule returned by the query in Step <a href="#BCGDGHJG">1</a>:</p>
<pre>
COLUMN RULE_OWNER HEADING 'Rule Owner' FORMAT A15
COLUMN DESTINATION_QUEUE_NAME HEADING 'Destination Queue' FORMAT A30

SELECT RULE_OWNER, DESTINATION_QUEUE_NAME
  FROM DBA_APPLY_ENQUEUE
  WHERE RULE_NAME = 'EMPLOYEES3'
  ORDER BY DESTINATION_QUEUE_NAME;
</pre>
<p>Ensure that you substitute the rule name returned in Step <a href="#BCGDGHJG">1</a> in the <code>WHERE</code> clause. Your output looks similar to the following:</p>
<pre>
Rule Owner      Destination Queue
--------------- ------------------------------
STRMADMIN       "STRMADMIN"."STREAMS_QUEUE"
</pre>
<p>The output should show that LCRs that satisfy the apply process rule are enqueued into <code>streams_queue</code>.</p>
</li>
</ol>
</dd>
<dd><a id="STREX1325"></a><a id="BCGFIAAD"></a></dd>
<dt class="seghead">Step 2&nbsp;&nbsp;&nbsp;Perform an INSERT, UPDATE, and DELETE on hr.employees</dt>
<dd>
<p>Make the following DML changes to the <code>hr.employees</code> table.</p>
<pre>
CONNECT hr@cpap.example.com
Enter password: <span class="italic">password</span>

INSERT INTO hr.employees VALUES(207, 'JOHN', 'SMITH', 'JSMITH@EXAMPLE.COM', 
  NULL, '07-JUN-94', 'AC_ACCOUNT', 777, NULL, NULL, 110);
COMMIT;

UPDATE hr.employees SET salary=5999 WHERE employee_id=207;
COMMIT;

DELETE FROM hr.employees WHERE employee_id=207;
COMMIT;
</pre></dd>
<dd><a id="STREX1326"></a><a id="BCGEAGAB"></a></dd>
<dt class="seghead">Step 3&nbsp;&nbsp;&nbsp;Query the hr.emp_del Table and the streams_queue_table</dt>
<dd>
<p>After some time passes to allow for capture and apply of the changes performed in the previous step, run the following queries to see the results:</p>
<pre>
CONNECT strmadmin@cpap.example.com
Enter password: <span class="italic">password</span>

SELECT employee_id, first_name, last_name, timestamp 
  FROM hr.emp_del ORDER BY employee_id;

SELECT MSG_ID, MSG_STATE, CONSUMER_NAME 
  FROM AQ$STREAMS_QUEUE_TABLE ORDER BY MSG_ID;
</pre>
<p>When you run the first query, you should see a record for the employee with an <code>employee_id</code> of <code>207</code>. This employee was deleted in the previous step. When you run the second query, you should see the reenqueued messages resulting from all of the changes in the previous step, and the <code>MSG_STATE</code> should be <code>READY</code> for these messages.</p>
</dd>
<dd><a id="STREX1327"></a><a id="BCGFEDFH"></a></dd>
<dt class="seghead">Step 4&nbsp;&nbsp;&nbsp;Dequeue Messages Reenqueued by the Procedure DML Handler</dt>
<dd>
<p>Use the <code>emp_dq</code> procedure to dequeue the messages that were reenqueued by the procedure DML handler.</p>
<pre>
SET SERVEROUTPUT ON SIZE 100000

EXEC emp_dq('HR');
</pre>
<p>For each row changed by a DML statement, one line is returned, and each line states the command type of the change (either <code>INSERT</code>, <code>UPDATE</code>, or <code>DELETE</code>). If you repeat the query on the queue table in Step <a href="#BCGEAGAB">3</a> after the messages are dequeued, then the dequeued messages should have been consumed. That is, either the <code>MSG_STATE</code> should be <code>PROCESSED</code> for these messages, or the messages should no longer be in the queue.</p>
<pre>
SELECT MSG_ID, MSG_STATE, CONSUMER_NAME 
  FROM AQ$STREAMS_QUEUE_TABLE ORDER BY MSG_ID;
</pre></dd>
</dl>
</div>
<!-- class="sect1" --></div>
<!-- class="chapter" --></div>
<!-- class="ind" -->
<!-- Start Footer -->
</div>
<!-- add extra wrapper close div-->
<footer><!--
<hr />
<table class="cellalignment1463">
<tr>
<td class="cellalignment1470">
<table class="cellalignment1468">
<tr>
<td class="cellalignment1467"><a href="repmultdemo.htm"><img width="24" height="24" src="../../dcommon/gifs/leftnav.gif" alt="Go to previous page" /><br />
<span class="icon">Previous</span></a></td>
<td class="cellalignment1467"><a href="loblcrdemo.htm"><img width="24" height="24" src="../../dcommon/gifs/rightnav.gif" alt="Go to next page" /><br />
<span class="icon">Next</span></a></td>
</tr>
</table>
</td>
<td class="cellalignment-copyrightlogo"><img width="144" height="18" src="../../dcommon/gifs/oracle.gif" alt="Oracle" /><br />
Copyright&nbsp;&copy;&nbsp;2008, 2013,&nbsp;Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved.<br />
<a href="../../dcommon/html/cpyr.htm">Legal Notices</a></td>
<td class="cellalignment1472">
<table class="cellalignment1466">
<tr>
<td class="cellalignment1467"><a href="../../index.htm"><img width="24" height="24" src="../../dcommon/gifs/doclib.gif" alt="Go to Documentation Home" /><br />
<span class="icon">Home</span></a></td>
<td class="cellalignment1467"><a href="../../nav/portal_booklist.htm"><img width="24" height="24" src="../../dcommon/gifs/booklist.gif" alt="Go to Book List" /><br />
<span class="icon">Book List</span></a></td>
<td class="cellalignment1467"><a href="toc.htm"><img width="24" height="24" src="../../dcommon/gifs/toc.gif" alt="Go to Table of Contents" /><br />
<span class="icon">Contents</span></a></td>
<td class="cellalignment1467"><a href="index.htm"><img width="24" height="24" src="../../dcommon/gifs/index.gif" alt="Go to Index" /><br />
<span class="icon">Index</span></a></td>
<td class="cellalignment1467"><a href="../../nav/mindx.htm"><img width="24" height="24" src="../../dcommon/gifs/masterix.gif" alt="Go to Master Index" /><br />
<span class="icon">Master Index</span></a></td>
<td class="cellalignment1467"><a href="../../dcommon/html/feedback.htm"><img width="24" height="24" src="../../dcommon/gifs/feedbck2.gif" alt="Go to Feedback page" /><br />
<span class="icon">Contact Us</span></a></td>
</tr>
</table>
</td>
</tr>
</table>
--></footer>
<noscript>
<p>Scripting on this page enhances content navigation, but does not change the content in any way.</p>
</noscript>
</body>
</html>
