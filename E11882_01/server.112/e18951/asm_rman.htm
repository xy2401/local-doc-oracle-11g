<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta charset="utf-8">
<title>Performing Oracle ASM Data Migration with RMAN</title>
<meta name="generator" content="Oracle DARB XHTML Converter (Mode = document) - Version 5.1.2 Build 047" />
<meta name="dcterms.created" content="2012-02-03T20:20:16Z" />
<meta name="robots" content="all" />
<meta name="dcterms.title" content="Automatic Storage Management Administrator's Guide" />
<meta name="dcterms.identifier" content="E18951-03" />
<meta name="dcterms.isVersionOf" content="OSTMG" />
<meta name="dcterms.rights" content="Copyright&nbsp;&copy;&nbsp;2007, 2012,&nbsp;Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved." />
<link rel="Start" href="../../index.htm" title="Home" type="text/html" />
<link rel="Copyright" href="../../dcommon/html/cpyr.htm" title="Copyright" type="text/html" />

<script type="application/javascript"  src="../../dcommon/js/headfoot.js"></script>
<script type="application/javascript"  src="../../nav/js/doccd.js"></script>
<link rel="Contents" href="toc.htm" title="Contents" type="text/html" />
<link rel="Index" href="index.htm" title="Index" type="text/html" />
<link rel="Glossary" href="ostmg_gloss.htm" title="Glossary" type="text/html" />
<link rel="Prev" href="asmfiles.htm" title="Previous" type="text/html" />
<link rel="Next" href="asm_em.htm" title="Next" type="text/html" />
<link rel="alternate" href="../e18951.pdf" title="PDF version" type="application/pdf" />
<link rel="schema.dcterms" href="http://purl.org/dc/terms/" />
<link rel="stylesheet" href="../../dcommon/css/fusiondoc.css">
<link rel="stylesheet" type="text/css"  href="../../dcommon/css/header.css">
<link rel="stylesheet" type="text/css"  href="../../dcommon/css/footer.css">
<link rel="stylesheet" type="text/css"  href="../../dcommon/css/fonts.css">
<link rel="stylesheet" href="../../dcommon/css/foundation.css">
<link rel="stylesheet" href="../../dcommon/css/codemirror.css">
<link rel="stylesheet" type="text/css" title="Default" href="../../nav/css/html5.css">
<link rel="stylesheet" href="../../dcommon/css/respond-480-tablet.css">
<link rel="stylesheet" href="../../dcommon/css/respond-768-laptop.css">
<link rel="stylesheet" href="../../dcommon/css/respond-1140-deskop.css">
<script type="application/javascript" src="../../dcommon/js/modernizr.js"></script>
<script type="application/javascript" src="../../dcommon/js/codemirror.js"></script>
<script type="application/javascript" src="../../dcommon/js/jquery.js"></script>
<script type="application/javascript" src="../../dcommon/js/foundation.min.js"></script>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-552992c80ef99c8d" async="async"></script>
<script type="application/javascript" src="../../dcommon/js/jqfns.js"></script>
<script type="application/javascript" src="../../dcommon/js/ohc-inline-videos.js"></script>
<!-- Add fancyBox -->
<link rel="stylesheet" href="../../dcommon/fancybox/jquery.fancybox.css?v=2.1.5" type="text/css" media="screen" />
<script type="text/javascript" src="../../dcommon/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>
<!-- Optionally add helpers - button, thumbnail and/or media -->
<link rel="stylesheet"  href="../../dcommon/fancybox/helpers/jquery.fancybox-buttons.css?v=1.0.5"  type="text/css" media="screen" />
<script type="text/javascript" src="../../dcommon/fancybox/helpers/jquery.fancybox-buttons.js?v=1.0.5"></script>
<script type="text/javascript" src="../../dcommon/fancybox/helpers/jquery.fancybox-media.js?v=1.0.6"></script>
<link rel="stylesheet"  href="../../dcommon/fancybox/helpers/jquery.fancybox-thumbs.css?v=1.0.7"  type="text/css" media="screen" />
<script type="text/javascript" src="../../dcommon/fancybox/helpers/jquery.fancybox-thumbs.js?v=1.0.7"></script>
</head>
<body>
<a href="#BEGIN" class="accessibility-top skipto" tabindex="0">Go to main content</a><header><!--
<div class="zz-skip-header"><a id="top" href="#BEGIN">Go to main content</a>--></header>
<div class="row" id="CONTENT">
<div class="IND large-9 medium-8 columns">
<a id="BEGIN" name="BEGIN"></a>
<span id="PAGE" style="display:none;">14/40</span> <!-- End Header --><a id="BABJAFIF"></a><a id="OSTMG12000"></a>
<h1 class="chapter"><span class="secnum">8</span> Performing Oracle ASM Data Migration with RMAN</h1>
<p><a id="sthref609"></a><a id="sthref610"></a>This chapter describes how to migrate data into and out of Oracle Automatic Storage Management (Oracle ASM) storage with Recovery Manager (RMAN).</p>
<p>This chapter includes the following topics:</p>
<ul>
<li>
<p><a href="#CHDCDCFJ">Overview of Oracle ASM Data Migration</a></p>
</li>
<li>
<p><a href="#i1022780">Preparing to Migrate the Database to Oracle ASM Using RMAN</a></p>
</li>
<li>
<p><a href="#BABHICCC">Migrating the Database to Oracle ASM Using RMAN</a></p>
</li>
<li>
<p><a href="#i1014926">Migrating a Database from Oracle ASM to Alternative Storage</a></p>
</li>
<li>
<p><a href="#CHDBDJJG">Moving Data Files Between Oracle ASM Disk Groups Using RMAN</a></p>
</li>
</ul>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<a class="olink BRADV8001" href="../../backup.112/e10642/rcmintro.htm#BRADV8001"><span class="italic">Oracle Database Backup and Recovery User's Guide</span></a> for complete information about using RMAN</div>
<a id="CHDCDCFJ"></a><a id="OSTMG89991"></a>
<div class="sect1"><!-- infolevel="all" infotype="General" -->
<h2 class="sect1">Overview of Oracle ASM Data Migration</h2>
<p><a id="sthref611"></a>This section explains the basic concepts and tasks involved in migrating data to and from Oracle ASM.</p>
<p>This section includes the following topics:</p>
<ul>
<li>
<p><a href="#CACDFJGC">Purpose of Oracle ASM Data Migration</a></p>
</li>
<li>
<p><a href="#CACIHGBF">Basic Concepts of Oracle ASM Data Migration</a></p>
</li>
<li>
<p><a href="#CACIEBGJ">Basics Steps of Data Migration to Oracle ASM Using RMAN</a></p>
</li>
</ul>
<a id="CACDFJGC"></a><a id="OSTMG89992"></a>
<div class="sect2"><!-- infolevel="all" infotype="General" -->
<h3 class="sect2">Purpose of Oracle ASM Data Migration</h3>
<p>Alternatives to Oracle ASM storage include file systems, raw disks, and SAN configurations. Oracle ASM includes numerous benefits over these storage alternatives, including performance optimization, redundancy protection, and load balancing. You do not need a third-party Logical Volume Manager because Oracle ASM manages disks for you. Oracle Real Application Clusters (Oracle RAC) databases benefit from Oracle ASM because it provides ready-made shared storage.</p>
<p>If a database currently uses a storage system other than Oracle ASM, then you can migrate all or part of the database into Oracle ASM, thereby simplifying database administration. You can also migrate a fast recovery area to Oracle ASM.</p>
<p>Native operating system commands such as Linux <code>cp</code> or Windows <code>COPY</code> cannot write or read files in Oracle ASM storage. Because RMAN can read and write Oracle ASM files, you can use RMAN to copy data files into and out of Oracle ASM storage or between Oracle ASM disk groups. This technique is useful if you must store backups on user-managed disks.</p>
</div>
<!-- class="sect2" -->
<a id="CACIHGBF"></a><a id="OSTMG89993"></a>
<div class="sect2"><!-- infolevel="all" infotype="General" -->
<h3 class="sect2">Basic Concepts of Oracle ASM Data Migration</h3>
<p>You can migrate data to Oracle ASM with RMAN even if you are not using RMAN as your primary backup tool. The migration requires one RMAN database backup.</p>
<p>If you have sufficient disk space to hold the entire database both in Oracle ASM and alternative storage systems, then you can move a database directly into Oracle ASM. If you do not have sufficient storage, then you can back the database up to tape, create an Oracle ASM disk group that uses old disk space, and restore the database from tape to Oracle ASM.</p>
<p>After you set the location of the new recovery area, existing backups remain in the old recovery area and count against the total disk quota of the recovery area. The backups are deleted from the old recovery area when space is needed. These backups are usable by RMAN. It is not necessary to move legacy backups to the new Oracle ASM recovery area unless you need disk space. To free space consumed by files in the old recovery area, you can back them up to tape or migrate them to the Oracle ASM recovery area.</p>
<div class="infobox-note">
<p class="notep1">Note:</p>
A foreign archived redo log is a log received by a logical standby database for a LogMiner session. Foreign archived redo logs cannot be migrated. Unlike normal archived logs, foreign archived logs have a different internal database identifier (DBID). For this reason, they cannot be backed up or restored on a logical standby database.</div>
<p>Migrating a database from Oracle ASM to an alternative storage system is similar to migration from an alternative storage system to Oracle ASM. The primary change is to modify each step to refer to file locations in the alternative storage system.</p>
<p>For information about migrating the database to Oracle ASM with Enterprise Manager, see <a href="asm_em.htm#CACHBFDE">Chapter 9, "Administering Oracle ASM with Oracle Enterprise Manager"</a>.</p>
</div>
<!-- class="sect2" -->
<a id="CACIEBGJ"></a><a id="OSTMG89994"></a>
<div class="sect2"><!-- infolevel="all" infotype="General" -->
<h3 class="sect2">Basics Steps of Data Migration to Oracle ASM Using RMAN</h3>
<p><a id="sthref612"></a><a id="sthref613"></a>This section discusses the process of migrating the entire database and fast recovery area from alternative storage to Oracle ASM using RMAN.</p>
<p>The fast recovery area is an optional disk location that you can use to store recovery-related files such as control file and online redo log copies, archived redo log files, flashback logs, and RMAN backups. Oracle Database and RMAN manage the files in the fast recovery area automatically. You can specify the disk quota, which is the user-specified maximum size of the fast recovery area. When the disk quota is reached, Oracle automatically deletes files that are no longer needed.</p>
<p>Flashback logs are Oracle-generated logs used to perform flashback database operations. The database can only write flashback logs to the fast recovery area. Flashback logs are written sequentially and are not archived. They cannot be backed up to disk.</p>
<p>To migrate the entire database and fast recovery area from alternative storage to Oracle ASM, perform the following steps:</p>
<ol>
<li>
<p>Back up the database and server parameter file, and disable Oracle Flashback Database.</p>
<p>The Oracle Flashback Database option returns the entire database to a prior consistent System Change Number (SCN) with the <code>FLASHBACK</code> <code>DATABASE</code> command in RMAN or SQL. A database flashback is different from traditional media recovery because it does not involve the restore of physical files, instead restoring your current data files to past states using saved images of changed data blocks. This feature uses flashback logs and archived redo logs.</p>
<p>This step is described in <a href="#i1022780">"Preparing to Migrate the Database to Oracle ASM Using RMAN"</a>.</p>
</li>
<li>
<p>Restore files to Oracle ASM, recover the database, and optionally migrate the fast recovery area to Oracle ASM.</p>
<p>This step is described in <a href="#BABHICCC">"Migrating the Database to Oracle ASM Using RMAN"</a>.</p>
</li>
</ol>
<p>To migrate files from Oracle ASM to alternative storage, see <a href="#i1014926">"Migrating a Database from Oracle ASM to Alternative Storage"</a>.</p>
</div>
<!-- class="sect2" --></div>
<!-- class="sect1" -->
<a id="i1022780"></a><a id="OSTMG89995"></a>
<div class="sect1">
<h2 class="sect1">Preparing to Migrate the Database to Oracle ASM Using RMAN</h2>
<p>This section explains how to prepare the database for migration. This section makes the following assumptions:</p>
<ul>
<li>
<p>You want to migrate the database to two Oracle ASM disk groups: <code>+DATA</code> for the database and <code>+FRA</code> for the fast recovery area.</p>
</li>
<li>
<p>The database to be migrated to Oracle ASM storage is named <code>mydb</code>.</p>
</li>
</ul>
<p>To prepare the database for Oracle ASM migration:</p>
<ol>
<li>
<p>If the <code>COMPATIBLE</code> initialization parameter setting for the database is less than 11.0.0, then make any read-only transportable tablespaces read/write.</p>
<p>Read-only transportable tablespaces cannot be migrated because RMAN cannot back them up.</p>
</li>
<li>
<p>If the database is a physical standby database, and if managed recovery is started, then stop managed recovery.</p>
<p>A physical standby database is a copy of a production database that you can use for disaster protection.</p>
<p>For example, connect SQL*Plus to the database with <code>SYSDBA</code> privileges, and run the following statement to stop managed recovery:</p>
<pre>
SQL&gt; ALTER DATABASE RECOVER MANAGED STANDBY DATABASE CANCEL;
</pre>
<p>Keep this terminal window open.</p>
</li>
<li>
<p>Copy the server parameter file or initialization parameter file to a temporary location.</p>
<p>The following example uses an operating system utility to copy the server parameter file:</p>
<pre>
$ cp spfileMYDB.ora orig_spfileMYDB.ora
</pre></li>
<li>
<p>In a new terminal window, start RMAN session and connect as <code>TARGET</code> to the database to be migrated. Optionally, connect to a recovery catalog.</p>
</li>
<li>
<p><a id="BAJHEEDG"></a>Back up the data files to the Oracle ASM disk group.</p>
<p>The following example uses a <code>RUN</code> command to make a level 0 incremental backup and allocates four channels to increase the backup speed. A level 0 incremental backup is an RMAN incremental backup that backs up all data blocks in the data files being backed up. An incremental backup at level 0 is identical in content to a full backup, but unlike a full backup the level 0 backup is considered a part of the incremental backup strategy.</p>
<p>An incremental backup is a RMAN backup in which only modified blocks are backed up. Incremental backups are classified by <span class="glossaryterm">level</span>. A level 0 incremental backup performs the same function as a full backup in that they both back up all blocks that have ever been used. The difference is that a full backup does not affect blocks backed up by subsequent incremental backups, whereas an incremental backup affects blocks backed up by subsequent incremental backups.</p>
<p>A full backup is a non-incremental RMAN backup. Full does not refer to how much of the database is backed up, but to the fact that the backup is not incremental. Consequently, you can make a full backup of one data file.</p>
<p>Increase or decrease this number accordingly. The format clause specifies <code>+DATA</code>, which is the name of the Oracle ASM disk group to be used for storing the database.</p>
<pre>
RUN
{
  ALLOCATE CHANNEL dev1 DEVICE TYPE DISK;
  ALLOCATE CHANNEL dev2 DEVICE TYPE DISK;
  ALLOCATE CHANNEL dev3 DEVICE TYPE DISK;
  ALLOCATE CHANNEL dev4 DEVICE TYPE DISK;
  BACKUP AS COPY
    INCREMENTAL LEVEL 0
    DATABASE
    FORMAT '+DATA'
    TAG 'ORA_ASM_MIGRATION';
}
</pre></li>
<li>
<p>If block change tracking is enabled for the database, then optionally make a level 1 incremental backup that you can use later to recover the database copy.</p>
<p>Block change tracking is a database option that causes Oracle to track data file blocks affected by each database update. The tracking information is stored in a block change tracking file. When block change tracking is enabled, RMAN uses the record of changed blocks from the change tracking file to improve incremental backup performance by only reading those blocks known to have changed, instead of reading data files in their entirety.</p>
<p>The following example makes an incremental level 1 copy of the level 0 backup created in the previous step:</p>
<pre>
RUN
{
  ALLOCATE CHANNEL dev1 DEVICE TYPE DISK;
  ALLOCATE CHANNEL dev2 DEVICE TYPE DISK;
  ALLOCATE CHANNEL dev3 DEVICE TYPE DISK;
  ALLOCATE CHANNEL dev4 DEVICE TYPE DISK;
  BACKUP INCREMENTAL LEVEL 1 
    FOR RECOVER OF COPY WITH TAG 'ORA_ASM_MIGRATION' 
    DATABASE;
}
</pre></li>
<li>
<p>If the database is in <code>ARCHIVELOG</code> mode, and if the database is open, then archive the online logs.</p>
<p>The following example uses the <code>SQL</code> command to archive the current redo logs:</p>
<pre>
RMAN&gt; SQL "ALTER SYSTEM ARCHIVE LOG CURRENT";
</pre></li>
<li>
<p>If the database instance is currently using a server parameter file, then back it up.</p>
<p>The following example backs up the server parameter file:</p>
<pre>
RMAN&gt; BACKUP AS BACKUPSET SPFILE;
</pre></li>
<li>
<p>If block change tracking is enabled, then disable it.</p>
<p>The following command disables block change tracking:</p>
<pre>
RMAN&gt; SQL "ALTER DATABASE DISABLE BLOCK CHANGE TRACKING";
</pre></li>
<li>
<p>If Flashback Database is enabled, then disable it and drop any guaranteed restore points.</p>
<div class="infobox-note">
<p class="notep1">Note:</p>
If you are not migrating the fast recovery area, then skip this step.</div>
<p>Disabling Oracle Flashback Database is necessary because you cannot migrate flashback logs to Oracle ASM. The following command disables Flashback Database:</p>
<pre>
RMAN&gt; SQL "ALTER DATABASE FLASHBACK OFF";
</pre>
<p>The following command drops the guaranteed restore point named <code>Q106</code>:</p>
<pre>
RMAN&gt; SQL "DROP RESTORE POINT Q106";
</pre></li>
<li>
<p>Shut down the database consistently.</p>
<p>The following command shuts down the database:</p>
<pre>
RMAN&gt; SHUTDOWN IMMEDIATE;
</pre></li>
</ol>
</div>
<!-- class="sect1" -->
<a id="BABHICCC"></a><a id="OSTMG12121"></a>
<div class="sect1">
<h2 class="sect1">Migrating the Database to Oracle ASM Using RMAN</h2>
<p><a id="sthref614"></a><a id="sthref615"></a>The following procedure is intended to minimize database downtime. The steps differ slightly depending on whether you are migrating a primary or standby database. The procedure makes the same assumptions described in <a href="#i1022780">"Preparing to Migrate the Database to Oracle ASM Using RMAN"</a>. If you are not migrating the recovery area to Oracle ASM, then you must modify some steps, which are noted.</p>
<div class="infobox-note">
<p class="notep1">Note:</p>
The following procedure switches between SQL*Plus and RMAN, so keep a terminal window open for each utility.</div>
<p>To migrate the database to Oracle ASM:</p>
<ol>
<li>
<p>Follow the steps in <a href="#i1022780">"Preparing to Migrate the Database to Oracle ASM Using RMAN"</a>.</p>
</li>
<li>
<p>Restore or create a server parameter file in Oracle ASM storage.</p>
<p>The steps depend on whether the database is using a server parameter file:</p>
<ul>
<li>
<p>If the database is using a server parameter file, then restore it to the Oracle ASM disk group with the following commands, where <code><span class="codeinlineitalic">sid</span></code> is the SID of the instance:</p>
<pre>
RMAN&gt; STARTUP MOUNT;
RMAN&gt; RESTORE SPFILE TO '+DATA/spfile<span class="italic">sid</span>.ora';
RMAN&gt; SHUTDOWN IMMEDIATE;
</pre></li>
<li>
<p>If the database is not using a server parameter file, then create one in Oracle ASM. Run the <code>CREATE SPFILE</code> command in SQL*Plus as follows, where <code><span class="codeinlineitalic">sid</span></code> is the SID of the database (the command spans two lines):</p>
<pre>
SQL&gt; CREATE SPFILE='+DATA/spfile<span class="italic">sid</span>.ora' FROM PFILE='?/dbs/init<span class="italic">sid</span>.ora';
</pre>
<p>Afterward, delete <code>spfile</code><code><span class="codeinlineitalic">sid</span></code><code>.ora</code> and <code>init</code><code><span class="codeinlineitalic">sid</span></code><code>.ora</code> from the <code>?/dbs</code> directory and create a new <code>init</code><code><span class="codeinlineitalic">sid</span></code><code>.ora</code> with the following line of content:</p>
<pre>
SPFILE='+DATA/spfile<span class="italic">sid</span>.ora'
</pre></li>
</ul>
</li>
<li>
<p><a id="BAJCGAFE"></a>Set Oracle Managed Files initialization parameters to Oracle ASM locations.</p>
<div class="infobox-note">
<p class="notep1">Note:</p>
If you are not migrating the fast recovery area, then do not change the <code>DB_RECOVERY_FILE_DEST</code> and <code>DB_RECOVERY_FILE_DEST_SIZE</code> initialization parameter settings. However, you must set <code>DB_CREATE_ONLINE_LOG_DEST_</code><code><span class="codeinlineitalic">n</span></code> parameter to an Oracle ASM location for migration of the online redo logs.</div>
<p>Set the <code>DB_CREATE_FILE_DEST</code> and optional <code>DB_CREATE_ONLINE_LOG_DEST_</code><code><span class="codeinlineitalic">n</span></code> initialization parameters to Oracle ASM disk groups. If the database uses a recovery area, then change the recovery area location to the Oracle ASM disk group. Also, change the recovery area size.</p>
<p>Run commands in SQL*Plus as shown in the following example. The example assumes that the size of the fast recovery area is 100 GB and specifies the disk group <code>+FRA</code> for the fast recovery area.</p>
<pre>
SQL&gt; STARTUP FORCE NOMOUNT;
SQL&gt; ALTER SYSTEM SET DB_CREATE_FILE_DEST='+DATA' SID='*';
SQL&gt; ALTER SYSTEM SET DB_RECOVERY_FILE_DEST_SIZE=100G SID='*';
SQL&gt; ALTER SYSTEM SET DB_RECOVERY_FILE_DEST='+FRA' SID='*';
</pre></li>
<li>
<p>Set the <code>CONTROL_FILES</code> initialization parameter to Oracle ASM locations.</p>
<p>If you are migrating the fast recovery area, then enter the following commands in SQL*Plus to restart the database instance and set the control file locations to disk groups <code>+DATA</code> and <code>+FRA</code>:</p>
<pre>
SQL&gt; STARTUP FORCE NOMOUNT;
SQL&gt; ALTER SYSTEM SET CONTROL_FILES='+DATA','+FRA' SCOPE=SPFILE SID='*';
</pre>
<p>If you are not migrating the fast recovery area, then enter the following commands in SQL*Plus to restart the database instance and set the control file locations to disk group <code>+DATA</code>:</p>
<pre>
SQL&gt; STARTUP FORCE NOMOUNT;
SQL&gt; ALTER SYSTEM SET CONTROL_FILES='+DATA','+DATA' SCOPE=SPFILE SID='*';
</pre></li>
<li>
<p>Migrate the control file to Oracle ASM and mount the control file.</p>
<p>Switch to the RMAN terminal to restore the control file. In the following example, <code><span class="codeinlineitalic">original_cf_name</span></code> is a control file name in the initialization parameter file before migration:</p>
<pre>
RMAN&gt; STARTUP FORCE NOMOUNT;
RMAN&gt; RESTORE CONTROLFILE FROM '<span class="italic">original_cf_name</span>';
RMAN&gt; ALTER DATABASE MOUNT;
</pre></li>
<li>
<p>Migrate the data files to Oracle ASM.</p>
<p>Use RMAN to switch to the database copy that you created in step <a href="#BAJHEEDG">5</a> "Back up the data files to the Oracle ASM disk group" in <a href="#i1022780">"Preparing to Migrate the Database to Oracle ASM Using RMAN"</a>. The switch renames all the data files to files on Oracle ASM disk groups. Afterward, recover the database. If incremental backups were taken, then RMAN applies them during recovery. For example, enter the following commands at the RMAN prompt:</p>
<pre>
SWITCH DATABASE TO COPY;
RUN
{
  ALLOCATE CHANNEL dev1 DEVICE TYPE DISK;
  ALLOCATE CHANNEL dev2 DEVICE TYPE DISK;
  ALLOCATE CHANNEL dev3 DEVICE TYPE DISK;
  ALLOCATE CHANNEL dev4 DEVICE TYPE DISK;
  RECOVER DATABASE;
}
</pre></li>
<li>
<p>If the database uses block change tracking or Flashback Database, then enable these features.</p>
<div class="infobox-note">
<p class="notep1">Note:</p>
If you are not migrating the recovery area, then you do not enable Flashback Database unless you had disabled it previously.</div>
<p>For example, enter the following statements in SQL*Plus:</p>
<pre>
SQL&gt; ALTER DATABASE ENABLE BLOCK CHANGE TRACKING USING FILE '+DATA';
SQL&gt; ALTER DATABASE FLASHBACK ON;
</pre></li>
<li>
<p>Place the database in its normal operation mode.</p>
<p>The normal operational mode depends on whether the database is a primary or standby database:</p>
<ul>
<li>
<p>If the database is a primary database, then open it as follows:</p>
<pre>
SQL&gt; ALTER DATABASE OPEN;
</pre></li>
<li>
<p>If the database is a standby database, then resume managed recovery mode as follows:</p>
<pre>
SQL&gt; ALTER DATABASE RECOVER MANAGED STANDBY DATABASE;
</pre></li>
</ul>
</li>
<li>
<p>Drop the tempfiles and re-create them in Oracle ASM.</p>
<p>Use SQL*Plus to re-create the tempfiles. In the following example, the name of the tempfile in the original storage is <code><span class="codeinlineitalic">tempfile_name</span></code>. The name of the temporary tablespace is <code><span class="codeinlineitalic">temp_tbs_name</span></code>.</p>
<pre>
SQL&gt; ALTER DATABASE TEMPFILE '<span class="italic">tempfile_name</span>' DROP;
SQL&gt; ALTER TABLESPACE <span class="italic">temp_tbs_name</span> ADD TEMPFILE;
</pre></li>
<li>
<p>Migrate the online redo log files.</p>
<p>If this is a primary database, then add new log group members in Oracle ASM and drop the old members. You can use the following PL/SQL script to migrate the online redo log groups into an Oracle ASM disk group. The PL/SQL script assumes that the Oracle Managed Files initialization parameters specified in step <a href="#BAJCGAFE">3</a> "Set Oracle Managed Files initialization parameters to Oracle ASM locations" in <a href="#BABHICCC">"Migrating the Database to Oracle ASM Using RMAN"</a> are set.</p>
<div class="example">
<p class="titleinexample"><a id="OSTMG94244"></a><a id="sthref616"></a>Example 8-1 Migrating the online redo logs</p>
<pre>
SET SERVEROUTPUT ON;
DECLARE
   CURSOR rlc IS
      SELECT GROUP# GRP, THREAD# THR, BYTES, 'NO' SRL
      FROM   V$LOG
      UNION
      SELECT GROUP# GRP, THREAD# THR, BYTES, 'YES' SRL
      FROM   V$STANDBY_LOG
      ORDER BY 1;
   stmt     VARCHAR2(2048);
BEGIN
   FOR rlcRec IN rlc LOOP
      IF (rlcRec.srl = 'YES') THEN
         stmt := 'ALTER DATABASE ADD STANDBY LOGFILE THREAD ' ||
                 rlcRec.thr || ' SIZE ' || rlcRec.bytes;
         EXECUTE IMMEDIATE stmt;
         stmt := 'ALTER DATABASE DROP STANDBY LOGFILE GROUP ' || rlcRec.grp;
         EXECUTE IMMEDIATE stmt;
      ELSE
         stmt := 'ALTER DATABASE ADD LOGFILE THREAD ' ||
                 rlcRec.thr || ' SIZE ' ||  rlcRec.bytes;
         EXECUTE IMMEDIATE stmt;
         BEGIN
            stmt := 'ALTER DATABASE DROP LOGFILE GROUP ' || rlcRec.grp;
            DBMS_OUTPUT.PUT_LINE(stmt);
            EXECUTE IMMEDIATE stmt;
         EXCEPTION
            WHEN OTHERS THEN
               EXECUTE IMMEDIATE 'ALTER SYSTEM SWITCH LOGFILE';
               EXECUTE IMMEDIATE 'ALTER SYSTEM CHECKPOINT GLOBAL';
               EXECUTE IMMEDIATE stmt;
         END;
      END IF;
   END LOOP;
END;
/
</pre></div>
<!-- class="example" --></li>
<li>
<p>Optionally, migrate backups and copies in the old fast recovery area to Oracle ASM as follows:</p>
<ol>
<li>
<p>If foreign archived logs exists in the recovery area, then you cannot migrate them to Oracle ASM. Run the following command at the RMAN prompt:</p>
<pre>
RMAN&gt; DELETE REMOTE ARCHIVELOG ALL;
</pre></li>
<li>
<p>Back up archived redo log files, backup sets, and data file copies to Oracle ASM. For example, run the following command at the RMAN prompt:</p>
<pre>
RUN
{
  ALLOCATE CHANNEL dev1 DEVICE TYPE DISK;
  ALLOCATE CHANNEL dev2 DEVICE TYPE DISK;
  ALLOCATE CHANNEL dev3 DEVICE TYPE DISK;
  ALLOCATE CHANNEL dev4 DEVICE TYPE DISK;

  BACKUP AS COPY ARCHIVELOG ALL DELETE INPUT;
  BACKUP BACKUPSET ALL DELETE INPUT;
  BACKUP AS COPY DATAFILECOPY ALL DELETE INPUT;
}
</pre></li>
</ol>
</li>
</ol>
</div>
<!-- class="sect1" -->
<a id="i1014926"></a><a id="OSTMG89996"></a>
<div class="sect1">
<h2 class="sect1">Migrating a Database from Oracle ASM to Alternative Storage</h2>
<p><a id="sthref617"></a><a id="sthref618"></a>Migrating a database from Oracle ASM to an alternative storage system is essentially the reverse of the migration to Oracle ASM. Modify the steps in <a href="#i1022780">"Preparing to Migrate the Database to Oracle ASM Using RMAN"</a> and <a href="#BABHICCC">"Migrating the Database to Oracle ASM Using RMAN"</a> as follows:</p>
<ul>
<li>
<p>If the procedure specifies Oracle Managed Files locations, then alter the procedure to use locations in alternative storage.</p>
</li>
<li>
<p>If the <code>FORMAT</code> clause of the <code>BACKUP</code> command specifies an Oracle ASM location, then change the backup format to an alternative storage location.</p>
</li>
<li>
<p>If a filename used in a SQL statement is an Oracle ASM location, then change it to a filename in the alternative storage location.</p>
</li>
</ul>
</div>
<!-- class="sect1" -->
<a id="CHDBDJJG"></a><a id="OSTMG89997"></a>
<div class="sect1"><!-- infolevel="all" infotype="General" -->
<h2 class="sect1">Moving Data Files Between Oracle ASM Disk Groups Using RMAN</h2>
<p><a id="sthref619"></a><a id="sthref620"></a>You may want to move an active data file in an <code>ARCHIVELOG</code> mode database from one Oracle ASM disk group to another. In this case, you use <code>BACKUP</code> <code>AS</code> <code>COPY</code> to copy the data file to the new disk group and <code>SET</code> <code>NEWNAME</code> and <code>SWITCH</code> commands to rename the data file in the control file.</p>
<p>For this scenario, assume that you are using disk groups <code>DATA</code> and <code>USERDATA</code>. You want to move data file <code>+DATA/orcl/datafile/users.261.689589837</code> to disk group <code>USERDATA</code>.</p>
<p>Ensure that <code>ARCHIVELOG</code> mode is enabled for the database before beginning the procedure to move data files.</p>
<p>To move a data file from one Oracle ASM disk group to another disk group, perform the following steps.</p>
<ol>
<li>
<p>Start RMAN and connect to the target database.</p>
<p>For example:</p>
<pre>
$ rman
RMAN&gt; CONNECT TARGET SYS@orcl
target database Password: <span class="italic">XXXXXXXXX</span>
connected to target database: ORCL (DBID=1217369048)
</pre></li>
<li>
<p>Generate a report that shows the names of the data files.</p>
<p>Run the following <code>REPORT</code> command after connecting RMAN to the target database. Note the data file name of the file to be moved.</p>
<p>For example:</p>
<pre>
RMAN&gt; REPORT SCHEMA;

Report of database schema for database with db_unique_name ORCL
 
List of Permanent Datafiles
===========================
File Size(MB) Tablespace           RB segs Datafile Name
---- -------- -------------- ------- ------------------------
1    740      SYSTEM         ***     +DATA/orcl/datafile/system.258.689589737
2    570      SYSAUX         ***     +DATA/orcl/datafile/sysaux.259.689589785
3    55       UNDOTBS1       ***     +DATA/orcl/datafile/undotbs1.260.689589831
4    5        USERS          ***     +DATA/orcl/datafile/users.261.689589837

List of Temporary Files
=======================
File Size(MB) Tablespace           Maxsize(MB) Tempfile Name
---- -------- -------------- ----------- --------------------
1    20       TEMP           32767       +DATA/orcl/tempfile/temp.262.689589851
</pre></li>
<li>
<p>Back up the data file to the new Oracle ASM disk group.</p>
<p>Run the <code>BACKUP</code> <code>AS</code> <code>COPY</code> command to back up the data file on <code>DATA</code> to <code>USERDATA</code>.</p>
<p>For example:</p>
<pre>
RMAN&gt; BACKUP AS COPY
        DATAFILE "+DATA/orcl/datafile/users.261.689589837"
        FORMAT   "+USERDATA";

Starting backup at 16-JUN-09
allocated channel: ORA_DISK_1
channel ORA_DISK_1: SID=51 device type=DISK
channel ORA_DISK_1: starting datafile copy
input datafile file number=00004 name=+DATA/orcl/datafile/users.261.689589837
output file name=+USERDATA/orcl/datafile/users.256.689682663
  tag=TAG20090616T103101 RECID=13 STAMP=689682663
channel ORA_DISK_1: datafile copy complete, elapsed time: 00:00:01
Finished backup at 16-JUN-09
</pre>
<p>You could also specify the data file by the data file number and data file type.</p>
<p>For example:</p>
<pre>
BACKUP AS COPY
  DATAFILE 4
  FORMAT   "+USERDATA";
</pre></li>
<li>
<p>Offline the data file that you intend to move to a new disk group.</p>
<p>Run the following <code>SQL</code> command in the RMAN client. Note that you use two single quotation marks around the name of the data file, not double quotation marks.</p>
<p>For example:</p>
<pre>
RMAN&gt; SQL "ALTER DATABASE DATAFILE 
       ''+DATA/orcl/datafile/users.261.689589837'' OFFLINE";

sql statement: ALTER DATABASE DATAFILE
     ''+DATA/orcl/datafile/users.261.689589837''  OFFLINE
</pre></li>
<li>
<p>Point the control file to the newly created copy of the data file.</p>
<p>Run the <code>SWITCH...TO COPY</code> command in the RMAN client. The <code>TO</code> <code>COPY</code> option of <code>SWITCH</code> switches the data file to the most recent copy of the data file.</p>
<p>For example:</p>
<pre>
RMAN&gt; SWITCH DATAFILE "+DATA/orcl/datafile/users.261.689589837" TO COPY;

datafile 4 switched to datafile copy
    "+USERDATA/orcl/datafile/users.256.689682663"
</pre>
<p>The output of this command displays the new name of the data file.</p>
</li>
<li>
<p>Recover the renamed data file.</p>
<p>Run the <code>RECOVER</code> command in the RMAN client.</p>
<p>For example:</p>
<pre>
RMAN&gt; RECOVER DATAFILE "+USERDATA/orcl/datafile/users.256.689682663";

Starting recover at 16-JUN-09
using channel ORA_DISK_1
starting media recovery
media recovery complete, elapsed time: 00:00:01
Finished recover at 16-JUN-09
</pre></li>
<li>
<p>Bring the data file online.</p>
<p>Run the <code>SQL</code> command in the RMAN client. Note that you use two single quotation marks around the name of the data file, not double quotation marks.</p>
<p>For example:</p>
<pre>
RMAN&gt; SQL "ALTER DATABASE DATAFILE
      ''+USERDATA/orcl/datafile/users.256.689682663'' ONLINE";

sql statement: ALTER DATABASE DATAFILE
   ''+USERDATA/orcl/datafile/users.256.689682663'' ONLINE
</pre></li>
<li>
<p>Delete the data file copy from the original Oracle ASM disk group.</p>
<p>In this scenario, <code>+DATA/orcl/datafile/users.261.689589837</code> is the original data file in <code>DATA</code>. Because you issued <code>SET NEWNAME</code> and <code>SWITCH</code> commands for this data file, the original file is now recorded in the RMAN repository as a data file copy. Run a <code>DELETE</code> command in the RMAN client to remove this file.</p>
<p>For example:</p>
<pre>
RMAN&gt; DELETE DATAFILECOPY "+DATA/orcl/datafile/users.261.689589837";

released channel: ORA_DISK_1
allocated channel: ORA_DISK_1
channel ORA_DISK_1: SID=51 device type=DISK
List of Datafile Copies
=======================
Key     File S Completion Time Ckp SCN    Ckp Time       
------- ---- - --------------- ---------- ---------------
14      4    A 16-JUN-09       864471     16-JUN-09      
        Name: +DATA/orcl/datafile/users.261.689589837
        Tag: TAG20090615T084217

Do you really want to delete the above objects (enter YES or NO)? y
deleted datafile copy
datafile copy file name=+DATA/orcl/datafile/users.261.689589837 RECID=14 STAMP=689683255
Deleted 1 objects
</pre></li>
</ol>
</div>
<!-- class="sect1" --></div>
<!-- class="ind" -->
<!-- Start Footer -->
</div>
<!-- add extra wrapper close div-->
<footer><!--
<hr />
<table class="cellalignment1536">
<tr>
<td class="cellalignment1543">
<table class="cellalignment1541">
<tr>
<td class="cellalignment1540"><a href="asmfiles.htm"><img width="24" height="24" src="../../dcommon/gifs/leftnav.gif" alt="Go to previous page" /><br />
<span class="icon">Previous</span></a></td>
<td class="cellalignment1540"><a href="asm_em.htm"><img width="24" height="24" src="../../dcommon/gifs/rightnav.gif" alt="Go to next page" /><br />
<span class="icon">Next</span></a></td>
</tr>
</table>
</td>
<td class="cellalignment-copyrightlogo"><img width="144" height="18" src="../../dcommon/gifs/oracle.gif" alt="Oracle" /><br />
Copyright&nbsp;&copy;&nbsp;2007, 2012,&nbsp;Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved.<br />
<a href="../../dcommon/html/cpyr.htm">Legal Notices</a></td>
<td class="cellalignment1545">
<table class="cellalignment1539">
<tr>
<td class="cellalignment1540"><a href="../../index.htm"><img width="24" height="24" src="../../dcommon/gifs/doclib.gif" alt="Go to Documentation Home" /><br />
<span class="icon">Home</span></a></td>
<td class="cellalignment1540"><a href="../../nav/portal_booklist.htm"><img width="24" height="24" src="../../dcommon/gifs/booklist.gif" alt="Go to Book List" /><br />
<span class="icon">Book List</span></a></td>
<td class="cellalignment1540"><a href="toc.htm"><img width="24" height="24" src="../../dcommon/gifs/toc.gif" alt="Go to Table of Contents" /><br />
<span class="icon">Contents</span></a></td>
<td class="cellalignment1540"><a href="index.htm"><img width="24" height="24" src="../../dcommon/gifs/index.gif" alt="Go to Index" /><br />
<span class="icon">Index</span></a></td>
<td class="cellalignment1540"><a href="../../nav/mindx.htm"><img width="24" height="24" src="../../dcommon/gifs/masterix.gif" alt="Go to Master Index" /><br />
<span class="icon">Master Index</span></a></td>
<td class="cellalignment1540"><a href="../../dcommon/html/feedback.htm"><img width="24" height="24" src="../../dcommon/gifs/feedbck2.gif" alt="Go to Feedback page" /><br />
<span class="icon">Contact Us</span></a></td>
</tr>
</table>
</td>
</tr>
</table>
--></footer>
<noscript>
<p>Scripting on this page enhances content navigation, but does not change the content in any way.</p>
</noscript>
</body>
</html>
