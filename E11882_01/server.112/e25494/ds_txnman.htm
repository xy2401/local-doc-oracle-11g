<!DOCTYPE html>
<html lang="en" >
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta charset="utf-8">
<title>Managing Distributed Transactions</title>
<meta name="generator" content="Oracle DARB XHTML Converter (Mode = document) - Merged Version 1055" />
<meta name="dcterms.created" content="2015-05-05T8:27:39Z" />
<meta name="robots" content="all" />
<meta name="dcterms.title" content="Database Administrator's Guide" />
<meta name="dcterms.identifier" content="E25494-07" />
<meta name="dcterms.isVersionOf" content="ADMIN" />
<meta name="dcterms.rights" content="Copyright&nbsp;&copy;&nbsp;2001, 2015,&nbsp;Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved." />
<link rel="Start" href="../../index.htm" title="Home" type="text/html" />
<link rel="Copyright" href="../../dcommon/html/cpyr.htm" title="Copyright" type="text/html" />

<script type="application/javascript"  src="../../dcommon/js/headfoot.js"></script>
<script type="application/javascript"  src="../../nav/js/doccd.js"></script>
<link rel="Contents" href="toc.htm" title="Contents" type="text/html" />
<link rel="Index" href="index.htm" title="Index" type="text/html" />
<link rel="Prev" href="ds_txns.htm" title="Previous" type="text/html" />
<link rel="Next" href="part8.htm" title="Next" type="text/html" />
<link rel="alternate" href="../e25494.pdf" title="PDF version" type="application/pdf" />
<link rel="schema.dcterms" href="http://purl.org/dc/terms/" />
<link rel="stylesheet" href="../../dcommon/css/fusiondoc.css">
<link rel="stylesheet" type="text/css"  href="../../dcommon/css/header.css">
<link rel="stylesheet" type="text/css"  href="../../dcommon/css/footer.css">
<link rel="stylesheet" type="text/css"  href="../../dcommon/css/fonts.css">
<link rel="stylesheet" href="../../dcommon/css/foundation.css">
<link rel="stylesheet" href="../../dcommon/css/codemirror.css">
<link rel="stylesheet" type="text/css" title="Default" href="../../nav/css/html5.css">
<link rel="stylesheet" href="../../dcommon/css/respond-480-tablet.css">
<link rel="stylesheet" href="../../dcommon/css/respond-768-laptop.css">
<link rel="stylesheet" href="../../dcommon/css/respond-1140-deskop.css">
<script type="application/javascript" src="../../dcommon/js/modernizr.js"></script>
<script type="application/javascript" src="../../dcommon/js/codemirror.js"></script>
<script type="application/javascript" src="../../dcommon/js/jquery.js"></script>
<script type="application/javascript" src="../../dcommon/js/foundation.min.js"></script>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-552992c80ef99c8d" async="async"></script>
<script type="application/javascript" src="../../dcommon/js/jqfns.js"></script>
<script type="application/javascript" src="../../dcommon/js/ohc-inline-videos.js"></script>
<!-- Add fancyBox -->
<link rel="stylesheet" href="../../dcommon/fancybox/jquery.fancybox.css?v=2.1.5" type="text/css" media="screen" />
<script type="text/javascript" src="../../dcommon/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>
<!-- Optionally add helpers - button, thumbnail and/or media -->
<link rel="stylesheet"  href="../../dcommon/fancybox/helpers/jquery.fancybox-buttons.css?v=1.0.5"  type="text/css" media="screen" />
<script type="text/javascript" src="../../dcommon/fancybox/helpers/jquery.fancybox-buttons.js?v=1.0.5"></script>
<script type="text/javascript" src="../../dcommon/fancybox/helpers/jquery.fancybox-media.js?v=1.0.6"></script>
<link rel="stylesheet"  href="../../dcommon/fancybox/helpers/jquery.fancybox-thumbs.css?v=1.0.7"  type="text/css" media="screen" />
<script type="text/javascript" src="../../dcommon/fancybox/helpers/jquery.fancybox-thumbs.js?v=1.0.7"></script>
</head>
<body>
<a href="#BEGIN" class="accessibility-top skipto" tabindex="0">Go to main content</a><header><!--
<div class="zz-skip-header"><a id="top" href="#BEGIN">Go to main content</a>--></header>
<div class="row" id="CONTENT">
<div class="IND large-9 medium-8 columns" dir="ltr">
<a id="BEGIN" name="BEGIN"></a>
<span id="PAGE" style="display:none;">46/49</span> <!-- End Header -->
<div id="ADMIN032" class="chapter"><a id="g1014752"></a> <a id="i1207516"></a>
<h1 class="chapter"><span class="secnum">35</span> Managing Distributed Transactions</h1>
<p>In this chapter:</p>
<ul>
<li>
<p><a href="#i1007570">Specifying the Commit Point Strength of a Node</a></p>
</li>
<li>
<p><a href="#i1007593">Naming Transactions</a></p>
</li>
<li>
<p><a href="#i1007609">Viewing Information About Distributed Transactions</a></p>
</li>
<li>
<p><a href="#i1007799">Deciding How to Handle In-Doubt Transactions</a></p>
</li>
<li>
<p><a href="#i1007905">Manually Overriding In-Doubt Transactions</a></p>
</li>
<li>
<p><a href="#i1008018">Purging Pending Rows from the Data Dictionary</a></p>
</li>
<li>
<p><a href="#i1008132">Manually Committing an In-Doubt Transaction: Example</a></p>
</li>
<li>
<p><a href="#i1008399">Data Access Failures Due to Locks</a></p>
</li>
<li>
<p><a href="#i1008438">Simulating Distributed Transaction Failure</a></p>
</li>
<li id="i1107567">
<p><a href="#i1008473">Managing Read Consistency</a></p>
</li>
</ul>
<a id="i1007570"></a>
<div id="ADMIN12247" class="sect1">
<h2 class="sect1">Specifying the Commit Point Strength of a Node</h2>
<p><a id="sthref3758"></a><a id="sthref3759"></a><a id="sthref3760"></a><a id="sthref3761"></a>The database with the highest commit point strength determines which node commits first in a distributed transaction. When specifying a commit point strength for each node, ensure that the most critical server will be non-blocking if a failure occurs during a prepare or commit phase. The <code dir="ltr"><a id="sthref3762"></a><a id="sthref3763"></a>COMMIT_POINT_STRENGTH</code> initialization parameter determines the commit point strength of a node.</p>
<p>The default value is operating system-dependent. The range of values is any integer from 0 to 255. For example, to set the commit point strength of a database to 200, include the following line in the database initialization parameter file:</p>
<pre dir="ltr">
COMMIT_POINT_STRENGTH = 200
</pre>
<p>The commit point strength is only used to determine the commit point site in a distributed transaction.</p>
<p>When setting the commit point strength for a database, note the following considerations:</p>
<ul>
<li>
<p>Because the commit point site stores information about the status of the transaction, the commit point site should not be a node that is frequently unreliable or unavailable in case other nodes need information about transaction status.</p>
</li>
<li>
<p>Set the commit point strength for a database relative to the amount of critical shared data in the database. For example, a database on a mainframe computer usually shares more data among users than a database on a PC. Therefore, set the commit point strength of the mainframe to a higher value than the PC.</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<a href="ds_txns.htm#i1007721">"Commit Point Site"</a> for a conceptual overview of commit points</div>
</li>
</ul>
</div>
<!-- class="sect1" -->
<a id="i1007593"></a>
<div id="ADMIN12248" class="sect1">
<h2 class="sect1">Naming Transactions</h2>
<p>You can name a <a id="sthref3764"></a><a id="sthref3765"></a>transaction. This is useful for identifying a specific distributed transaction and replaces the use of the <code dir="ltr"><a id="sthref3766"></a>COMMIT COMMENT</code> statement for this purpose.</p>
<p>To name a transaction, use the <code dir="ltr"><a id="sthref3767"></a>SET TRANSACTION...NAME</code> statement. For example:</p>
<pre dir="ltr">
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE
     NAME 'update inventory checkpoint 0';
</pre>
<p>This example shows that the user started a new transaction with isolation level equal to <code dir="ltr">SERIALIZABLE</code> and named it <code dir="ltr">'update inventory checkpoint 0'</code>.</p>
<p>For distributed transactions, the name is sent to participating sites when a transaction is committed. If a <code dir="ltr">COMMIT COMMENT</code> exists, it is ignored when a transaction name exists.</p>
<p>The transaction name is displayed in the <code dir="ltr">NAME</code> column of the <code dir="ltr">V$TRANSACTION</code> view, and in the <code dir="ltr">TRAN_COMMENT</code> field of the DBA_2PC_PENDING view when the transaction is committed.</p>
</div>
<!-- class="sect1" -->
<a id="i1007609"></a>
<div id="ADMIN12249" class="sect1">
<h2 class="sect1">Viewing Information About Distributed Transactions</h2>
<p>The data dictionary of each database stores information about all open distributed transactions. You can use data dictionary tables and views to gain information about the transactions. This section contains the following topics:</p>
<ul>
<li>
<p><a href="#i1107620">Determining the ID Number and Status of Prepared Transactions</a></p>
</li>
<li>
<p><a href="#i1207719">Tracing the Session Tree of In-Doubt Transactions</a></p>
</li>
</ul>
<a id="i1107620"></a>
<div id="ADMIN12250" class="sect2">
<h3 class="sect2">Determining the ID Number and Status of Prepared Transactions</h3>
<p><a id="sthref3768"></a><a id="sthref3769"></a><a id="sthref3770"></a>The following view shows the database links that have been defined at the local database and stored in the data dictionary:<a id="sthref3771"></a><a id="sthref3772"></a><a id="sthref3773"></a><a id="sthref3774"></a></p>
<div class="inftblruleinformal">
<table class="cellalignment1333" title="Viewing Information About In-Doubt Transactions" summary="Column 1 lists the names of views used to display the database links; column 2 describes each view." dir="ltr">
<thead>
<tr class="cellalignment1327">
<th class="cellalignment1334" id="r1c1-t3">View</th>
<th class="cellalignment1334" id="r1c2-t3">Purpose</th>
</tr>
</thead>
<tbody>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r2c1-t3" headers="r1c1-t3"><a id="sthref3775"></a><code dir="ltr">DBA_2PC_PENDING</code></td>
<td class="cellalignment1335" headers="r2c1-t3 r1c2-t3">Lists all in-doubt distributed transactions. The view is empty until populated by an in-doubt transaction. After the transaction is resolved, the view is purged.</td>
</tr>
</tbody>
</table>
<br /></div>
<!-- class="inftblruleinformal" -->
<p>Use this view to determine the global commit number for a particular transaction ID. You can use this global commit number when manually resolving an in-doubt transaction.</p>
<p>The following table shows the most relevant columns (for a description of all the columns in the view, see <a class="olink REFRN" href="../e40402/toc.htm"><span class="italic">Oracle Database Reference</span></a>):</p>
<div id="ADMIN13153" class="tblruleformal">
<p class="titleintable"><a id="sthref3776"></a><a id="g1008762"></a>Table 35-1 DBA_2PC_PENDING</p>
<table class="cellalignment1333" title="DBA_2PC_PENDING" summary="Column 1 contains the view column name; column 2 describes the column." dir="ltr">
<thead>
<tr class="cellalignment1327">
<th class="cellalignment1334" id="r1c1-t4">Column</th>
<th class="cellalignment1334" id="r1c2-t4">Description</th>
</tr>
</thead>
<tbody>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r2c1-t4" headers="r1c1-t4">
<p><code dir="ltr">LOCAL_TRAN_ID</code></p>
</td>
<td class="cellalignment1335" headers="r2c1-t4 r1c2-t4">
<p>Local transaction identifier in the format <span class="italic">integer</span>.<span class="italic">integer</span>.<span class="italic">integer</span>.</p>
<p><span class="bold">Note:</span> When the <code dir="ltr">LOCAL_TRAN_ID</code> and the <code dir="ltr">GLOBAL_TRAN_ID</code> for a connection are the same, the node is the global coordinator of the transaction.</p>
</td>
</tr>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r3c1-t4" headers="r1c1-t4">
<p><code dir="ltr">GLOBAL_TRAN_ID</code></p>
</td>
<td class="cellalignment1335" headers="r3c1-t4 r1c2-t4">
<p>Global database identifier in the format <span class="italic">global_db_nam</span>e.<span class="italic">db_hex_id</span>.<span class="italic">local_tran_id</span>, where <span class="italic">db_hex_id</span> is an eight-character hexadecimal value used to uniquely identify the database. This common transaction ID is the same on every node for a distributed transaction.</p>
<p><span class="bold">Note:</span> When the <code dir="ltr">LOCAL_TRAN_ID</code> and the <code dir="ltr">GLOBAL_TRAN_ID</code> for a connection are the same, the node is the global coordinator of the transaction.</p>
</td>
</tr>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r4c1-t4" headers="r1c1-t4">
<p><code dir="ltr">STATE</code></p>
</td>
<td class="cellalignment1335" headers="r4c1-t4 r1c2-t4">
<p><code dir="ltr">STATE</code> can have the following values:</p>
<ul>
<li>
<p>Collecting</p>
<p>This category normally applies only to the global coordinator or local coordinators. The node is currently collecting information from other database servers before it can decide whether it can prepare.</p>
</li>
<li>
<p>Prepared</p>
<p>The node has prepared and may or may not have acknowledged this to its local coordinator with a prepared message. However, no commit request has been received. The node remains prepared, holding any local resource locks necessary for the transaction to commit.</p>
</li>
<li>
<p>Committed</p>
<p>The node (any type) has committed the transaction, but other nodes involved in the transaction may not have done the same. That is, the transaction is still pending at one or more nodes.</p>
</li>
<li>
<p>Forced Commit</p>
<p>A pending transaction can be forced to commit at the discretion of a database administrator<a id="sthref3777"></a>. This entry occurs if a transaction is manually committed at a local node.</p>
</li>
<li>
<p>Forced termination (rollback)</p>
<p>A pending transaction can be forced to roll back at the discretion of a database administrator. This entry occurs if this transaction is manually rolled back at a local node.</p>
</li>
</ul>
</td>
</tr>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r5c1-t4" headers="r1c1-t4">
<p><code dir="ltr">MIXED</code></p>
</td>
<td class="cellalignment1335" headers="r5c1-t4 r1c2-t4">
<p><code dir="ltr">YES</code> means that part of the transaction was committed on one node and rolled back on another node.</p>
</td>
</tr>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r6c1-t4" headers="r1c1-t4">
<p><code dir="ltr">TRAN_COMMENT</code></p>
</td>
<td class="cellalignment1335" headers="r6c1-t4 r1c2-t4">
<p>Transaction comment or, if using transaction naming, the transaction name is placed here when the transaction is committed.</p>
</td>
</tr>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r7c1-t4" headers="r1c1-t4">
<p><code dir="ltr">HOST</code></p>
</td>
<td class="cellalignment1335" headers="r7c1-t4 r1c2-t4">
<p>Name of the host system.</p>
</td>
</tr>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r8c1-t4" headers="r1c1-t4">
<p><code dir="ltr">COMMIT#</code></p>
</td>
<td class="cellalignment1335" headers="r8c1-t4 r1c2-t4">
<p>Global commit number for committed transactions.</p>
</td>
</tr>
</tbody>
</table>
<br /></div>
<!-- class="tblruleformal" -->
<p>Execute the following script, named <code dir="ltr">pending_txn_script</code>, to query pertinent information in <code dir="ltr">DBA_2PC_PENDING</code> (sample output included):</p>
<pre dir="ltr">
COL LOCAL_TRAN_ID FORMAT A13
COL GLOBAL_TRAN_ID FORMAT A30
COL STATE FORMAT A8
COL MIXED FORMAT A3
COL HOST FORMAT A10
COL COMMIT# FORMAT A10

SELECT LOCAL_TRAN_ID, GLOBAL_TRAN_ID, STATE, MIXED, HOST, COMMIT#
   FROM DBA_2PC_PENDING
/

SQL&gt; @pending_txn_script

LOCAL_TRAN_ID GLOBAL_TRAN_ID                 STATE    MIX HOST       COMMIT#
------------- ------------------------------ -------- --- ---------- ----------
1.15.870      HQ.EXAMPLE.COM.ef192da4.1.15.870  commit   no  dlsun183   115499
</pre>
<p>This output indicates that local transaction <code dir="ltr">1.15.870</code> has been committed on this node, but it may be pending on one or more other nodes. Because <code dir="ltr">LOCAL_TRAN_ID</code> and the local part of <code dir="ltr">GLOBAL_TRAN_ID</code> are the same, the node is the global coordinator of the transaction.</p>
</div>
<!-- class="sect2" -->
<a id="i1207719"></a>
<div id="ADMIN12251" class="sect2">
<h3 class="sect2">Tracing the Session Tree of In-Doubt Transactions</h3>
<p><a id="sthref3778"></a><a id="sthref3779"></a><a id="sthref3780"></a><a id="sthref3781"></a>The following view shows which in-doubt transactions are incoming from a remote client and which are outgoing to a remote server:<a id="sthref3782"></a><a id="sthref3783"></a><a id="sthref3784"></a><a id="sthref3785"></a></p>
<div class="inftblruleinformal">
<table class="cellalignment1333" title="Viewing Information About In-Doubt Transactions" summary="Column 1 lists the view name and column 2 describes the purpose of the view." dir="ltr">
<thead>
<tr class="cellalignment1327">
<th class="cellalignment1334" id="r1c1-t5">View</th>
<th class="cellalignment1334" id="r1c2-t5">Purpose</th>
</tr>
</thead>
<tbody>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r2c1-t5" headers="r1c1-t5"><a id="sthref3786"></a><code dir="ltr">DBA_2PC_NEIGHBORS</code></td>
<td class="cellalignment1335" headers="r2c1-t5 r1c2-t5">Lists all incoming (from remote client) and outgoing (to remote server) in-doubt distributed transactions. It also indicates whether the local node is the commit point site in the transaction.
<p>The view is empty until populated by an in-doubt transaction. After the transaction is resolved, the view is purged.</p>
</td>
</tr>
</tbody>
</table>
<br /></div>
<!-- class="inftblruleinformal" -->
<p>When a transaction is in-doubt, you may need to determine which nodes performed which roles in the session tree. Use to this view to determine:</p>
<ul>
<li>
<p>All the incoming and outgoing connections for a given transaction</p>
</li>
<li>
<p>Whether the node is the commit point site in a given transaction</p>
</li>
<li>
<p>Whether the node is a global coordinator in a given transaction (because its local transaction ID and global transaction ID are the same)</p>
</li>
</ul>
<p>The following table shows the most relevant columns (for an account of all the columns in the view, see <a class="olink REFRN" href="../e40402/toc.htm"><span class="italic">Oracle Database Reference</span></a>):</p>
<div id="ADMIN13154" class="tblruleformal">
<p class="titleintable"><a id="sthref3787"></a><a id="sthref3788"></a>Table 35-2 DBA_2PC_NEIGHBORS</p>
<table class="cellalignment1333" title="DBA_2PC_NEIGHBORS" summary="Column 1 contains the view column name; column 2 describes the column." dir="ltr">
<thead>
<tr class="cellalignment1327">
<th class="cellalignment1334" id="r1c1-t6">Column</th>
<th class="cellalignment1334" id="r1c2-t6">Description</th>
</tr>
</thead>
<tbody>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r2c1-t6" headers="r1c1-t6">
<p><code dir="ltr">LOCAL_TRAN_ID</code></p>
</td>
<td class="cellalignment1335" headers="r2c1-t6 r1c2-t6">
<p>Local transaction identifier with the format <span class="italic">integer</span>.<span class="italic">integer</span>.<span class="italic">integer</span>.</p>
<p><span class="bold">Note:</span> When <code dir="ltr">LOCAL_TRAN_ID</code> and <code dir="ltr">GLOBAL_TRAN_ID</code>.<code dir="ltr">DBA_2PC_PENDING</code> for a connection are the same, the node is the global coordinator of the transaction.</p>
</td>
</tr>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r3c1-t6" headers="r1c1-t6">
<p><code dir="ltr">IN_OUT</code></p>
</td>
<td class="cellalignment1335" headers="r3c1-t6 r1c2-t6">
<p><code dir="ltr">IN</code> for incoming transactions; <code dir="ltr">OUT</code> for outgoing transactions.</p>
</td>
</tr>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r4c1-t6" headers="r1c1-t6">
<p><code dir="ltr">DATABASE</code></p>
</td>
<td class="cellalignment1335" headers="r4c1-t6 r1c2-t6">
<p>For incoming transactions, the name of the client database that requested information from this local node; for outgoing transactions, the name of the database link used to access information on a remote server.</p>
</td>
</tr>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r5c1-t6" headers="r1c1-t6">
<p><code dir="ltr">DBUSER_OWNER</code></p>
</td>
<td class="cellalignment1335" headers="r5c1-t6 r1c2-t6">
<p>For incoming transactions, the local account used to connect by the remote database link; for outgoing transactions, the owner of the database link.</p>
</td>
</tr>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r6c1-t6" headers="r1c1-t6">
<p><code dir="ltr">INTERFACE</code></p>
</td>
<td class="cellalignment1335" headers="r6c1-t6 r1c2-t6">
<p><code dir="ltr">C</code> is a commit message; <code dir="ltr">N</code> is either a message indicating a prepared state or a request for a read-only commit.</p>
<p>When <code dir="ltr">IN_OUT</code> is <code dir="ltr">OUT</code>, <code dir="ltr">C</code> means that the child at the remote end of the connection is the commit point site and knows whether to commit or terminate. <code dir="ltr">N</code> means that the local node is informing the remote node that it is prepared.</p>
<p>When <code dir="ltr">IN_OUT</code> is <code dir="ltr">IN</code>, <code dir="ltr">C</code> means that the local node or a database at the remote end of an outgoing connection is the commit point site. <code dir="ltr">N</code> means that the remote node is informing the local node that it is prepared.</p>
</td>
</tr>
</tbody>
</table>
<br /></div>
<!-- class="tblruleformal" -->
<p>Execute the following script, named <code dir="ltr">neighbors_script</code>, to query pertinent information in <code dir="ltr">DBA_2PC_PENDING</code> (sample output included):</p>
<pre dir="ltr">
COL LOCAL_TRAN_ID FORMAT A13
COL IN_OUT FORMAT A6
COL DATABASE FORMAT A25
COL DBUSER_OWNER FORMAT A15
COL INTERFACE FORMAT A3
SELECT LOCAL_TRAN_ID, IN_OUT, DATABASE, DBUSER_OWNER, INTERFACE 
   FROM DBA_2PC_NEIGHBORS
/

SQL&gt; CONNECT SYS@hq.example.com AS SYSDBA
SQL&gt; @neighbors_script

LOCAL_TRAN_ID IN_OUT DATABASE                  DBUSER_OWNER    INT
------------- ------ ------------------------- --------------- ---
1.15.870      out    SALES.EXAMPLE.COM            SYS             C
</pre>
<p>This output indicates that the local node sent an outgoing request to remote server <code dir="ltr">sales</code> to commit transaction <code dir="ltr">1.15.870</code>. If <code dir="ltr">sales</code> committed the transaction but no other node did, then you know that <code dir="ltr">sales</code> is the commit point site, because the commit point site always commits first.</p>
</div>
<!-- class="sect2" --></div>
<!-- class="sect1" -->
<a id="i1007799"></a>
<div id="ADMIN12252" class="sect1">
<h2 class="sect1">Deciding How to Handle In-Doubt Transactions<a id="sthref3789"></a></h2>
<p><a id="sthref3790"></a>A transaction is in-doubt when there is a failure during any aspect of the two-phase commit. Distributed transactions become in-doubt in the following ways:</p>
<ul>
<li>
<p>A server system running Oracle Database software crashes</p>
</li>
<li>
<p>A network connection between two or more Oracle Databases involved in distributed processing is disconnected</p>
</li>
<li>
<p>An unhandled software error occurs</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<a href="ds_txns.htm#i1008016">"In-Doubt Transactions"</a> for a conceptual overview of in-doubt transactions</div>
</li>
</ul>
<p>You can manually force the commit or rollback of a local, in-doubt distributed transaction. Because this operation can generate consistency problems, perform it only when specific conditions exist.</p>
<p>This section contains the following topics:</p>
<ul>
<li>
<p><a href="#i1007832">Discovering Problems with a Two-Phase Commit</a></p>
</li>
<li>
<p><a href="#i1007850">Determining Whether to Perform a Manual Override</a></p>
</li>
<li>
<p><a href="#i1007866">Analyzing the Transaction Data</a></p>
</li>
</ul>
<a id="i1007832"></a>
<div id="ADMIN12253" class="sect2">
<h3 class="sect2">Discovering Problems with a Two-Phase Commit</h3>
<p><a id="sthref3791"></a><a id="sthref3792"></a>The user application that commits a distributed transaction is informed of a problem by one of the following error messages:<a id="sthref3793"></a><a id="sthref3794"></a><a id="sthref3795"></a><a id="sthref3796"></a><a id="sthref3797"></a></p>
<pre dir="ltr">
ORA-02050: transaction <span class="italic">ID</span> rolled back,
           some remote dbs may be in-doubt
ORA-02053: transaction <span class="italic">ID</span> committed,
           some remote dbs may be in-doubt
ORA-02054: transaction <span class="italic">ID</span> in-doubt
</pre>
<p>A robust application should save information about a transaction if it receives any of the preceding errors. This information can be used later if manual distributed transaction recovery is desired.</p>
<p>No action is required by the administrator of any node that has one or more in-doubt distributed transactions due to a network or system failure. The automatic recovery features of the database transparently complete any in-doubt transaction so that the same outcome occurs on all nodes of a session tree (that is, all commit or all roll back) after the network or system failure is resolved.</p>
<p>In extended outages, however, you can force the commit or rollback of a transaction to release any locked data. Applications must account for such possibilities.</p>
</div>
<!-- class="sect2" -->
<a id="i1007850"></a>
<div id="ADMIN12254" class="sect2">
<h3 class="sect2">Determining Whether to Perform a Manual Override</h3>
<p><a id="sthref3798"></a>Override a specific in-doubt transaction manually <span class="italic">only</span> when one of the following conditions exists:<a id="sthref3799"></a><a id="sthref3800"></a><a id="sthref3801"></a><a id="sthref3802"></a><a id="sthref3803"></a><a id="sthref3804"></a></p>
<ul>
<li>
<p>The in-doubt transaction locks data that is required by other transactions. This situation occurs when the <code dir="ltr">ORA-01591</code> error message interferes with user transactions.</p>
</li>
<li>
<p>An in-doubt transaction prevents the extents of a undo segment from being used by other transactions. The first portion of the local transaction ID of an in-doubt distributed transaction corresponds to the ID of the undo segment, as listed by the data dictionary view <code dir="ltr">DBA_2PC_PENDING.</code></p>
</li>
<li>
<p>The failure preventing the two-phase commit phases to complete cannot be corrected in an acceptable time period. Examples of such cases include a telecommunication network that has been damaged or a damaged database that requires a long recovery time.</p>
</li>
</ul>
<p>Normally, you should decide to locally force an in-doubt distributed transaction in consultation with administrators at other locations. A wrong decision can lead to database inconsistencies that can be difficult to trace and that you must manually correct.</p>
<p>If none of these conditions apply, <span class="italic">always</span> allow the automatic recovery features of the database to complete the transaction. If any of these conditions are met, however, consider a local override of the in-doubt transaction.</p>
</div>
<!-- class="sect2" -->
<a id="i1007866"></a>
<div id="ADMIN12255" class="sect2">
<h3 class="sect2">Analyzing the Transaction Data</h3>
<p>If you decide to force the transaction to complete, analyze available information with the following goals in mind.</p>
<div id="ADMIN12256" class="sect3"><a id="sthref3805"></a>
<h4 class="sect3">Find a Node that Committed or Rolled Back</h4>
<p>Use the <code dir="ltr">DBA_2PC_PENDING</code> view to find a node that has either committed or rolled back the transaction. If you can find a node that has already resolved the transaction, then you can follow the action taken at that node.</p>
</div>
<!-- class="sect3" -->
<div id="ADMIN12257" class="sect3"><a id="sthref3806"></a>
<h4 class="sect3">Look for Transaction Comments</h4>
<p>See if any information is given in the <code dir="ltr">TRAN_COMMENT</code> column of <code dir="ltr">DBA_2PC_PENDING</code> for the distributed transaction. Comments are included in the <code dir="ltr">COMMENT</code> clause of the <code dir="ltr">COMMIT</code> statement, or if transaction naming is used, the transaction name is placed in the <code dir="ltr">TRAN_COMMENT</code> field when the transaction is committed.</p>
<p>For example, the comment of an in-doubt distributed transaction can indicate the origin of the transaction and what type of transaction it is:<code dir="ltr"><a id="sthref3807"></a></code></p>
<pre dir="ltr">
COMMIT COMMENT 'Finance/Accts_pay/Trans_type 10B';
</pre>
<p>The <code dir="ltr">SET TRANSACTION...NAME</code> statement<a id="sthref3808"></a><a id="sthref3809"></a> could also have been used (and is preferable) to provide this information in a transaction name.</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<a href="#i1007593">"Naming Transactions"</a></div>
</div>
<!-- class="sect3" -->
<div id="ADMIN12258" class="sect3"><a id="sthref3810"></a>
<h4 class="sect3">Look for Transaction Advice</h4>
<p>See if any information is given in the <code dir="ltr">ADVICE</code> column of <code dir="ltr">DBA_2PC_PENDING</code> for the distributed transaction. An application can prescribe advice about whether to force the commit or force the rollback of separate parts of a distributed transaction with the <code dir="ltr">ADVISE</code> clause of the <code dir="ltr">ALTER SESSION</code> statement.</p>
<p>The advice sent during the prepare phase to each node is the advice in effect at the time the most recent DML statement executed at that database in the current transaction.</p>
<p>For example, consider a distributed transaction that moves an employee record from the <code dir="ltr">emp</code> table at one node to the <code dir="ltr">emp</code> table at another node. The transaction can protect the record--even when administrators independently force the in-doubt transaction at each node--by including the following sequence of SQL statements:<a id="sthref3811"></a><a id="sthref3812"></a><a id="sthref3813"></a></p>
<pre dir="ltr">
ALTER SESSION ADVISE COMMIT;
INSERT INTO emp@hq ... ;    /*advice to commit at HQ */
ALTER SESSION ADVISE ROLLBACK;
DELETE FROM emp@sales ... ; /*advice to roll back at SALES*/

ALTER SESSION ADVISE NOTHING;
</pre>
<p>If you manually force the in-doubt transaction following the given advice, the worst that can happen is that each node has a copy of the employee record; the record cannot disappear.</p>
</div>
<!-- class="sect3" --></div>
<!-- class="sect2" --></div>
<!-- class="sect1" -->
<a id="i1007905"></a>
<div id="ADMIN12259" class="sect1">
<h2 class="sect1">Manually Overriding In-Doubt Transactions</h2>
<p><a id="sthref3814"></a><a id="sthref3815"></a>Use the <a id="sthref3816"></a><a id="sthref3817"></a><a id="sthref3818"></a><a id="sthref3819"></a><code dir="ltr">COMMIT</code> or <code dir="ltr">ROLLBACK</code> statement with the <code dir="ltr">FORCE</code> option and a text string that indicates either the local or global transaction ID of the in-doubt transaction to commit.<a id="sthref3820"></a><a id="sthref3821"></a></p>
<div class="infobox-note">
<p class="notep1">Note:</p>
In all examples, the transaction is committed or rolled back on the local node, and the local pending transaction table records a value of forced commit or forced termination for the <code dir="ltr">STATE</code> column the row for this transaction.</div>
<p>This section contains the following topics:</p>
<ul>
<li>
<p><a href="#i1107926">Manually Committing an In-Doubt Transaction</a></p>
</li>
<li>
<p><a href="#i1007973">Manually Rolling Back an In-Doubt Transaction</a></p>
</li>
</ul>
<a id="i1107926"></a>
<div id="ADMIN12260" class="sect2">
<h3 class="sect2">Manually Committing an In-Doubt Transaction</h3>
<p><a id="sthref3822"></a>Before attempting to commit the transaction, ensure that you have the proper privileges. Note the following requirements:</p>
<div class="inftblruleinformal">
<table class="cellalignment1333" title="Privileges Required to Commit In-Doubt Transactions" summary="Column 1 lists who is attempting to commit a transaction.; column 2 lists the associated privileges that are required." dir="ltr">
<thead>
<tr class="cellalignment1327">
<th class="cellalignment1334" id="r1c1-t10">User Committing the Transaction</th>
<th class="cellalignment1334" id="r1c2-t10">Privilege Required</th>
</tr>
</thead>
<tbody>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r2c1-t10" headers="r1c1-t10">You</td>
<td class="cellalignment1335" headers="r2c1-t10 r1c2-t10"><code dir="ltr">FORCE TRANSACTION</code></td>
</tr>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r3c1-t10" headers="r1c1-t10">Another user</td>
<td class="cellalignment1335" headers="r3c1-t10 r1c2-t10"><code dir="ltr">FORCE ANY TRANSACTION</code></td>
</tr>
</tbody>
</table>
<br /></div>
<!-- class="inftblruleinformal" -->
<div id="ADMIN12261" class="sect3"><a id="sthref3823"></a>
<h4 class="sect3">Committing Using Only the Transaction ID</h4>
<p>The following SQL statement commits an in-doubt transaction:</p>
<pre dir="ltr">
COMMIT FORCE '<span class="italic">transaction_id</span>';
</pre>
<p>The variable <span class="italic">transaction_id</span> is the identifier of the transaction as specified in either the <code dir="ltr">LOCAL_TRAN_ID</code> or <code dir="ltr">GLOBAL_TRAN_ID</code> columns of the <code dir="ltr">DBA_2PC_PENDING</code> data dictionary view.</p>
<p>For example, assume that you query <code dir="ltr">DBA_2PC_PENDING</code> and determine that <code dir="ltr">LOCAL_TRAN_ID</code> for a distributed transaction is <code dir="ltr">1:45.13</code>.</p>
<p>You then issue the following SQL statement to force the commit of this in-doubt transaction:<a id="sthref3824"></a><a id="sthref3825"></a><a id="sthref3826"></a></p>
<pre dir="ltr">
COMMIT FORCE '1.45.13';
</pre></div>
<!-- class="sect3" -->
<div id="ADMIN12262" class="sect3"><a id="sthref3827"></a>
<h4 class="sect3">Committing Using an SCN</h4>
<p>Optionally, you can specify the SCN for the transaction when forcing a transaction to commit. This feature lets you commit an in-doubt transaction with the SCN assigned when it was committed at other nodes.</p>
<p>Consequently, you maintain the synchronized commit time of the distributed transaction even if there is a failure. Specify an SCN only when you can determine the SCN of the same transaction already committed at another node.<a id="sthref3828"></a></p>
<p>For example, assume you want to manually commit a transaction with the following global transaction ID:</p>
<pre dir="ltr">
SALES.EXAMPLE.COM.55d1c563.1.93.29 
</pre>
<p>First, query the <code dir="ltr">DBA_2PC_PENDING</code> view of a remote database also involved with the transaction in question. Note the SCN used for the commit of the transaction at that node. Specify the SCN when committing the transaction at the local node. For example, if the SCN is <code dir="ltr">829381993</code>, issue:</p>
<pre dir="ltr">
COMMIT FORCE 'SALES.EXAMPLE.COM.55d1c563.1.93.29', 829381993;
</pre>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<a class="olink SQLRF01110" href="../../server.112/e41084/statements_4010.htm#SQLRF01110"><span class="italic">Oracle Database SQL Language Reference</span></a> for more information about using the <code dir="ltr">COMMIT</code> statement</div>
</div>
<!-- class="sect3" --></div>
<!-- class="sect2" -->
<a id="i1007973"></a>
<div id="ADMIN12263" class="sect2">
<h3 class="sect2">Manually Rolling Back an In-Doubt Transaction</h3>
<p><a id="sthref3829"></a>Before attempting to roll back the in-doubt distributed transaction, ensure that you have the proper privileges. Note the following requirements:</p>
<div class="inftblruleinformal">
<table class="cellalignment1333" title="Privileges Required to Roll Back In-Doubt Transactions" summary="Column 1 lists who is attempting to commit a transaction.; column 2 lists the associated privileges that are required." dir="ltr">
<thead>
<tr class="cellalignment1327">
<th class="cellalignment1334" id="r1c1-t12">User Committing the Transaction</th>
<th class="cellalignment1334" id="r1c2-t12">Privilege Required</th>
</tr>
</thead>
<tbody>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r2c1-t12" headers="r1c1-t12">You</td>
<td class="cellalignment1335" headers="r2c1-t12 r1c2-t12"><code dir="ltr">FORCE TRANSACTION</code></td>
</tr>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r3c1-t12" headers="r1c1-t12">Another user</td>
<td class="cellalignment1335" headers="r3c1-t12 r1c2-t12"><code dir="ltr">FORCE ANY TRANSACTION</code></td>
</tr>
</tbody>
</table>
<br /></div>
<!-- class="inftblruleinformal" -->
<p>The following SQL statement rolls back an in-doubt transaction:<a id="sthref3830"></a><a id="sthref3831"></a><a id="sthref3832"></a></p>
<pre dir="ltr">
ROLLBACK FORCE '<span class="italic">transaction_id</span>';
</pre>
<p>The variable <span class="italic">transaction_id</span> is the identifier of the transaction as specified in either the <code dir="ltr">LOCAL_TRAN_ID</code> or <code dir="ltr">GLOBAL_TRAN_ID</code> columns of the <code dir="ltr">DBA_2PC_PENDING</code> data dictionary view.</p>
<p>For example, to roll back the in-doubt transaction with the local transaction ID of <code dir="ltr">2.9.4</code>, use the following statement:</p>
<pre dir="ltr">
ROLLBACK FORCE '2.9.4';<a id="sthref3833"></a><a id="sthref3834"></a>
</pre>
<div class="infobox-note">
<p class="notep1">Note:</p>
You cannot roll back an in-doubt transaction to a savepoint.</div>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<a class="olink SQLRF01610" href="../../server.112/e41084/statements_9021.htm#SQLRF01610"><span class="italic">Oracle Database SQL Language Reference</span></a> for more information about using the <code dir="ltr">ROLLBACK</code> statement</div>
</div>
<!-- class="sect2" --></div>
<!-- class="sect1" -->
<a id="i1008018"></a>
<div id="ADMIN12264" class="sect1">
<h2 class="sect1">Purging Pending Rows from the Data Dictionary</h2>
<p><a id="sthref3835"></a><a id="sthref3836"></a>Before RECO recovers an in-doubt transaction, the transaction appears in <a id="sthref3837"></a><code dir="ltr">DBA_2PC_PENDING.STATE</code> as <code dir="ltr">COLLECTING</code>, <code dir="ltr">COMMITTED</code>, or <code dir="ltr">PREPARED</code>. If you force an in-doubt transaction using <code dir="ltr">COMMIT FORCE</code> or <code dir="ltr">ROLLBACK FORCE</code>, then the states <code dir="ltr">FORCED COMMIT</code> or <code dir="ltr">FORCED ROLLBACK</code> may appear.</p>
<p>Automatic recovery normally deletes entries in these states. The only exception is when recovery discovers a forced transaction that is in a state inconsistent with other sites in the transaction. In this case, the entry can be left in the table and the <code dir="ltr">MIXED</code> column in <code dir="ltr">DBA_2PC_PENDING</code> has a value of <code dir="ltr">YES</code>. These entries can be cleaned up with the <code dir="ltr">DBMS_TRANSACTION.PURGE_MIXED</code> procedure.</p>
<p>If automatic recovery is not possible because a remote database has been permanently lost, then recovery cannot identify the re-created database because it receives a new database ID when it is re-created. In this case, you must use the <code dir="ltr">PURGE_LOST_DB_ENTRY</code> procedure in the <code dir="ltr">DBMS_TRANSACTION</code> package to clean up the entries. The entries do not hold up database resources, so there is no urgency in cleaning them up.</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<a class="olink ARPLS062" href="../../appdev.112/e40758/d_transa.htm#ARPLS062"><span class="italic">Oracle Database PL/SQL Packages and Types Reference</span></a> for more information about the <code dir="ltr">DBMS_TRANSACTION</code> package</div>
<div id="ADMIN12265" class="sect2"><a id="sthref3838"></a>
<h3 class="sect2">Executing the PURGE_LOST_DB_ENTRY Procedure</h3>
<p><a id="sthref3839"></a><a id="sthref3840"></a>To manually remove an entry from the data dictionary, use the following syntax (where <span class="italic">trans_id</span> is the identifier for the transaction):</p>
<pre dir="ltr">
DBMS_TRANSACTION.PURGE_LOST_DB_ENTRY('<span class="italic">trans_id</span>');
</pre>
<p>For example, to purge pending distributed transaction <code dir="ltr">1.44.99</code>, enter the following statement in SQL*Plus:</p>
<pre dir="ltr">
EXECUTE DBMS_TRANSACTION.PURGE_LOST_DB_ENTRY('1.44.99');
</pre>
<p>Execute this procedure only if significant reconfiguration has occurred so that automatic recovery cannot resolve the transaction. Examples include:</p>
<ul>
<li>
<p>Total loss of the remote database</p>
</li>
<li>
<p>Reconfiguration in software resulting in loss of two-phase commit capability</p>
</li>
<li>
<p>Loss of information from an external transaction coordinator such as a TPMonitor</p>
</li>
</ul>
</div>
<!-- class="sect2" -->
<div id="ADMIN12266" class="sect2"><a id="sthref3841"></a>
<h3 class="sect2">Determining When to Use DBMS_TRANSACTION</h3>
<p><a id="sthref3842"></a><a id="sthref3843"></a>The following tables indicates what the various states indicate about the distributed transaction what the administrator's action should be:</p>
<div class="inftblruleinformal">
<table class="cellalignment1333" title="Distributed Transaction State and Appropriate Action" summary="Column 1 lists the possible STATE column settings for a distributed transaction; column 2 lists the state of a global transaction; column 3 lists the state of a local transaction; column 4 lists the normal action that is required; column 5 lists alternative actions." dir="ltr">
<thead>
<tr class="cellalignment1327">
<th class="cellalignment1334" id="r1c1-t16">STATE Column</th>
<th class="cellalignment1334" id="r1c2-t16">State of Global Transaction</th>
<th class="cellalignment1334" id="r1c3-t16">State of Local Transaction</th>
<th class="cellalignment1334" id="r1c4-t16">Normal Action</th>
<th class="cellalignment1334" id="r1c5-t16">Alternative Action</th>
</tr>
</thead>
<tbody>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r2c1-t16" headers="r1c1-t16">Collecting</td>
<td class="cellalignment1335" headers="r2c1-t16 r1c2-t16">Rolled back</td>
<td class="cellalignment1335" headers="r2c1-t16 r1c3-t16">Rolled back</td>
<td class="cellalignment1335" headers="r2c1-t16 r1c4-t16">None</td>
<td class="cellalignment1335" headers="r2c1-t16 r1c5-t16"><code dir="ltr">PURGE_LOST_DB_ENTRY</code> (only if autorecovery cannot resolve transaction)</td>
</tr>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r3c1-t16" headers="r1c1-t16">Committed</td>
<td class="cellalignment1335" headers="r3c1-t16 r1c2-t16">Committed</td>
<td class="cellalignment1335" headers="r3c1-t16 r1c3-t16">Committed</td>
<td class="cellalignment1335" headers="r3c1-t16 r1c4-t16">None</td>
<td class="cellalignment1335" headers="r3c1-t16 r1c5-t16"><code dir="ltr">PURGE_LOST_DB_ENTRY</code> (only if autorecovery cannot resolve transaction)</td>
</tr>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r4c1-t16" headers="r1c1-t16">Prepared</td>
<td class="cellalignment1335" headers="r4c1-t16 r1c2-t16">Unknown</td>
<td class="cellalignment1335" headers="r4c1-t16 r1c3-t16">Prepared</td>
<td class="cellalignment1335" headers="r4c1-t16 r1c4-t16">None</td>
<td class="cellalignment1335" headers="r4c1-t16 r1c5-t16">Force commit or rollback</td>
</tr>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r5c1-t16" headers="r1c1-t16">Forced commit</td>
<td class="cellalignment1335" headers="r5c1-t16 r1c2-t16">Unknown</td>
<td class="cellalignment1335" headers="r5c1-t16 r1c3-t16">Committed</td>
<td class="cellalignment1335" headers="r5c1-t16 r1c4-t16">None</td>
<td class="cellalignment1335" headers="r5c1-t16 r1c5-t16"><code dir="ltr">PURGE_LOST_DB_ENTRY</code> (only if autorecovery cannot resolve transaction)</td>
</tr>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r6c1-t16" headers="r1c1-t16">Forced rollback</td>
<td class="cellalignment1335" headers="r6c1-t16 r1c2-t16">Unknown</td>
<td class="cellalignment1335" headers="r6c1-t16 r1c3-t16">Rolled back</td>
<td class="cellalignment1335" headers="r6c1-t16 r1c4-t16">None</td>
<td class="cellalignment1335" headers="r6c1-t16 r1c5-t16"><code dir="ltr">PURGE_LOST_DB_ENTRY</code> (only if autorecovery cannot resolve transaction)</td>
</tr>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r7c1-t16" headers="r1c1-t16">Forced commit</td>
<td class="cellalignment1335" headers="r7c1-t16 r1c2-t16">Mixed</td>
<td class="cellalignment1335" headers="r7c1-t16 r1c3-t16">Committed</td>
<td class="cellalignment1335" headers="r7c1-t16 r1c4-t16">Manually remove inconsistencies then use <code dir="ltr">PURGE_MIXED</code></td>
<td class="cellalignment1335" headers="r7c1-t16 r1c5-t16">-</td>
</tr>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r8c1-t16" headers="r1c1-t16">Forced rollback</td>
<td class="cellalignment1335" headers="r8c1-t16 r1c2-t16">Mixed</td>
<td class="cellalignment1335" headers="r8c1-t16 r1c3-t16">Rolled back</td>
<td class="cellalignment1335" headers="r8c1-t16 r1c4-t16">Manually remove inconsistencies then use <code dir="ltr">PURGE_MIXED</code></td>
<td class="cellalignment1335" headers="r8c1-t16 r1c5-t16">-</td>
</tr>
</tbody>
</table>
<br /></div>
<!-- class="inftblruleinformal" --></div>
<!-- class="sect2" --></div>
<!-- class="sect1" -->
<a id="i1008132"></a>
<div id="ADMIN12267" class="sect1">
<h2 class="sect1">Manually Committing an <a id="sthref3844"></a>In-Doubt Transaction: Example</h2>
<p><a id="sthref3845"></a><a href="#i1008140">Figure 35-1</a>, illustrates a failure during the commit of a distributed transaction. In this failure case, the prepare phase completes. During the commit phase, however, the commit confirmation of the commit point site never reaches the global coordinator, even though the commit point site committed the transaction. Inventory data is locked and cannot be accessed because the in-doubt transaction is critical to other transactions. Further, the locks must be held until the in-doubt transaction either commits or rolls back.</p>
<div id="ADMIN13155" class="figure">
<p class="titleinfigure"><a id="i1008140"></a>Figure 35-1 Example of an In-Doubt Distributed Transaction</p>
<img width="507" height="216" src="img/admin037.png" alt="Description of Figure 35-1 follows" /><br />
<a id="sthref3846" href="img_text/admin037.htm">Description of "Figure 35-1 Example of an In-Doubt Distributed Transaction"</a><br />
<br /></div>
<!-- class="figure" -->
<p>You can manually force the local portion of the in-doubt transaction by following the steps detailed in the following sections:</p>
<p><a href="#i1008171">Step 1: Record User Feedback</a></p>
<p><a href="#i1008177">Step 2: Query DBA_2PC_PENDING</a></p>
<p><a href="#i1108221">Step 3: Query DBA_2PC_NEIGHBORS on Local Node</a></p>
<p><a href="#i1008279">Step 4: Querying Data Dictionary Views on All Nodes</a></p>
<p><a href="#i1008375">Step 5: Commit the In-Doubt Transaction</a></p>
<p><a href="#i1008384">Step 6: Check for Mixed Outcome Using DBA_2PC_PENDING</a></p>
<a id="i1008171"></a>
<div id="ADMIN12268" class="sect2">
<h3 class="sect2">Step 1: Record User Feedback</h3>
<p>The users of the local database system that conflict with the locks of the in-doubt transaction receive the following error message:</p>
<pre dir="ltr">
ORA-01591: lock held by in-doubt distributed transaction 1.21.17
</pre>
<p>In this case, <code dir="ltr">1.21.17</code> is the local transaction ID of the in-doubt distributed transaction. You should request and record this ID number from users that report problems to identify which in-doubt transactions should be forced.</p>
</div>
<!-- class="sect2" -->
<a id="i1008177"></a>
<div id="ADMIN12269" class="sect2">
<h3 class="sect2">Step 2: Query DBA_2PC_PENDING</h3>
<p>After connecting with SQL*Plus to <code dir="ltr">warehouse</code>, query the local <code dir="ltr">DBA_2PC_PENDING</code> data dictionary view to gain information about the in-doubt transaction:</p>
<pre dir="ltr">
CONNECT SYS@warehouse.example.com AS SYSDBA
SELECT * FROM DBA_2PC_PENDING WHERE LOCAL_TRAN_ID = '1.21.17';
</pre>
<p>The database returns the following information:</p>
<pre dir="ltr">
Column Name            Value
---------------------- --------------------------------------
LOCAL_TRAN_ID          1.21.17
GLOBAL_TRAN_ID         SALES.EXAMPLE.COM.55d1c563.1.93.29
STATE                  prepared
MIXED                  no
ADVICE
TRAN_COMMENT           Sales/New Order/Trans_type 10B
FAIL_TIME              31-MAY-91
FORCE_TIME
RETRY_TIME             31-MAY-91
OS_USER                SWILLIAMS
OS_TERMINAL            TWA139:
HOST                   system1
DB_USER                SWILLIAMS
COMMIT#
</pre>
<div id="ADMIN12270" class="sect3"><a id="sthref3847"></a>
<h4 class="sect3">Determining the Global Transaction ID</h4>
<p>The global transaction ID is the common transaction ID that is the same on every node for a distributed transaction. It is of the form:</p>
<p><code dir="ltr"><span class="codeinlineitalic">global_database_name</span></code>.<code dir="ltr"><span class="codeinlineitalic">hhhhhhhh.local</span></code>_<code dir="ltr"><span class="codeinlineitalic">transaction_id</span></code></p>
<p>where:</p>
<ul>
<li>
<p><code dir="ltr"><span class="codeinlineitalic">global_database_name</span></code> is the database name of the global coordinator.</p>
</li>
<li>
<p><code dir="ltr"><span class="codeinlineitalic">hhhhhhhh</span></code> is the internal database identifier of the global coordinator (in hexadecimal).</p>
</li>
<li>
<p><code dir="ltr"><span class="codeinlineitalic">local_transaction_id</span></code> is the corresponding local transaction ID assigned on the global coordinator.</p>
</li>
</ul>
<p>Note that the last portion of the global transaction ID and the local transaction ID match at the global coordinator. In the example, you can tell that <code dir="ltr">warehouse</code> is <span class="italic">not</span> the global coordinator because these numbers do not match:</p>
<pre dir="ltr">
LOCAL_TRAN_ID          1.21.17
GLOBAL_TRAN_ID         ... 1.93.29
</pre></div>
<!-- class="sect3" -->
<div id="ADMIN12271" class="sect3"><a id="sthref3848"></a>
<h4 class="sect3">Determining the State of the Transaction</h4>
<p>The transaction on this node is in a prepared state:</p>
<pre dir="ltr">
STATE          prepared 
</pre>
<p>Therefore, <code dir="ltr">warehouse</code> waits for its coordinator to send either a commit or a rollback request.</p>
</div>
<!-- class="sect3" -->
<div id="ADMIN12272" class="sect3"><a id="sthref3849"></a>
<h4 class="sect3">Looking for Comments or Advice</h4>
<p>The transaction comment or advice can include information about this transaction. If so, use this comment to your advantage. In this example, the origin and transaction type is in the transaction comment:</p>
<pre dir="ltr">
TRAN_COMMENT           Sales/New Order/Trans_type 10B
</pre>
<p>It could also be provided as a transaction name with a <code dir="ltr">SET TRANSACTION...NAME</code> statement.</p>
<p>This information can reveal something that helps you decide whether to commit or rollback the local portion of the transaction. If useful comments do not accompany an in-doubt transaction, you must complete some extra administrative work to trace the session tree and find a node that has resolved the transaction.</p>
</div>
<!-- class="sect3" --></div>
<!-- class="sect2" -->
<a id="i1108221"></a>
<div id="ADMIN12273" class="sect2">
<h3 class="sect2">Step 3: Query DBA_2PC_NEIGHBORS on Local Node</h3>
<p>The purpose of this step is to climb the session tree so that you find coordinators, eventually reaching the global coordinator. Along the way, you may find a coordinator that has resolved the transaction. If not, you can eventually work your way to the commit point site, which will always have resolved the in-doubt transaction. To trace the session tree, query the <code dir="ltr">DBA_2PC_NEIGHBORS</code> view on each node.</p>
<p>In this case, you query this view on the <code dir="ltr">warehouse</code> database:</p>
<pre dir="ltr">
CONNECT SYS@warehouse.example.com AS SYSDBA
SELECT * FROM DBA_2PC_NEIGHBORS
  WHERE LOCAL_TRAN_ID = '1.21.17'
  ORDER BY SESS#, IN_OUT;

Column Name            Value
---------------------- --------------------------------------
LOCAL_TRAN_ID          1.21.17
IN_OUT                 in
DATABASE               SALES.EXAMPLE.COM
DBUSER_OWNER           SWILLIAMS
INTERFACE              N
DBID                   000003F4
SESS#                  1
BRANCH                 0100
</pre>
<div id="ADMIN12274" class="sect3"><a id="sthref3850"></a>
<h4 class="sect3">Obtaining Database Role and Database Link Information</h4>
<p>The <code dir="ltr">DBA_2PC_NEIGHBORS</code> view provides information about connections associated with an in-doubt transaction. Information for each connection is different, based on whether the connection is <span class="bold">inbound</span> (<code dir="ltr">IN_OUT = in</code>) or <span class="bold">outbound</span> (<code dir="ltr">IN_OUT = out</code>):</p>
<div class="inftblruleinformal">
<table class="cellalignment1333" title="Connections Associated With In-Doubt Transactions" summary="Column 1 lists the value of the IN_OUT column; column 2 explains the meaning of the value; column 3 explains the significance of the DATABASE column; column 4 explains the significance of the DBUSER_OWNER column." dir="ltr">
<thead>
<tr class="cellalignment1327">
<th class="cellalignment1334" id="r1c1-t17">IN_OUT</th>
<th class="cellalignment1334" id="r1c2-t17">Meaning</th>
<th class="cellalignment1334" id="r1c3-t17">DATABASE</th>
<th class="cellalignment1334" id="r1c4-t17">DBUSER_OWNER</th>
</tr>
</thead>
<tbody>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r2c1-t17" headers="r1c1-t17">in</td>
<td class="cellalignment1335" headers="r2c1-t17 r1c2-t17">Your node is a server of another node.</td>
<td class="cellalignment1335" headers="r2c1-t17 r1c3-t17">Lists the name of the client database that connected to your node.</td>
<td class="cellalignment1335" headers="r2c1-t17 r1c4-t17">Lists the local account for the database link connection that corresponds to the in-doubt transaction.</td>
</tr>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r3c1-t17" headers="r1c1-t17">out</td>
<td class="cellalignment1335" headers="r3c1-t17 r1c2-t17">Your node is a client of other servers.</td>
<td class="cellalignment1335" headers="r3c1-t17 r1c3-t17">Lists the name of the database link that connects to the remote node.</td>
<td class="cellalignment1335" headers="r3c1-t17 r1c4-t17">Lists the owner of the database link for the in-doubt transaction.</td>
</tr>
</tbody>
</table>
<br /></div>
<!-- class="inftblruleinformal" -->
<p>In this example, the <code dir="ltr">IN_OUT</code> column reveals that the <code dir="ltr">warehouse</code> database is a server for the <code dir="ltr">sales</code> client, as specified in the DATABASE column:</p>
<pre dir="ltr">
IN_OUT                 in
DATABASE               SALES.EXAMPLE.COM
</pre>
<p>The connection to <code dir="ltr">warehouse</code> was established through a database link from the <code dir="ltr">swilliams</code> account, as shown by the <code dir="ltr">DBUSER_OWNER</code> column:</p>
<pre dir="ltr">
DBUSER_OWNER           SWILLIAMS
</pre></div>
<!-- class="sect3" -->
<div id="ADMIN12275" class="sect3"><a id="sthref3851"></a>
<h4 class="sect3">Determining the Commit Point Site</h4>
<p>Additionally, the <code dir="ltr">INTERFACE</code> column tells whether the local node or a subordinate node is the commit point site:</p>
<pre dir="ltr">
INTERFACE              N
</pre>
<p>Neither <code dir="ltr">warehouse</code> nor any of its descendants is the commit point site, as shown by the <code dir="ltr">INTERFACE</code> column.</p>
</div>
<!-- class="sect3" --></div>
<!-- class="sect2" -->
<a id="i1008279"></a>
<div id="ADMIN12276" class="sect2">
<h3 class="sect2">Step 4: Querying Data Dictionary Views on All Nodes</h3>
<p>At this point, you can contact the administrator at the located nodes and ask each person to repeat Steps 2 and 3 using the global transaction ID.</p>
<div class="infobox-note">
<p class="notep1">Note:</p>
If you can directly connect to these nodes with another network, you can repeat Steps 2 and 3 yourself.</div>
<p>For example, the following results are returned when Steps 2 and 3 are performed at <code dir="ltr">sales</code> and <code dir="ltr">hq</code>.</p>
<div id="ADMIN12277" class="sect3"><a id="sthref3852"></a>
<h4 class="sect3">Checking the Status of Pending Transactions at sales</h4>
<p>At this stage, the <code dir="ltr">sales</code> administrator queries the <code dir="ltr">DBA_2PC_PENDING</code> data dictionary view:</p>
<pre dir="ltr">
SQL&gt; CONNECT SYS@sales.example.com AS SYSDBA
SQL&gt; SELECT * FROM DBA_2PC_PENDING
   &gt; WHERE GLOBAL_TRAN_ID = 'SALES.EXAMPLE.COM.55d1c563.1.93.29';

Column Name            Value
---------------------- --------------------------------------
LOCAL_TRAN_ID          1.93.29
GLOBAL_TRAN_ID         SALES.EXAMPLE.COM.55d1c563.1.93.29
STATE                  prepared
MIXED                  no
ADVICE
TRAN_COMMENT           Sales/New Order/Trans_type 10B
FAIL_TIME              31-MAY-91
FORCE_TIME
RETRY_TIME             31-MAY-91
OS_USER                SWILLIAMS
OS_TERMINAL            TWA139:
HOST                   system1
DB_USER                SWILLIAMS
COMMIT#
</pre></div>
<!-- class="sect3" -->
<div id="ADMIN12278" class="sect3"><a id="sthref3853"></a>
<h4 class="sect3">Determining the Coordinators and Commit Point Site at sales</h4>
<p>Next, the <code dir="ltr">sales</code> administrator queries <code dir="ltr">DBA_2PC_NEIGHBORS</code> to determine the global and local coordinators as well as the commit point site:</p>
<pre dir="ltr">
SELECT * FROM DBA_2PC_NEIGHBORS
   WHERE GLOBAL_TRAN_ID = 'SALES.EXAMPLE.COM.55d1c563.1.93.29'
   ORDER BY SESS#, IN_OUT;
</pre>
<p>This query returns three rows:</p>
<ul>
<li>
<p>The connection to <code dir="ltr">warehouse</code></p>
</li>
<li>
<p>The connection to <code dir="ltr">hq</code></p>
</li>
<li>
<p>The connection established by the user</p>
</li>
</ul>
<p>Reformatted information corresponding to the rows for the <code dir="ltr">warehouse</code> connection appears below:</p>
<pre dir="ltr">
Column Name            Value
---------------------- --------------------------------------
LOCAL_TRAN_ID          1.93.29
IN_OUT                 OUT
DATABASE               WAREHOUSE.EXAMPLE.COM
DBUSER_OWNER           SWILLIAMS
INTERFACE              N
DBID                   55d1c563
SESS#                  1
BRANCH                 1
</pre>
<p>Reformatted information corresponding to the rows for the <code dir="ltr">hq</code> connection appears below:</p>
<pre dir="ltr">
Column Name            Value
---------------------- --------------------------------------
LOCAL_TRAN_ID          1.93.29
IN_OUT                 OUT
DATABASE               HQ.EXAMPLE.COM
DBUSER_OWNER           ALLEN
INTERFACE              C
DBID                   00000390
SESS#                  1
BRANCH                 1
</pre>
<p>The information from the previous queries reveal the following:</p>
<ul>
<li>
<p><code dir="ltr">sales</code> is the global coordinator because the local transaction ID and global transaction ID match.</p>
</li>
<li>
<p>Two outbound connections are established from this node, but no inbound connections. <code dir="ltr">sales</code> is not the server of another node.</p>
</li>
<li>
<p><code dir="ltr">hq</code> or one of its servers is the commit point site.</p>
</li>
</ul>
</div>
<!-- class="sect3" -->
<div id="ADMIN12279" class="sect3"><a id="sthref3854"></a>
<h4 class="sect3">Checking the Status of Pending Transactions at HQ</h4>
<p>At this stage, the <code dir="ltr">hq</code> administrator queries the <code dir="ltr">DBA_2PC_PENDING</code> data dictionary view:</p>
<pre dir="ltr">
SELECT * FROM DBA_2PC_PENDING@hq.example.com
   WHERE GLOBAL_TRAN_ID = 'SALES.EXAMPLE.COM.55d1c563.1.93.29';

Column Name            Value
---------------------- --------------------------------------
LOCAL_TRAN_ID          1.45.13
GLOBAL_TRAN_ID         SALES.EXAMPLE.COM.55d1c563.1.93.29
STATE                  COMMIT
MIXED                  NO
ACTION
TRAN_COMMENT           Sales/New Order/Trans_type 10B
FAIL_TIME              31-MAY-91
FORCE_TIME
RETRY_TIME             31-MAY-91
OS_USER                SWILLIAMS
OS_TERMINAL            TWA139:
HOST                   SYSTEM1
DB_USER                SWILLIAMS
COMMIT#                129314
</pre>
<p>At this point, you have found a node that resolved the transaction. As the view reveals, it has been committed and assigned a commit ID number:</p>
<pre dir="ltr">
STATE                  COMMIT
COMMIT#                129314
</pre>
<p>Therefore, you can force the in-doubt transaction to commit at your local database. It is a good idea to contact any other administrators you know that could also benefit from your investigation.</p>
</div>
<!-- class="sect3" --></div>
<!-- class="sect2" -->
<a id="i1008375"></a>
<div id="ADMIN12280" class="sect2">
<h3 class="sect2">Step 5: Commit the In-Doubt Transaction</h3>
<p>You contact the administrator of the <code dir="ltr">sales</code> database, who manually commits the in-doubt transaction using the global ID:</p>
<pre dir="ltr">
SQL&gt; CONNECT SYS@sales.example.com AS SYSDBA
SQL&gt; COMMIT FORCE 'SALES.EXAMPLE.COM.55d1c563.1.93.29';
</pre>
<p>As administrator of the <code dir="ltr">warehouse</code> database, you manually commit the in-doubt transaction using the global ID:</p>
<pre dir="ltr">
SQL&gt; CONNECT SYS@warehouse.example.com AS SYSDBA
SQL&gt; COMMIT FORCE 'SALES.EXAMPLE.COM.55d1c563.1.93.29';
</pre></div>
<!-- class="sect2" -->
<a id="i1008384"></a>
<div id="ADMIN12281" class="sect2">
<h3 class="sect2">Step 6: Check for Mixed Outcome Using DBA_2PC_PENDING</h3>
<p>After you manually force a transaction to commit or roll back, the corresponding row in the pending transaction table remains. The state of the transaction is changed depending on how you forced the transaction.</p>
<p><a id="i1108387"></a>Every Oracle Database has a <span class="bold">pending transaction table</span>. This is a special table that stores information about distributed transactions as they proceed through the two-phase commit phases. You can query the pending transaction table of a database through the <code dir="ltr">DBA_2PC_PENDING</code> data dictionary view (see <a href="#g1008762">Table 35-1</a>). <a id="sthref3855"></a><a id="sthref3856"></a><a id="sthref3857"></a><a id="sthref3858"></a></p>
<p>Also of particular interest in the pending transaction table is the mixed outcome flag as indicated in <code dir="ltr">DBA_2PC_PENDING.MIXED</code>. You can make the wrong choice if a pending transaction is forced to commit or roll back. For example, the local administrator rolls back the transaction, but the other nodes commit it. Incorrect decisions are detected automatically, and the damage flag for the corresponding pending transaction record is set (<code dir="ltr">MIXED=yes</code>).</p>
<p>The RECO (Recoverer) background process uses the information in the pending transaction table to finalize the status of in-doubt transactions. You can also use the information in the pending transaction table to manually override the automatic recovery procedures for pending distributed transactions.</p>
<p>All transactions automatically resolved by RECO are removed from the pending transaction table. Additionally, all information about in-doubt transactions correctly resolved by an administrator (as checked when RECO reestablishes communication) are automatically removed from the pending transaction table. However, all rows resolved by an administrator that result in a mixed outcome across nodes remain in the pending transaction table of all involved nodes until they are manually deleted using <code dir="ltr">DBMS_TRANSACTIONS.PURGE_MIXED</code>.</p>
</div>
<!-- class="sect2" --></div>
<!-- class="sect1" -->
<a id="i1008399"></a>
<div id="ADMIN12282" class="sect1">
<h2 class="sect1">Data Access Failures Due to Locks</h2>
<p><a id="sthref3859"></a><a id="sthref3860"></a>When you issue a SQL statement, the database attempts to lock the resources needed to successfully execute the statement. If the requested data is currently held by statements of other uncommitted transactions, however, and remains locked for a long time, a timeout occurs.</p>
<p>Consider the following scenarios involving data access failure:</p>
<ul>
<li>
<p><a href="#i1008415">Transaction Timeouts</a><a id="sthref3861"></a><a id="sthref3862"></a><a id="sthref3863"></a></p>
</li>
<li>
<p><a href="#i1008428">Locks from In-Doubt Transactions</a></p>
</li>
</ul>
<a id="i1008415"></a>
<div id="ADMIN12283" class="sect2">
<h3 class="sect2">Transaction Timeouts</h3>
<p><a id="sthref3864"></a>A DML statement that requires locks on a remote database can be blocked if another transaction own locks on the requested data. If these locks continue to block the requesting SQL statement, then the following sequence of events occurs:</p>
<ol>
<li>
<p>A timeout occurs.</p>
</li>
<li>
<p>The database rolls back the statement.</p>
</li>
<li>
<p>The database returns this error message to the user:<a id="sthref3865"></a><a id="sthref3866"></a><a id="sthref3867"></a></p>
<pre dir="ltr">
ORA-02049: time-out: distributed transaction waiting for lock
</pre></li>
</ol>
<p>Because the transaction did not modify data, no actions are necessary as a result of the timeout. Applications should proceed as if a deadlock has been encountered. The user who executed the statement can try to reexecute the statement later. If the lock persists, then the user should contact an administrator to report the problem.</p>
</div>
<!-- class="sect2" -->
<a id="i1008428"></a>
<div id="ADMIN12284" class="sect2">
<h3 class="sect2">Locks from In-Doubt Transactions</h3>
<p><a id="sthref3868"></a><a id="sthref3869"></a>A query or DML statement that requires locks on a local database can be blocked indefinitely due to the locked resources of an in-doubt distributed transaction. In this case, the database issues the following error message:<a id="sthref3870"></a></p>
<pre dir="ltr">
ORA-01591: lock held by in-doubt distributed transaction <span class="italic">identifier</span>
</pre>
<p>In this case, the database rolls back the SQL statement immediately. The user who executed the statement can try to reexecute the statement later. If the lock persists, the user should contact an administrator to report the problem, <span class="italic">including</span> the ID of the in-doubt distributed transaction.</p>
<p>The chances of these situations occurring are rare considering the low probability of failures during the critical portions of the two-phase commit. Even if such a failure occurs, and assuming quick recovery from a network or system failure, problems are automatically resolved without manual intervention. Thus, problems usually resolve before they can be detected by users or database administrators.</p>
</div>
<!-- class="sect2" --></div>
<!-- class="sect1" -->
<a id="i1008438"></a>
<div id="ADMIN12285" class="sect1">
<h2 class="sect1">Simulating Distributed Transaction Failure</h2>
<p><a id="sthref3871"></a><a id="sthref3872"></a>You can force the failure of a distributed transaction for the following reasons:</p>
<ul>
<li>
<p>To observe RECO automatically resolving the local portion of the transaction</p>
</li>
<li>
<p>To practice manually resolving in-doubt distributed transactions and observing the results</p>
</li>
</ul>
<p>This section describes the features available and the steps necessary to perform such operations.</p>
<div id="ADMIN12286" class="sect2"><!-- infolevel="all" infotype="General" --><a id="sthref3873"></a>
<h3 class="sect2">Forcing a Distributed Transaction to Fail</h3>
<p>You can include comments in the <code dir="ltr">COMMENT</code> parameter of the <code dir="ltr">COMMIT</code> statement. To intentionally induce a failure during the two-phase commit phases of a distributed transaction, include the following comment in the <code dir="ltr">COMMENT</code> parameter:</p>
<pre dir="ltr">
COMMIT COMMENT 'ORA-2PC-CRASH-TEST-<span class="italic">n</span>';
</pre>
<p>where <span class="italic">n</span> is one of the following integers:</p>
<div class="inftblinformal">
<table class="cellalignment1333" title="Effect of setting a value for n." summary="This table lists the possible values of n and their effect." dir="ltr">
<thead>
<tr class="cellalignment1327">
<th class="cellalignment1334" id="r1c1-t19">n</th>
<th class="cellalignment1334" id="r1c2-t19">Effect</th>
</tr>
</thead>
<tbody>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r2c1-t19" headers="r1c1-t19">1</td>
<td class="cellalignment1335" headers="r2c1-t19 r1c2-t19">Crash commit point after collect</td>
</tr>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r3c1-t19" headers="r1c1-t19">2</td>
<td class="cellalignment1335" headers="r3c1-t19 r1c2-t19">Crash non-commit-point site after collect</td>
</tr>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r4c1-t19" headers="r1c1-t19">3</td>
<td class="cellalignment1335" headers="r4c1-t19 r1c2-t19">Crash before prepare (non-commit-point site)</td>
</tr>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r5c1-t19" headers="r1c1-t19">4</td>
<td class="cellalignment1335" headers="r5c1-t19 r1c2-t19">Crash after prepare (non-commit-point site)</td>
</tr>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r6c1-t19" headers="r1c1-t19">5</td>
<td class="cellalignment1335" headers="r6c1-t19 r1c2-t19">Crash commit point site before commit</td>
</tr>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r7c1-t19" headers="r1c1-t19">6</td>
<td class="cellalignment1335" headers="r7c1-t19 r1c2-t19">Crash commit point site after commit</td>
</tr>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r8c1-t19" headers="r1c1-t19">7</td>
<td class="cellalignment1335" headers="r8c1-t19 r1c2-t19">Crash non-commit-point site before commit</td>
</tr>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r9c1-t19" headers="r1c1-t19">8</td>
<td class="cellalignment1335" headers="r9c1-t19 r1c2-t19">Crash non-commit-point site after commit</td>
</tr>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r10c1-t19" headers="r1c1-t19">9</td>
<td class="cellalignment1335" headers="r10c1-t19 r1c2-t19">Crash commit point site before forget</td>
</tr>
<tr class="cellalignment1327">
<td class="cellalignment1335" id="r11c1-t19" headers="r1c1-t19">10</td>
<td class="cellalignment1335" headers="r11c1-t19 r1c2-t19">Crash non-commit-point site before forget</td>
</tr>
</tbody>
</table>
<br /></div>
<!-- class="inftblinformal" -->
<p>For example, the following statement returns the following messages if the local commit point strength is greater than the remote commit point strength and both nodes are updated:</p>
<pre dir="ltr">
COMMIT COMMENT 'ORA-2PC-CRASH-TEST-7';

ORA-02054: transaction 1.93.29 in-doubt
ORA-02059: ORA_CRASH_TEST_7 in commit comment
</pre>
<p>At this point, the in-doubt distributed transaction appears in the <code dir="ltr">DBA_2PC_PENDING</code> view. If enabled, RECO automatically resolves the transaction.</p>
</div>
<!-- class="sect2" -->
<div id="ADMIN12287" class="sect2"><!-- infolevel="all" infotype="General" --><a id="sthref3874"></a>
<h3 class="sect2">Disabling and Enabling RECO</h3>
<p>The RECO background process of an Oracle Database instance automatically resolves failures involving distributed transactions. At exponentially growing time intervals, the RECO background process of a node attempts to recover the local portion of an in-doubt distributed transaction.</p>
<p>RECO can use an existing connection or establish a new connection to other nodes involved in the failed transaction. When a connection is established, RECO automatically resolves all in-doubt transactions. Rows corresponding to any resolved in-doubt transactions are automatically removed from the pending transaction table of each database. <a id="sthref3875"></a><a id="sthref3876"></a><a id="sthref3877"></a></p>
<p>You can enable and disable RECO using the <code dir="ltr">ALTER SYSTEM</code> statement with the <code dir="ltr">ENABLE</code>/<code dir="ltr">DISABLE DISTRIBUTED RECOVERY</code> options. For example, you can temporarily disable RECO to force the failure of a two-phase commit and manually resolve the in-doubt transaction.</p>
<p>The following statement disables RECO:<a id="sthref3878"></a><a id="sthref3879"></a><a id="sthref3880"></a><a id="sthref3881"></a><a id="sthref3882"></a><a id="sthref3883"></a></p>
<pre dir="ltr">
ALTER SYSTEM DISABLE DISTRIBUTED RECOVERY;
</pre>
<p>Alternatively, the following statement enables RECO so that in-doubt transactions are automatically resolved:</p>
<pre dir="ltr">
ALTER SYSTEM ENABLE DISTRIBUTED RECOVERY;
</pre></div>
<!-- class="sect2" --></div>
<!-- class="sect1" -->
<a id="i1008473"></a>
<div id="ADMIN12288" class="sect1">
<h2 class="sect1">Managing Read Consistency</h2>
<p><a id="sthref3884"></a><a id="sthref3885"></a>An important restriction exists in the Oracle Database implementation of distributed read consistency. The problem arises because each system has its own SCN, which you can view as the database internal timestamp. The Oracle Database server uses the SCN to decide which version of data is returned from a query.</p>
<p>The SCNs in a distributed transaction are synchronized at the end of each remote SQL statement and at the start and end of each transaction. Between two nodes that have heavy traffic and especially distributed updates, the synchronization is frequent. Nevertheless, no practical way exists to keep SCNs in a distributed system absolutely synchronized: a window always exists in which one node may have an SCN that is somewhat in the past with respect to the SCN of another node.</p>
<p>Because of the SCN gap, you can execute a query that uses a slightly old snapshot, so that the most recent changes to the remote database are not seen. In accordance with read consistency, a query can therefore retrieve consistent, but out-of-date data. Note that all data retrieved by the query will be from the old SCN, so that if a locally executed update transaction updates two tables at a remote node, then data selected from both tables in the next remote access contain data prior to the update.</p>
<p>One consequence of the SCN gap is that two consecutive <code dir="ltr">SELECT</code> statements can retrieve different data even though no DML has been executed between the two statements. For example, you can issue an update statement and then commit the update on the remote database. When you issue a <code dir="ltr">SELECT</code> statement on a view based on this remote table, the view does not show the update to the row. The next time that you issue the <code dir="ltr">SELECT</code> statement, the update is present.</p>
<p>You can use the following techniques to ensure that the SCNs of the two systems are synchronized just before a query:</p>
<ul>
<li>
<p>Because SCNs are synchronized at the end of a remote query, precede each remote query with a dummy remote query to the same site, for example, <code dir="ltr">SELECT * FROM DUAL@REMOTE</code>.</p>
</li>
<li>
<p>Because SCNs are synchronized at the start of every remote transaction, commit or roll back the current transaction before issuing the remote query.</p>
</li>
</ul>
</div>
<!-- class="sect1" --></div>
<!-- class="chapter" --></div>
<!-- class="ind" -->
<!-- Start Footer -->
</div>
<!-- add extra wrapper close div-->
<footer><!--
<hr />
<table class="cellalignment1326">
<tr>
<td class="cellalignment1335">
<table class="cellalignment1331">
<tr>
<td class="cellalignment1330"><a href="ds_txns.htm"><img width="24" height="24" src="../../dcommon/gifs/leftnav.gif" alt="Go to previous page" /><br />
<span class="icon">Previous</span></a></td>
<td class="cellalignment1330"><a href="part8.htm"><img width="24" height="24" src="../../dcommon/gifs/rightnav.gif" alt="Go to next page" /><br />
<span class="icon">Next</span></a></td>
</tr>
</table>
</td>
<td class="cellalignment-copyrightlogo"><img width="144" height="18" src="../../dcommon/gifs/oracle.gif" alt="Oracle" /><br />
Copyright&nbsp;&copy;&nbsp;2001, 2015,&nbsp;Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved.<br />
<a href="../../dcommon/html/cpyr.htm">Legal Notices</a></td>
<td class="cellalignment1337">
<table class="cellalignment1329">
<tr>
<td class="cellalignment1330"><a href="../../index.htm"><img width="24" height="24" src="../../dcommon/gifs/doclib.gif" alt="Go to Documentation Home" /><br />
<span class="icon">Home</span></a></td>
<td class="cellalignment1330"><a href="../../nav/portal_booklist.htm"><img width="24" height="24" src="../../dcommon/gifs/booklist.gif" alt="Go to Book List" /><br />
<span class="icon">Book List</span></a></td>
<td class="cellalignment1330"><a href="toc.htm"><img width="24" height="24" src="../../dcommon/gifs/toc.gif" alt="Go to Table of Contents" /><br />
<span class="icon">Contents</span></a></td>
<td class="cellalignment1330"><a href="index.htm"><img width="24" height="24" src="../../dcommon/gifs/index.gif" alt="Go to Index" /><br />
<span class="icon">Index</span></a></td>
<td class="cellalignment1330"><a href="../../nav/mindx.htm"><img width="24" height="24" src="../../dcommon/gifs/masterix.gif" alt="Go to Master Index" /><br />
<span class="icon">Master Index</span></a></td>
<td class="cellalignment1330"><a href="../../dcommon/html/feedback.htm"><img width="24" height="24" src="../../dcommon/gifs/feedbck2.gif" alt="Go to Feedback page" /><br />
<span class="icon">Contact Us</span></a></td>
</tr>
</table>
</td>
</tr>
</table>
--></footer>
<noscript>
<p>Scripting on this page enhances content navigation, but does not change the content in any way.</p>
</noscript>
</body>
</html>
