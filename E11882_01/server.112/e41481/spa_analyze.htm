<!DOCTYPE html>
<html lang="en" >
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta charset="utf-8">
<title>Comparing SQL Trials</title>
<meta name="generator" content="Oracle DARB XHTML Converter (Mode = document) - Version 5.1.2 Build 740" />
<meta name="dcterms.created" content="2014-06-16T16:24:48Z" />
<meta name="robots" content="all" />
<meta name="dcterms.title" content="Database Real Application Testing User's Guide" />
<meta name="dcterms.identifier" content="E41481-03" />
<meta name="dcterms.isVersionOf" content="RATUG" />
<meta name="dcterms.rights" content="Copyright&nbsp;&copy;&nbsp;2008, 2014,&nbsp;Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved." />
<link rel="Start" href="../../index.htm" title="Home" type="text/html" />
<link rel="Copyright" href="../../dcommon/html/cpyr.htm" title="Copyright" type="text/html" />

<script type="application/javascript"  src="../../dcommon/js/headfoot.js"></script>
<script type="application/javascript"  src="../../nav/js/doccd.js"></script>
<link rel="Contents" href="toc.htm" title="Contents" type="text/html" />
<link rel="Index" href="index.htm" title="Index" type="text/html" />
<link rel="Prev" href="spa_post_change.htm" title="Previous" type="text/html" />
<link rel="Next" href="spa_upgrade.htm" title="Next" type="text/html" />
<link rel="alternate" href="../e41481.pdf" title="PDF version" type="application/pdf" />
<link rel="schema.dcterms" href="http://purl.org/dc/terms/" />
<link rel="stylesheet" href="../../dcommon/css/fusiondoc.css">
<link rel="stylesheet" type="text/css"  href="../../dcommon/css/header.css">
<link rel="stylesheet" type="text/css"  href="../../dcommon/css/footer.css">
<link rel="stylesheet" type="text/css"  href="../../dcommon/css/fonts.css">
<link rel="stylesheet" href="../../dcommon/css/foundation.css">
<link rel="stylesheet" href="../../dcommon/css/codemirror.css">
<link rel="stylesheet" type="text/css" title="Default" href="../../nav/css/html5.css">
<link rel="stylesheet" href="../../dcommon/css/respond-480-tablet.css">
<link rel="stylesheet" href="../../dcommon/css/respond-768-laptop.css">
<link rel="stylesheet" href="../../dcommon/css/respond-1140-deskop.css">
<script type="application/javascript" src="../../dcommon/js/modernizr.js"></script>
<script type="application/javascript" src="../../dcommon/js/codemirror.js"></script>
<script type="application/javascript" src="../../dcommon/js/jquery.js"></script>
<script type="application/javascript" src="../../dcommon/js/foundation.min.js"></script>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-552992c80ef99c8d" async="async"></script>
<script type="application/javascript" src="../../dcommon/js/jqfns.js"></script>
<script type="application/javascript" src="../../dcommon/js/ohc-inline-videos.js"></script>
<!-- Add fancyBox -->
<link rel="stylesheet" href="../../dcommon/fancybox/jquery.fancybox.css?v=2.1.5" type="text/css" media="screen" />
<script type="text/javascript" src="../../dcommon/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>
<!-- Optionally add helpers - button, thumbnail and/or media -->
<link rel="stylesheet"  href="../../dcommon/fancybox/helpers/jquery.fancybox-buttons.css?v=1.0.5"  type="text/css" media="screen" />
<script type="text/javascript" src="../../dcommon/fancybox/helpers/jquery.fancybox-buttons.js?v=1.0.5"></script>
<script type="text/javascript" src="../../dcommon/fancybox/helpers/jquery.fancybox-media.js?v=1.0.6"></script>
<link rel="stylesheet"  href="../../dcommon/fancybox/helpers/jquery.fancybox-thumbs.css?v=1.0.7"  type="text/css" media="screen" />
<script type="text/javascript" src="../../dcommon/fancybox/helpers/jquery.fancybox-thumbs.js?v=1.0.7"></script>
</head>
<body>
<a href="#BEGIN" class="accessibility-top skipto" tabindex="0">Go to main content</a><header><!--
<div class="zz-skip-header"><a id="top" href="#BEGIN">Go to main content</a>--></header>
<div class="row" id="CONTENT">
<div class="IND large-9 medium-8 columns" dir="ltr">
<a id="BEGIN" name="BEGIN"></a>
<span id="PAGE" style="display:none;">10/23</span> <!-- End Header -->
<div id="RATUG186" class="chapter"><a id="CACCDGAG"></a>
<h1 class="chapter"><span class="secnum">6</span> Comparing SQL Trials</h1>
<p>After the post-change SQL performance data is built, you can <a id="sthref60"></a>compare the performance data collected in the pre-change SQL trial to the post-change SQL trial by running a comparison analysis using SQL Performance Analyzer. After the comparison analysis is completed, you can generate a report to identify the SQL statements that have improved, remained unchanged, or regressed due to the system change. The SQL Performance Analyzer report calculates two chief impact measurements for the change in performance of each SQL statement:</p>
<ul>
<li>
<p>Impact on workload</p>
<p>This represents the percentage of impact that this change to the SQL statement has on the cumulative execution time of the workload, after accounting for execution frequency. For example, a change that causes a SQL statement's cumulative execution time to improve from 101 seconds to 1 second&mdash;where the rest of the workload had a total execution time of 99 seconds before the change&mdash;would have a 50% (2x) value for this measurement.</p>
</li>
<li>
<p>Impact on SQL</p>
<p>This represents the percentage of impact that this change to the SQL statement has on the SQL statement's response time. For example, a change that causes a SQL statement's response time to improve from 10 seconds to 1 second will have a 90% (10x) value for this measurement.</p>
</li>
</ul>
<p>For more information, see <a href="spa_intro.htm#CHDFFEBH">"Comparing Performance Measurements"</a>.</p>
<p>This chapter describes how to compare and analyze the performance data from the pre-change and post-change SQL trials and contains the following topics:</p>
<ul>
<li>
<p><a href="#CACFGHBH">Comparing SQL Trials Using Oracle Enterprise Manager</a></p>
</li>
<li>
<p><a href="#CACEJGGD">Comparing SQL Trials Using APIs</a></p>
</li>
</ul>
<div class="infobox-note">
<p class="notep1">Note:</p>
The primary interface for comparing SQL trials is Oracle Enterprise Manager. If for some reason Oracle Enterprise Manager is unavailable, you can compare SQL trials using the <code>DBMS_SQLPA</code> PL/SQL package.</div>
<div class="infoboxnotealso">
<p class="notep1">Tip:</p>
Before comparing SQL trials, you need to create a post-change SQL trial, as described in <a href="spa_post_change.htm#CDEFIJBB">Chapter 5, "Creating a Post-Change SQL Trial"</a>.</div>
<a id="CACFGHBH"></a>
<div id="RATUG187" class="sect1"><!-- infolevel="all" infotype="General" -->
<h2 class="sect1"><span class="secnum">6.1</span> Comparing SQL Trials Using Oracle Enterprise Manager</h2>
<p>Comparing <a id="sthref61"></a>SQL trials using Oracle Enterprise Manager involves the following steps:</p>
<ul>
<li>
<p><a href="#CACGCAID">Analyzing SQL Performance Using Oracle Enterprise Manager</a></p>
</li>
<li>
<p><a href="#CACHAFHE">Reviewing the SQL Performance Analyzer Report Using Oracle Enterprise Manager</a></p>
</li>
<li>
<p><a href="#CACHBCGE">Tuning Regressed SQL Statements Using Oracle Enterprise Manager</a></p>
</li>
</ul>
<a id="CACGCAID"></a>
<div id="RATUG188" class="sect2"><!-- infolevel="all" infotype="General" -->
<h3 class="sect2"><span class="secnum">6.1.1</span> Analyzing SQL Performance Using Oracle Enterprise Manager</h3>
<p>This section describes how to analyze SQL performance before and after the system change using Oracle Enterprise Manager.</p>
<p class="subhead2"><a id="RATUG279"></a>To analyze SQL performance using Enterprise Manager:</p>
<ol>
<li>
<p>On the Guided Workflow page, click the <span class="bold">Execute</span> icon for Compare Step 2 and Step 3.</p>
<p>The Run SQL Trial Comparison page appears.</p>
<img width="762" height="481" src="img/spa_run_trial_compare.gif" alt="Description of spa_run_trial_compare.gif follows" /><br />
<a id="sthref62" href="img_text/spa_run_trial_compare.htm">Description of the illustration spa_run_trial_compare.gif</a><br />
<br />
<p>In this example, the <code>SQL_TRIAL_1241213421833</code> and <code>SQL_TRIAL_1241213881923</code> trials are selected for comparison.</p>
</li>
<li>
<p>To compare trials other than those listed by default, select the desired trials in the <span class="bold">Trial 1 Name</span> and <span class="bold">Trial 2 Name</span> lists.</p>
<p>Note that you cannot compare a statistical trial with a trial that tests the explain plan only.</p>
</li>
<li>
<p>In the Comparison Metric list, select the comparison metric to use for the comparison analysis:</p>
<ul>
<li>
<p><span class="bold">Elapsed Time</span></p>
</li>
<li>
<p><span class="bold">CPU Time</span></p>
</li>
<li>
<p><span class="bold">User I/O Time</span></p>
</li>
<li>
<p><span class="bold">Buffer Gets</span></p>
</li>
<li>
<p><span class="bold">Physical I/O</span></p>
</li>
<li>
<p><span class="bold">Optimizer Cost</span></p>
</li>
<li>
<p><span class="bold">I/O Interconnect Bytes</span></p>
</li>
</ul>
<p>Optimizer Cost is the only comparison metric available if you generated execution plans only in the SQL trials.</p>
<p>To perform the comparison analysis by using more than one comparison metric, perform separate comparison analyses by repeating this procedure with different metrics.</p>
</li>
<li>
<p>In the Schedule section:</p>
<ol>
<li>
<p>In the Time Zone list, select your time zone code.</p>
</li>
<li>
<p>Select <span class="bold">Immediately</span> to start the task now, or <span class="bold">Later</span> to schedule the task to start at a time specified using the Date and Time fields.</p>
</li>
</ol>
</li>
<li>
<p>Click <span class="bold">Submit</span>.</p>
<p>The Guided Workflow page appears when the comparison analysis begins.</p>
<p>The status icon of this step changes to an arrow icon while the comparison analysis is in progress. To refresh the status icon, click <span class="bold">Refresh</span>. Depending on the amount of performance data collected from the pre-change and post-change executions, the comparison analysis may take a long time to complete. After the comparison analysis is completed, the Status icon changes to a check mark and the Execute icon for the next step is enabled.</p>
</li>
<li>
<p>Once SQL Performance Analyzer has analyzed the pre-change and post-change performance data, generate a SQL Performance Analyzer report that you can use for further analysis.</p>
<p>On the Guided Workflow page, click the <span class="bold">Execute</span> icon for View Trial Comparison Report.</p>
<p>The SQL Performance Analyzer Task Report page appears. Review the report, as described in <a href="#CACHAFHE">"Reviewing the SQL Performance Analyzer Report Using Oracle Enterprise Manager"</a>.</p>
</li>
</ol>
</div>
<!-- class="sect2" -->
<a id="CACHAFHE"></a>
<div id="RATUG189" class="sect2"><!-- infolevel="all" infotype="General" -->
<h3 class="sect2"><span class="secnum">6.1.2</span> Reviewing the SQL Performance Analyzer Report Using Oracle Enterprise Manager</h3>
<p>When a SQL Performance Analyzer task is completed, the resulting data is generated into a SQL Performance Analyzer report that compares the pre-change and post-change SQL performance.</p>
<p><a href="#CACCEHEA">Figure 6-1</a> shows a sample <a id="sthref63"></a>SQL Performance Analyzer report. This sample report uses the elapsed time comparison metric to compare the pre-change and post-change executions of a SQL workload.</p>
<div id="RATUG241" class="figure">
<p class="titleinfigure"><a id="CACCEHEA"></a>Figure 6-1 SQL Performance Analyzer Report</p>
<img width="995" height="690" src="img/spa_report.gif" alt="Description of Figure 6-1 follows" /><br />
<a id="sthref64" href="img_text/spa_report.htm">Description of "Figure 6-1 SQL Performance Analyzer Report"</a><br />
<br /></div>
<!-- class="figure" -->
<div class="infoboxnotealso">
<p class="notep1">Tip:</p>
Before you can view the SQL Performance Analyzer report, compare the pre-change version of performance data with the post-change version, as described in <a href="#CACFGHBH">"Comparing SQL Trials Using Oracle Enterprise Manager"</a></div>
<p class="subhead2"><a id="RATUG280"></a>To generate and review the SQL Performance Analyzer report:</p>
<ol>
<li>
<p>On the Software and Support page, under Real Application Testing, click <span class="bold">SQL Performance Analyzer</span>.</p>
<p>The SQL Performance Analyzer page appears. A list of existing SQL Performance Analyzer tasks are displayed.</p>
</li>
<li>
<p>Under SQL Performance Analyzer Tasks, select the task for which you want to view a SQL Performance Analyzer report and click <span class="bold">View Latest Report</span>.</p>
<p>The SQL Performance Analyzer Task Report page appears.</p>
</li>
<li>
<p>Review the general information about the performance analysis, as described in <a href="#CACHHHEE">"Reviewing the SQL Performance Analyzer Report: General Information"</a>.</p>
</li>
<li>
<p>Review general statistics, as described in <a href="#CACIAHBF">"Reviewing the SQL Performance Analyzer Report: Global Statistics"</a>.</p>
</li>
<li>
<p>Optionally, review the detailed statistics, as described in <a href="#CACJHJBB">"Reviewing the SQL Performance Analyzer Report: Global Statistics Details"</a>.</p>
</li>
<li>
<p>To generate an active report, click <span class="bold">Save</span> to generate and save the report, or <span class="bold">Mail</span> to generate and mail the report as an HTML attachment.</p>
<p>Active reports include information about the top SQL statements from each category (such as improved, regressed, and changed plans) with pre-change and post-change statistics, explain plans, and task summary.</p>
<p>For more information, see <a href="#BABHBFHC">"About SQL Performance Analyzer Active Reports"</a>.</p>
</li>
</ol>
<a id="CACHHHEE"></a>
<div id="RATUG190" class="sect3"><!-- infolevel="all" infotype="General" -->
<h4 class="sect3"><span class="secnum">6.1.2.1</span> Reviewing the SQL Performance Analyzer Report: General Information</h4>
<p>The <a id="sthref65"></a>General Information section contains basic information and metadata about the workload comparison performed by SQL Performance Analyzer.</p>
<p class="subhead2"><a id="RATUG281"></a>To review general information:</p>
<ol>
<li>
<p>On the SQL Performance Analyzer Task Report page, review the summary at the top of the page.</p>
<img width="601" height="114" src="img/spa_report_info.gif" alt="Description of spa_report_info.gif follows" /><br />
<a id="sthref66" href="img_text/spa_report_info.htm">Description of the illustration spa_report_info.gif</a><br />
<br />
<p>This summary includes the following information:</p>
<ul>
<li>
<p>The name and owner of the SQL tuning set</p>
</li>
<li>
<p>The total number of SQL statements in the tuning set and the number of SQL statements that had errors, are unsupported, or timed out</p>
</li>
<li>
<p>The names of the SQL trials and the comparison metric used</p>
</li>
</ul>
</li>
<li>
<p>Optionally, click the link next to SQL Tuning Set Name.</p>
<p>The SQL Tuning Set page appears.</p>
<p>This page contains information&mdash;such as SQL ID and SQL text&mdash;about every SQL statement in the SQL tuning set.</p>
</li>
<li>
<p>Click the link next to SQL Statements With Errors if errors were found.</p>
<p>The Errors table reports all errors that occurred while executing a given SQL workload. An error may be reported at the SQL tuning set level if it is common to all SQL executions in the SQL tuning set, or at the execution level if it is specific to a SQL statement or execution plan.</p>
</li>
<li>
<p>Review the global statistics, as described in <a href="#CACIAHBF">"Reviewing the SQL Performance Analyzer Report: Global Statistics"</a>.</p>
</li>
</ol>
</div>
<!-- class="sect3" -->
<a id="CACIAHBF"></a>
<div id="RATUG191" class="sect3"><!-- infolevel="all" infotype="General" -->
<h4 class="sect3"><span class="secnum">6.1.2.2</span> Reviewing the SQL Performance Analyzer Report: Global Statistics</h4>
<p>The <a id="sthref67"></a>Global Statistics section reports statistics that describe the overall performance of the entire SQL workload. This section is a very important part of the SQL Performance Analyzer analysis, because it reports on the impact of the system change on the overall performance of the SQL workload. Use the information in this section to understand the tendency of the workload performance, and determine how it will be affected by the system change.</p>
<p class="subhead2"><a id="RATUG282"></a>To review global statistics:</p>
<ol>
<li>
<p>Review the chart in the Projected Workload Elapsed Time subsection.</p>
<div class="infobox-note">
<p class="notep1">Note:</p>
The name of the subsection may vary based on the comparison metric that is selected.</div>
<p>The chart shows the two trials on the x-axis and the elapsed time (in seconds) on the y-axis.</p>
<img width="293" height="235" src="img/spa_report_elapsed_time.gif" alt="Description of spa_report_elapsed_time.gif follows" /><br />
<a id="sthref68" href="img_text/spa_report_elapsed_time.htm">Description of the illustration spa_report_elapsed_time.gif</a><br />
<br />
<p>The first bar (on the left) in the chart represents the cumulative elapsed time for all SQL statements before the system change, weighed by the execution frequency of each SQL statement. The second bar (on the right) represents the cumulative elapsed time for all SQL statements after the system change, weighed by the execution frequency of each SQL statement. The overall impact is the difference between the improvement impact and the regression impact and is given as a percentage.</p>
<p>You can click the link for any impact statistic to obtain more details, as described in <a href="#CACJHJBB">"Reviewing the SQL Performance Analyzer Report: Global Statistics Details"</a>.</p>
<div class="infobox-note">
<p class="notep1">Note:</p>
The overall impact percentage may sometimes be off by 1% compared to the sum of the improvement impact and the regression impact. This discrepancy may be caused by rounding or if the SQL and workload time limits are set at 1%, which is the recommended value. This enables the analysis to focus on SQL statements with higher impact by filtering out those that have a minimal impact.</div>
</li>
<li>
<p>Review the chart in the SQL Statement Count subsection.</p>
<p>The x-axis of the chart shows the number of SQL statements whose performance improved, regressed, or remain unchanged after the system change. The y-axis shows the number of SQL statements. The chart also indicates whether the explain plans changed for the SQL statements.</p>
<img width="383" height="168" src="img/spa_report_sql_count.gif" alt="Description of spa_report_sql_count.gif follows" /><br />
<a id="sthref69" href="img_text/spa_report_sql_count.htm">Description of the illustration spa_report_sql_count.gif</a><br />
<br />
<p>This chart enables you to quickly weigh the relative performance of the SQL statements. You can click any bar in the chart to obtain more details about the SQL statements, as described in <a href="#CACJHJBB">"Reviewing the SQL Performance Analyzer Report: Global Statistics Details"</a>. Only up to the top 100 SQL statements will be displayed, even if the actual number of SQL statements exceeds 100.</p>
</li>
</ol>
</div>
<!-- class="sect3" -->
<a id="CACJHJBB"></a>
<div id="RATUG192" class="sect3"><!-- infolevel="all" infotype="General" -->
<h4 class="sect3"><span class="secnum">6.1.2.3</span> Reviewing the SQL Performance Analyzer Report: Global Statistics Details</h4>
<p>You can use the SQL Performance Analyzer Report to obtain detailed statistics for the SQL workload comparison. The <a id="sthref70"></a>details chart enables you to drill down into the performance of SQL statements that appears in the report. Use the information in this section to investigate why the performance of a particular SQL statement regressed.</p>
<div class="infobox-note">
<p class="notep1">Note:</p>
The report displays only up to the top 100 SQL statements, even if the actual number of SQL statements exceeds 100.</div>
<p class="subhead2"><a id="RATUG283"></a>To review global statistics details:</p>
<ol>
<li>
<p>In the Projected Workload Elapsed Time subsection, click the impact percentage of the SQL statements for which you want to view details. To view SQL statements whose performance:</p>
<ul>
<li>
<p>Improved, click the percentage for Improvement Impact</p>
</li>
<li>
<p>Regressed, click the percentage for Regression Impact</p>
</li>
<li>
<p>Improved or regressed, click the percentage for Overall Impact</p>
</li>
</ul>
<p>A table including the detailed statistics appears. Depending on the type of SQL statements chosen, the following columns are included:</p>
<ul>
<li>
<p>SQL ID</p>
<p>This column indicates the ID of the SQL statement.</p>
</li>
<li>
<p>Net Impact on Workload (%)</p>
<p>This column indicates the impact of the system change relative to the performance of the SQL workload.</p>
</li>
<li>
<p>Elapsed Time</p>
<p>This column indicates the total time (in seconds) of the SQL statement execution.</p>
</li>
<li>
<p>Net Impact on SQL (%)</p>
<p>This column indicates the local impact of the change on the performance of a particular SQL statement.</p>
</li>
<li>
<p>New Plan</p>
<p>This column indicates whether the SQL execution plan changed.</p>
</li>
</ul>
</li>
<li>
<p>To view details about a particular SQL statement, click the SQL ID link for the SQL statement that you are interested in.</p>
<p>The SQL Details page appears.</p>
<p>You can use this page to access the SQL text and obtain low-level details about the SQL statement, such as its execution statistics and execution plan.</p>
</li>
</ol>
</div>
<!-- class="sect3" -->
<a id="BABHBFHC"></a>
<div id="RATUG321" class="sect3">
<h4 class="sect3"><span class="secnum">6.1.2.4</span> About SQL Performance Analyzer Active Reports</h4>
<p><a id="sthref71"></a>SQL Performance Analyzer active reports are HTML files that display all reporting data using a Web-hosted interactive user interface. Similar to the SQL Performance Analyzer reports available in Oracle Enterprise Manager, active reports include information about the top SQL statements from each category (such as improved, regressed, and changed plans) with pre-change and post-change statistics, explain plans, and task summary.</p>
<p>SQL Performance Analyzer active reports are more useful than traditional HTML or text reports because they offer a similar user interface as Oracle Enterprise Manager, yet they can be viewed even when the database is unavailable, or even after a database is dropped. Hence active reports offer the advantages of traditional reporting and dynamic Oracle Enterprise Manager analysis, but eliminates the disadvantages of both. Moreover, active reports contain more information about the comparison analysis and provide more user interactive options. It is strongly recommended that you use active reports instead of HTML or text reports.</p>
<p>The active report user interface components are very similar to those displayed in Oracle Enterprise Manager. For descriptions of the user interface components, see the related sections described in <a href="#CACHAFHE">"Reviewing the SQL Performance Analyzer Report Using Oracle Enterprise Manager"</a>.</p>
</div>
<!-- class="sect3" --></div>
<!-- class="sect2" -->
<a id="CACHBCGE"></a>
<div id="RATUG193" class="sect2"><!-- infolevel="all" infotype="General" -->
<h3 class="sect2"><span class="secnum">6.1.3</span> Tuning Regressed SQL Statements Using Oracle Enterprise Manager</h3>
<p>After reviewing the SQL Performance Analyzer report, you should tune any <a id="sthref72"></a>regressed SQL statements that are identified after comparing the SQL performance. If there are large numbers of SQL statements that appear to have regressed, you should try to identify the root cause and make system-level changes to rectify the problem. In cases when only a few SQL statements have regressed, consider using one of the following tuning methods to implement a point solution for them:</p>
<ul>
<li>
<p><a href="#CACJCAIF">Creating SQL Plan Baselines</a></p>
</li>
<li>
<p><a href="#CACEGEBI">Running SQL Tuning Advisor</a></p>
</li>
</ul>
<p>After tuning the regressed SQL statements, you should test these changes using SQL Performance Analyzer. Run a new SQL trial on the test system, followed by a second comparison (between this new SQL trial and the first SQL trial) to validate your results. Once SQL Performance Analyzer shows that performance has stabilized, the testing is complete. Implement the fixes from this step to your production system.</p>
<p>Starting with Oracle Database 11<span class="italic">g</span> Release 1, SQL Tuning Advisor performs an alternative plan analysis when tuning a SQL statement. SQL Tuning Advisor searches the current system for previous execution plans, including the plans from the first SQL trial. If the execution plans from the first SQL trial differ from those of the second SQL trial, SQL Tuning Advisor will recommend the plans from the first SQL trial. If these execution plans produce better performance, you can create plan baselines using the plans from the first SQL trial.</p>
<div class="infobox-note">
<p class="notep1">Note:</p>
SQL Performance Analyzer does not provide the option to create SQL plan baselines or run SQL Tuning Advisor directly after after completing a remote SQL trial. In such cases, you need to use APIs to manually transport the SQL tuning set and complete the appropriate procedure on the remote database.</div>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<ul>
<li>
<p><a class="olink PFGRF95155" href="../../server.112/e41573/sql_tune.htm#PFGRF95155"><span class="italic">Oracle Database Performance Tuning Guide</span></a> for information about alternative plan analysis</p>
</li>
</ul>
</div>
<a id="CACJCAIF"></a>
<div id="RATUG194" class="sect3"><!-- infolevel="all" infotype="General" -->
<h4 class="sect3"><span class="secnum">6.1.3.1</span> Creating SQL Plan Baselines</h4>
<p>Creating SQL plan baselines enables the optimizer to avoid performance regressions by using execution plans with known performance characteristics. If a performance regression occurs due to plan changes, a SQL plan baseline can be created and used to prevent the optimizer from picking a new, regressed execution plan.</p>
<p class="subhead2"><a id="RATUG284"></a>To create SQL plan baselines:</p>
<ol>
<li>
<p>On the SQL Performance Analyzer Task Result page, under Recommendations, click <span class="bold">Create SQL Plan Baselines</span>.</p>
<p>The Create SQL Plan Baselines page appears. The Regressed SQL Statements section lists the regressed SQL statements that will be associated with the new SQL plan baselines.</p>
</li>
<li>
<p>Under Job Parameters, specify the parameters for the job:</p>
<ol>
<li>
<p>In the Job Name field, enter a name for the job.</p>
</li>
<li>
<p>In the Description field, optionally enter a description for the job.</p>
</li>
</ol>
</li>
<li>
<p>Under Schedule, select:</p>
<ul>
<li>
<p><span class="bold">Immediately</span> to start the job now.</p>
</li>
<li>
<p><span class="bold">Later</span> to schedule the job to start at a time specified using the Time Zone, Date, and Time fields.</p>
</li>
</ul>
</li>
<li>
<p>Click <span class="bold">OK</span>.</p>
<p>The SQL Performance Analyzer Task Result page appears. A message is displayed to inform you that the job has been submitted successfully.</p>
</li>
</ol>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<ul>
<li>
<p><a class="olink TDPPT335" href="../../server.112/e10822/tdppt_sqltune.htm#TDPPT335"><span class="italic">Oracle Database 2 Day + Performance Tuning Guide</span></a> for information about creating and managing SQL plan baselines</p>
</li>
</ul>
</div>
</div>
<!-- class="sect3" -->
<a id="CACEGEBI"></a>
<div id="RATUG195" class="sect3"><!-- infolevel="all" infotype="General" -->
<h4 class="sect3"><span class="secnum">6.1.3.2</span> Running SQL Tuning Advisor</h4>
<p>The SQL Tuning Advisor performs an in-depth analysis of regressed SQL statements and attempts to fix the root cause of the problem.</p>
<p class="subhead2"><a id="RATUG285"></a>To run SQL Tuning Advisor:</p>
<ol>
<li>
<p>On the SQL Performance Analyzer Task Result page, under Recommendations, click <span class="bold">Run SQL Tuning Advisor</span>.</p>
<p>The Schedule SQL Tuning Task page appears.</p>
</li>
<li>
<p>In the Tuning Task Name field, enter a name for the SQL tuning task.</p>
</li>
<li>
<p>In the Tuning Task Description field, optionally enter a name for the SQL tuning task.</p>
</li>
<li>
<p>Under Schedule, select:</p>
<ul>
<li>
<p><span class="bold">Immediately</span> to start the job now.</p>
</li>
<li>
<p><span class="bold">Later</span> to schedule the job to start at a time specified using the Time Zone, Date, and Time fields.</p>
</li>
</ul>
</li>
<li>
<p>Click <span class="bold">OK</span>.</p>
<p>The SQL Performance Analyzer Task Result page appears. A link to the SQL tuning report appears under Recommendations.</p>
</li>
<li>
<p>To view the SQL tuning report, click the SQL Tune Report link.</p>
<p>The SQL Tuning Results page appears.</p>
</li>
</ol>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<ul>
<li>
<p><a class="olink TDPPT161" href="../../server.112/e10822/tdppt_sqltune.htm#TDPPT161"><span class="italic">Oracle Database 2 Day + Performance Tuning Guide</span></a> for information about running the SQL Tuning Advisor</p>
</li>
</ul>
</div>
</div>
<!-- class="sect3" --></div>
<!-- class="sect2" --></div>
<!-- class="sect1" -->
<a id="CACEJGGD"></a>
<div id="RATUG196" class="sect1"><!-- infolevel="all" infotype="General" -->
<h2 class="sect1"><span class="secnum">6.2</span> Comparing SQL Trials Using APIs</h2>
<p>Comparing SQL trials using APIs involves the following steps:</p>
<ul>
<li>
<p><a href="#CACHAJID">Analyzing SQL Performance Using APIs</a></p>
</li>
<li>
<p><a href="#CACFEBHH">Reviewing the SQL Performance Analyzer Report Using APIs</a></p>
</li>
<li>
<p><a href="#CHDFHHGE">Comparing SQL Tuning Sets Using APIs</a></p>
</li>
<li>
<p><a href="#CACDFCBJ">Tuning Regressed SQL Statements Using APIs</a></p>
</li>
<li>
<p><a href="#CHDHGFEH">Tuning Regressed SQL Statements From a Remote SQL Trial Using APIs</a></p>
</li>
<li>
<p><a href="#CHDBFJIE">Creating SQL Plan Baselines Using APIs</a></p>
</li>
<li>
<p><a href="#CACHDBCH">Using SQL Performance Analyzer Views</a></p>
</li>
</ul>
<a id="CACHAJID"></a>
<div id="RATUG197" class="sect2"><!-- infolevel="all" infotype="General" -->
<h3 class="sect2"><span class="secnum">6.2.1</span> Analyzing SQL Performance Using APIs</h3>
<p>After the post-change SQL performance data is built, you can <a id="sthref73"></a>compare the pre-change version of performance data to the post-change version. Run a comparison analysis using the <code>DBMS_SQLPA.EXECUTE_ANALYSIS_TASK</code> procedure or function.</p>
<p>To compare the pre-change and post-change SQL performance data:</p>
<ol>
<li>
<p>Call the <a id="sthref74"></a><code>EXECUTE_ANALYSIS_TASK</code> procedure or function using the following parameters:</p>
<ul>
<li>
<p>Set the <code>task_name</code> parameter to the name of the SQL Performance Analyzer task.</p>
</li>
<li>
<p>Set the <code>execution_type</code> parameter to <code>COMPARE PERFORMANCE</code>. This setting will analyze and compare two versions of SQL performance data.</p>
</li>
<li>
<p>Specify a name to identify the execution using the <code>execution_name</code> parameter. If not specified, it will be generated by SQL Performance Analyzer and returned by the function.</p>
</li>
<li>
<p>Specify two versions of SQL performance data using the <code>execution_params</code> parameters. The <code>execution_params</code> parameters are specified as (<span class="italic">name</span>, <span class="italic">value</span>) pairs for the specified execution. Set the execution parameters that are related to comparing and analyzing SQL performance data as follows:</p>
<ul>
<li>
<p>Set the <code>execution_name1</code> parameter to the name of the first execution (before the system change was made). This value should correspond to the value of the <code>execution_name</code> parameter specified in <a href="spa_pre_change.htm#CACCIHDA">"Creating a Pre-Change SQL Trial Using APIs"</a>.</p>
</li>
<li>
<p>Set the <code>execution_name2</code> parameter to the name of the second execution (after the system change was made). This value should correspond to the value of the <code>execution_name</code> parameter specified in <a href="spa_post_change.htm#CHDFHGBA">"Creating a Post-Change SQL Trial Using APIs"</a> when you executed the SQL workload after the system change. If the caller does not specify the executions, then by default SQL Performance Analyzer will always compare the last two task executions.</p>
</li>
<li>
<p>Set the <code>comparison_metric</code> parameter to specify an expression of execution statistics to use in the performance impact analysis. Possible values include the following metrics or any combination of them: <code>elapsed_time</code> (default), <code>cpu_time</code>, <code>buffer_gets</code>, <code>disk_reads</code>, <code>direct_writes</code>, <code>optimizer_cost</code>, and <code>io_interconnect_bytes</code>.</p>
</li>
</ul>
<p>For other possible parameters that you can set for comparison, see the description of the <code>DBMS_SQLPA</code> package in <a class="olink ARPLS229" href="../../appdev.112/e40758/d_sqlpa.htm#ARPLS229"><span class="italic">Oracle Database PL/SQL Packages and Types Reference</span></a>.</p>
</li>
</ul>
<p>The following example illustrates a function call:</p>
<pre>
EXEC DBMS_SQLPA.EXECUTE_ANALYSIS_TASK(task_name =&gt; 'my_spa_task', - 
       execution_type =&gt; 'COMPARE PERFORMANCE', -
       execution_name =&gt; 'my_exec_compare', -
       execution_params =&gt; dbms_advisor.arglist(-
                             'comparison_metric', 'buffer_gets'));
</pre></li>
<li>
<p>Call the <a id="sthref75"></a><code>REPORT_ANALYSIS_TASK</code> function using the following parameters:</p>
<ul>
<li>
<p>Set the <code>task_name</code> parameter to the name of the SQL Performance Analyzer task.</p>
</li>
<li>
<p>Set the <code>execution_name</code> parameter to the name of the execution to use. This value should match the <code>execution_name</code> parameter of the execution for which you want to generate a report.</p>
<p>To generate a report to display the results of:</p>
<ul>
<li>
<p>Execution plans generated for the SQL workload, set this value to match the <code>execution_name</code> parameter of the desired <code>EXPLAIN PLAN</code> execution.</p>
</li>
<li>
<p>Execution plans and execution statistics generated for the SQL workload, set this parameter to match the value of the <code>execution_name</code> parameter used in the desired <code>TEST EXECUTE</code> execution.</p>
</li>
<li>
<p>A comparison analysis, set this value to match the <code>execution_name</code> parameter of the desired <code>ANALYZE PERFORMANCE</code> execution.</p>
</li>
</ul>
<p>If unspecified, SQL Performance Analyzer generates a report for the last execution.</p>
</li>
<li>
<p>Set the <code>type</code> parameter to specify the type of report to generate. Possible values include <code>TEXT</code> (default), <code>HTML</code>, <code>XML</code>, and <code>ACTIVE</code>.</p>
<p>Active reports provides in-depth reporting using an interactive user interface that enables you to perform detailed analysis even when disconnected from the database or Oracle Enterprise Manager. It is recommended that you use active reports instead of HTML or text reports when possible.</p>
<p>For information about active reports, see <a href="#BABHBFHC">"About SQL Performance Analyzer Active Reports"</a>.</p>
</li>
<li>
<p>Set the <code>level</code> parameter to specify the format of the recommendations. Possible values include <code>TYPICAL</code> (default), <code>ALL</code>, <code>BASIC</code>, <code>CHANGED</code>, <code>CHANGED_PLANS</code>, <code>ERRORS</code>, <code>IMPROVED</code>, <code>REGRESSED</code>, <code>TIMEOUT</code>, <code>UNCHANGED</code>, <code>UNCHANGED_PLANS</code>, and <code>UNSUPPORTED</code>.</p>
</li>
<li>
<p>Set the <code>section</code> parameter to specify a particular section to generate in the report. Possible values include <code>SUMMARY</code> (default) and <code>ALL</code>.</p>
</li>
<li>
<p>Set the <code>top_sql</code> parameter to specify the number of SQL statements in a SQL tuning set to generate in the report. By default, the report shows the top 100 SQL statements impacted by the system change.</p>
</li>
</ul>
<p>To generate an active report, run the following script:</p>
<pre>
set trimspool on
set trim on
set pages 0
set linesize 1000
set long 1000000
set longchunksize 1000000
spool spa_active.html
SELECT DBMS_SQLPA.REPORT_ANALYSIS_TASK(task_name =&gt; 'my_spa_task',
          type =&gt; 'active', section =&gt; 'all') FROM dual;
spool off
</pre>
<p>The following example illustrates a portion of a SQL script that you could use to create and display a comparison summary report in text format:</p>
<pre>
VAR rep   CLOB;
EXEC :rep := DBMS_SQLPA.REPORT_ANALYSIS_TASK('my_spa_task', -
                'text', 'typical', 'summary');
SET LONG 100000 LONGCHUNKSIZE 100000 LINESIZE 130
PRINT :rep
</pre></li>
<li>
<p>Review the SQL Performance Analyzer report, as described in <a href="#CACFEBHH">"Reviewing the SQL Performance Analyzer Report Using APIs"</a>.</p>
</li>
</ol>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<ul>
<li>
<p><a class="olink ARPLS229" href="../../appdev.112/e40758/d_sqlpa.htm#ARPLS229"><span class="italic">Oracle Database PL/SQL Packages and Types Reference</span></a> for information about the <code>DBMS_SQLPA.EXECUTE_ANALYSIS_TASK</code> and <code>DBMS_SQLPA.REPORT_ANALYSIS_TASK</code> functions</p>
</li>
</ul>
</div>
</div>
<!-- class="sect2" -->
<a id="CACFEBHH"></a>
<div id="RATUG198" class="sect2"><!-- infolevel="all" infotype="General" -->
<h3 class="sect2"><span class="secnum">6.2.2</span> Reviewing the SQL Performance Analyzer Report Using APIs</h3>
<p>The SQL Performance Analyzer report is divided into the following sections:</p>
<ul>
<li>
<p><a href="#CACCCHIH">General Information</a></p>
</li>
<li>
<p><a href="#CACFJAFB">Result Summary</a></p>
</li>
<li>
<p><a href="#CACCIFEB">Result Details</a></p>
</li>
</ul>
<p>This section uses a sample report to illustrate how to review the <a id="sthref76"></a>SQL Performance Analyzer report. The sample report uses <code>buffer_gets</code> as the comparison metric to compare the pre-change and post-change executions of a SQL workload.</p>
<a id="CACCCHIH"></a>
<div id="RATUG199" class="sect3"><!-- infolevel="all" infotype="General" -->
<h4 class="sect3"><span class="secnum">6.2.2.1</span> General Information</h4>
<p>The <a id="sthref77"></a>General Information section contains basic information and metadata about the SQL Performance Analyzer task, the SQL tuning set used, and the pre-change and post-change executions. <a href="#CDEDEJHC">Example 6-1</a> shows the General Information section of a sample report.</p>
<div id="RATUG242" class="example">
<p class="titleinexample"><a id="CDEDEJHC"></a>Example 6-1 General Information</p>
<pre>
---------------------------------------------------------------------------------------------
General Information
---------------------------------------------------------------------------------------------

 Task Information:                              Workload Information:
 ---------------------------------------------  ---------------------------------------------
  Task Name    : my_spa_task                     SQL Tuning Set Name        : my_sts
  Task Owner   : APPS                            SQL Tuning Set Owner       : APPS
  Description  :                                 Total SQL Statement Count  : 101

Execution Information:
---------------------------------------------------------------------------------------------
  Execution Name  : my_exec_compare        Started             : 05/21/2007 11:30:09
  Execution Type  : ANALYZE PERFORMANCE    Last Updated        : 05/21/2007 11:30:10
  Description     :                        Global Time Limit   : UNLIMITED
  Scope           : COMPREHENSIVE          Per-SQL Time Limit  : UNUSED
  Status          : COMPLETED              Number of Errors    : 0

Analysis Information:
---------------------------------------------------------------------------------------------
 Comparison Metric: BUFFER_GETS
 ------------------
 Workload Impact Threshold: 1%
 --------------------------
 SQL Impact Threshold: 1%
 ----------------------
 Before Change Execution:                       After Change Execution:
 ---------------------------------------------  ---------------------------------------------
  Execution Name      : my_exec_BEFORE_change    Execution Name      : my_exec_AFTER_change
  Execution Type      : TEST EXECUTE             Execution Type      : TEST EXECUTE
  Description         :                          Description         :
  Scope               : COMPREHENSIVE            Scope               : COMPREHENSIVE
  Status              : COMPLETED                Status              : COMPLETED
  Started             : 05/21/2007 11:22:06      Started             : 05/21/2007 11:25:56
  Last Updated        : 05/21/2007 11:24:01      Last Updated        : 05/21/2007 11:28:30
  Global Time Limit   : 1800                     Global Time Limit   : 1800
  Per-SQL Time Limit  : UNUSED                   Per-SQL Time Limit  : UNUSED
  Number of Errors    : 0                        Number of Errors    : 0

---------------------------------------------------------------------------------------------
</pre></div>
<!-- class="example" -->
<p>In <a href="#CDEDEJHC">Example 6-1</a>, the Task Information section indicates that the task name is <code>my_spa_task</code>. The Workload Information section indicates that the task compares executions of the <code>my_sts</code> SQL tuning set, which contains 101 SQL statements. As shown in the Execution Information section, the comparison execution is named <code>my_exec_compare</code>.</p>
<p>The Analysis Information sections shows that SQL Performance Analyzer compares two executions of the <code>my_sts</code> SQL tuning set, <code>my_exec_BEFORE_change</code> and <code>my_exec_AFTER_change</code>, using <code>buffer_gets</code> as a comparison metric.</p>
</div>
<!-- class="sect3" -->
<a id="CACFJAFB"></a>
<div id="RATUG200" class="sect3"><!-- infolevel="all" infotype="General" -->
<h4 class="sect3"><span class="secnum">6.2.2.2</span> Result Summary</h4>
<p>The <a id="sthref78"></a>Result Summary section summarizes the results of the SQL Performance Analyzer task. The Result Summary section is divided into the following subsections:</p>
<ul>
<li>
<p><a href="#CACDCHID">Overall Performance Statistics</a></p>
</li>
<li>
<p><a href="#CACGBCEA">Performance Statistics of SQL Statements</a></p>
</li>
<li>
<p><a href="#CACFHHIF">Errors</a></p>
</li>
</ul>
<a id="CACDCHID"></a>
<div id="RATUG201" class="sect4"><!-- infolevel="all" infotype="General" -->
<h5 class="sect4"><span class="secnum">6.2.2.2.1</span> Overall Performance Statistics</h5>
<p>The Overall Performance Statistics subsection displays statistics about the overall performance of the entire SQL workload. This section is a very important part of the SQL Performance Analyzer analysis because it shows the impact of the system change on the overall performance of the SQL workload. Use the information in this section to understand the change of the workload performance, and determine whether the workload performance will improve or degrade after making the system change.</p>
<p><a href="#CDEIIHEA">Example 6-2</a> shows the Overall Performance Statistics subsection of a sample report.</p>
<div id="RATUG243" class="example">
<p class="titleinexample"><a id="CDEIIHEA"></a>Example 6-2 Overall Performance Statistics</p>
<pre>
Report Summary
---------------------------------------------------------------------------------------------
 
Projected Workload Change Impact:
-------------------------------------------
 Overall Impact      :   47.94%
 Improvement Impact  :   58.02%
 Regression Impact   :  -10.08%
 
SQL Statement Count
-------------------------------------------
 SQL Category  SQL Count  Plan Change Count
 Overall       101        6
 Improved      2          2
 Regressed     1          1
 Unchanged     98         3
.
.
.
---------------------------------------------------------------------------------------------
</pre></div>
<!-- class="example" -->
<p>This example indicates that the overall performance of the SQL workload improved by 47.94%, even though regressions had a negative impact of -10.08%. This means that if all of the regressions are fixed in this example, the overall change impact will be 58.02%. After the system change, 2 of the 101 SQL statements ran faster, while 1 ran slower. Performance of 98 statements remained unchanged.</p>
</div>
<!-- class="sect4" -->
<a id="CACGBCEA"></a>
<div id="RATUG202" class="sect4"><!-- infolevel="all" infotype="General" -->
<h5 class="sect4"><span class="secnum">6.2.2.2.2</span> Performance Statistics of SQL Statements</h5>
<p>The Performance Statistics subsection highlights the SQL statements that are the most impacted by the system change. The pre-change and post-change performance data for each SQL statement in the workload are compared based on the following criteria:</p>
<ul>
<li>
<p>Execution frequency, or importance, of each SQL statement</p>
</li>
<li>
<p>Impact of the system change on each SQL statement relative to the entire SQL workload</p>
</li>
<li>
<p>Impact of the system change on each SQL statement</p>
</li>
<li>
<p>Whether the structure of the execution plan for each SQL statement has changed</p>
</li>
</ul>
<p><a href="#CDEJGFFB">Example 6-3</a> shows the Performance Statistics of SQL Statements subsection of a sample report. The report has been altered slightly to fit on the page.</p>
<div id="RATUG244" class="example">
<p class="titleinexample"><a id="CDEJGFFB"></a>Example 6-3 Performance Statistics of SQL Statements</p>
<pre>
SQL Statements Sorted by their Absolute Value of Change Impact on the Workload
---------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------
|           |               | Impact on | Execution |  Metric  |  Metric  | Impact | Plan   |
| object_id | sql_id        | Workload  | Frequency |  Before  |  After   | on SQL | Change |
---------------------------------------------------------------------------------------------
|    205    | 73s2sgy2svfrw |   29.01%  |   100000  |  1681683 |  220590  | 86.88% |   y    |
|    206    | gq2a407mv2hsy |   29.01%  |   949141  |  1681683 |  220590  | 86.88% |   y    |
|    204    | 2wtgxbjz6u2by |  -10.08%  |   478254  |  1653012 |  2160529 | -30.7% |   y    |
---------------------------------------------------------------------------------------------
</pre></div>
<!-- class="example" -->
<p>The SQL statements are sorted in descending order by the absolute value of the net impact on the SQL workload, that is, the sort order does not depend on whether the impact was positive or negative.</p>
</div>
<!-- class="sect4" -->
<a id="CACFHHIF"></a>
<div id="RATUG203" class="sect4"><!-- infolevel="all" infotype="General" -->
<h5 class="sect4"><span class="secnum">6.2.2.2.3</span> Errors</h5>
<p>The Errors subsection reports all errors that occurred during an execution. An error may be reported at the SQL tuning set level if it is common to all executions in the SQL tuning set, or at the execution level if it is specific to a SQL statement or execution plan.</p>
<p><a href="#CDEGIAAE">Example 6-4</a> shows an example of the Errors subsection of a SQL Performance Analyzer report.</p>
<div id="RATUG245" class="example">
<p class="titleinexample"><a id="CDEGIAAE"></a>Example 6-4 Errors</p>
<pre>
----------------------------------------------------------------------------------
                             SQL STATEMENTS WITH ERRORS
----------------------------------------------------------------------------------
SQL ID        Error
------------- --------------------------------------------------------------------
47bjmcdtw6htn ORA-00942: table or view does not exist
br61bjp4tnf7y ORA-00920: invalid relational operator
----------------------------------------------------------------------------------
</pre></div>
<!-- class="example" --></div>
<!-- class="sect4" --></div>
<!-- class="sect3" -->
<a id="CACCIFEB"></a>
<div id="RATUG204" class="sect3"><!-- infolevel="all" infotype="General" -->
<h4 class="sect3"><span class="secnum">6.2.2.3</span> Result Details</h4>
<p>The <a id="sthref79"></a>Result Details section represents a drill-down into the performance of SQL statements that appears in the Result Summary section of the report. Use the information in this section to investigate why the performance of a particular SQL statement regressed.</p>
<p>This section will contain an entry of every SQL statement processed in the SQL performance impact analysis. Each entry is organized into the following subsections:</p>
<ul>
<li>
<p><a href="#CACGGAGJ">SQL Details</a></p>
</li>
<li>
<p><a href="#CACDEAFE">Execution Statistics</a></p>
</li>
<li>
<p><a href="#CACBGJFI">Execution Plans</a></p>
</li>
</ul>
<a id="CACGGAGJ"></a>
<div id="RATUG205" class="sect4"><!-- infolevel="all" infotype="General" -->
<h5 class="sect4"><span class="secnum">6.2.2.3.1</span> SQL Details</h5>
<p>This section of the report summarizes the SQL statement, listing its information and execution details.</p>
<p><a href="#CDEIICCB">Example 6-5</a> shows the SQL Details subsection of a sample report.</p>
<div id="RATUG246" class="example">
<p class="titleinexample"><a id="CDEIICCB"></a>Example 6-5 SQL Details</p>
<pre>
SQL Details:
-----------------------------
 Object ID            : 204
 Schema Name          : APPS
 SQL ID               : 2wtgxbjz6u2by
 Execution Frequency  : 1
 SQL Text             : SELECT /* my_query_14_scott */ /*+ ORDERED INDEX(t1)
                        USE_HASH(t1) */ 'B' || t2.pg_featurevalue_05_id
                        pg_featurevalue_05_id, 'r' || t4.elementrange_id
                        pg_featurevalue_15_id, 'G' || t5.elementgroup_id
                        pg_featurevalue_01_id, 'r' || t6.elementrange_id . . .
.
.
.
---------------------------------------------------------------------------------------------
</pre></div>
<!-- class="example" -->
<p>In <a href="#CDEIICCB">Example 6-5</a>, the report summarizes the regressed SQL statement whose ID is <code>2wtgxbjz6u2by</code> and corresponding object ID is <code>204</code>.</p>
</div>
<!-- class="sect4" -->
<a id="CACDEAFE"></a>
<div id="RATUG206" class="sect4"><!-- infolevel="all" infotype="General" -->
<h5 class="sect4"><span class="secnum">6.2.2.3.2</span> Execution Statistics</h5>
<p>The Execution Statistics subsection compares execution statistics of the SQL statement from the pre-change and post-change executions and then summarizes the findings.</p>
<p><a href="#CDEHCDHE">Example 6-6</a> shows the Execution Statistics subsection of a sample report.</p>
<div id="RATUG247" class="example">
<p class="titleinexample"><a id="CDEHCDHE"></a>Example 6-6 Execution Statistics</p>
<pre>
Execution Statistics:
-----------------------------
---------------------------------------------------------------------------------------
|              | Impact on | Value   | Value   | Impact     | % Workload | % Workload |
| Stat Name    | Workload  | Before  | After   | on SQL     | Before     | After      |
---------------------------------------------------------------------------------------
| elapsed_time |    -95.54%|  36.484 | 143.161 |   -292.39% |     32.68% |     94.73% |
| parse_time   |    -12.37%|    .004 |    .062 |     -1450% |       .85% |     11.79% |
| exec_elapsed |    -95.89%|   36.48 | 143.099 |   -292.27% |     32.81% |     95.02% |
| exec_cpu     |    -19.73%|  36.467 |  58.345 |    -59.99% |     32.89% |     88.58% |
| buffer_gets  |    -10.08%| 1653012 | 2160529 |     -30.7% |     32.82% |     82.48% |
| cost         |     12.17%|   11224 |    2771 |     75.31% |     16.16% |      4.66% |
| reads        |  -1825.72%|    4091 |  455280 | -11028.82% |     16.55% |     96.66% |
| writes       |     -1500%|       0 |      15 |     -1500% |         0% |       100% |
| rows         |           |     135 |     135 |            |            |            |
---------------------------------------------------------------------------------------

Notes:
-----------------------------
Before Change:
1. The statement was first executed to warm the buffer cache.
2. Statistics shown were averaged over next 9 executions.

After Change:
1. The statement was first executed to warm the buffer cache.
2. Statistics shown were averaged over next 9 executions.

Findings (2):
-----------------------------
1. The performance of this SQL has regressed.
2. The structure of the SQL execution plan has changed.
---------------------------------------------------------------------------------------------
</pre></div>
<!-- class="example" --></div>
<!-- class="sect4" -->
<a id="CACBGJFI"></a>
<div id="RATUG207" class="sect4"><!-- infolevel="all" infotype="General" -->
<h5 class="sect4"><span class="secnum">6.2.2.3.3</span> Execution Plans</h5>
<p>The Execution Plans subsection displays the pre-change and post-change execution plans for the SQL statement. In cases when the performance regressed, this section also contains findings on root causes and symptoms.</p>
<p><a href="#CDEIGJAE">Example 6-7</a> shows the Execution Plans subsection of a sample report.</p>
<div id="RATUG248" class="example">
<p class="titleinexample"><a id="CDEIGJAE"></a>Example 6-7 Execution Plans</p>
<pre>
Execution Plan Before Change:
-----------------------------
 Plan Id          : 1
 Plan Hash Value  : 3412943215
 
----------------------------------------------------------------------------------------------------------
| Id   | Operation                           | Name                | Rows   | Bytes   | Cost  | Time     |
----------------------------------------------------------------------------------------------------------
|    0 | SELECT STATEMENT                    |                     |      1 |     126 | 11224 | 00:02:15 |
|    1 |   HASH GROUP BY                     |                     |      1 |     126 | 11224 | 00:02:15 |
|    2 |    NESTED LOOPS                     |                     |      1 |     126 | 11223 | 00:02:15 |
|  * 3 |     HASH JOIN                       |                     |      1 |     111 | 11175 | 00:02:15 |
|  * 4 |      TABLE ACCESS FULL              | LU_ELEMENTGROUP_REL |      1 |      11 |   162 | 00:00:02 |
|  * 5 |      HASH JOIN                      |                     |    487 |   48700 | 11012 | 00:02:13 |
|    6 |       MERGE JOIN                    |                     |     14 |     924 |  1068 | 00:00:13 |
|    7 |        SORT JOIN                    |                     |   5391 |  274941 |  1033 | 00:00:13 |
|  * 8 |         HASH JOIN                   |                     |   5391 |  274941 |   904 | 00:00:11 |
|  * 9 |          TABLE ACCESS FULL          | LU_ELEMENTGROUP_REL |    123 |    1353 |   175 | 00:00:03 |
| * 10 |          HASH JOIN                  |                     |   5352 |  214080 |   729 | 00:00:09 |
| * 11 |           TABLE ACCESS FULL         | LU_ITEM_293         |   5355 |  128520 |    56 | 00:00:01 |
| * 12 |           TABLE ACCESS FULL         | ADM_PG_FEATUREVALUE |   1629 |   26064 |   649 | 00:00:08 |
| * 13 |        FILTER                       |                     |        |         |       |          |
| * 14 |         SORT JOIN                   |                     |      1 |      15 |    36 | 00:00:01 |
| * 15 |          TABLE ACCESS FULL          | LU_ELEMENTRANGE_REL |      1 |      15 |    35 | 00:00:01 |
|   16 |       INLIST ITERATOR               |                     |        |         |       |          |
| * 17 |        TABLE ACCESS BY INDEX ROWID  | FACT_PD_OUT_ITM_293 | 191837 | 6522458 |  9927 | 00:02:00 |
|   18 |         BITMAP CONVERSION TO ROWIDS |                     |        |         |       |          |
| * 19 |          BITMAP INDEX SINGLE VALUE  | FACT_274_PER_IDX    |        |         |       |          |
| * 20 |     TABLE ACCESS FULL               | LU_ELEMENTRANGE_REL |      1 |      15 |    49 | 00:00:01 |
----------------------------------------------------------------------------------------------------------
.
.
.

Execution Plan After Change:
-----------------------------
 Plan Id          : 102
 Plan Hash Value  : 1923145679
 
------------------------------------------------------------------------------------------------------
| Id   | Operation                           | Name                | Rows | Bytes  | Cost | Time     |
------------------------------------------------------------------------------------------------------
|    0 | SELECT STATEMENT                    |                     |    1 |    126 | 2771 | 00:00:34 |
|    1 |   HASH GROUP BY                     |                     |    1 |    126 | 2771 | 00:00:34 |
|    2 |    NESTED LOOPS                     |                     |    1 |    126 | 2770 | 00:00:34 |
|  * 3 |     HASH JOIN                       |                     |    1 |    111 | 2722 | 00:00:33 |
|  * 4 |      HASH JOIN                      |                     |    1 |    100 | 2547 | 00:00:31 |
|  * 5 |       TABLE ACCESS FULL             | LU_ELEMENTGROUP_REL |    1 |     11 |  162 | 00:00:02 |
|    6 |       NESTED LOOPS                  |                     |      |        |      |          |
|    7 |        NESTED LOOPS                 |                     |  484 |  43076 | 2384 | 00:00:29 |
|  * 8 |         HASH JOIN                   |                     |   14 |    770 |  741 | 00:00:09 |
|    9 |          NESTED LOOPS               |                     |    4 |    124 |  683 | 00:00:09 |
| * 10 |           TABLE ACCESS FULL         | LU_ELEMENTRANGE_REL |    1 |     15 |   35 | 00:00:01 |
| * 11 |           TABLE ACCESS FULL         | ADM_PG_FEATUREVALUE |    4 |     64 |  649 | 00:00:08 |
| * 12 |          TABLE ACCESS FULL          | LU_ITEM_293         | 5355 | 128520 |   56 | 00:00:01 |
|   13 |         BITMAP CONVERSION TO ROWIDS |                     |      |        |      |          |
| * 14 |          BITMAP INDEX SINGLE VALUE  | FACT_274_ITEM_IDX   |      |        |      |          |
| * 15 |        TABLE ACCESS BY INDEX ROWID  | FACT_PD_OUT_ITM_293 |   36 |   1224 | 2384 | 00:00:29 |
| * 16 |      TABLE ACCESS FULL              | LU_ELEMENTGROUP_REL |  123 |   1353 |  175 | 00:00:03 |
| * 17 |     TABLE ACCESS FULL               | LU_ELEMENTRANGE_REL |    1 |     15 |   49 | 00:00:01 |
------------------------------------------------------------------------------------------------------
</pre></div>
<!-- class="example" --></div>
<!-- class="sect4" --></div>
<!-- class="sect3" --></div>
<!-- class="sect2" -->
<a id="CHDFHHGE"></a>
<div id="RATUG305" class="sect2"><!-- infolevel="all" infotype="General" -->
<h3 class="sect2"><span class="secnum">6.2.3</span> Comparing SQL Tuning Sets Using APIs</h3>
<p>You can compare two <a id="sthref80"></a>SQL tuning sets using SQL Performance Analyzer APIs. For example, while using Database Replay, you may have captured a SQL tuning set on the production system during workload capture, and another SQL tuning set on a test system during workload replay. You can then use SQL Performance Analyzer to compare these SQL tuning sets, without having to re-execute the SQL statements. This is useful in cases where you already have another utility to run your workload before and after making the system change, such as a custom script.</p>
<p>When comparing SQL tuning sets, SQL Performance Analyzer uses the runtime statistics captured in the SQL tuning sets to perform its comparison analysis, and reports on any new or missing SQL statements that are found in one SQL tuning set, but not in the other. Any changes in execution plans between the two SQL tuning sets are also reported. For each SQL statement in both SQL tuning sets, improvement and regression findings are reported for each SQL statement&mdash;calculated based on the average statistic value per execution&mdash;and for the entire workload&mdash;calculated based on the cumulative statistic value.</p>
<p>To compare SQL tuning sets using the <code>DBMS_SQLPA</code> package:</p>
<ol>
<li>
<p>Create a SQL Performance Analyzer task:</p>
<pre>
VAR aname varchar2(30);
EXEC :aname := 'compare_s2s';
EXEC :aname := DBMS_SQLPA.CREATE_ANALYSIS_TASK(task_name =&gt; :aname);
</pre>
<p>It is not necessary to associate a SQL tuning set to the task during creation.</p>
</li>
<li>
<p>Create the first SQL trial and convert the first SQL tuning set:</p>
<pre>
EXEC DBMS_SQLPA.EXECUTE_ANALYSIS_TASK(task_name =&gt; :aname, -
          execution_type =&gt; 'convert sqlset', -
          execution_name =&gt; 'first trial', -
          execution_params =&gt; DBMS_ADVISOR.ARGLIST(
                               'sqlset_name', 'my_first_sts', -
                               'sqlset_owner', 'APPS'));
</pre>
<p>Specify the name and owner of the SQL tuning set using the <code>SQLSET_NAME</code> and <code>SQLSET_OWNER</code> task parameters. The content of the SQL tuning set will not be duplicated by the SQL Performance Analyzer task. Instead, a reference to the SQL tuning set is recorded in association to the new SQL trial, which in this example is "first trial".</p>
</li>
<li>
<p>Create a second SQL trial and associate it to the second SQL tuning second to which you want to compare:</p>
<pre>
EXEC DBMS_SQLPA.EXECUTE_ANALYSIS_TASK(task_name =&gt; :aname, -
          execution_type =&gt; 'convert sqlset', -
          execution_name =&gt; 'second trial', -
          execution_params =&gt; DBMS_ADVISOR.ARGLIST(
                               'sqlset_name', 'my_second_sts', -
                               'sqlset_owner', 'APPS'));
</pre></li>
<li>
<p>Compare the performance data from the two SQL trials (or SQL tuning sets) by running a comparison analysis:</p>
<pre>
EXEC DBMS_SQLPA.EXECUTE_ANALYSIS_TASK(task_name =&gt; :aname, -
          execution_type =&gt; 'compare', -
          execution_name =&gt; 'comparison', -
          execution_params =&gt; DBMS_ADVISOR.ARGLIST(
                               'workload_impact_threshold', 0, -
                               'sql_impact_threshold', 0));
</pre>
<p>In this example, the workload and per-SQL impact threshold are set to 0% for comparison (the default value is 1%).</p>
</li>
<li>
<p>After the comparison analysis is complete, generate a SQL Performance Analyzer report using the <code>DBMS_SQLPA.REPORT_ANALYSIS_TASK</code> function.</p>
<p>For information about generating a SQL Performance Analyzer report using APIs, see <a href="#CACHAJID">"Analyzing SQL Performance Using APIs"</a>.</p>
</li>
</ol>
<p>Once the report is generated, review it to identify any differences between the contents of the two SQL tuning sets. <a href="#CHDIIHJC">Example 6-8</a> shows the Analysis Information and Report Summary sections of a sample report generated by comparing two SQL tuning sets:</p>
<div id="RATUG306" class="example">
<p class="titleinexample"><a id="CHDIIHJC"></a>Example 6-8 Analysis Information and Report Summary</p>
<pre>
Analysis Information:
------------------------------------------------------------------------------------------------
 Before Change Execution:                          After Change Execution:
 ---------------------------------------------     ---------------------------------------------
  Execution Name      : first trial                 Execution Name      : second trial
  Execution Type      : CONVERT SQLSET              Execution Type      : CONVERT SQLSET
  Status              : COMPLETED                   Status              : COMPLETED
  Started             : &hellip;
  Last Updated        : &hellip;
 
 Before Change Workload:                           After Change Workload:
 ---------------------------------------------     ---------------------------------------------
  SQL Tuning Set Name        : my_first_sts         SQL Tuning Set Name        : my_second_sts
  SQL Tuning Set Owner       : APPS                 SQL Tuning Set Owner       : APPS
  Total SQL Statement Count  : 5                    Total SQL Statement Count  : 6
 
------------------------------------------------------------------------------------------------
Report Summary
------------------------------------------------------------------------------------------------
 
Projected Workload Change Impact:
-------------------------------------------
 Overall Impact      :  72.32%
 Improvement Impact  :  47.72%
 Regression Impact   :   -.02%
 Missing-SQL Impact  :   33.1%
 New-SQL Impact      :  -8.48%
 
SQL Statement Count
-------------------------------------------
 SQL Category   SQL Count  Plan Change Count
 Overall                7                  1
 Common                 4                  1
  Improved              3                  1
  Regressed             1                  0
 Different              3                  0
  Missing SQL           1                  0
  New SQL               2                  0
</pre></div>
<!-- class="example" -->
<p>As shown in <a href="#CHDIIHJC">Example 6-8</a>, this report contains two additional categories that are not found in standard SQL Performance Analyzer reports; both categories are grouped under the heading Different:</p>
<ul>
<li>
<p>Missing SQL</p>
<p>This category represents all SQL statements that are present in the first SQL tuning set, but are not found in the second SQL tuning set. In this example, only one SQL statement is missing. As shown in <a href="#CHDDEHJA">Example 6-9</a>, this SQL statement has:</p>
<ul>
<li>
<p>A <code>sql_id</code> value of gv7xb8tyd1v91</p>
</li>
<li>
<p>A performance impact on the workload of 33.1% based on the change</p>
</li>
<li>
<p>No performance impact on the SQL statement based on the change because its "Total Metric After" change value is missing</p>
</li>
</ul>
</li>
<li>
<p>New SQL</p>
<p>This category represents all SQL statements that are present in the second SQL tuning set, but are not found in the first SQL tuning set. In this example, only two SQL statements are new in the second SQL tuning set. As shown in <a href="#CHDDEHJA">Example 6-9</a>, these SQL statements have:</p>
<ul>
<li>
<p><code>sql_id</code> values of 4c8nrqxhtb2sf and 9utadgu5udmh4</p>
</li>
<li>
<p>A total performance impact on the workload of -8.48%</p>
</li>
<li>
<p>Missing "Total Metric Before" change values</p>
</li>
</ul>
</li>
</ul>
<p><a href="#CHDDEHJA">Example 6-9</a> shows a table in the sample report that lists the missing and new SQL statements, as well as other top SQL statements as determined by their impact on the workload:</p>
<div id="RATUG307" class="example">
<p class="titleinexample"><a id="CHDDEHJA"></a>Example 6-9 Top 7 SQL Sorted by Absolute Value of Change Impact on the Workload</p>
<pre>
Top 7 SQL Sorted by Absolute Value of Change Impact on the Workload
------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------
|           |               | Impact on | Total Metric | Total Metric | Impact  | Plan   |
| object_id | sql_id        | Workload  |    Before    |    After     | on SQL  | Change |
------------------------------------------------------------------------------------------
|         4 | 7gj3w9ya4d9sj |    41.04% |       812791 |        36974 |     95% | y      |
|         7 | gv7xb8tyd1v91 |     33.1% |       625582 |              |         | n      |
|         2 | 4c8nrqxhtb2sf |    -8.35% |              |       157782 |         | n      |
|         1 | 22u3tvrt0yr6g |     4.58% |       302190 |       215681 |  28.63% | n      |
|         6 | fgdd0fd56qmt0 |      2.1% |       146128 |       106369 |  27.21% | n      |
|         5 | 9utadgu5udmh4 |     -.13% |              |         2452 |         | n      |
|         3 | 4dtv43awxnmv3 |     -.02% |         3520 |         3890 | -47.35% | n      |
------------------------------------------------------------------------------------------
</pre></div>
<!-- class="example" -->
<p>Once you have identified a SQL statement of interest, you can generate a report for the SQL statement to perform more detailed investigation. For example, you may want to investigate the SQL statement with the <code>sql_id</code> value of 7gj3w9ya4d9sj and <code>object_id</code> value of 4 because it has the highest impact on the workload:</p>
<pre>
SELECT DBMS_SQLPA.REPORT_ANALYSIS_TASK(task_name =&gt; :aname, object_id =&gt; 4) rep
FROM dual;
</pre>
<p><a href="#CHDFGHJE">Example 6-10</a> shows a sample report generated for this SQL statement:</p>
<div id="RATUG308" class="example">
<p class="titleinexample"><a id="CHDFGHJE"></a>Example 6-10 Sample Report for SQL Statement</p>
<pre>
SQL Details:
-----------------------------
 Object ID  : 4
 SQL ID     : 7gj3w9ya4d9sj
 SQL Text   : /* my_csts_query1 */ select * FROM emp where empno=2
 
SQL Execution Statistics (average):
---------------------------------------
---------------------------------------------------------
|              | Impact on | Value   | Value   | Impact |
| Stat Name    | Workload  | Before  | After   | on SQL |
---------------------------------------------------------
| elapsed_time |    41.04% | .036945 | .001849 |    95% |
| cpu_time     |    13.74% | .004772 |  .00185 | 61.24% |
| buffer_gets  |     9.59% |       8 |       2 | 69.01% |
| cost         |    11.76% |       1 |       1 |    10% |
| reads        |     4.08% |       0 |       0 | 63.33% |
| writes       |        0% |       0 |       0 |     0% |
| rows         |           |       0 |       0 |        |
| executions   |           |      22 |      20 |        |
| plan_count   |           |       3 |       2 |        |
---------------------------------------------------------
Findings (2):
-----------------------------
 1. The performance of this SQL has improved.
 2. The structure of the SQL execution plan has changed.
 
Plan Execution Statistics (average):
---------------------------------------
----------------------------------------------------------------------------------
| Statistic Name  | Plans Before Change              | Plans After Change        |
----------------------------------------------------------------------------------
| plan hash value | 440231712  571903972  3634526668 | 571903972  3634526668     |
| --------------- | ---------  ---------  ---------- | ---------  ----------     |
|  schema name    | APPS1      APPS2      APPS2      | APPS2      APPS2          |
|  executions     | 7          5          10         | 10         10             |
|  cost           | 2          1          2          | 1          2              |
|  elapsed_time   | .108429    .000937    .00491     | .000503    .003195        |
|  cpu_time       | .00957     .0012      .0032      | .0005      .0032          |
|  buffer_gets    | 18         0          5          | 0          5              |
|  reads          | 0          0          0          | 0          0              |
|  writes         | 0          0          0          | 0          0              |
|  rows           | 0          0          0          | 0          0              |
----------------------------------------------------------------------------------
Execution Plans Before Change:
-----------------------------
Plan Hash Value  : 440231712
---------------------------------------------------------------------------
| Id | Operation              | Name     | Rows | Bytes | Cost | Time     |
---------------------------------------------------------------------------
|  0 | SELECT STATEMENT       |          |      |       |    2 |          |
|  1 |   PX COORDINATOR       |          |      |       |      |          |
|  2 |    PX SEND QC (RANDOM) | :TQ10000 |    1 |    87 |    2 | 00:00:01 |
|  3 |     PX BLOCK ITERATOR  |          |    1 |    87 |    2 | 00:00:01 |
|  4 |      TABLE ACCESS FULL | EMP      |    1 |    87 |    2 | 00:00:01 |
---------------------------------------------------------------------------
Note
-----
- dynamic sampling used for this statement
Plan Hash Value  : 571903972
----------------------------------------------------------------------------------
| Id | Operation                     | Name       | Rows | Bytes | Cost | Time   |
----------------------------------------------------------------------------------
|  0 | SELECT STATEMENT              |            |      |       |    1 |        |
|  1 |   TABLE ACCESS BY INDEX ROWID | EMP        |    1 |    87 |    1 |00:00:01|
|  2 |    INDEX UNIQUE SCAN          | MY_EMP_IDX |    1 |       |    0 |        |
----------------------------------------------------------------------------------
Plan Hash Value  : 3634526668
--------------------------------------------------------------------
| Id | Operation           | Name | Rows | Bytes | Cost | Time     |
--------------------------------------------------------------------
|  0 | SELECT STATEMENT    |      |      |       |    2 |          |
|  1 |   TABLE ACCESS FULL | EMP  |    1 |    87 |    2 | 00:00:01 |
--------------------------------------------------------------------
Note
-----
- dynamic sampling used for this statement
 
Executions Plan After Change:
-----------------------------
Plan Hash Value  : 571903972
----------------------------------------------------------------------------------
| Id | Operation                     | Name       | Rows | Bytes | Cost | Time   |
----------------------------------------------------------------------------------
|  0 | SELECT STATEMENT              |            |      |       |    1 |        |
|  1 |   TABLE ACCESS BY INDEX ROWID | EMP        |    1 |    87 |    1 |00:00:01|
|  2 |    INDEX UNIQUE SCAN          | MY_EMP_IDX |    1 |       |    0 |        |
----------------------------------------------------------------------------------
Plan Hash Value  : 3634526668
--------------------------------------------------------------------
| Id | Operation           | Name | Rows | Bytes | Cost | Time     |
--------------------------------------------------------------------
|  0 | SELECT STATEMENT    |      |      |       |    2 |          |
|  1 |   TABLE ACCESS FULL | EMP  |    1 |    87 |    2 | 00:00:01 |
--------------------------------------------------------------------
Note
-----
- dynamic sampling used for this statement
----------------------------------------------------------------------------------
</pre></div>
<!-- class="example" -->
<p>The SQL Execution Statistics section shows the average runtime statistics (per execution) of the SQL statement. The data in this table reveals that this SQL statement is present in both SQL tuning sets, but that it has only three execution plans in the first SQL tuning set and two execution plans in the second SQL tuning set. Furthermore, the SQL statement was executed 22 times in the first SQL tuning set, but only 20 times in the second SQL tuning set.</p>
<p>The Plan Execution Statistics section shows runtime statistics per execution plan (or plan hash value). The Plans Before Change column lists plans and their associated execution statistics for the first SQL tuning set; the Plans After Change columns lists these values for the second SQL tuning set. Execution plans structures for both SQL tuning sets are shown at the end of the report.</p>
<p>You can use these sections in the report to identify changes in execution plans between two SQL tuning sets. This is important because changes in execution plans may be a result of test changes that can have a direct impact to performance. When comparing two SQL tuning sets, SQL Performance Analyzer reports execution plan changes when a SQL statement has:</p>
<ul>
<li>
<p>One plan in both SQL tuning sets, but the plan structure is different</p>
</li>
<li>
<p>More than one plan, and the number of plans in both SQL tuning sets are:</p>
<ul>
<li>
<p>The same, but at least one plan in the second SQL tuning set is different from all plans in the first SQL tuning set</p>
</li>
<li>
<p>Different</p>
</li>
</ul>
</li>
</ul>
<p>After evaluating the SQL statement and plan changes, determine if further action is required. If the SQL statement has regressed, perform one of the following actions:</p>
<ul>
<li>
<p>Tune the regressed SQL statement, as described in <a href="#CACDFCBJ">"Tuning Regressed SQL Statements Using APIs"</a></p>
</li>
<li>
<p>Create SQL plan baselines, as described in <a href="#CHDBFJIE">"Creating SQL Plan Baselines Using APIs"</a></p>
</li>
</ul>
</div>
<!-- class="sect2" -->
<a id="CACDFCBJ"></a>
<div id="RATUG208" class="sect2"><!-- infolevel="all" infotype="General" -->
<h3 class="sect2"><span class="secnum">6.2.4</span> Tuning Regressed SQL Statements Using APIs</h3>
<p>After reviewing the SQL Performance Analyzer report, you should tune any <a id="sthref81"></a>regressed SQL statements that are identified after comparing the SQL performance. If there are large numbers of SQL statements that appear to have regressed, you should try to identify the root cause and make system-level changes to rectify the problem. In cases when only a few SQL statements have regressed, consider using the SQL Tuning Advisor to implement a point solution for them, or creating SQL plan baselines to instruct the optimizer to select the original execution plan in the future.</p>
<p>To tune regressed SQL statements reported by SQL Performance Analyzer using APIs, create a SQL tuning task for the SQL Performance Analyzer execution by using the <a id="sthref82"></a><code>CREATE_TUNING_TASK</code> function in the <code>DBMS_SQLTUNE</code> package:</p>
<pre>
BEGIN
  DBMS_SQLTUNE.CREATE_TUNING_TASK(
    spa_task_name =&gt; 'my_spa_task',
    spa_task_owner =&gt; 'immchan',
    spa_compare_exec =&gt; 'my_exec_compare');
  DBMS_SQLTUNE.EXECUTE_TUNING_TASK(spa_task_name =&gt; 'my_spa_task');
END;
/
</pre>
<p>This example creates and executes a SQL tuning task to tune the SQL statements that regressed in the compare performance execution named <code>my_exec_compare</code> of the SQL Performance Analyzer task named <code>my_spa_task</code>. In this case, it is important to use this version of the <code>CREATE_TUNING_TASK</code> function call. Otherwise, SQL statements may be tuned in the environment from the production system where they were captured, which will not reflect the system change.</p>
<div class="infobox-note">
<p class="notep1">Note:</p>
If you chose to execute the SQL workload remotely on a separate database, you should not use this version of the <code>CREATE_TUNING_TASK</code> function call to tune regressed SQL statements. Instead, you should tune any regressions identified by the SQL trials on the remote database, because the application schema is not on the database running SQL Performance Analyzer. Therefore, you need to run SQL Tuning Advisor on the database where the schema resides and where the change was made. For more information, see <a href="#CHDHGFEH">"Tuning Regressed SQL Statements From a Remote SQL Trial Using APIs"</a>.</div>
<p><a href="#CHDCFJAH">Table 6-1</a> lists the SQL Performance Analyzer parameters that can be used with the <code>DBMS_SQLTUNE</code>.<code>CREATE_TUNING_TASK</code> function.</p>
<div id="RATUG295" class="tblformal">
<p class="titleintable"><a id="sthref83"></a><a id="CHDCFJAH"></a>Table 6-1 CREATE_TUNING_TASK Function SQL Performance Analyzer Parameters</p>
<table class="cellalignment1812" title="CREATE_TUNING_TASK Function SQL Performance Analyzer Parameters" summary="List the SQL Performance Analyzer parameters for the DBMS_SQLTUNE.CREATE_TUNING_TASK function and their descriptions" dir="ltr">
<thead>
<tr class="cellalignment1799">
<th class="cellalignment1809" id="r1c1-t14">Parameter</th>
<th class="cellalignment1809" id="r1c2-t14">Description</th>
</tr>
</thead>
<tbody>
<tr class="cellalignment1799">
<td class="cellalignment1805" id="r2c1-t14" headers="r1c1-t14">
<p><code>SPA_TASK_NAME</code></p>
</td>
<td class="cellalignment1805" headers="r2c1-t14 r1c2-t14">
<p>Name of the SQL Performance Analyzer task.</p>
</td>
</tr>
<tr class="cellalignment1799">
<td class="cellalignment1805" id="r3c1-t14" headers="r1c1-t14">
<p><code>SPA_TASK_OWNER</code></p>
</td>
<td class="cellalignment1805" headers="r3c1-t14 r1c2-t14">
<p>Owner of the specified SQL Performance Analyzer task. If unspecified, this parameter will default to the current user.</p>
</td>
</tr>
<tr class="cellalignment1799">
<td class="cellalignment1805" id="r4c1-t14" headers="r1c1-t14">
<p><code>SPA_COMPARE_EXEC</code></p>
</td>
<td class="cellalignment1805" headers="r4c1-t14 r1c2-t14">
<p>Execution name of the compare performance trial for the specified SQL Performance Analyzer task. If unspecified, this parameter defaults to the most recent execution of the <code>COMPARE PERFORMANCE</code> type for the given SQL Performance Analyzer task.</p>
</td>
</tr>
</tbody>
</table>
<br /></div>
<!-- class="tblformal" -->
<p>After tuning the regressed SQL statements, you should test these changes using SQL Performance Analyzer. Run a new SQL trial on the test system, followed by a second comparison (between this new SQL trial and the first SQL trial) to validate your results. Once SQL Performance Analyzer shows that performance has stabilized, implement the fixes from this step to your production system.</p>
<p>Starting with Oracle Database 11<span class="italic">g</span> Release 2, SQL Tuning Advisor performs an alternative plan analysis when tuning a SQL statement. SQL Tuning Advisor reviews the execution history of the SQL statement, including any historical plans stored in the Automatic Workload Repository. If SQL Tuning Advisor finds alternate plans, it allows you to choose a specific plan and create a plan baseline to ensure that the desired execution plan is used for that SQL statement.</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<ul>
<li>
<p><a class="olink PFGRF028" href="../../server.112/e41573/sql_tune.htm#PFGRF028"><span class="italic">Oracle Database Performance Tuning Guide</span></a> for information about using the SQL Tuning Advisor</p>
</li>
<li>
<p><a class="olink PFGRF95155" href="../../server.112/e41573/sql_tune.htm#PFGRF95155"><span class="italic">Oracle Database Performance Tuning Guide</span></a> for information about alternative plan analysis</p>
</li>
<li>
<p><a class="olink ARPLS220" href="../../appdev.112/e40758/d_sqltun.htm#ARPLS220"><span class="italic">Oracle Database PL/SQL Packages and Types Reference</span></a> for information about the <code>DBMS_SQLTUNE</code> package</p>
</li>
</ul>
</div>
</div>
<!-- class="sect2" -->
<a id="CHDHGFEH"></a>
<div id="RATUG309" class="sect2"><!-- infolevel="all" infotype="General" -->
<h3 class="sect2"><span class="secnum">6.2.5</span> Tuning Regressed SQL Statements From a Remote SQL Trial Using APIs</h3>
<p>If you chose to execute the SQL workload remotely on a separate database, then you should tune any regressions identified by the SQL trials on the remote database, instead of the system where the SQL Performance Analyzer task resides.</p>
<p>To tune <a id="sthref84"></a>regressed SQL statements from a remote SQL trial:</p>
<ol>
<li>
<p>On the system running SQL Performance Analyzer, create a subset of the regressed SQL statements as a SQL tuning set:</p>
<pre>
DECLARE
  sqlset_cur  DBMS_SQLTUNE.SQLSET_CURSOR;
BEGIN
  DBMS_SQLTUNE.CREATE_SQLSET('SUB_STS1', 'test purpose');
 
  OPEN sqlset_cur FOR
    SELECT value(p)
    FROM table(
      DBMS_SQLTUNE.SELECT_SQLPA_TASK(
        task_name  =&gt; 'SPA_TASK1',
        execution_name =&gt; 'COMP',
        level_filter =&gt; 'REGRESSED')) p;
   
  DBMS_SQLTUNE.LOAD_SQLSET('SUB_STS1', sqlset_cur);
 
  CLOSE sqlset_cur;
END;
/
</pre>
<p>Other than <code>'REGRESSED'</code>, you can use other filters to select SQL statements for the SQL tuning set, such as <code>'CHANGED'</code>, <code>'ERRORS'</code>, or <code>'CHANGED_PLANS'</code>. For more information, see <a class="olink ARPLS73150" href="../../appdev.112/e40758/d_sqltun.htm#ARPLS73150"><span class="italic">Oracle Database PL/SQL Packages and Types Reference</span></a>.</p>
</li>
<li>
<p>Create a staging table to where the SQL tuning set will be exported:</p>
<pre>
BEGIN
  DBMS_SQLTUNE.CREATE_STGTAB_SQLSET(
    table_name  =&gt; 'STG_TAB1',
    schema_name =&gt; 'JOHNDOE',
    tablespace_name =&gt; 'TBS_1',
    db_version =&gt; DBMS_SQLTUNE.STS_STGTAB_11_1_VERSION);
END;
/
</pre>
<p>Use the <code>db_version</code> parameter to specify the appropriate database version to where the SQL tuning set will be exported and tuned. In this example, the staging table will be created with a format so that it can be exported to a system running Oracle Database 11<span class="italic">g</span> Release 1, where it will later be tuned using SQL Tuning Advisor. For other database versions, see <a class="olink ARPLS" href="../../appdev.112/e40758/toc.htm"><span class="italic">Oracle Database PL/SQL Packages and Types Reference</span></a> for that release.</p>
</li>
<li>
<p>Export the SQL tuning set into the staging table:</p>
<pre>
BEGIN
  DBMS_SQLTUNE.PACK_STGTAB_SQLSET(
    sqlset_name =&gt; 'SUB_STS1', 
    sqlset_owner =&gt; 'JOHNDOE', 
    staging_table_name =&gt; 'STG_TAB1', 
    staging_schema_owner =&gt; 'JOHNDOE', 
    db_version =&gt; DBMS_SQLTUNE.STS_STGTAB_11_1_VERSION);
END;
/
</pre></li>
<li>
<p>Move the staging table to the remote database (where the SQL workload was executed) using the mechanism of choice (such as Oracle Data Pump or database link).</p>
</li>
<li>
<p>On the remote database, import the SQL tuning set from the staging table:</p>
<pre>
BEGIN
  DBMS_SQLTUNE.UNPACK_STGTAB_SQLSET(
    sqlset_name =&gt; 'SUB_STS1', 
    staging_table_name =&gt; 'STG_TAB1', 
    replace =&gt; TRUE);
END;
/
</pre></li>
<li>
<p>Tune the regressed SQL statements in the SQL tuning set by running SQL Tuning Advisor:</p>
<pre>
BEGIN
  sts_name  := 'SUB_STS1';
  sts_owner := 'JOHNDOE';
  tune_task_name := 'TUNE_TASK1';
  tname := DBMS_SQLTUNE.CREATE_TUNING_TASK(sqlset_name  =&gt; sts_name, 
                                           sqlset_owner =&gt; sts_owner, 
                                           task_name    =&gt; tune_task_name);
  EXEC DBMS_SQLTUNE.SET_TUNING_TASK_PARAMETER(:tname, 
                                              'APPLY_CAPTURED_COMPILENV', 
                                              'FALSE');
  exec_name := DBMS_SQLTUNE.EXECUTE_TUNING_TASK(tname);
END;
/
</pre>
<div class="infobox-note">
<p class="notep1">Note:</p>
The <code>APPLY_CAPTURED_COMPILENV</code> parameter used in this example is only supported by Oracle Database 11<span class="italic">g</span> Release 1 and newer releases. If you are testing a database upgrade from an earlier version of Oracle Database, SQL Tuning Advisor will use the environment variables stored in the SQL tuning set instead.</div>
</li>
</ol>
<p>After tuning the regressed SQL statements, you should test these changes using SQL Performance Analyzer. Run a new SQL trial on the test system, followed by a second comparison (between this new SQL trial and the first SQL trial) to validate your results. Once SQL Performance Analyzer shows that performance has stabilized, implement the fixes from this step to your production system.</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<ul>
<li>
<p><a class="olink PFGRF028" href="../../server.112/e41573/sql_tune.htm#PFGRF028"><span class="italic">Oracle Database Performance Tuning Guide</span></a> for information about using the SQL Tuning Advisor and transporting SQL tuning sets</p>
</li>
<li>
<p><a class="olink ARPLS220" href="../../appdev.112/e40758/d_sqltun.htm#ARPLS220"><span class="italic">Oracle Database PL/SQL Packages and Types Reference</span></a> for information about the <code>DBMS_SQLTUNE</code> package</p>
</li>
</ul>
</div>
</div>
<!-- class="sect2" -->
<a id="CHDBFJIE"></a>
<div id="RATUG310" class="sect2"><!-- infolevel="all" infotype="General" -->
<h3 class="sect2"><span class="secnum">6.2.6</span> Creating SQL Plan Baselines Using APIs</h3>
<p>Creating <a id="sthref85"></a>SQL plan baselines for regressed SQL statements with plan changes is another option to running the SQL Tuning Advisor. Doing so instructs the optimizer to use the original execution plans for these SQL statements in the future.</p>
<p>To create SQL plan baselines for the original plans, first create a subset of a SQL tuning set of only the regressed SQL statements. Next, create SQL plan baselines for this subset of SQL statements by loading their plans using the <a id="sthref86"></a><code>LOAD_PLANS_FROM_SQLSET</code> function of the <code>DBMS_SPM</code> package, as shown in the following example:</p>
<pre>
DECLARE
  my_plans PLS_INTEGER;
BEGIN
  my_plans := DBMS_SPM.LOAD_PLANS_FROM_SQLSET(
    sqlset_name =&gt; 'regressed_sql');
END;
/
</pre>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<ul>
<li>
<p><a class="olink PFGRF007" href="../../server.112/e41573/optplanmgmt.htm#PFGRF007"><span class="italic">Oracle Database Performance Tuning Guide</span></a> for information about using SQL plan baselines</p>
</li>
<li>
<p><a class="olink ARPLS150" href="../../appdev.112/e40758/d_spm.htm#ARPLS150"><span class="italic">Oracle Database PL/SQL Packages and Types Reference</span></a> for information about the <code>DBMS_SPM</code> package</p>
</li>
</ul>
</div>
</div>
<!-- class="sect2" -->
<a id="CACHDBCH"></a>
<div id="RATUG209" class="sect2"><!-- infolevel="all" infotype="General" -->
<h3 class="sect2"><span class="secnum">6.2.7</span> Using SQL Performance Analyzer Views</h3>
<p>You can query the following views to monitor <a id="sthref87"></a>SQL Performance Analyzer and view its analysis results:</p>
<div class="infobox-note">
<p class="notep1">Note:</p>
The information available in these views are also contained in the SQL Performance Analyzer report. It is recommended that you use the SQL Performance Analyzer report to view analysis results instead. Consider using these views only for performing more advanced analysis of the results.</div>
<ul>
<li>
<p>The <code>DBA_ADVISOR_TASKS</code> and <code>USER_ADVISOR_TASKS</code> views display descriptive information about the SQL Performance Analyzer task that was created.</p>
</li>
<li>
<p>The <code>DBA_ADVISOR_EXECUTIONS</code> and <code>USER_ADVISOR_EXECUTIONS</code> views display information about task executions. SQL Performance Analyzer creates at least three executions to analyze the SQL performance impact caused by a database change on a SQL workload. The first execution collects a pre-change version of the performance data. The second execution collects a post-change version of the performance data. The third execution performs the comparison analysis.</p>
</li>
<li>
<p>The <code>DBA_ADVISOR_FINDINGS</code> and <code>USER_ADVISOR_FINDINGS</code> views display the SQL Performance Analyzer findings. SQL Performance Analyzer generates the following types of findings:</p>
<ul>
<li>
<p>Problems, such as performance regression</p>
</li>
<li>
<p>Symptoms, such as when the structure of an execution plan has changed</p>
</li>
<li>
<p>Errors, such as nonexistence of an object or view</p>
</li>
<li>
<p>Informative messages, such as when the structure of an execution plan in the pre-change version is different than the one stored in the SQL tuning set</p>
</li>
</ul>
</li>
<li>
<p>The <code>DBA_ADVISOR_SQLPLANS</code> and <code>USER_ADVISOR_SQLPLANS</code> views display a list of all execution plans.</p>
</li>
<li>
<p>The <code>DBA_ADVISOR_SQLSTATS</code> and <code>USER_ADVISOR_SQLSTATS</code> views display a list of all SQL compilations and execution statistics.</p>
</li>
<li>
<p>The <code>V$ADVISOR_PROGRESS</code> view displays the operation progress of SQL Performance Analyzer. Use this view to monitor how many SQL statements have completed or are awaiting execution in a SQL trial. The <code>SOFAR</code> column indicates the number of SQL statements processed so far, and the <code>TOTAL WORK</code> column shows the total number of SQL statements to be processed by the task execution.</p>
</li>
</ul>
<p>You must have the <code>SELECT_CATALOG_ROLE</code> role to access the DBA views.</p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<ul>
<li>
<p><a class="olink REFRN" href="../e40402/toc.htm"><span class="italic">Oracle Database Reference</span></a> for information about the <code>DBA_ADVISOR_TASKS</code>, <code>DBA_ADVISOR_EXECUTIONS</code>, and <code>DBA_ADVISOR_SQLPLANS</code> views</p>
</li>
</ul>
</div>
</div>
<!-- class="sect2" --></div>
<!-- class="sect1" --></div>
<!-- class="chapter" --></div>
<!-- class="ind" -->
<!-- Start Footer -->
</div>
<!-- add extra wrapper close div-->
<footer><!--
<hr />
<table class="cellalignment1798">
<tr>
<td class="cellalignment1805">
<table class="cellalignment1803">
<tr>
<td class="cellalignment1802"><a href="spa_post_change.htm"><img width="24" height="24" src="../../dcommon/gifs/leftnav.gif" alt="Go to previous page" /><br />
<span class="icon">Previous</span></a></td>
<td class="cellalignment1802"><a href="spa_upgrade.htm"><img width="24" height="24" src="../../dcommon/gifs/rightnav.gif" alt="Go to next page" /><br />
<span class="icon">Next</span></a></td>
</tr>
</table>
</td>
<td class="cellalignment-copyrightlogo"><img width="144" height="18" src="../../dcommon/gifs/oracle.gif" alt="Oracle" /><br />
Copyright&nbsp;&copy;&nbsp;2008, 2014,&nbsp;Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved.<br />
<a href="../../dcommon/html/cpyr.htm">Legal Notices</a></td>
<td class="cellalignment1807">
<table class="cellalignment1801">
<tr>
<td class="cellalignment1802"><a href="../../index.htm"><img width="24" height="24" src="../../dcommon/gifs/doclib.gif" alt="Go to Documentation Home" /><br />
<span class="icon">Home</span></a></td>
<td class="cellalignment1802"><a href="../../nav/portal_booklist.htm"><img width="24" height="24" src="../../dcommon/gifs/booklist.gif" alt="Go to Book List" /><br />
<span class="icon">Book List</span></a></td>
<td class="cellalignment1802"><a href="toc.htm"><img width="24" height="24" src="../../dcommon/gifs/toc.gif" alt="Go to Table of Contents" /><br />
<span class="icon">Contents</span></a></td>
<td class="cellalignment1802"><a href="index.htm"><img width="24" height="24" src="../../dcommon/gifs/index.gif" alt="Go to Index" /><br />
<span class="icon">Index</span></a></td>
<td class="cellalignment1802"><a href="../../nav/mindx.htm"><img width="24" height="24" src="../../dcommon/gifs/masterix.gif" alt="Go to Master Index" /><br />
<span class="icon">Master Index</span></a></td>
<td class="cellalignment1802"><a href="../../dcommon/html/feedback.htm"><img width="24" height="24" src="../../dcommon/gifs/feedbck2.gif" alt="Go to Feedback page" /><br />
<span class="icon">Contact Us</span></a></td>
</tr>
</table>
</td>
</tr>
</table>
--></footer>
<noscript>
<p>Scripting on this page enhances content navigation, but does not change the content in any way.</p>
</noscript>
</body>
</html>
