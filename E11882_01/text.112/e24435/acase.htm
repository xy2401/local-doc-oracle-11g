<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta charset="utf-8">
<title>CONTEXT Query Application</title>
<meta name="generator" content="Oracle DARB XHTML Converter (Mode = document) - Version 5.1.2 Build 748" />
<meta name="dcterms.created" content="2014-02-11T12:39:53Z" />
<meta name="robots" content="all" />
<meta name="dcterms.title" content="Text Application Developer's Guide" />
<meta name="dcterms.identifier" content="E24435-03" />
<meta name="dcterms.isVersionOf" content="CCAPP" />
<meta name="dcterms.rights" content="Copyright&nbsp;&copy;&nbsp;2004, 2014,&nbsp;Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved." />
<link rel="Start" href="../../index.htm" title="Home" type="text/html" />
<link rel="Copyright" href="../../dcommon/html/cpyr.htm" title="Copyright" type="text/html" />

<script type="application/javascript"  src="../../dcommon/js/headfoot.js"></script>
<script type="application/javascript"  src="../../nav/js/doccd.js"></script>
<link rel="Contents" href="toc.htm" title="Contents" type="text/html" />
<link rel="Index" href="index.htm" title="Index" type="text/html" />
<link rel="Glossary" href="txtgloss.htm" title="Glossary" type="text/html" />
<link rel="Prev" href="cmigrt.htm" title="Previous" type="text/html" />
<link rel="Next" href="acatapp.htm" title="Next" type="text/html" />
<link rel="alternate" href="../e24435.pdf" title="PDF version" type="application/pdf" />
<link rel="schema.dcterms" href="http://purl.org/dc/terms/" />
<link rel="stylesheet" href="../../dcommon/css/fusiondoc.css">
<link rel="stylesheet" type="text/css"  href="../../dcommon/css/header.css">
<link rel="stylesheet" type="text/css"  href="../../dcommon/css/footer.css">
<link rel="stylesheet" type="text/css"  href="../../dcommon/css/fonts.css">
<link rel="stylesheet" href="../../dcommon/css/foundation.css">
<link rel="stylesheet" href="../../dcommon/css/codemirror.css">
<link rel="stylesheet" type="text/css" title="Default" href="../../nav/css/html5.css">
<link rel="stylesheet" href="../../dcommon/css/respond-480-tablet.css">
<link rel="stylesheet" href="../../dcommon/css/respond-768-laptop.css">
<link rel="stylesheet" href="../../dcommon/css/respond-1140-deskop.css">
<script type="application/javascript" src="../../dcommon/js/modernizr.js"></script>
<script type="application/javascript" src="../../dcommon/js/codemirror.js"></script>
<script type="application/javascript" src="../../dcommon/js/jquery.js"></script>
<script type="application/javascript" src="../../dcommon/js/foundation.min.js"></script>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-552992c80ef99c8d" async="async"></script>
<script type="application/javascript" src="../../dcommon/js/jqfns.js"></script>
<script type="application/javascript" src="../../dcommon/js/ohc-inline-videos.js"></script>
<!-- Add fancyBox -->
<link rel="stylesheet" href="../../dcommon/fancybox/jquery.fancybox.css?v=2.1.5" type="text/css" media="screen" />
<script type="text/javascript" src="../../dcommon/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>
<!-- Optionally add helpers - button, thumbnail and/or media -->
<link rel="stylesheet"  href="../../dcommon/fancybox/helpers/jquery.fancybox-buttons.css?v=1.0.5"  type="text/css" media="screen" />
<script type="text/javascript" src="../../dcommon/fancybox/helpers/jquery.fancybox-buttons.js?v=1.0.5"></script>
<script type="text/javascript" src="../../dcommon/fancybox/helpers/jquery.fancybox-media.js?v=1.0.6"></script>
<link rel="stylesheet"  href="../../dcommon/fancybox/helpers/jquery.fancybox-thumbs.css?v=1.0.7"  type="text/css" media="screen" />
<script type="text/javascript" src="../../dcommon/fancybox/helpers/jquery.fancybox-thumbs.js?v=1.0.7"></script>
</head>
<body>
<a href="#BEGIN" class="accessibility-top skipto" tabindex="0">Go to main content</a><header><!--
<div class="zz-skip-header"><a id="top" href="#BEGIN">Go to main content</a>--></header>
<div class="row" id="CONTENT">
<div class="IND large-9 medium-8 columns">
<a id="BEGIN" name="BEGIN"></a>
<span id="PAGE" style="display:none;">18/21</span> <!-- End Header -->
<div id="CCAPP3000" class="appendix"><a id="g637598"></a><a id="i634426"></a>
<h1 class="appendix"><span class="secnum">A</span> CONTEXT Query Application</h1>
<p><a id="sthref927"></a><a id="sthref928"></a><a id="sthref929"></a><a id="sthref930"></a>This appendix describes how to build a simple Web search application using the <code>CONTEXT</code> index type, whether by writing your own code or by using the Oracle Text Wizard. The following topics are covered:</p>
<ul>
<li>
<p><a href="#i634452">Web Query Application Overview</a></p>
</li>
<li>
<p><a href="#i634460">The PSP Web Application</a></p>
</li>
<li>
<p><a href="#i634799">The JSP Web Application</a></p>
</li>
</ul>
<a id="i634452"></a>
<div id="CCAPP9371" class="sect1">
<h2 class="sect1"><span class="secnum">A.1</span> Web Query Application Overview</h2>
<p>A common use of Oracle Text is to index HTML files on Web sites and provide search capabilities to users. The sample application in this appendix indexes a set of HTML files stored in the database and uses a Web server connected to Oracle Database to provide the search service.</p>
<p>This appendix describes two versions of the Web query application:</p>
<ul>
<li>
<p>One using PL/SQL Server Pages (PSP)</p>
</li>
<li>
<p>One using Java Server Pages (JSP)</p>
</li>
</ul>
<p>Both versions of these applications can be produced by means of a query application wizard, which produces the necessary code automatically.</p>
<p>You can view and download both the PSP and JSP application code, as well as the text query application wizard, at the Oracle Technology Network Web site:</p>
<pre>
<a href="http://www.oracle.com/technology/products/text/">http://www.oracle.com/technology/products/text</a>
</pre>
<p>The text query application wizard Web page also contains complete instructions on how to use the wizard.</p>
<p><a href="#CHDIHHGG">Figure A-1</a> shows what the JSP version of the text query application looks like. This application was created with the Oracle Text application wizard.</p>
<div id="CCAPP9528" class="figure">
<p class="titleinfigure"><a id="CHDIHHGG"></a>Figure A-1 The Text Query Application</p>
<img width="832" height="273" src="img/search01b.gif" alt="Description of Figure A-1 follows" /><br />
<a id="sthref931" href="img_text/search01b.htm">Description of "Figure A-1 The Text Query Application"</a><br />
<br /></div>
<!-- class="figure" -->
<p><a href="#CHDGCBIC">Figure A-2</a> shows the results of the text query.</p>
<div id="CCAPP9529" class="figure">
<p class="titleinfigure"><a id="CHDGCBIC"></a>Figure A-2 <a id="sthref932"></a><a id="sthref933"></a><a id="sthref934"></a><a id="sthref935"></a><a id="sthref936"></a><a id="sthref937"></a><a id="sthref938"></a>The Text Query Application with Results</p>
<img width="900" height="540" src="img/search02b.gif" alt="Description of Figure A-2 follows" /><br />
<a id="sthref939" href="img_text/search02b.htm">Description of "Figure A-2 The Text Query Application with Results"</a><br />
<br /></div>
<!-- class="figure" -->
<p>The application returns links to documents containing the search term. Each document has four links:</p>
<ul>
<li>
<p>The <span class="bold">HTML</span> link displays the document.</p>
<p>Graphics are not displayed in the filtered document. (You can see the source document for the first hit by looking at <a href="view.htm#BABCGIIH">Figure 5-1, "Sample Document for Highlighting, Gisting, and Theme Extraction"</a>.)</p>
</li>
<li>
<p>The <span class="bold">Highlight</span> link displays the document with the search term highlighted. <a href="view.htm#CEGDAJHB">Figure 5-2, "Pet Highlighted in Pet Magnet Document"</a> shows an example of highlighting.</p>
</li>
<li>
<p>The <span class="bold">Theme</span> link shows the top 50 themes associated with the document. <a href="view.htm#i1006508">Figure 5-3, "Query Application Displaying Document Themes"</a> shows an example of theme extraction.</p>
</li>
<li>
<p>The <span class="bold">Gist</span> link displays a short summary of the document. <a href="view.htm#i1006519">Figure 5-4, "Query Application Presenting Document Gist"</a> shows an example of this gisting feature.</p>
</li>
</ul>
</div>
<!-- class="sect1" -->
<a id="i634460"></a>
<div id="CCAPP9372" class="sect1">
<h2 class="sect1"><span class="secnum">A.2</span> The PSP Web Application<a id="sthref940"></a></h2>
<p>This application is based on PL/SQL server pages. <a href="#CACJEDFE">Figure A-3, "The PSP Web Application"</a> illustrates how the browser calls the PSP-stored procedure on Oracle Database through a Web server.</p>
<div id="CCAPP9530" class="figure">
<p class="titleinfigure"><a id="CACJEDFE"></a>Figure A-3 The PSP Web Application</p>
<img width="666" height="269" src="img/ccapp012.gif" alt="Description of Figure A-3 follows" /><br />
<a id="sthref941" href="img_text/ccapp012.htm">Description of "Figure A-3 The PSP Web Application"</a><br />
<br /></div>
<!-- class="figure" -->
<a id="i634473"></a>
<div id="CCAPP9373" class="sect2">
<h3 class="sect2"><span class="secnum">A.2.1</span> Web Application Prerequisites</h3>
<p>This application has the following requirements:</p>
<ul>
<li>
<p>Your Oracle Database (version 8.1.6 or higher) is up and running.</p>
</li>
<li>
<p>You have the Oracle PL/SQL gateway running.</p>
</li>
<li>
<p>You have a Web server such as Apache up and running and correctly configured to send requests to Oracle Database.</p>
</li>
</ul>
</div>
<!-- class="sect2" -->
<a id="i634479"></a>
<div id="CCAPP9374" class="sect2">
<h3 class="sect2"><span class="secnum">A.2.2</span> Building the Web Application</h3>
<p>This section describes how to build the PSP Web application.</p>
<dl>
<dd><a id="sthref942"></a></dd>
<dt class="seghead">Step 1&nbsp;&nbsp;&nbsp;Create your Text Table</dt>
<dd>
<p>You must create a text table to store your HTML files. This example creates a table called <code>search_table</code> as follows:</p>
<pre>
create table search_table (tk numeric primary key, title varchar2(2000), 
  text clob);
</pre></dd>
<dd><a id="sthref943"></a></dd>
<dt class="seghead">Step 2&nbsp;&nbsp;&nbsp;Load HTML Documents into Table Using SQL*Loader</dt>
<dd>
<p>You must load the text table with the HTML files. This example uses the control file <a href="#i634573">loader.ctl</a> to load the files named in <a href="#i634584">loader.dat</a>. The SQL*Loader statement is as follows:</p>
<pre>
% sqlldr userid=scott/tiger control=loader.ctl 
</pre></dd>
<dd><a id="sthref944"></a></dd>
<dt class="seghead">Step 3&nbsp;&nbsp;&nbsp;Create the CONTEXT index<a id="sthref945"></a><a id="sthref946"></a><a id="sthref947"></a><a id="sthref948"></a></dt>
<dd>
<p>If you are using the text query wizard: The wizard produces a script to create an index. (See the instructions on the download Web page for the wizard.) Run that script.</p>
<p>If you are not using the wizard: Index the HTML files by creating a <code>CONTEXT</code> index on the text column as follows. Because you are indexing HTML, this example uses the <code>NULL_FILTER</code> preference type for no filtering and uses the <code>HTML_SECTION_GROUP</code> type:</p>
<pre>
create index idx_search_table on search_table(text)
  indextype is ctxsys.context parameters
  ('filter ctxsys.null_filter section group CTXSYS.HTML_SECTION_GROUP');
</pre></dd>
<dd><a id="sthref949"></a></dd>
<dt class="seghead">Step 4&nbsp;&nbsp;&nbsp;Compile search_htmlservices Package in Oracle Database</dt>
<dd>
<p>The application must present selected documents to the user. To do so, Oracle Database must read the documents from the <code>CLOB</code> in <code>search_table</code> and output the result for viewing, This is done by calling procedures in the search_htmlservices package. The file <a href="#i634617">search_htmlservices.sql</a> must be compiled. You can do this at the SQL*Plus prompt:</p>
<pre>
SQL&gt; @search_htmlservices.sql

Package created.
</pre></dd>
<dd><a id="sthref950"></a></dd>
<dt class="seghead">Step 5&nbsp;&nbsp;&nbsp;Compile the search_html PSP page with loadpsp</dt>
<dd>
<p>The search page is invoked by calling <a href="#i634707">search_html.psp</a> from a browser. You compile search_html in Oracle Database with the <code>loadpsp</code> command-line program:</p>
<pre>
% loadpsp -replace -user scott/tiger search_html.psp
"search_html.psp": procedure "search_html" created.
</pre>
<div class="infoboxnotealso">
<p class="notep1"><span class="bold">See Also</span>:</p>
<a class="olink ADFNS" href="../../appdev.112/e41502/toc.htm"><span class="italic">Oracle Database Advanced Application Developer's Guide</span></a> for more information about using PSP</div>
</dd>
<dd><a id="sthref951"></a></dd>
<dt class="seghead">Step 6&nbsp;&nbsp;&nbsp;Configure Your Web Server</dt>
<dd>
<p>You must configure your Web server to accept client PSP requests as a URL. Your Web server forwards these requests to Oracle Database and returns server output to the browser. See <a href="#CACJEDFE">Figure A-3</a>.</p>
<p>You can use the Oracle WebDB Web listener or Oracle Application Server, which includes the Apache Web server. See your Web server documentation for more information.</p>
</dd>
<dd><a id="sthref952"></a></dd>
<dt class="seghead">Step 7&nbsp;&nbsp;&nbsp;Enter Query from Browser</dt>
<dd>
<p>You can access the query application from a browser using a URL. You configure the URL with your Web server. An example URL might look like:</p>
<pre>
http://server.example.com:7777/mypath/search_html
</pre>
<p>The application displays a query entry box in your browser and returns the query results as a list of HTML links, as shown in <a href="#CHDIHHGG">Figure A-1</a> and <a href="#CHDGCBIC">Figure A-2</a>.</p>
</dd>
</dl>
</div>
<!-- class="sect2" -->
<a id="i635065"></a>
<div id="CCAPP9375" class="sect2">
<h3 class="sect2"><span class="secnum">A.2.3</span> PSP Sample Code</h3>
<p>This section lists the code used to build the example Web application. It includes the following files:</p>
<ul>
<li>
<p><a href="#i634573">loader.ctl</a></p>
</li>
<li>
<p><a href="#i634584">loader.dat</a></p>
</li>
<li>
<p><a href="#i634617">search_htmlservices.sql</a></p>
</li>
<li>
<p><a href="#i634707">search_html.psp</a></p>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<code><a href="http://www.oracle.com/technology/products/text/">http://www.oracle.com/technology/products/text/</a></code></div>
</li>
</ul>
<a id="i634573"></a>
<div id="CCAPP9376" class="sect3">
<h4 class="sect3"><span class="secnum">A.2.3.1</span> loader.ctl</h4>
<p>This example shows a sample <code>loader.ctl</code> file. It is used by <code>sqlldr</code> to load the data file, <code>loader.dat</code>.</p>
<pre>
LOAD DATA 
        INFILE 'loader.dat'
        INTO TABLE search_table 
        REPLACE 
        FIELDS TERMINATED BY ';'
        (tk             INTEGER,
         title          CHAR,
         text_file      FILLER CHAR,
         text           LOBFILE(text_file) TERMINATED BY EOF)
</pre></div>
<!-- class="sect3" -->
<a id="i634584"></a>
<div id="CCAPP9377" class="sect3">
<h4 class="sect3"><span class="secnum">A.2.3.2</span> loader.dat</h4>
<p>This example shows a sample <code>loader.dat</code> file. Each row contains three fields: a reference number for the document, a label (or "title"), and the name of the HTML document to load into the text column of <code>search_table</code>. The file has been truncated for this example.</p>
<pre>
1;   Pizza Shredder;Pizza.html
2;   Refrigerator w/ Front-Door Auto Cantaloupe Dispenser;Cantaloupe.html
3;   Self-Tipping Couch;Couch.html
4;   Home Air Dirtier;Mess.html
5;   Set of Pet Magnets;Pet.html
6;   Esteem-Building Talking Pillow;Snooze.html
      . . .
28;   Shaggy Found Inspiration For Success In Jamaica ;shaggy_found.html
29;   Solar Flare Eruptions Likely ;solar_flare.html
30;   Supersonic Plane Breaks Food Barrier ;food_barrier.html
31;   SOUNDSCAN REPORT: Recipe for An Aspiring Top Ten;urban_groove_1.html
      . . .
</pre></div>
<!-- class="sect3" -->
<a id="i634617"></a>
<div id="CCAPP9378" class="sect3">
<h4 class="sect3"><span class="secnum">A.2.3.3</span> search_htmlservices.sql</h4>
<pre>
set define off
create or replace package search_htmlServices as
  procedure showHTMLDoc (p_id in numeric);
  procedure showDoc  (p_id in varchar2, p_query in varchar2);
end;
/
show errors;

create or replace package body search_htmlServices as

  procedure showHTMLDoc (p_id in numeric) is
    v_clob_selected   CLOB;
    v_read_amount     integer;
    v_read_offset     integer;
    v_buffer          varchar2(32767);
   begin


     select text into v_clob_selected from search_table where tk = p_id;
     v_read_amount := 32767;
     v_read_offset := 1;
   begin
    loop
      dbms_lob.read(v_clob_selected,v_read_amount,v_read_offset,v_buffer);
      htp.print(v_buffer);
      v_read_offset := v_read_offset + v_read_amount;
      v_read_amount := 32767;
    end loop;
   exception
   when no_data_found then
     null;
   end;
 end showHTMLDoc;


procedure showDoc (p_id in varchar2, p_query in varchar2) is

 v_clob_selected   CLOB;
 v_read_amount     integer;
 v_read_offset     integer;
 v_buffer          varchar2(32767);
 v_query           varchar(2000);
 v_cursor          integer;

 begin
   htp.p('&lt;html&gt;&lt;title&gt;HTML version with highlighted terms&lt;/title&gt;');
   htp.p('&lt;body bgcolor="#ffffff"&gt;');
   htp.p('&lt;b&gt;HTML version with highlighted terms&lt;/b&gt;');

   begin
     ctx_doc.markup (index_name =&gt; 'idx_search_table',
                     textkey    =&gt; p_id,
                     text_query =&gt; p_query,
                     restab     =&gt; v_clob_selected,
                     starttag   =&gt; '&lt;i&gt;&lt;font color=red&gt;',
                     endtag     =&gt; '&lt;/font&gt;&lt;/i&gt;');

     v_read_amount := 32767;
     v_read_offset := 1;
     begin
      loop
        dbms_lob.read(v_clob_selected,v_read_amount,v_read_offset,v_buffer);
        htp.print(v_buffer);
        v_read_offset := v_read_offset + v_read_amount;
        v_read_amount := 32767;
      end loop;
     exception
      when no_data_found then
         null;
     end;

     exception
      when others then
        null; --showHTMLdoc(p_id);
   end;
end showDoc;
end;
/
show errors


set define on
</pre></div>
<!-- class="sect3" -->
<a id="i634707"></a>
<div id="CCAPP9379" class="sect3">
<h4 class="sect3"><span class="secnum">A.2.3.4</span> search_html.psp</h4>
<pre>
&lt;%@ plsql procedure="search_html" %&gt;
&lt;%@ plsql parameter="query" default="null" %&gt;
&lt;%! v_results numeric := 0; %&gt;

&lt;html&gt;
&lt;head&gt;
  &lt;title&gt;search_html Search &lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;

&lt;%

If query is null Then
%&gt;

  &lt;center&gt;
    &lt;form method=post action="search_html"&gt;
     &lt;b&gt;Search for: &lt;/b&gt;
     &lt;input type=text name="query" size=30&gt;&amp;nbsp;
     &lt;input type=submit value=Search&gt;
  &lt;/center&gt;
&lt;hr&gt;

&lt;% 
  Else
%&gt;

   &lt;p&gt;
   &lt;%!
      color varchar2(6) := 'ffffff';
   %&gt;

   &lt;center&gt;
     &lt;form method=post action="search_html"&gt;
      &lt;b&gt;Search for:&lt;/b&gt;
      &lt;input type=text name="query" size=30 value="&lt;%= query %&gt;"&gt;
      &lt;input type=submit value=Search&gt;
     &lt;/form&gt;
   &lt;/center&gt;
   &lt;hr&gt;
   &lt;p&gt;

   &lt;%
     -- select statement 
    for doc in (
                select /*+ DOMAIN_INDEX_SORT */ rowid, tk, title, score(1) scr
                from search_table
                where contains(text, query,1) &gt;0
                order by score(1) desc
               ) 
         loop
           v_results := v_results + 1;
           if v_results = 1 then

   %&gt;

             &lt;center&gt;
              &lt;table border="0"&gt;
                &lt;tr bgcolor="#6699CC"&gt;
                  &lt;th&gt;Score&lt;/th&gt;
                  &lt;th&gt;Title&lt;/th&gt;
                &lt;/tr&gt;

  &lt;%      end if; %&gt;
          &lt;tr bgcolor="#&lt;%= color %&gt;"&gt;
           &lt;td&gt; &lt;%= doc.scr %&gt;% &lt;/td&gt;
           &lt;td&gt; &lt;%= doc.title %&gt;
           [&lt;a href="search_htmlServices.showHTMLDoc?p_id=
                  &lt;%= doc.tk %&gt;"&gt;HTML&lt;/a&gt;]
           [&lt;a href="search_htmlServices.showDoc?p_id=
                  &lt;%= doc.tk %&gt;&amp;p_query=&lt;%= query %&gt;"&gt;Highlight&lt;/a&gt;]
           &lt;/td&gt;
         &lt;/tr&gt;

   &lt;%
          if (color = 'ffffff') then
               color := 'eeeeee';
             else
               color := 'ffffff';
          end if;

     end loop; 
   %&gt;

    &lt;/table&gt;
   &lt;/center&gt;

&lt;% 
  end if;
%&gt;
&lt;/body&gt;&lt;/html&gt;
</pre></div>
<!-- class="sect3" --></div>
<!-- class="sect2" --></div>
<!-- class="sect1" -->
<a id="i634799"></a>
<div id="CCAPP9380" class="sect1">
<h2 class="sect1"><span class="secnum">A.3</span> The JSP Web Application</h2>
<p>Creating the JSP-based Web application involves most of the same steps as those used in building the PSP-based application (see <a href="#i634479">"Building the Web Application"</a>). You can use the same <code>loader.dat</code> and <code>loader.ctl</code> files. However, with the JSP-based application, you do not need to do the following:</p>
<ul>
<li>
<p>Compile the <code>search_htmlservices</code> package</p>
</li>
<li>
<p>Compile the <code>search_html</code> PSP page with <code>loadpsp</code></p>
</li>
</ul>
<div id="CCAPP9381" class="sect2"><a id="sthref953"></a>
<h3 class="sect2"><span class="secnum">A.3.1</span> Web Application Prerequisites</h3>
<p>This application has the following requirements:</p>
<ul>
<li>
<p>Your Oracle database (version 8.1.6 or higher) is up and running.</p>
</li>
<li>
<p>You have a Web server such as Apache up and running and correctly configured to send requests to Oracle Database.</p>
</li>
</ul>
</div>
<!-- class="sect2" -->
<div id="CCAPP9382" class="sect2"><a id="sthref954"></a>
<h3 class="sect2"><span class="secnum">A.3.2</span> JSP Sample Code</h3>
<p>This section lists the Java code used to build the example Web application. It includes the following files:</p>
<ul>
<li>
<p><a href="#CIABCIHF">search_html.jsp</a></p>
<p>The code for this file was generated by the text query application wizard. (Some longer lines have been split to make the code easier to read.)</p>
</li>
</ul>
<a id="CIABCIHF"></a>
<div id="CCAPP9383" class="sect3">
<h4 class="sect3"><span class="secnum">A.3.2.1</span> search_html.jsp</h4>
<pre>
&lt;%@ page import="java.sql.*, java.util.*, java.net.*, 
   oracle.jdbc.*, oracle.jsp.dbutil.*" %&gt;
&lt;%@ page contentType="text/html;charset=UTF-8" %&gt;
&lt;% oracle.jsp.util.PublicUtil.setReqCharacterEncoding(request, "UTF-8"); %&gt;
&lt;jsp:useBean id="name" class="oracle.jsp.jml.JmlString" scope ="request" &gt;
&lt;jsp:setProperty name="name" property="value" param="query" /&gt;
&lt;/jsp:useBean&gt;
 
&lt;%
String connStr="jdbc:oracle:thin:@jsmith-pc.us.oracle.com:1521:zippy922";
 
java.util.Properties info=new java.util.Properties();
Connection conn = null;
ResultSet rset = null;
OracleCallableStatement callStmt = null;
Statement stmt = null;
String userQuery = null;
String myQuery = null;
URLEncoder myEncoder;
int count=0;
int loopNum=0;
int startNum=0;
if (name.isEmpty()) {
%&gt;
  &lt;html&gt;
    &lt;title&gt;Text Search&lt;/title&gt;
    &lt;body&gt;
      &lt;table width="100%"&gt;
        &lt;tr bgcolor="#336699"&gt;
          &lt;td&gt;&lt;font face="arial, helvetica" align="left" 
          color="#CCCC99" size=+2&gt;Text Search&lt;/td&gt;
        &lt;/tr&gt;
      &lt;/table&gt;
    &lt;center&gt;
      &lt;form method = post&gt;
      Search for:
      &lt;input type=text name=query size = 30&gt;
      &lt;input type=submit value="Search"&gt;
      &lt;/form&gt;
    &lt;/center&gt;
    &lt;/body&gt;
  &lt;/html&gt;
 
&lt;%}
 
else {
%&gt;
  &lt;html&gt;
    &lt;title&gt;Text Search&lt;/title&gt;
    &lt;body text="#000000" bgcolor="#FFFFFF" link="#663300" 
          vlink="#996633" alink="#ff6600"&gt;
      &lt;table width="100%"&gt;
        &lt;tr bgcolor="#336699"&gt;
          &lt;td&gt;&lt;font face="arial, helvetica" align="left" 
                 color="#CCCC99" size=+2&gt;Text Search&lt;/td&gt;
        &lt;/tr&gt;
      &lt;/table&gt;
    &lt;center&gt;
      &lt;form method = post action="TextSearchApp.jsp"&gt;
      Search for:
      &lt;input type=text name="query" value="&lt;%=name.getValue() %&gt;" size = 30&gt;
      &lt;input type=submit value="Search"&gt;
      &lt;/form&gt;
    &lt;/center&gt;
&lt;%
  try {
    DriverManager.registerDriver(new oracle.jdbc.driver.OracleDriver() );
    info.put ("user", "jsmith");
    info.put ("password","hello");
    conn = DriverManager.getConnection(connStr,info);
    stmt = conn.createStatement();
    userQuery =   request.getParameter("query");
    myQuery =   URLEncoder.encode(userQuery);
    String numStr =   request.getParameter("sn");
    if(numStr!=null)
      startNum=Integer.parseInt(numStr);
    String theQuery =   translate(userQuery);
    callStmt =(OracleCallableStatement)conn.prepareCall("begin "+
         "?:=ctx_query.count_hits(index_name=&gt;'ULTRA_IDX1', "+
         "text_query=&gt;?"+
         "); " +
         "end; ");
    callStmt.setString(2,theQuery);
    callStmt.registerOutParameter(1, OracleTypes.NUMBER);
    callStmt.execute();
    count=((OracleCallableStatement)callStmt).getNUMBER(1).intValue();
    if(count&gt;=(startNum+20)){
%&gt;
    &lt;font color="#336699" FACE="Arial,Helvetica" SIZE=+1&gt;Results
           &lt;%=startNum+1%&gt; - &lt;%=startNum+20%&gt; of &lt;%=count%&gt; matches
&lt;%
    }
    else if(count&gt;0){
%&gt;
    &lt;font color="#336699" FACE="Arial,Helvetica" SIZE=+1&gt;Results
           &lt;%=startNum+1%&gt; - &lt;%=count%&gt; of &lt;%=count%&gt; matches
&lt;%
    }
    else {
%&gt;
    &lt;font color="#336699" FACE="Arial,Helvetica" SIZE=+1&gt;No match found
&lt;%
    }
%&gt;
  &lt;table width="100%"&gt;
  &lt;TR ALIGN="RIGHT"&gt;
&lt;%
  if((startNum&gt;0)&amp;(count&lt;=startNum+20))
  {
%&gt;
    &lt;TD ALIGN="RIGHT"&gt;
    &lt;a href="TextSearchApp.jsp?sn=&lt;%=startNum-20 %&gt;&amp;query=
            &lt;%=myQuery %&gt;"&gt;previous20&lt;/a&gt;
    &lt;/TD&gt;
&lt;%
  }
  else if((count&gt;startNum+20)&amp;(startNum==0))
  {
%&gt;
    &lt;TD ALIGN="RIGHT"&gt;
    &lt;a href="TextSearchApp.jsp?sn=&lt;%=startNum+20 
          %&gt;&amp;query=&lt;%=myQuery %&gt;"&gt;next20&lt;/a&gt;
    &lt;/TD&gt;
&lt;%
  }
  else if((count&gt;startNum+20)&amp;(startNum&gt;0))
  {
%&gt;
    &lt;TD ALIGN="RIGHT"&gt;
    &lt;a href="TextSearchApp.jsp?sn=&lt;%=startNum-20 %&gt;&amp;query=
              &lt;%=myQuery %&gt;"&gt;previous20&lt;/a&gt;
    &lt;a href="TextSearchApp.jsp?sn=&lt;%=startNum+20 %&gt;&amp;query=
              &lt;%=myQuery %&gt;"&gt;next20&lt;/a&gt;
    &lt;/TD&gt;
&lt;%
  }
%&gt;
  &lt;/TR&gt;
  &lt;/table&gt;
&lt;%
    String ctxQuery = "select /*+ DOMAIN_INDEX_SORT */ rowid, 'TITLE',
     score(1) scr from 'ULTRA_TAB1' where contains('TEXT', '"+theQuery+"',1 )
     &gt; 0 order by score(1) desc";
    rset = stmt.executeQuery(ctxQuery);
    String color = "ffffff";
    String rowid = null;
    String fakeRowid = null;
    String[] colToDisplay = new String[1];
    int myScore = 0;
    int items = 0;
    while (rset.next()&amp;&amp;items&lt; 20) {
      if(loopNum&gt;=startNum)
      {
        rowid = rset.getString(1);
        fakeRowid = URLEncoder.encode(rowid);
        colToDisplay[0] = rset.getString(2);
        myScore = (int)rset.getInt(3);
        items++;
        if (items == 1) {
%&gt;
        &lt;center&gt;
          &lt;table BORDER=1 CELLSPACING=0 CELLPADDING=0 width="100%"
            &lt;tr bgcolor="#CCCC99"&gt;
              &lt;th&gt;&lt;font face="arial, helvetica" color="#336699"&gt;Score&lt;/th&gt;
              &lt;th&gt;&lt;font face="arial, helvetica" color="#336699"&gt;TITLE&lt;/th&gt;
              &lt;th&gt; &lt;font face="arial, helvetica" 
                       color="#336699"&gt;Document Services&lt;/th&gt;
            &lt;/tr&gt;
&lt;%   } %&gt;
      &lt;tr bgcolor="#FFFFE0"&gt;
        &lt;td ALIGN="CENTER"&gt; &lt;%= myScore %&gt;%&lt;/td&gt;
        &lt;td&gt; &lt;%= colToDisplay[0] %&gt;
        &lt;td&gt;
        &lt;/td&gt;
      &lt;/tr&gt;
&lt;%
      if (color.compareTo("ffffff") == 0)
        color = "eeeeee";
      else
        color = "ffffff";
      }
      loopNum++;
    }
} catch (SQLException e) {
%&gt;
    &lt;b&gt;Error: &lt;/b&gt; &lt;%= e %&gt;&lt;p&gt;
&lt;%
} finally {
  if (conn != null) conn.close();
  if (stmt != null) stmt.close();
  if (rset != null) rset.close();
  }
%&gt;
  &lt;/table&gt;
  &lt;/center&gt;
  &lt;table width="100%"&gt;
  &lt;TR ALIGN="RIGHT"&gt;
&lt;%
  if((startNum&gt;0)&amp;(count&lt;=startNum+20))
  {
%&gt;
    &lt;TD ALIGN="RIGHT"&gt;
    &lt;a href="TextSearchApp.jsp?sn=&lt;%=startNum-20 %&gt;&amp;query=
               &lt;%=myQuery %&gt;"&gt;previous20&lt;/a&gt;
    &lt;/TD&gt;
&lt;%
  }
  else if((count&gt;startNum+20)&amp;(startNum==0))
  {
%&gt;
    &lt;TD ALIGN="RIGHT"&gt;
    &lt;a href="TextSearchApp.jsp?sn=&lt;%=startNum+20 %&gt;&amp;query=
          &lt;%=myQuery %&gt;"&gt;next20&lt;/a&gt;
    &lt;/TD&gt;
&lt;%
  }
  else if((count&gt;startNum+20)&amp;(startNum&gt;0))
  {
%&gt;
    &lt;TD ALIGN="RIGHT"&gt;
    &lt;a href="TextSearchApp.jsp?sn=&lt;%=startNum-20 %&gt;&amp;query=
          &lt;%=myQuery %&gt;"&gt;previous20&lt;/a&gt;
    &lt;a href="TextSearchApp.jsp?sn=&lt;%=startNum+20 %&gt;&amp;query=
          &lt;%=myQuery %&gt;"&gt;next20&lt;/a&gt;
    &lt;/TD&gt;
&lt;%
  }
%&gt;
  &lt;/TR&gt;
  &lt;/table&gt;
  &lt;/body&gt;&lt;/html&gt;
&lt;%}
 
%&gt;
&lt;%!
   public String translate (String input)
   {
      Vector reqWords = new Vector();
      StringTokenizer st = new StringTokenizer(input, " '", true);
      while (st.hasMoreTokens())
      {
        String token = st.nextToken();
        if (token.equals("'"))
        {
           String phrase = getQuotedPhrase(st);
           if (phrase != null)
           {
              reqWords.addElement(phrase);
           }
        }
        else if (!token.equals(" "))
        {
           reqWords.addElement(token);
        }
      }
      return getQueryString(reqWords);
   }
 
   private String getQuotedPhrase(StringTokenizer st)
   {
      StringBuffer phrase = new StringBuffer();
      String token = null;
      while (st.hasMoreTokens() &amp;&amp; (!(token = st.nextToken()).equals("'")))
      {
        phrase.append(token);
      }
      return phrase.toString();
   }
 
 
   private String getQueryString(Vector reqWords)
   {
      StringBuffer query = new StringBuffer("");
      int length = (reqWords == null) ? 0 : reqWords.size();
      for (int ii=0; ii &lt; length; ii++)
      {
         if (ii != 0)
         {
           query.append(" &amp; ");
         }
         query.append("{");
         query.append(reqWords.elementAt(ii));
         query.append("}");
      }
      return query.toString();
   }
%&gt;
</pre></div>
<!-- class="sect3" --></div>
<!-- class="sect2" --></div>
<!-- class="sect1" --></div>
<!-- class="appendix" --></div>
<!-- class="ind" -->
<!-- Start Footer -->
</div>
<!-- add extra wrapper close div-->
<footer><!--
<hr />
<table class="cellalignment105">
<tr>
<td class="cellalignment112">
<table class="cellalignment110">
<tr>
<td class="cellalignment109"><a href="cmigrt.htm"><img width="24" height="24" src="../../dcommon/gifs/leftnav.gif" alt="Go to previous page" /><br />
<span class="icon">Previous</span></a></td>
<td class="cellalignment109"><a href="acatapp.htm"><img width="24" height="24" src="../../dcommon/gifs/rightnav.gif" alt="Go to next page" /><br />
<span class="icon">Next</span></a></td>
</tr>
</table>
</td>
<td class="cellalignment-copyrightlogo"><img width="144" height="18" src="../../dcommon/gifs/oracle.gif" alt="Oracle" /><br />
Copyright&nbsp;&copy;&nbsp;2004, 2014,&nbsp;Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved.<br />
<a href="../../dcommon/html/cpyr.htm">Legal Notices</a></td>
<td class="cellalignment114">
<table class="cellalignment108">
<tr>
<td class="cellalignment109"><a href="../../index.htm"><img width="24" height="24" src="../../dcommon/gifs/doclib.gif" alt="Go to Documentation Home" /><br />
<span class="icon">Home</span></a></td>
<td class="cellalignment109"><a href="../../nav/portal_booklist.htm"><img width="24" height="24" src="../../dcommon/gifs/booklist.gif" alt="Go to Book List" /><br />
<span class="icon">Book List</span></a></td>
<td class="cellalignment109"><a href="toc.htm"><img width="24" height="24" src="../../dcommon/gifs/toc.gif" alt="Go to Table of Contents" /><br />
<span class="icon">Contents</span></a></td>
<td class="cellalignment109"><a href="index.htm"><img width="24" height="24" src="../../dcommon/gifs/index.gif" alt="Go to Index" /><br />
<span class="icon">Index</span></a></td>
<td class="cellalignment109"><a href="../../nav/mindx.htm"><img width="24" height="24" src="../../dcommon/gifs/masterix.gif" alt="Go to Master Index" /><br />
<span class="icon">Master Index</span></a></td>
<td class="cellalignment109"><a href="../../dcommon/html/feedback.htm"><img width="24" height="24" src="../../dcommon/gifs/feedbck2.gif" alt="Go to Feedback page" /><br />
<span class="icon">Contact Us</span></a></td>
</tr>
</table>
</td>
</tr>
</table>
--></footer>
<noscript>
<p>Scripting on this page enhances content navigation, but does not change the content in any way.</p>
</noscript>
</body>
</html>
