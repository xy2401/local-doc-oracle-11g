<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta charset="utf-8">
<title>Using XML Query Result Set Interface</title>
<meta name="generator" content="Oracle DARB XHTML Converter (Mode = document) - Version 5.1.2 Build 748" />
<meta name="dcterms.created" content="2014-02-11T12:39:53Z" />
<meta name="robots" content="all" />
<meta name="dcterms.title" content="Text Application Developer's Guide" />
<meta name="dcterms.identifier" content="E24435-03" />
<meta name="dcterms.isVersionOf" content="CCAPP" />
<meta name="dcterms.rights" content="Copyright&nbsp;&copy;&nbsp;2004, 2014,&nbsp;Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved." />
<link rel="Start" href="../../index.htm" title="Home" type="text/html" />
<link rel="Copyright" href="../../dcommon/html/cpyr.htm" title="Copyright" type="text/html" />

<script type="application/javascript"  src="../../dcommon/js/headfoot.js"></script>
<script type="application/javascript"  src="../../nav/js/doccd.js"></script>
<link rel="Contents" href="toc.htm" title="Contents" type="text/html" />
<link rel="Index" href="index.htm" title="Index" type="text/html" />
<link rel="Glossary" href="txtgloss.htm" title="Glossary" type="text/html" />
<link rel="Prev" href="cthes.htm" title="Previous" type="text/html" />
<link rel="Next" href="admin.htm" title="Next" type="text/html" />
<link rel="alternate" href="../e24435.pdf" title="PDF version" type="application/pdf" />
<link rel="schema.dcterms" href="http://purl.org/dc/terms/" />
<link rel="stylesheet" href="../../dcommon/css/fusiondoc.css">
<link rel="stylesheet" type="text/css"  href="../../dcommon/css/header.css">
<link rel="stylesheet" type="text/css"  href="../../dcommon/css/footer.css">
<link rel="stylesheet" type="text/css"  href="../../dcommon/css/fonts.css">
<link rel="stylesheet" href="../../dcommon/css/foundation.css">
<link rel="stylesheet" href="../../dcommon/css/codemirror.css">
<link rel="stylesheet" type="text/css" title="Default" href="../../nav/css/html5.css">
<link rel="stylesheet" href="../../dcommon/css/respond-480-tablet.css">
<link rel="stylesheet" href="../../dcommon/css/respond-768-laptop.css">
<link rel="stylesheet" href="../../dcommon/css/respond-1140-deskop.css">
<script type="application/javascript" src="../../dcommon/js/modernizr.js"></script>
<script type="application/javascript" src="../../dcommon/js/codemirror.js"></script>
<script type="application/javascript" src="../../dcommon/js/jquery.js"></script>
<script type="application/javascript" src="../../dcommon/js/foundation.min.js"></script>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-552992c80ef99c8d" async="async"></script>
<script type="application/javascript" src="../../dcommon/js/jqfns.js"></script>
<script type="application/javascript" src="../../dcommon/js/ohc-inline-videos.js"></script>
<!-- Add fancyBox -->
<link rel="stylesheet" href="../../dcommon/fancybox/jquery.fancybox.css?v=2.1.5" type="text/css" media="screen" />
<script type="text/javascript" src="../../dcommon/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>
<!-- Optionally add helpers - button, thumbnail and/or media -->
<link rel="stylesheet"  href="../../dcommon/fancybox/helpers/jquery.fancybox-buttons.css?v=1.0.5"  type="text/css" media="screen" />
<script type="text/javascript" src="../../dcommon/fancybox/helpers/jquery.fancybox-buttons.js?v=1.0.5"></script>
<script type="text/javascript" src="../../dcommon/fancybox/helpers/jquery.fancybox-media.js?v=1.0.6"></script>
<link rel="stylesheet"  href="../../dcommon/fancybox/helpers/jquery.fancybox-thumbs.css?v=1.0.7"  type="text/css" media="screen" />
<script type="text/javascript" src="../../dcommon/fancybox/helpers/jquery.fancybox-thumbs.js?v=1.0.7"></script>
</head>
<body>
<a href="#BEGIN" class="accessibility-top skipto" tabindex="0">Go to main content</a><header><!--
<div class="zz-skip-header"><a id="top" href="#BEGIN">Go to main content</a>--></header>
<div class="row" id="CONTENT">
<div class="IND large-9 medium-8 columns">
<a id="BEGIN" name="BEGIN"></a>
<span id="PAGE" style="display:none;">15/21</span> <!-- End Header -->
<div id="CCAPP9537" class="chapter"><a id="sthref852"></a>
<h1 class="chapter"><span class="secnum">11</span> Using XML Query Result Set Interface</h1>
<p>This chapter descr<a id="sthref853"></a><a id="sthref854"></a>ibes how to use the XML query result set interface, and includes:</p>
<ul>
<li>
<p><a href="#BABFJCHB">Overview of the XML Query Result Set Interface</a></p>
</li>
<li>
<p><a href="#BABFGJEFE">Using the XML Query Result Set Interface</a></p>
</li>
</ul>
<a id="BABFJCHB"></a>
<div id="CCAPP9538" class="sect1"><!-- infolevel="all" infotype="General" -->
<h2 class="sect1"><span class="secnum">11.1</span> Overview of the XML Query Result Set Interface</h2>
<p>A page of search results in applications can consist of many disparate elements - metadata of the first few documents, total hit counts, per-word hit counts, and so on. Generating these results in earlier versions of Oracle Text required several queries and calls &mdash; perhaps a query on the base table, a call to <code>CTX_QUERY.COUNT_HITS</code>, and so on. Each extra call takes time to reparse the query and look up index metadata. Additionally, some search operations, such as iterative query refinement or breakdown top ten, are difficult for SQL. If it is even possible to construct a SQL statement to produce the desired results, such SQL is usually suboptimal.</p>
<p>The result set interface is able to produce the various kinds of data needed for a page of search results all at once, thus improving performance by sharing overhead. The result set interface can also return data views that are difficult to express in SQL, such as top <span class="italic">N</span> by category queries.</p>
</div>
<!-- class="sect1" -->
<a id="BABFGJEFE"></a>
<div id="CCAPP9539" class="sect1"><!-- infolevel="all" infotype="General" -->
<h2 class="sect1"><span class="secnum">11.2</span> Using the XML Query Result Set Interface</h2>
<p>The <code>CTX_QUERY.RESULT_SET()</code> A<a id="sthref855"></a>PI enables you to obtain query results with a single query, rather than running multiple <code>CONTAINS()</code> queries to achieve the same result. For example, in order to display a search result page, the following information needs to be obtained first:</p>
<ul>
<li>
<p>top 20 hit list sorted by date and relevancy</p>
</li>
<li>
<p>total number of hits for the given Text query</p>
</li>
<li>
<p>counts group by publication date</p>
</li>
<li>
<p>counts group by author</p>
</li>
</ul>
<p>Assume the following table definition for storing documents to be searched:</p>
<pre>
create table docs (
  docid    number,
  author   varchar2(30),
  pubdate  date,
  title    varchar2(60),  doc      clob);
</pre>
<p>Assume the following Oracle Text Index definition:</p>
<pre>
create index docidx on docs(doc) indextype is ctxsys.context
filter by author, pubdate, title,
order by pubdate;
</pre>
<p>With these definitions, you can obtain the four pieces of information for displaying the search result page by issuing four SQL statements:</p>
<pre>
-- Get top 20 hits sorted by date and relevancy
select * from
  (select /*+ first_rows */ rowid, title, author, pubdate
   from docs where contains(doc, 'oracle',1)&gt;0
   order by pubdate desc, score(1) desc)
where rownum &lt; 21;
 
-- Get total number of hits for the given Text query
select count(*) from docs where contains(doc, 'oracle',1)&gt;0;
 
-- Get counts group by publication date
select pubdate, count(*) from docs where contains(doc, 'oracle',1)&gt;0 
group by pubdate;
 
-- Get counts group by author
select author, count(*) from docs where contains(doc, 'oracle',1)&gt;0 group by author;
</pre>
<p>As you can see, using separate SQL statements results in a resource-intensive query, as you run the same query four times. However, by using <code>CTX_QUERY.RESULT_SET()</code>, you can enter all this information in one single Oracle Text query:</p>
<pre>
declare
   rs clob;
begin
   dbms_lob.createtemporary(rs, true, dbms_lob.session);
   ctx_query.result_set('docidx', 'oracle text performance tuning', '
   &lt;ctx_result_set_descriptor&gt;  
    &lt;count/&gt;
    &lt;hitlist start_hit_num="1" end_hit_num="20" order="pubDate desc, 
        score desc"&gt;
      &lt;score/&gt;
      &lt;rowid/&gt;
         &lt;sdata name="title"/&gt;
      &lt;sdata name="author"/&gt;
      &lt;sdata name="pubDate"/&gt;
    &lt;/hitlist&gt;
    &lt;group sdata="pubDate"&gt;
      &lt;count/&gt;
    &lt;/group&gt;
   &lt;group sdata="author"&gt;
     &lt;count/&gt;
   &lt;/group&gt;
  &lt;/ctx_result_set_descriptor&gt;
 ', rs);
 
-- Put in your code here to process the Output Result Set XML
   dbms_lob.freetemporary(rs);
exception
   when others then
    dbms_lob.freetemporary(rs);
    raise;
end;
/
</pre>
<p>The result set output will be an XML containing all the necessary information required to construct the search result page:</p>
<pre>
&lt;ctx_result_set&gt;
  &lt;hitlist&gt;
    &lt;hit&gt;
      &lt;score&gt;90&lt;/score&gt;
      &lt;rowid&gt;AAAPoEAABAAAMWsAAC&lt;/rowid&gt;
      &lt;sdata name="TITLE"&gt; Article 8 &lt;/sdata&gt;
      &lt;sdata name="AUTHOR"&gt;John&lt;/sdata&gt;
      &lt;sdata name="PUBDATE"&gt;2001-01-03 00:00:00&lt;/sdata&gt;
    &lt;/hit&gt;
    &lt;hit&gt;
      &lt;score&gt;86&lt;/score&gt;
      &lt;rowid&gt;AAAPoEAABAAAMWsAAG&lt;/rowid&gt;
      &lt;sdata name="TITLE"&gt; Article 20 &lt;/sdata&gt;
      &lt;sdata name="AUTHOR"&gt;John&lt;/sdata&gt;
      &lt;sdata name="PUBDATE"&gt;2001-01-03 00:00:00&lt;/sdata&gt;
    &lt;/hit&gt;
    &lt;hit&gt;
      &lt;score&gt;78&lt;/score&gt;
      &lt;rowid&gt;AAAPoEAABAAAMWsAAK&lt;/rowid&gt;
      &lt;sdata name="TITLE"&gt; Article 17 &lt;/sdata&gt;
      &lt;sdata name="AUTHOR"&gt;John&lt;/sdata&gt;
      &lt;sdata name="PUBDATE"&gt;2001-01-03 00:00:00&lt;/sdata&gt;
    &lt;/hit&gt;
    &lt;hit&gt;
      &lt;score&gt;77&lt;/score&gt;
      &lt;rowid&gt;AAAPoEAABAAAMWsAAO&lt;/rowid&gt;
      &lt;sdata name="TITLE"&gt; Article 37 &lt;/sdata&gt;
      &lt;sdata name="AUTHOR"&gt;John&lt;/sdata&gt;
      &lt;sdata name="PUBDATE"&gt;2001-01-03 00:00:00&lt;/sdata&gt;
    &lt;/hit&gt;
...
    &lt;hit&gt;
      &lt;score&gt;72&lt;/score&gt;
      &lt;rowid&gt;AAAPoEAABAAAMWsAAS&lt;/rowid&gt;
      &lt;sdata name="TITLE"&gt; Article 56 &lt;/sdata&gt;
      &lt;sdata name="AUTHOR"&gt;John&lt;/sdata&gt;
      &lt;sdata name="PUBDATE"&gt;2001-01-03 00:00:00&lt;/sdata&gt;
    &lt;/hit&gt;
  &lt;/hitlist&gt;
 
  &lt;count&gt;100&lt;/count&gt;
 
  &lt;groups sdata="PUBDATE"&gt;
    &lt;group value="2001-01-01 00:00:00"&gt;&lt;count&gt;25&lt;/count&gt;&lt;/group&gt;
    &lt;group value="2001-01-02 00:00:00"&gt;&lt;count&gt;50&lt;/count&gt;&lt;/group&gt;
    &lt;group value="2001-01-03 00:00:00"&gt;&lt;count&gt;25&lt;/count&gt;&lt;/group&gt;
  &lt;/groups&gt;
 
  &lt;groups sdata="AUTHOR"&gt;
    &lt;group value="John"&gt;&lt;count&gt;50&lt;/count&gt;&lt;/group&gt;
    &lt;group value="Mike"&gt;&lt;count&gt;25&lt;/count&gt;&lt;/group&gt;
    &lt;group value="Steve"&gt;&lt;count&gt;25&lt;/count&gt;&lt;/group&gt;
  &lt;/groups&gt;
 
&lt;/ctx_result_set&gt;
</pre>
<div class="infoboxnotealso">
<p class="notep1">See Also:</p>
<a class="olink CCREF24056" href="http://www.oracle.com/pls/topic/lookup?ctx=db112&amp;id=CCREF24056"><span class="italic">Oracle Text Reference</span></a> for syntax details and more information</div>
</div>
<!-- class="sect1" --></div>
<!-- class="chapter" --></div>
<!-- class="ind" -->
<!-- Start Footer -->
</div>
<!-- add extra wrapper close div-->
<footer><!--
<hr />
<table class="cellalignment105">
<tr>
<td class="cellalignment112">
<table class="cellalignment110">
<tr>
<td class="cellalignment109"><a href="cthes.htm"><img width="24" height="24" src="../../dcommon/gifs/leftnav.gif" alt="Go to previous page" /><br />
<span class="icon">Previous</span></a></td>
<td class="cellalignment109"><a href="admin.htm"><img width="24" height="24" src="../../dcommon/gifs/rightnav.gif" alt="Go to next page" /><br />
<span class="icon">Next</span></a></td>
</tr>
</table>
</td>
<td class="cellalignment-copyrightlogo"><img width="144" height="18" src="../../dcommon/gifs/oracle.gif" alt="Oracle" /><br />
Copyright&nbsp;&copy;&nbsp;2004, 2014,&nbsp;Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved.<br />
<a href="../../dcommon/html/cpyr.htm">Legal Notices</a></td>
<td class="cellalignment114">
<table class="cellalignment108">
<tr>
<td class="cellalignment109"><a href="../../index.htm"><img width="24" height="24" src="../../dcommon/gifs/doclib.gif" alt="Go to Documentation Home" /><br />
<span class="icon">Home</span></a></td>
<td class="cellalignment109"><a href="../../nav/portal_booklist.htm"><img width="24" height="24" src="../../dcommon/gifs/booklist.gif" alt="Go to Book List" /><br />
<span class="icon">Book List</span></a></td>
<td class="cellalignment109"><a href="toc.htm"><img width="24" height="24" src="../../dcommon/gifs/toc.gif" alt="Go to Table of Contents" /><br />
<span class="icon">Contents</span></a></td>
<td class="cellalignment109"><a href="index.htm"><img width="24" height="24" src="../../dcommon/gifs/index.gif" alt="Go to Index" /><br />
<span class="icon">Index</span></a></td>
<td class="cellalignment109"><a href="../../nav/mindx.htm"><img width="24" height="24" src="../../dcommon/gifs/masterix.gif" alt="Go to Master Index" /><br />
<span class="icon">Master Index</span></a></td>
<td class="cellalignment109"><a href="../../dcommon/html/feedback.htm"><img width="24" height="24" src="../../dcommon/gifs/feedbck2.gif" alt="Go to Feedback page" /><br />
<span class="icon">Contact Us</span></a></td>
</tr>
</table>
</td>
</tr>
</table>
--></footer>
<noscript>
<p>Scripting on this page enhances content navigation, but does not change the content in any way.</p>
</noscript>
</body>
</html>
